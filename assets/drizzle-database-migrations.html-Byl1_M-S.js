import{_ as h}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as y,d as n,f as e,b as l,a as f,t as w,n as r,g as u,w as p,e as a,r as i,o as z}from"./app-BVguHYKu.js";const q={},E={id:"frontmatter-title-관련",tabindex:"-1"},A={class:"header-anchor",href:"#frontmatter-title-관련"},T={class:"table-of-contents"},D={href:"https://orm.drizzle.team/",target:"_blank",rel:"noopener noreferrer"},R={href:"https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping",target:"_blank",rel:"noopener noreferrer"},I={href:"https://docker.com/",target:"_blank",rel:"noopener noreferrer"},x={href:"https://frontendmasters.com/courses/intermediate-next-js/",target:"_blank",rel:"noopener noreferrer"},S={href:"https://orm.drizzle.team/docs/kit-overview",target:"_blank",rel:"noopener noreferrer"};function N(m,s){const c=i("VPCard"),o=i("router-link"),g=i("SiteInfo"),t=i("VPIcon"),b=i("RouteLink"),v=i("CodeTabs");return z(),y("div",null,[n("h1",E,[n("a",A,[n("span",null,w(m.$frontmatter.title)+" 관련",1)])]),e(c,r(u({title:"Node.js > Article(s)",desc:"Article(s)",link:"/programming/js-node/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),e(c,r(u({title:"Docker > Article(s)",desc:"Article(s)",link:"/devops/docker/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),e(c,r(u({title:"PostgreSQL > Article(s)",desc:"Article(s)",link:"/data-science/postgres/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),n("nav",T,[n("ul",null,[n("li",null,[e(o,{to:"#our-database"},{default:p(()=>s[0]||(s[0]=[a("Our Database")])),_:1,__:[0]})]),n("li",null,[e(o,{to:"#setting-up"},{default:p(()=>s[1]||(s[1]=[a("Setting Up")])),_:1,__:[1]})]),n("li",null,[e(o,{to:"#configuring-drizzle"},{default:p(()=>s[2]||(s[2]=[a("Configuring Drizzle")])),_:1,__:[2]})]),n("li",null,[e(o,{to:"#the-database-first-approach"},{default:p(()=>s[3]||(s[3]=[a("The Database First Approach")])),_:1,__:[3]}),n("ul",null,[n("li",null,[e(o,{to:"#files-generated"},{default:p(()=>s[4]||(s[4]=[a("Files generated")])),_:1,__:[4]})])])]),n("li",null,[e(o,{to:"#making-changes-migrations"},{default:p(()=>s[5]||(s[5]=[a("Making Changes (Migrations)")])),_:1,__:[5]})]),n("li",null,[e(o,{to:"#the-code-first-approach"},{default:p(()=>s[6]||(s[6]=[a("The Code First Approach")])),_:1,__:[6]}),n("ul",null,[n("li",null,[e(o,{to:"#making-a-schema-change"},{default:p(()=>s[7]||(s[7]=[a("Making a schema change")])),_:1,__:[7]})])])]),n("li",null,[e(o,{to:"#mixing-matching-approaches"},{default:p(()=>s[8]||(s[8]=[a("Mixing & Matching Approaches")])),_:1,__:[8]})]),n("li",null,[e(o,{to:"#going-further"},{default:p(()=>s[9]||(s[9]=[a("Going Further")])),_:1,__:[9]})]),n("li",null,[e(o,{to:"#concluding-thoughts"},{default:p(()=>s[10]||(s[10]=[a("Concluding Thoughts")])),_:1,__:[10]})])])]),s[76]||(s[76]=n("hr",null,null,-1)),e(g,{name:"Drizzle Database Migrations",desc:"Drizzle ORM is a powerful object-relational mapper that combines SQL capabilities with a strongly typed API, enabling complex queries. Here we'll look at using it's ability to help with migrations, both code-first and database-first.",url:"https://frontendmasters.com/blog/drizzle-database-migrations/",logo:"https://frontendmasters.com/favicon.ico",preview:"https://frontendmasters.com/blog/wp-json/social-image-generator/v1/image/4692"}),n("p",null,[n("a",D,[e(t,{icon:"fas fa-globe"}),s[11]||(s[11]=a("Drizzle ORM"))]),s[13]||(s[13]=a(" is an incredibly impressive")),n("a",R,[e(t,{icon:"fa-brands fa-wikipedia-w"}),s[12]||(s[12]=a("object-relational mapper"))]),s[14]||(s[14]=a("(ORM). Like traditional ORMs, it offers a domain-specific language (DSL) for querying entire object graphs. Imagine grabbing some “tasks”, along with “comments” on those tasks from your database. But unlike traditional ORMs, it also exposes SQL itself via a thin, strongly typed API. This allows you to write complex queries using things like")),s[15]||(s[15]=n("code",null,"MERGE",-1)),s[16]||(s[16]=a(",")),s[17]||(s[17]=n("code",null,"UNION",-1)),s[18]||(s[18]=a(", CTEs, and so on, but in a strongly typed API that looks incredibly similar to the SQL you already know (and hopefully love)."))]),n("p",null,[e(b,{to:"/frontendmasters.com/introducing-drizzle.html"},{default:p(()=>s[19]||(s[19]=[n("strong",null,"I wrote about Drizzlepreviously.",-1)])),_:1,__:[19]}),s[20]||(s[20]=a(" That post focused exclusively on the typed SQL API. This post will look at another drizzle feature: database migrations. Not only will Drizzle allow you to query your database via a strongly typed API, but it will also keep your object model and database in sync. Let’s get started!"))]),s[77]||(s[77]=n("hr",null,null,-1)),s[78]||(s[78]=n("h2",{id:"our-database",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#our-database"},[n("span",null,"Our Database")])],-1)),n("p",null,[s[22]||(s[22]=a("Drizzle supports Postgres, MySQL, and SQLite. For this post we’ll be using Postgres, but the idea is the same for all of them. If you’d like to follow along at home, I urge you to use ")),n("a",I,[e(t,{icon:"fa-brands fa-docker"}),s[21]||(s[21]=a("Docker"))]),s[23]||(s[23]=a(" to spin up a Postgres database (or MySQL, if that’s your preference). If you’re completely new to Docker, it’s not terribly hard to get it installed. Once you have it installed, run this:"))]),s[79]||(s[79]=l(`<div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">docker</span> container run <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">-e</span> <span class="token assign-left variable">POSTGRES_USER</span><span class="token operator">=</span>docker <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">-e</span> <span class="token assign-left variable">POSTGRES_PASSWORD</span><span class="token operator">=</span>docker <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">-p</span> <span class="token number">5432</span>:5432 <span class="token punctuation">\\</span></span>
<span class="line">postgres:17.2-alpine3.20</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>That should get you a Postgres instance up and running that you can connect to on <code>localhost</code>, with a username and password of docker / docker. When you stop that process, your database will vanish into the ether. Restarting that same process will create a brand new Postgres instance with a completely clean slate, making this especially convenient for the type of testing we’re about to do: <strong>database migrations</strong>.</p><p>Incidentally, if you’d like to run a database that actually persists its data on your machine, you can mount a volume.</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">docker</span> container run <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">-e</span> <span class="token assign-left variable">POSTGRES_USER</span><span class="token operator">=</span>docker <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">-e</span> <span class="token assign-left variable">POSTGRES_PASSWORD</span><span class="token operator">=</span>docker <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">-p</span> <span class="token number">5432</span>:5432 <span class="token punctuation">\\</span></span>
<span class="line"><span class="token parameter variable">-v</span> /Users/arackis/Documents/pg-data:/var/lib/postgresql/data <span class="token punctuation">\\</span></span>
<span class="line">postgres:17.2-alpine3.20</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,4)),n("p",null,[s[24]||(s[24]=a("That does the same thing, while telling Docker to alias the directory in its image of")),e(t,{icon:"fas fa-folder-open"}),s[25]||(s[25]=n("code",null,"/var/lib/postgresql/data",-1)),s[26]||(s[26]=a("(where Postgres stores its data) onto the directory on your laptop at")),e(t,{icon:"fas fa-folder-open"}),s[27]||(s[27]=n("code",null,"/Users/arackis/Documents/pg-data",-1)),s[28]||(s[28]=a(". Adjust the latter path as desired. (The other path isn’t up for debate, as that’s what Postgres uses.)"))]),s[80]||(s[80]=n("hr",null,null,-1)),s[81]||(s[81]=n("h2",{id:"setting-up",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#setting-up"},[n("span",null,"Setting Up")])],-1)),s[82]||(s[82]=n("p",null,[a("We’ll get an empty app up ("),n("code",null,"npm init"),a(" is all we need), and then install a few things.")],-1)),e(v,{data:[{id:'<VPIcon icon="fa-brands fa-yarn"/>'},{id:'<VPIcon icon="fa-brands fa-npm"/>'}],active:0,"tab-id":"sh"},{title0:p(({value:d,isActive:k})=>[e(t,{icon:"fa-brands fa-yarn"})]),title1:p(({value:d,isActive:k})=>[e(t,{icon:"fa-brands fa-npm"})]),tab0:p(({value:d,isActive:k})=>s[29]||(s[29]=[n("div",{class:"language-bash line-numbers-mode","data-highlighter":"prismjs","data-ext":"sh"},[n("pre",null,[n("code",{class:"language-bash"},[n("span",{class:"line"},[n("span",{class:"token function"},"yarn"),a(),n("span",{class:"token function"},"add"),a(" drizzle-orm drizzle-kit pg")]),a(`
`),n("span",{class:"line"})])]),n("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[n("div",{class:"line-number"})])],-1)])),tab1:p(({value:d,isActive:k})=>s[30]||(s[30]=[n("div",{class:"language-bash line-numbers-mode","data-highlighter":"prismjs","data-ext":"sh"},[n("pre",null,[n("code",{class:"language-bash"},[n("span",{class:"line"},[n("span",{class:"token function"},"npm"),a(" i drizzle-orm drizzle-kit pg")]),a(`
`),n("span",{class:"line"})])]),n("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[n("div",{class:"line-number"})])],-1)])),_:1}),n("p",null,[s[31]||(s[31]=a("The")),e(t,{icon:"fa-brands fa-npm"}),s[32]||(s[32]=n("code",null,"drizzle-orm",-1)),s[33]||(s[33]=a("package is the main ORM that handles querying your database. The ")),e(t,{icon:"fa-brands fa-npm"}),s[34]||(s[34]=n("code",null,"drizzle-kit",-1)),s[35]||(s[35]=a("package is what handles database migrations, which will be particularly relevant for this post. Lastly, the")),e(t,{icon:"fa-brands fa-npm"}),s[36]||(s[36]=n("code",null,"pg",-1)),s[37]||(s[37]=a("package is the Node Postgres drivers."))]),s[83]||(s[83]=n("hr",null,null,-1)),s[84]||(s[84]=n("h2",{id:"configuring-drizzle",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#configuring-drizzle"},[n("span",null,"Configuring Drizzle")])],-1)),n("p",null,[s[38]||(s[38]=a("Let’s start by adding a")),e(t,{icon:"iconfont icon-typescript"}),s[39]||(s[39]=n("code",null,"drizzle.config.ts",-1)),s[40]||(s[40]=a("to the root of our project."))]),s[85]||(s[85]=l(`<div class="code-block-with-title"><div class="code-block-title-bar" data-title="drizzle.config.ts"><span>drizzle.config.ts</span></div><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> defineConfig <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;drizzle-kit&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">defineConfig</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  dialect<span class="token operator">:</span> <span class="token string">&quot;postgresql&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  out<span class="token operator">:</span> <span class="token string">&quot;./drizzle-schema&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  dbCredentials<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    database<span class="token operator">:</span> <span class="token string">&quot;jira&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    host<span class="token operator">:</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    port<span class="token operator">:</span> <span class="token number">5432</span><span class="token punctuation">,</span></span>
<span class="line">    user<span class="token operator">:</span> <span class="token string">&quot;docker&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    password<span class="token operator">:</span> <span class="token string">&quot;docker&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    ssl<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>`,1)),n("p",null,[s[41]||(s[41]=a("We tell Drizzle what kind of database we’re using (Postgres), where to put the generated schema code (the ")),e(t,{icon:"fas fa-folder-open"}),s[42]||(s[42]=n("code",null,"drizzle-schema",-1)),s[43]||(s[43]=a(" folder), and then the database connection info."))]),n("p",null,[s[45]||(s[45]=a("Wanna see more real-world use cases of Drizzle in action? Check out Scott Moss’ course ")),n("a",x,[e(t,{icon:"fas fa-globe"}),s[44]||(s[44]=a("Intermediate Next.js"))]),s[46]||(s[46]=a(" which uses it and gets into it when the project gets into data fetching needs."))]),s[86]||(s[86]=l(`<hr><h2 id="the-database-first-approach" tabindex="-1"><a class="header-anchor" href="#the-database-first-approach"><span>The Database First Approach</span></a></h2><p>Say we already have a database and want to generate a Drizzle schema from it. (If you want to go in the opposite direction, stay tuned.)</p><p>To create our initial database, I’ve put together a script, which I’ll put here in its entirety.</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> jira<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">\\c jira</span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> users <span class="token punctuation">(</span></span>
<span class="line">  id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">  username <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  avatar <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tasks <span class="token punctuation">(</span></span>
<span class="line">  id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">  name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  epic_id <span class="token keyword">INT</span><span class="token punctuation">,</span></span>
<span class="line">  user_id <span class="token keyword">INT</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> epics <span class="token punctuation">(</span></span>
<span class="line">  id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">  name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  description <span class="token keyword">TEXT</span><span class="token punctuation">,</span></span>
<span class="line">  due <span class="token keyword">DATE</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tags <span class="token punctuation">(</span></span>
<span class="line">  id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">  name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> tasks_tags <span class="token punctuation">(</span></span>
<span class="line">  id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">  task <span class="token keyword">INT</span><span class="token punctuation">,</span></span>
<span class="line">  tag <span class="token keyword">INT</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tasks</span>
<span class="line"><span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> fk_task_user</span>
<span class="line"><span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">REFERENCES</span> users <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tasks</span>
<span class="line"><span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> fk_task_epic</span>
<span class="line"><span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>epic_id<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">REFERENCES</span> epics <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tasks_tags</span>
<span class="line"><span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> fk_tasks_tags_tag</span>
<span class="line"><span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>tag<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">REFERENCES</span> tags <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tasks_tags</span>
<span class="line"><span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> fk_tasks_tags_task</span>
<span class="line"><span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>task<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">REFERENCES</span> tasks <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This will construct a basic database for an hypothetical Jira clone. We have tables for users, epics, tasks and tags, along with various foreign keys connecting them. Assuming you have<code>psql</code>installed (can be installed via libpq), you can execute that script from the command line like this:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token assign-left variable">PGPASSWORD</span><span class="token operator">=</span>docker psql <span class="token parameter variable">-h</span> localhost <span class="token parameter variable">-p</span> <span class="token number">5432</span> <span class="token parameter variable">-U</span> <span class="token function">docker</span> <span class="token parameter variable">-f</span> database-creation-script.sql</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Now run this command:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">npx drizzle-kit pull</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>This tells Drizzle to look at our database and generate a schema from it.</p><figure><img src="https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2024/12/drizzle-pull.png?resize=1024%2C438&amp;ssl=1" alt="Drizzle pull" tabindex="0" loading="lazy"><figcaption>Drizzle pull</figcaption></figure><h3 id="files-generated" tabindex="-1"><a class="header-anchor" href="#files-generated"><span>Files generated</span></a></h3>`,12)),n("p",null,[s[47]||(s[47]=a("Inside the")),e(t,{icon:"fas fa-folder-open"}),s[48]||(s[48]=n("code",null,"drizzle-schema",-1)),s[49]||(s[49]=a("folder there’s now a")),e(t,{icon:"iconfont icon-typescript"}),s[50]||(s[50]=n("code",null,"schema.ts",-1)),s[51]||(s[51]=a("file with our Drizzle schema. Here’s a small sample of it."))]),s[87]||(s[87]=l(`<div class="code-block-with-title"><div class="code-block-title-bar" data-title="drizzle-schema/schema.ts"><span>drizzle-schema/schema.ts</span></div><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> pgTable<span class="token punctuation">,</span> serial<span class="token punctuation">,</span> varchar<span class="token punctuation">,</span> foreignKey<span class="token punctuation">,</span> integer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;drizzle-orm/pg-core&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> sql <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;drizzle-orm&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token function">pgTable</span><span class="token punctuation">(</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  id<span class="token operator">:</span> <span class="token function">serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">primaryKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  username<span class="token operator">:</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">50</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  name<span class="token operator">:</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">250</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  avatar<span class="token operator">:</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">500</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> tasks <span class="token operator">=</span> <span class="token function">pgTable</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token string">&quot;tasks&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span></span>
<span class="line">    id<span class="token operator">:</span> <span class="token function">serial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">primaryKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    name<span class="token operator">:</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token punctuation">{</span> length<span class="token operator">:</span> <span class="token number">250</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    epicId<span class="token operator">:</span> <span class="token function">integer</span><span class="token punctuation">(</span><span class="token string">&quot;epic_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    userId<span class="token operator">:</span> <span class="token function">integer</span><span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  table <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">      fkTaskUser<span class="token operator">:</span> <span class="token function">foreignKey</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        columns<span class="token operator">:</span> <span class="token punctuation">[</span>table<span class="token punctuation">.</span>userId<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        foreignColumns<span class="token operator">:</span> <span class="token punctuation">[</span>users<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        name<span class="token operator">:</span> <span class="token string">&quot;fk_task_user&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      fkTaskEpic<span class="token operator">:</span> <span class="token function">foreignKey</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        columns<span class="token operator">:</span> <span class="token punctuation">[</span>table<span class="token punctuation">.</span>epicId<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        foreignColumns<span class="token operator">:</span> <span class="token punctuation">[</span>epics<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">        name<span class="token operator">:</span> <span class="token string">&quot;fk_task_epic&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>The<code>users</code>entity is a table with some columns. The<code>tasks</code>entity is a bit more interesting. It’s also a table with some columns, but we can also see some foreign keys being defined.</p><p>In Postgres, foreign keys merely create a constraint that’s checked on inserts and updates to verify that a valid value is set, corresponding to a row in the target table. But it has no effect on application code, so you might wonder why Drizzle saw fit to bother creating it. Essentially, Drizzle will allow us to subsequently modify our schema in code, and generate an SQL file that will make equivalent changes in the database. For this to work, Drizzle needs to be aware of things like foreign keys, indexes, etc, so the schema in code, and the database are always truly in sync, and Drizzle knows what’s missing, and needs to be created.</p><h4 id="relations" tabindex="-1"><a class="header-anchor" href="#relations"><span>Relations</span></a></h4>`,4)),n("p",null,[s[52]||(s[52]=a("The other file Drizzle created is")),e(t,{icon:"iconfont icon-typescript"}),s[53]||(s[53]=n("code",null,"relations.ts",-1)),s[54]||(s[54]=a(". Here’s a bit of it:"))]),s[88]||(s[88]=l(`<div class="code-block-with-title"><div class="code-block-title-bar" data-title="relations.ts"><span>relations.ts</span></div><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> relations <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;drizzle-orm/relations&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> tasksRelations <span class="token operator">=</span> <span class="token function">relations</span><span class="token punctuation">(</span>tasks<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> one<span class="token punctuation">,</span> many <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  user<span class="token operator">:</span> <span class="token function">one</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    fields<span class="token operator">:</span> <span class="token punctuation">[</span>tasks<span class="token punctuation">.</span>userId<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    references<span class="token operator">:</span> <span class="token punctuation">[</span>users<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  epic<span class="token operator">:</span> <span class="token function">one</span><span class="token punctuation">(</span>epics<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">    fields<span class="token operator">:</span> <span class="token punctuation">[</span>tasks<span class="token punctuation">.</span>epicId<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    references<span class="token operator">:</span> <span class="token punctuation">[</span>epics<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  tasksTags<span class="token operator">:</span> <span class="token function">many</span><span class="token punctuation">(</span>tasksTags<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> usersRelations <span class="token operator">=</span> <span class="token function">relations</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> many <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  tasks<span class="token operator">:</span> <span class="token function">many</span><span class="token punctuation">(</span>tasks<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>This defines the relationships between tables (and is closely related to foreign keys). If you choose to use the Drizzle query API (the one that’s<em>not</em>SQL with types), Drizzle is capable of understanding that some tables have foreign keys into other tables, and allows you to pull down objects, with related objects in one fell swoop. For example, the tasks table has a <code>user_id</code> column in it, representing the user it’s assigned to. With the relationship set up, we can write queries like this:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">const</span> tasks <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span>query<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span><span class="token function">findMany</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">with</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    user<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This will pull down all tasks, along with the user each is assigned to.</p><hr><h2 id="making-changes-migrations" tabindex="-1"><a class="header-anchor" href="#making-changes-migrations"><span>Making Changes (Migrations)</span></a></h2><p>With the code generation above, we’d now be capable of<em>using</em>Drizzle. But that’s not what this post is about. See my last post on Drizzle, or even just the Drizzle docs for guides on using it. This post is all about database migrations. So far, we took an existing database, and scaffolded a valid Drizzle schema. Now let’s run a script to add some things to the database, and see about updating our Drizzle schema.</p><p>We’ll add a new column to tasks called<code>importance</code>, and we’ll also add an index on the <code>tasks</code> table, on the <code>epic_id</code> column. This is unrelated to the foreign key we already have on this column. This is a traditional database index that would assist us in querying the <code>tasks</code> table on the<code>epic_id</code>column.</p><p>Here’s the SQL script we’ll run:</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> idx_tasks_epic <span class="token keyword">ON</span> tasks <span class="token punctuation">(</span>epic_id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> tasks</span>
<span class="line"><span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> importance <span class="token keyword">INT</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>After running that script on our database, we’ll now run:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">npx drizzle-kit pull</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Our terminal should look like this:</p><figure><img src="https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2024/12/drizzle-pull-2-2.png?resize=1024%2C536&amp;ssl=1" alt="Drizzle pull again" tabindex="0" loading="lazy"><figcaption>Drizzle pull again</figcaption></figure><p>We can now see our schema updates in the git diffs:</p><figure><img src="https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2024/12/drizzle-pull-diffs.png?resize=1024%2C427&amp;ssl=1" alt="Drizzle pull changes" tabindex="0" loading="lazy"><figcaption>Drizzle pull changes</figcaption></figure><p>Note the new columns being added, and the new index being created. Again, the index will not affect our application code; it will make our Drizzle schema a faithful representation of our database, so we can make changes on either side, and generate updates to the other. To that end, let’s see about updating our code, and generating SQL to match those changes.</p><hr><h2 id="the-code-first-approach" tabindex="-1"><a class="header-anchor" href="#the-code-first-approach"><span>The Code First Approach</span></a></h2>`,19)),n("p",null,[s[55]||(s[55]=a("Let’s go the other way. Let’s start with a Drizzle schema, and generate an SQL script from it. In order to get a Drizzle schema, let’s just cheat and grab the ")),e(t,{icon:"iconfont icon-typescript"}),s[56]||(s[56]=n("code",null,"schema.ts",-1)),s[57]||(s[57]=a(" and ")),e(t,{icon:"iconfont icon-typescript"}),s[58]||(s[58]=n("code",null,"relations.ts",-1)),s[59]||(s[59]=a(" files Drizzle created above. We’ll paste them into the ")),e(t,{icon:"fas fa-folder-open"}),s[60]||(s[60]=n("code",null,"drizzle-schema",-1)),s[61]||(s[61]=a(" folder, and remove anything else Drizzle created: any snapshots, and anything in the meta folder Drizzle uses to track our history."))]),n("p",null,[s[62]||(s[62]=a("Next, since we want Drizzle to")),s[63]||(s[63]=n("em",null,"read",-1)),s[64]||(s[64]=a("our schema files, rather than just generate them, we need to tell Drizzle where they are. We’ll go back into our ")),e(t,{icon:"iconfont icon-typescript"}),s[65]||(s[65]=n("code",null,"drizzle.config.ts",-1)),s[66]||(s[66]=a(" file, and add this line:"))]),s[89]||(s[89]=l(`<div class="code-block-with-title"><div class="code-block-title-bar" data-title="drizzle.config.ts"><span>drizzle.config.ts</span></div><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line">schema<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./drizzle-schema/schema.ts&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;./drizzle-schema/relations.ts&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></div><p>Now run:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">npx drizzle-kit generate</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Voila! We have database assets being created.</p><figure><img src="https://i0.wp.com/adam-rackis-blog-staging.fly.dev/drizzle-migrations/drizzle-generate.png?ssl=1" alt="Drizzle pull changes" tabindex="0" loading="lazy"><figcaption>Drizzle pull changes</figcaption></figure>`,5)),n("p",null,[s[67]||(s[67]=a("The resulting sql file is huge. Mine is named")),e(t,{icon:"iconfont icon-postgresql"}),s[68]||(s[68]=n("code",null,"0000_quick_wild_pack.sql",-1)),s[69]||(s[69]=a("(Drizzle will add these silly names to make the files stand out) and looks like this, in part."))]),s[90]||(s[90]=l(`<div class="code-block-with-title"><div class="code-block-title-bar" data-title="0000_quick_wild_pack.sql"><span>0000_quick_wild_pack.sql</span></div><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token string">&quot;epics&quot;</span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token string">&quot;id&quot;</span> <span class="token keyword">serial</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&quot;name&quot;</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&quot;description&quot;</span> <span class="token keyword">text</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&quot;due&quot;</span> <span class="token keyword">date</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">--&gt; statement-breakpoint</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token string">&quot;tags&quot;</span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token string">&quot;id&quot;</span> <span class="token keyword">serial</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&quot;name&quot;</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">--&gt; statement-breakpoint</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token string">&quot;tasks&quot;</span> <span class="token punctuation">(</span></span>
<span class="line">  <span class="token string">&quot;id&quot;</span> <span class="token keyword">serial</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&quot;name&quot;</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">250</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&quot;epic_id&quot;</span> <span class="token keyword">integer</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token string">&quot;user_id&quot;</span> <span class="token keyword">integer</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><h3 id="making-a-schema-change" tabindex="-1"><a class="header-anchor" href="#making-a-schema-change"><span>Making a schema change</span></a></h3><p>Now let’s make some changes to our schema. Let’s add that same<code>importance</code>column to our tasks table, add that same index on epicId, and then, for fun, let’s tell Drizzle that our foreign key on userId should have an<code>ON DELETE CASCADE</code>rule, meaning that if we delete a user, the database will automatically delete all tasks assigned to that user. This would probably be an awful rule to add to a real issue tracking software, but it’ll help us see Drizzle in action.</p><p>Here are the changes:</p><figure><img src="https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2024/12/drizzle-update-schema.png?resize=1024%2C673&amp;ssl=1" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>And now we’ll run<code>npx drizzle-kit generate</code> and you should see:</p><figure><img src="https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2024/12/drizzle-generate-2-1.png?resize=1024%2C349&amp;ssl=1" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure>`,7)),n("p",null,[s[70]||(s[70]=a("As before, Drizzle generated a new sql file, this time called")),e(t,{icon:"iconfont icon-postgresql"}),s[71]||(s[71]=n("code",null,"0001_curved_warhawk.sql",-1)),s[72]||(s[72]=a("which looks like this:"))]),s[91]||(s[91]=l(`<div class="code-block-with-title"><div class="code-block-title-bar" data-title="0001_curved_warhawk.sql"><span>0001_curved_warhawk.sql</span></div><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">&quot;tasks&quot;</span> <span class="token keyword">DROP</span> <span class="token keyword">CONSTRAINT</span> <span class="token string">&quot;fk_task_user&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">--&gt; statement-breakpoint</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">&quot;users&quot;</span> <span class="token keyword">ADD</span> <span class="token keyword">COLUMN</span> <span class="token string">&quot;importance&quot;</span> <span class="token keyword">integer</span><span class="token punctuation">;</span><span class="token comment">--&gt; statement-breakpoint</span></span>
<span class="line"><span class="token keyword">DO</span> $$ <span class="token keyword">BEGIN</span></span>
<span class="line"> <span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> <span class="token string">&quot;tasks&quot;</span> <span class="token keyword">ADD</span> <span class="token keyword">CONSTRAINT</span> <span class="token string">&quot;fk_task_user&quot;</span> <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token string">&quot;user_id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> <span class="token string">&quot;public&quot;</span><span class="token punctuation">.</span><span class="token string">&quot;users&quot;</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token keyword">ON</span> <span class="token keyword">DELETE</span> <span class="token keyword">cascade</span> <span class="token keyword">ON</span> <span class="token keyword">UPDATE</span> <span class="token keyword">no</span> <span class="token keyword">action</span><span class="token punctuation">;</span></span>
<span class="line">EXCEPTION</span>
<span class="line"> <span class="token keyword">WHEN</span> duplicate_object <span class="token keyword">THEN</span> <span class="token boolean">null</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">END</span> $$<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">--&gt; statement-breakpoint</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> <span class="token string">&quot;idx_tasks_epicId&quot;</span> <span class="token keyword">ON</span> <span class="token string">&quot;tasks&quot;</span> <span class="token keyword">USING</span> <span class="token keyword">btree</span> <span class="token punctuation">(</span><span class="token string">&quot;epic_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>It added a column, overwrote the foreign key constraint we already had to add our <code>CASCADE</code> rule, and created our index on <code>epic_id</code>.</p><hr><h2 id="mixing-matching-approaches" tabindex="-1"><a class="header-anchor" href="#mixing-matching-approaches"><span>Mixing &amp; Matching Approaches</span></a></h2><p>Make no mistake, you do not have to go all in on code-first, or database-first. You can mix and match approaches. You can scaffold a Drizzle schema from a pre-existing database using<code>drizzle-kit pull</code>, and then make changes to the code, and generate sql files to patch your database with the changes using<code>drizzle-kit generate</code>. Try it and see!</p><hr><h2 id="going-further" tabindex="-1"><a class="header-anchor" href="#going-further"><span>Going Further</span></a></h2>`,7)),n("p",null,[s[74]||(s[74]=a("Believe it or not, we’re only scratching the surface of what drizzle-kit can do. If you like what you’ve seen so far, be sure to check out")),n("a",S,[e(t,{icon:"fas fa-globe"}),s[73]||(s[73]=a("the docs"))]),s[75]||(s[75]=a("."))]),s[92]||(s[92]=n("hr",null,null,-1)),s[93]||(s[93]=n("h2",{id:"concluding-thoughts",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#concluding-thoughts"},[n("span",null,"Concluding Thoughts")])],-1)),s[94]||(s[94]=n("p",null,"Drizzle is an incredibly exciting ORM. Not only does it manage to add an impressive layer of static typing on top of SQL, allowing you to enjoy the power and flexibility of SQL with the type safety you already expect from TypeScript. But it also provides an impressive suite of commands for syncing your changing database with your ORM schema.",-1)),f(" TODO: add ARTICLE CARD "),e(c,r(u({title:"Drizzle Database Migrations",desc:"Drizzle ORM is a powerful object-relational mapper that combines SQL capabilities with a strongly typed API, enabling complex queries. Here we'll look at using it's ability to help with migrations, both code-first and database-first.",link:"https://chanhi2000.github.io/bookshelf/frontendmasters.com/drizzle-database-migrations.html",logo:"https://frontendmasters.com/favicon.ico",background:"rgba(188,75,52,0.2)"})),null,16)])}const O=h(q,[["render",N]]),M=JSON.parse('{"path":"/frontendmasters.com/drizzle-database-migrations.html","title":"Drizzle Database Migrations","lang":"en-US","frontmatter":{"lang":"en-US","title":"Drizzle Database Migrations","description":"Article(s) > Drizzle Database Migrations","icon":"fa-brands fa-node","category":["Node.js","DevOps","Docker","Data Science","PostgreSQL","Article(s)"],"tag":["blog","frontendmasters.com","node","nodejs","node-js","devops","docker","sql","db","postgres","postgresql"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Drizzle Database Migrations\\",\\"image\\":[\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2024/12/drizzle-pull.png?resize=1024%2C438&ssl=1\\",\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2024/12/drizzle-pull-2-2.png?resize=1024%2C536&ssl=1\\",\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2024/12/drizzle-pull-diffs.png?resize=1024%2C427&ssl=1\\",\\"https://i0.wp.com/adam-rackis-blog-staging.fly.dev/drizzle-migrations/drizzle-generate.png?ssl=1\\",\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2024/12/drizzle-update-schema.png?resize=1024%2C673&ssl=1\\",\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2024/12/drizzle-generate-2-1.png?resize=1024%2C349&ssl=1\\"],\\"datePublished\\":\\"2024-12-09T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Adam Rackis\\",\\"url\\":\\"https://frontendmasters.com/blog/author/adamrackis/\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/frontendmasters.com/drizzle-database-migrations.html"}],["meta",{"property":"og:site_name","content":"📚Bookshelf"}],["meta",{"property":"og:title","content":"Drizzle Database Migrations"}],["meta",{"property":"og:description","content":"Article(s) > Drizzle Database Migrations"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://frontendmasters.com/blog/wp-json/social-image-generator/v1/image/4692"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://frontendmasters.com/blog/wp-json/social-image-generator/v1/image/4692"}],["meta",{"name":"twitter:image:alt","content":"Drizzle Database Migrations"}],["meta",{"property":"article:author","content":"Adam Rackis"}],["meta",{"property":"article:tag","content":"postgresql"}],["meta",{"property":"article:tag","content":"postgres"}],["meta",{"property":"article:tag","content":"db"}],["meta",{"property":"article:tag","content":"sql"}],["meta",{"property":"article:tag","content":"docker"}],["meta",{"property":"article:tag","content":"devops"}],["meta",{"property":"article:tag","content":"node-js"}],["meta",{"property":"article:tag","content":"nodejs"}],["meta",{"property":"article:tag","content":"node"}],["meta",{"property":"article:tag","content":"frontendmasters.com"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2024-12-09T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Drizzle Database Migrations"},{"property":"og:description","content":"Drizzle Database Migrations"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/frontendmasters.com/drizzle-database-migrations.html"}]],"prev":"/programming/js-node/articles/README.md","date":"2024-12-09T00:00:00.000Z","isOriginal":false,"author":[{"name":"Adam Rackis","url":"https://frontendmasters.com/blog/author/adamrackis/"}],"cover":"https://frontendmasters.com/blog/wp-json/social-image-generator/v1/image/4692"},"git":{},"readingTime":{"minutes":8.81,"words":2642},"filePathRelative":"frontendmasters.com/drizzle-database-migrations.md","copyright":{"author":"Adam Rackis"}}');export{O as comp,M as data};
