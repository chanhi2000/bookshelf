import{_ as h}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as m,d as s,f as a,b as l,a as v,t as g,n as u,g as d,w as o,e,r as p,o as b}from"./app-BItykJLQ.js";const y={},f={id:"frontmatter-title-·ÑÄ·Ö™·Ü´·ÑÖ·Öß·Ü´",tabindex:"-1"},w={class:"header-anchor",href:"#frontmatter-title-·ÑÄ·Ö™·Ü´·ÑÖ·Öß·Ü´"},x={class:"table-of-contents"},C={href:"https://learn.microsoft.com/en-us/ef/core/dbcontext-configuration/#avoiding-dbcontext-threading-issues",target:"_blank",rel:"noopener noreferrer"},T={class:"hint-container info"},D={class:"hint-container-title"};function A(k,n){const c=p("VPCard"),t=p("router-link"),r=p("SiteInfo"),i=p("VPIcon");return b(),m("div",null,[s("h1",f,[s("a",w,[s("span",null,g(k.$frontmatter.title)+" Í¥ÄÎ†®",1)])]),a(c,u(d({title:"C# > Article(s)",desc:"Article(s)",link:"/programming/cs/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",x,[s("ul",null,[s("li",null,[a(t,{to:"#the-false-promise-of-task-whenall"},{default:o(()=>[...n[0]||(n[0]=[e("The False Promise of Task.WhenAll",-1)])]),_:1})]),s("li",null,[a(t,{to:"#the-solution"},{default:o(()=>[...n[1]||(n[1]=[e("The Solution",-1)])]),_:1})]),s("li",null,[a(t,{to:"#the-benchmark"},{default:o(()=>[...n[2]||(n[2]=[e("The Benchmark",-1)])]),_:1}),s("ul",null,[s("li",null,[a(t,{to:"#sequential-execution"},{default:o(()=>[...n[3]||(n[3]=[e("Sequential Execution",-1)])]),_:1})]),s("li",null,[a(t,{to:"#parallel-execution"},{default:o(()=>[...n[4]||(n[4]=[e("Parallel Execution",-1)])]),_:1})])])]),s("li",null,[a(t,{to:"#trade-offs-conclusion"},{default:o(()=>[...n[5]||(n[5]=[e("Trade-offs & Conclusion",-1)])]),_:1})])])]),n[16]||(n[16]=s("hr",null,null,-1)),a(r,{name:"DbContext is Not Thread-Safe: Parallelizing EF Core Queries the Right Way",desc:"Learn how to safely parallelize EF Core queries to improve performance by using IDbContextFactory to create isolated contexts, avoiding the thread-safety exceptions caused by sharing a single DbContext instance.",url:"https://milanjovanovic.tech/blog/dbcontext-is-not-thread-safe-parallelizing-ef-core-queries-the-right-way",logo:"https://milanjovanovic.tech/profile_favicon.png",preview:"https://milanjovanovic.tech/blog-covers/mnw_171.png"}),n[17]||(n[17]=l(`<p>We have all built <em>that</em> endpoint.</p><p>You know the one: the &quot;Executive Dashboard&quot; or the &quot;User Summary&quot; screen. It&#39;s the endpoint that needs to fetch three or four completely unrelated sets of data to paint a complete picture for the user. It needs the last 50 orders, the current system health logs, the user&#39;s profile settings, and maybe a notification count.</p><p>So, you write the code the standard way:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token class-name"><span class="token keyword">var</span></span> orders <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetRecentOrdersAsync</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name"><span class="token keyword">var</span></span> logs <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetSystemLogsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name"><span class="token keyword">var</span></span> stats <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">GetUserStatsAsync</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DashboardDto</span><span class="token punctuation">(</span>orders<span class="token punctuation">,</span> logs<span class="token punctuation">,</span> stats<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This works. It&#39;s clean. It&#39;s readable. But there is a problem.</p><p>If <code>GetRecentOrdersAsync</code> takes 300ms, <code>GetSystemLogsAsync</code> takes 400ms, and <code>GetUserStatsAsync</code> takes 300ms, your users are staring at a loading spinner for 1 full second (300 + 400 + 300).</p><p>In a distributed system, latency kills user experience. Since these data sets are unrelated, we should be able to run them in parallel. If we did, the total time would only be the duration of the slowest query (400ms). That is a 60% performance improvement just by changing how we execute the code.</p><p>But if you try the naive approach with Entity Framework Core, your application will crash.</p><hr><h2 id="the-false-promise-of-task-whenall" tabindex="-1"><a class="header-anchor" href="#the-false-promise-of-task-whenall"><span>The False Promise of Task.WhenAll</span></a></h2><p>The most common mistake developers make when trying to optimize this is wrapping their existing repository calls in tasks and waiting for them all at once.</p><p>It looks something like this:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token comment">// ‚ùå DO NOT DO THIS</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DashboardData<span class="token punctuation">&gt;</span></span> <span class="token function">GetDashboardData</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> userId<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// These methods all use the same injected _dbContext</span></span>
<span class="line">    <span class="token class-name"><span class="token keyword">var</span></span> ordersTask <span class="token operator">=</span> _repository<span class="token punctuation">.</span><span class="token function">GetOrdersAsync</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name"><span class="token keyword">var</span></span> logsTask <span class="token operator">=</span> _repository<span class="token punctuation">.</span><span class="token function">GetLogsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token class-name"><span class="token keyword">var</span></span> statsTask <span class="token operator">=</span> _repository<span class="token punctuation">.</span><span class="token function">GetStatsAsync</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WhenAll</span><span class="token punctuation">(</span>ordersTask<span class="token punctuation">,</span> logsTask<span class="token punctuation">,</span> statsTask<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// BOOM üí•</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DashboardData</span><span class="token punctuation">(</span>ordersTask<span class="token punctuation">.</span>Result<span class="token punctuation">,</span> logsTask<span class="token punctuation">.</span>Result<span class="token punctuation">,</span> statsTask<span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,13)),s("p",null,[n[7]||(n[7]=e("If you run this, you will immediately hit ",-1)),s("a",C,[a(i,{icon:"fa-brands fa-microsoft"}),n[6]||(n[6]=e("this dreaded exception",-1))]),n[8]||(n[8]=e(":",-1))]),s("div",T,[s("p",D,[n[9]||(n[9]=e("Avoiding DbContext threading issues (",-1)),a(i,{icon:"fa-brands fa-microsoft"}),n[10]||(n[10]=s("code",null,"learn.microsoft.com",-1)),n[11]||(n[11]=e(")",-1))]),n[12]||(n[12]=s("blockquote",null,[s("p",null,"A second operation started on this context before a previous operation completed. This is usually caused by different threads using the same instance of DbContext, however instance members are not guaranteed to be thread safe.")],-1)),a(r,{name:"DbContext Lifetime, Configuration, and Initialization - EF Core",desc:"Patterns for creating and managing DbContext instances with or without dependency injection",url:"https://learn.microsoft.com/en-us/ef/core/dbcontext-configuration/",logo:"/assets/image/learn.microsoft.com/favicon.ico",preview:"https://learn.microsoft.com/en-us/media/open-graph-image.png"})]),n[18]||(n[18]=l('<p><strong>Why does this happen?</strong></p><p>The <code>DbContext</code> in EF Core is <strong>not thread-safe</strong>. It is a stateful object designed to manage a single unit of work. It maintains a &quot;Change Tracker&quot; to keep track of the entities you&#39;ve loaded, and it wraps a single underlying database connection.</p><p>Database protocols (like the TCP stream for PostgreSQL or SQL Server) are generally synchronous at the connection level. You cannot push two different SQL queries down the same wire at the exact same millisecond. When you use <code>Task.WhenAll</code>, multiple threads try to grab that single connection simultaneously, and EF Core steps in to throw the exception to prevent data corruption.</p><p>So, we have a dilemma: We want the speed of parallelism, but the <code>DbContext</code> forces us into sequential execution.</p><hr><h2 id="the-solution" tabindex="-1"><a class="header-anchor" href="#the-solution"><span>The Solution</span></a></h2><p>Since .NET 5, EF Core has provided a first-class solution for this exact scenario: <code>IDbContextFactory&lt;T&gt;</code>.</p><p>Instead of injecting a scoped instance of your context (which lives for the entire HTTP request), you inject a factory that allows you to create lightweight, independent instances of <code>DbContext</code> on demand.</p><div class="hint-container note"><p class="hint-container-title">Note</p><p>While using the factory is the cleanest approach for Dependency Injection, you can also manually instantiate the context (<code>using var context = new AppDbContext(options)</code>) if you have access to the <code>DbContextOptions</code>.</p></div>',9)),s("p",null,[n[13]||(n[13]=e("First, we need to register the factory in our ",-1)),a(i,{icon:"iconfont icon-csharp"}),n[14]||(n[14]=s("code",null,"Program.cs",-1)),n[15]||(n[15]=e(".",-1))]),n[19]||(n[19]=l(`<div class="code-block-with-title"><div class="code-block-title-bar" data-title="Program.cs"><span>Program.cs</span></div><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token comment">// This registers IDbContextFactory&lt;AppDbContext&gt; as a Singleton (by default)</span></span>
<span class="line"><span class="token comment">// It also registers AppDbContext as Scoped for ease of use elsewhere</span></span>
<span class="line">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddDbContextFactory</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>AppDbContext<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    options<span class="token punctuation">.</span><span class="token function">UseNpgsql</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">&quot;db&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>Now, let&#39;s refactor our slow dashboard endpoint. Instead of injecting <code>AppDbContext</code>, we inject <code>IDbContextFactory&lt;AppDbContext&gt;</code>.</p><p>Inside our method, we spin up a dedicated task for each query. Inside each task, we create a brand new context, execute the query, and then immediately dispose of it.</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="DashboardService.cs"><span>DashboardService.cs</span></div><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DashboardService</span><span class="token punctuation">(</span><span class="token class-name">IDbContextFactory<span class="token punctuation">&lt;</span>AppDbContext<span class="token punctuation">&gt;</span></span> contextFactory<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>DashboardDto<span class="token punctuation">&gt;</span></span> <span class="token function">GetDashboardAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> userId<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// 1. Start the tasks (The queries start executing immediately upon invocation)</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> ordersTask <span class="token operator">=</span> <span class="token function">GetOrdersAsync</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> logsTask <span class="token operator">=</span> <span class="token function">GetSystemLogsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> statsTask <span class="token operator">=</span> <span class="token function">GetUserStatsAsync</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 2. Wait for all to complete</span></span>
<span class="line">        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">WhenAll</span><span class="token punctuation">(</span>ordersTask<span class="token punctuation">,</span> logsTask<span class="token punctuation">,</span> statsTask<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// 3. Return results (using &#39;await Task.WhenAll&#39; here unwraps the result cleanly)</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DashboardDto</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token keyword">await</span> ordersTask<span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">await</span> logsTask<span class="token punctuation">,</span></span>
<span class="line">            <span class="token keyword">await</span> statsTask</span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>Order<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetOrdersAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> userId<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Create a fresh context for this specific operation</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">await</span> contextFactory<span class="token punctuation">.</span><span class="token function">CreateDbContextAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span>Orders</span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">AsNoTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>UserId <span class="token operator">==</span> userId<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">OrderByDescending</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>CreatedAt<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">ThenByDescending</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span>Amount<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">Take</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>List<span class="token punctuation">&lt;</span>SystemLog<span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetSystemLogsAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">await</span> contextFactory<span class="token punctuation">.</span><span class="token function">CreateDbContextAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span>SystemLogs</span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">AsNoTracking</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">OrderByDescending</span><span class="token punctuation">(</span>l <span class="token operator">=&gt;</span> l<span class="token punctuation">.</span>Timestamp<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">Take</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>UserStats<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetUserStatsAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> userId<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> context <span class="token operator">=</span> <span class="token keyword">await</span> contextFactory<span class="token punctuation">.</span><span class="token function">CreateDbContextAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> context<span class="token punctuation">.</span>Users</span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>u <span class="token operator">=&gt;</span> u<span class="token punctuation">.</span>Id <span class="token operator">==</span> userId<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>u <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">UserStats</span> <span class="token punctuation">{</span> OrderCount <span class="token operator">=</span> u<span class="token punctuation">.</span>Orders<span class="token punctuation">.</span>Count <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="hint-container important"><p class="hint-container-title">Key Concepts</p><ol><li><strong>Isolation</strong>: Each task gets its own DbContext. This means they get their own database connection. There is no contention.</li><li><strong>Disposal</strong>: Notice the await using. This is critical. As soon as the query is done, we want to dispose of that context and return the connection to the pool.</li></ol></div><hr><h2 id="the-benchmark" tabindex="-1"><a class="header-anchor" href="#the-benchmark"><span>The Benchmark</span></a></h2><p>To prove this works, I built a small .NET 10 app using Aspire and PostgreSQL.. Since I&#39;m running this locally, the absolute times are very low. If I used a remote database, the times would be higher, but the speedup ratio would be similar.</p><h3 id="sequential-execution" tabindex="-1"><a class="header-anchor" href="#sequential-execution"><span>Sequential Execution</span></a></h3><blockquote><p>~36ms</p></blockquote><figure><img src="https://milanjovanovic.tech/blogs/mnw_171/sequential_ef_queries_trace.png?imwidth=3840" alt="A distributed trace showing sequential EF Core queries." tabindex="0" loading="lazy"><figcaption>A distributed trace showing sequential EF Core queries.</figcaption></figure><p>The waterfall is painfully obvious here. Each operation waits for the previous one to finish.</p><h3 id="parallel-execution" tabindex="-1"><a class="header-anchor" href="#parallel-execution"><span>Parallel Execution</span></a></h3><blockquote><p>~13ms</p></blockquote><figure><img src="https://milanjovanovic.tech/blogs/mnw_171/parallel_ef_queries_trace.png?imwidth=3840" alt="A distributed trace showing parallel EF Core queries." tabindex="0" loading="lazy"><figcaption>A distributed trace showing parallel EF Core queries.</figcaption></figure><p>By using the parallel approach, the timeline compresses. All three database spans start at the same time and complete together.</p><hr><h2 id="trade-offs-conclusion" tabindex="-1"><a class="header-anchor" href="#trade-offs-conclusion"><span>Trade-offs &amp; Conclusion</span></a></h2><p><code>IDbContextFactory</code> bridges the gap between EF Core&#39;s unit-of-work design and the reality of modern, parallel requirements. It allows you to break out of the &quot;one request, one thread&quot; box without sacrificing safety.</p><p>However, use this pattern sparingly:</p><ul><li><strong>Connection pool starvation</strong>: A single HTTP request now occupies 3 database connections simultaneously instead of 1. If you have high concurrency, you can easily exhaust your connection pool.</li><li><strong>Context overhead</strong>: If your queries are extremely fast (e.g., simple lookups by ID), the overhead of creating multiple contexts and tasks might make the parallel version slower than the sequential one.</li></ul><p>Next time you are staring at a slow dashboard, don&#39;t reach for raw SQL immediately. Check your awaits. If they are lined up single-file, it might be time to introduce some parallelization.</p><hr>`,23)),v(" TODO: add ARTICLE CARD "),a(c,u(d({title:"DbContext is Not Thread-Safe: Parallelizing EF Core Queries the Right Way",desc:"Learn how to safely parallelize EF Core queries to improve performance by using IDbContextFactory to create isolated contexts, avoiding the thread-safety exceptions caused by sharing a single DbContext instance.",link:"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/dbcontext-is-not-thread-safe-parallelizing-ef-core-queries-the-right-way.html",logo:"https://milanjovanovic.tech/profile_favicon.png",background:"rgba(79,70,229,0.2)"})),null,16)])}const q=h(y,[["render",A]]),E=JSON.parse('{"path":"/milanjovanovic.tech/dbcontext-is-not-thread-safe-parallelizing-ef-core-queries-the-right-way.html","title":"DbContext is Not Thread-Safe: Parallelizing EF Core Queries the Right Way","lang":"en-US","frontmatter":{"lang":"en-US","title":"DbContext is Not Thread-Safe: Parallelizing EF Core Queries the Right Way","description":"Article(s) > DbContext is Not Thread-Safe: Parallelizing EF Core Queries the Right Way","icon":"iconfont icon-csharp","category":["C#","DotNet","Article(s)"],"tag":["blog","milanjovanovic.tech","cs","c#","csharp","dotnet"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"DbContext is Not Thread-Safe: Parallelizing EF Core Queries the Right Way\\",\\"image\\":[\\"https://milanjovanovic.tech/blogs/mnw_171/sequential_ef_queries_trace.png?imwidth=3840\\",\\"https://milanjovanovic.tech/blogs/mnw_171/parallel_ef_queries_trace.png?imwidth=3840\\"],\\"datePublished\\":\\"2025-12-06T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Milan Jovanoviƒá\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/dbcontext-is-not-thread-safe-parallelizing-ef-core-queries-the-right-way.html"}],["meta",{"property":"og:site_name","content":"üìöBookshelf"}],["meta",{"property":"og:title","content":"DbContext is Not Thread-Safe: Parallelizing EF Core Queries the Right Way"}],["meta",{"property":"og:description","content":"Article(s) > DbContext is Not Thread-Safe: Parallelizing EF Core Queries the Right Way"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://milanjovanovic.tech/blog-covers/mnw_171.png"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://milanjovanovic.tech/blog-covers/mnw_171.png"}],["meta",{"name":"twitter:image:alt","content":"DbContext is Not Thread-Safe: Parallelizing EF Core Queries the Right Way"}],["meta",{"property":"article:author","content":"Milan Jovanoviƒá"}],["meta",{"property":"article:tag","content":"dotnet"}],["meta",{"property":"article:tag","content":"csharp"}],["meta",{"property":"article:tag","content":"c#"}],["meta",{"property":"article:tag","content":"cs"}],["meta",{"property":"article:tag","content":"milanjovanovic.tech"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2025-12-06T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > DbContext is Not Thread-Safe: Parallelizing EF Core Queries the Right Way"},{"property":"og:description","content":"DbContext is Not Thread-Safe: Parallelizing EF Core Queries the Right Way"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/dbcontext-is-not-thread-safe-parallelizing-ef-core-queries-the-right-way.html"}]],"prev":"/programming/cs/articles/README.md","date":"2025-12-06T00:00:00.000Z","isOriginal":false,"author":"Milan Jovanoviƒá","cover":"https://milanjovanovic.tech/blog-covers/mnw_171.png"},"git":{},"readingTime":{"minutes":4.82,"words":1446},"filePathRelative":"milanjovanovic.tech/dbcontext-is-not-thread-safe-parallelizing-ef-core-queries-the-right-way.md","copyright":{"author":"Milan Jovanoviƒá"}}');export{q as comp,E as data};
