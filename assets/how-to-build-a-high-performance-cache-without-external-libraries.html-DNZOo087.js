import{_ as v}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as h,d as s,f as e,b as i,a as y,t as b,n as r,g as k,w as t,e as a,r as o,o as w}from"./app-BItykJLQ.js";const g={},f={id:"frontmatter-title-관련",tabindex:"-1"},C={class:"header-anchor",href:"#frontmatter-title-관련"},x={class:"table-of-contents"},T={href:"https://en.wikipedia.org/wiki/Thundering_herd_problem",target:"_blank",rel:"noopener noreferrer"},A={href:"https://en.wikipedia.org/wiki/Cache_stampede",target:"_blank",rel:"noopener noreferrer"},q={href:"https://en.wikipedia.org/wiki/Double-checked_locking",target:"_blank",rel:"noopener noreferrer"},R={href:"https://github.com/ZiggyCreatures/FusionCache",target:"_blank",rel:"noopener noreferrer"};function E(d,n){const u=o("VPCard"),p=o("router-link"),m=o("SiteInfo"),c=o("RouteLink"),l=o("VPIcon");return w(),h("div",null,[s("h1",f,[s("a",C,[s("span",null,b(d.$frontmatter.title)+" 관련",1)])]),e(u,r(k({title:"C# > Article(s)",desc:"Article(s)",link:"/programming/cs/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",x,[s("ul",null,[s("li",null,[e(p,{to:"#the-starting-point"},{default:t(()=>[...n[0]||(n[0]=[a("The Starting Point",-1)])]),_:1})]),s("li",null,[e(p,{to:"#level-1-adding-a-concurrentdictionary"},{default:t(()=>[...n[1]||(n[1]=[a("Level 1: Adding a ConcurrentDictionary",-1)])]),_:1})]),s("li",null,[e(p,{to:"#level-2-adding-cache-expiration"},{default:t(()=>[...n[2]||(n[2]=[a("Level 2: Adding Cache Expiration",-1)])]),_:1})]),s("li",null,[e(p,{to:"#level-3-solving-the-cache-stampede"},{default:t(()=>[...n[3]||(n[3]=[a('Level 3: Solving the "Cache Stampede"',-1)])]),_:1})]),s("li",null,[e(p,{to:"#level-4-scaling-with-keyed-locking"},{default:t(()=>[...n[4]||(n[4]=[a("Level 4: Scaling with Keyed Locking",-1)])]),_:1})]),s("li",null,[e(p,{to:"#the-final-code"},{default:t(()=>[...n[5]||(n[5]=[a("The Final Code",-1)])]),_:1})]),s("li",null,[e(p,{to:"#takeaway"},{default:t(()=>[...n[6]||(n[6]=[a("Takeaway",-1)])]),_:1})])])]),n[35]||(n[35]=s("hr",null,null,-1)),e(m,{name:"How to Build a High-Performance Cache Without External Libraries",desc:"Learn how to build a high-performance cache from scratch in .NET, moving from a simple ConcurrentDictionary to an optimized keyed-locking system. This deep dive explores how to master concurrency patterns like double-checked locking to protect your APIs and improve application scalability.",url:"https://milanjovanovic.tech/blog/how-to-build-a-high-performance-cache-without-external-libraries",logo:"https://milanjovanovic.tech/profile_favicon.png",preview:"https://milanjovanovic.tech/blog-covers/mnw_174.png"}),n[36]||(n[36]=s("p",null,"A couple of days ago, I was looking at a piece of code that's doing too much work. I'm sure you'll be able to draw a parallel to something in your own applications. Maybe it's a database call that should be faster, or an external API that's starting to bill you by the thousands.",-1)),n[37]||(n[37]=s("p",null,[a("My first instinct is: "),s("strong",null,`"I'll just cache it"`),a(".")],-1)),n[38]||(n[38]=s("p",null,[a("In .NET, that usually means reaching for "),s("code",null,"IMemoryCache"),a(" or plugging in a distributed cache like Redis.")],-1)),n[39]||(n[39]=s("p",null,[a("But have you ever stopped to wonder what's actually happening inside those libraries?"),s("br"),a(" Why do we need all that complexity just to store a value in memory?")],-1)),s("p",null,[n[8]||(n[8]=a("So I spent the afternoon trying to build a ",-1)),e(c,{to:"/milanjovanovic.tech/caching-in-aspnetcore-improving-application-performance.html"},{default:t(()=>[...n[7]||(n[7]=[s("strong",null,"high-performance cache",-1)])]),_:1}),n[9]||(n[9]=a(" from scratch.",-1))]),s("p",null,[n[11]||(n[11]=a("I don't recommend DIY-ing your own caching library for production use. But I learn best by doing something myself. Understanding these patterns (concurrency, race conditions, and ",-1)),e(c,{to:"/milanjovanovic.tech/introduction-to-locking-and-concurrency-control-in-dotnet-6.html"},{default:t(()=>[...n[10]||(n[10]=[s("strong",null,"locking",-1)])]),_:1}),n[12]||(n[12]=a(') is what separates a "coder" from an engineer.',-1))]),n[40]||(n[40]=i(`<hr><h2 id="the-starting-point" tabindex="-1"><a class="header-anchor" href="#the-starting-point"><span>The Starting Point</span></a></h2><p>I was working on a simple currency conversion handler. We&#39;re calling a third-party API to get exchange rates. The API returns the current exchange rate for a given currency code (like EUR, GBP, JPY) against USD.</p><p>This is the initial implementation:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CurrencyConversion</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IResult<span class="token punctuation">&gt;</span></span> <span class="token function">Handle</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">string</span></span> currencyCode<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">decimal</span></span> amount<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">CurrencyApiClient</span> currencyClient<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Validate currency code format (3 uppercase letters)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">)</span> <span class="token operator">||</span></span>
<span class="line">            currencyCode<span class="token punctuation">.</span>Length <span class="token operator">!=</span> <span class="token number">3</span> <span class="token operator">||</span></span>
<span class="line">            <span class="token operator">!</span>currencyCode<span class="token punctuation">.</span><span class="token function">All</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">.</span>IsLetter<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> Results<span class="token punctuation">.</span><span class="token function">BadRequest</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token punctuation">{</span> error <span class="token operator">=</span> <span class="token string">&quot;Currency code must be a 3-letter uppercase code (e.g., EUR, GBP)&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// Validate amount (must be positive)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> Results<span class="token punctuation">.</span><span class="token function">BadRequest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> error <span class="token operator">=</span> <span class="token string">&quot;Amount must be a positive number&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> rate <span class="token operator">=</span> <span class="token keyword">await</span> currencyClient<span class="token punctuation">.</span><span class="token function">GetExchangeRateAsync</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>rate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> Results<span class="token punctuation">.</span><span class="token function">NotFound</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token punctuation">{</span> error <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;Exchange rate for </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">currencyCode</span><span class="token punctuation">}</span></span><span class="token string"> not found or API error occurred&quot;</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> convertedAmount <span class="token operator">=</span> amount <span class="token operator">*</span> rate<span class="token punctuation">.</span>Value<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> Results<span class="token punctuation">.</span><span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ExchangeRateResponse</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token named-parameter punctuation">Currency</span><span class="token punctuation">:</span> currencyCode<span class="token punctuation">,</span></span>
<span class="line">            <span class="token named-parameter punctuation">BaseCurrency</span><span class="token punctuation">:</span> <span class="token string">&quot;USD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token named-parameter punctuation">Rate</span><span class="token punctuation">:</span> rate<span class="token punctuation">.</span>Value<span class="token punctuation">,</span></span>
<span class="line">            <span class="token named-parameter punctuation">Amount</span><span class="token punctuation">:</span> amount<span class="token punctuation">,</span></span>
<span class="line">            <span class="token named-parameter punctuation">ConvertedAmount</span><span class="token punctuation">:</span> convertedAmount</span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This works fine in your local dev environment. But in production, if 100 people hit this at the same time, you&#39;re making 100 identical network calls. Your API provider will hate you (and you may even get rate limited), and your latency will spike.</p><p>Now let&#39;s build a cache to fix this without using any external libraries. Remember, we&#39;re doing this for learning purposes only.</p><hr><h2 id="level-1-adding-a-concurrentdictionary" tabindex="-1"><a class="header-anchor" href="#level-1-adding-a-concurrentdictionary"><span>Level 1: Adding a <code>ConcurrentDictionary</code></span></a></h2><p>Your first thought is probably to store the rates in a <code>ConcurrentDictionary</code>. It’s thread-safe, so it feels like the right tool.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">decimal</span><span class="token punctuation">&gt;</span></span> Cache <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// In the Handler:</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>Cache<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> cachedRate<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> cachedRate<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name"><span class="token keyword">var</span></span> rate <span class="token operator">=</span> <span class="token keyword">await</span> currencyClient<span class="token punctuation">.</span><span class="token function">GetExchangeRateAsync</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">Cache<span class="token punctuation">.</span><span class="token function">TryAdd</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">,</span> rate<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This definitely helps with performance under load. Multiple threads can read and write to the dictionary without crashing. But <code>ConcurrentDictionary</code> protects the <em>dictionary structure</em>, not your <em>logic</em>.</p>`,12)),s("p",null,[n[14]||(n[14]=a('If 100 users request "EUR" at the exact same time, ',-1)),n[15]||(n[15]=s("code",null,"TryGetValue",-1)),n[16]||(n[16]=a(" will return false for all of them. They will all proceed to call the API. This is a classic ",-1)),e(c,{to:"/milanjovanovic.tech/solving-race-conditions-with-ef-core-optimistic-locking.html"},{default:t(()=>[...n[13]||(n[13]=[s("strong",null,"race condition",-1)])]),_:1}),n[17]||(n[17]=a(". You've protected your memory, but you haven't protected the external API.",-1))]),n[41]||(n[41]=i(`<p>There&#39;s also another problem with this approach: the rates never expire.</p><hr><h2 id="level-2-adding-cache-expiration" tabindex="-1"><a class="header-anchor" href="#level-2-adding-cache-expiration"><span>Level 2: Adding Cache Expiration</span></a></h2><p>Currency rates don&#39;t stay the same forever. We need a way to expire them. Since <code>ConcurrentDictionary</code> doesn&#39;t have a &quot;Time to Live&quot; (TTL), we have to wrap our data.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token comment">// Store both the rate and the time it was created</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">record</span> <span class="token class-name">CacheEntry</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">decimal</span></span> Rate<span class="token punctuation">,</span> <span class="token class-name">DateTime</span> CreatedAt<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Our cache now stores CacheEntry objects</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> CacheEntry<span class="token punctuation">&gt;</span></span> Cache <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">TimeSpan</span> CacheDuration <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Check: Is it there? And is it still &quot;fresh&quot;?</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span>Cache<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> entry<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">    <span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>UtcNow <span class="token operator">-</span> entry<span class="token punctuation">.</span>CreatedAt<span class="token punctuation">)</span> <span class="token operator">&lt;</span> CacheDuration<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> entry<span class="token punctuation">.</span>Rate<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,5)),s("p",null,[n[20]||(n[20]=a("Now we have expiration. But we've actually created a new problem: ",-1)),s("a",T,[e(l,{icon:"fa-brands fa-wikipedia-w"}),n[18]||(n[18]=a("The Thundering Herd",-1))]),n[21]||(n[21]=a(" (a.k.a ",-1)),s("a",A,[e(l,{icon:"fa-brands fa-wikipedia-w"}),n[19]||(n[19]=a("Cache Stampede",-1))]),n[22]||(n[22]=a(").",-1))]),n[42]||(n[42]=s("p",null,'Every 5 minutes, when the cache expires, all incoming traffic will see "stale" data and try to refresh it at once.',-1)),n[43]||(n[43]=s("p",null,"So we need to fix that next.",-1)),n[44]||(n[44]=s("hr",null,null,-1)),n[45]||(n[45]=s("h2",{id:"level-3-solving-the-cache-stampede",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#level-3-solving-the-cache-stampede"},[s("span",null,'Level 3: Solving the "Cache Stampede"')])],-1)),n[46]||(n[46]=s("p",null,[a("To fix the stampede, we need to ensure that only "),s("em",null,"one"),a(" person can fetch the update while everyone else waits.")],-1)),n[47]||(n[47]=s("p",null,"How do we do that in C#?",-1)),s("p",null,[n[24]||(n[24]=a("We use a ",-1)),n[25]||(n[25]=s("code",null,"SemaphoreSlim",-1)),n[26]||(n[26]=a(" and a pattern called ",-1)),s("a",q,[e(l,{icon:"fa-brands fa-wikipedia-w"}),n[23]||(n[23]=a("Double-Checked Locking",-1))]),n[27]||(n[27]=a('. We check the cache once (the "fast path"), then we lock, and then we check ',-1)),n[28]||(n[28]=s("em",null,"again",-1)),n[29]||(n[29]=a(" to see if someone else filled it while we were waiting for the lock.",-1))]),n[48]||(n[48]=i(`<div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token comment">// Basically a mutex but async-friendly</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">SemaphoreSlim</span> Lock <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span><span class="token keyword">decimal</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetRateAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> code<span class="token punctuation">,</span> <span class="token class-name">CurrencyApiClient</span> client<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// Fast path: No locking needed</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>Cache<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> entry<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">IsFresh</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> entry<span class="token punctuation">.</span>Rate<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line highlighted">    <span class="token class-name"><span class="token keyword">var</span></span> acquired <span class="token operator">=</span> <span class="token keyword">await</span> Lock<span class="token punctuation">.</span><span class="token function">WaitAsync</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Avoid deadlocks</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>acquired<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;Could not acquire lock to fetch exchange rate.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">try</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Double-check: Did someone else finish the API call while we waited?</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>Cache<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token keyword">out</span> entry<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">IsFresh</span><span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> entry<span class="token punctuation">.</span>Rate<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> rate <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">GetExchangeRateAsync</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> newEntry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CacheEntry</span><span class="token punctuation">(</span>rate<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// Atomically update the cache</span></span>
<span class="line">        <span class="token comment">// This is safe because we&#39;re inside the lock</span></span>
<span class="line">        Cache<span class="token punctuation">.</span><span class="token function">AddOrUpdate</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> newEntry<span class="token punctuation">,</span> <span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> newEntry<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">return</span> rate<span class="token punctuation">.</span>Value<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">finally</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Always release the lock</span></span>
<span class="line">        Lock<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This is an improvement. But something still feels off.</p><p>Can you spot the <em>problem</em> with this code?</p><p>Our lock behaves like a global lock. This means that if one thread is fetching &quot;EUR&quot;, all other threads (even those requesting &quot;JPY&quot;) are blocked until the &quot;EUR&quot; fetch completes. This problem is called <strong>lock contention</strong>.</p><p>Let&#39;s fix that next.</p><hr><h2 id="level-4-scaling-with-keyed-locking" tabindex="-1"><a class="header-anchor" href="#level-4-scaling-with-keyed-locking"><span>Level 4: Scaling with Keyed Locking</span></a></h2><p>The &quot;pro&quot; move here is <strong>Keyed Locking</strong>. We create a lock for every specific currency. Since the number of currencies is finite, this isn&#39;t too memory-intensive.</p><p>We need an additional <code>ConcurrentDictionary</code> to hold our semaphores, per currency code.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> SemaphoreSlim<span class="token punctuation">&gt;</span></span> Locks <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// In the Handler:</span></span>
<span class="line"><span class="token class-name"><span class="token keyword">var</span></span> semaphore <span class="token operator">=</span> Locks<span class="token punctuation">.</span><span class="token function">GetOrAdd</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">,</span> _ <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SemaphoreSlim</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Cache<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> cachedRate<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">    DateTime<span class="token punctuation">.</span>UtcNow <span class="token operator">-</span> cachedRate<span class="token punctuation">?.</span>CreatedAt <span class="token operator">&lt;</span> CacheDuration<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name"><span class="token keyword">var</span></span> acquired <span class="token operator">=</span> <span class="token keyword">await</span> semaphore<span class="token punctuation">.</span><span class="token function">WaitAsync</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>acquired<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;Could not acquire lock to fetch exchange rate.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">try</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Fetch and update logic...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">finally</span> <span class="token punctuation">{</span> semaphore<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The only thing that changes is how we acquire the lock. Now, if one thread is fetching &quot;EUR&quot;, other threads requesting &quot;JPY&quot; can proceed without waiting. This is the most scalable version of our cache.</p><p><strong>But...</strong> It only works in memory. So it&#39;s not suitable for distributed systems or multiple server instances. There are also a few more edge cases to consider, but you can explore those as an exercise.</p><hr><h2 id="the-final-code" tabindex="-1"><a class="header-anchor" href="#the-final-code"><span>The Final Code</span></a></h2><p>Here&#39;s the final version of our caching logic:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CurrencyConversion</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">record</span> <span class="token class-name">CacheEntry</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">decimal</span></span> Rate<span class="token punctuation">,</span> <span class="token class-name">DateTime</span> CreatedAt<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> CacheEntry<span class="token punctuation">&gt;</span></span> Cache <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">TimeSpan</span> CacheDuration <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> SemaphoreSlim<span class="token punctuation">&gt;</span></span> Locks <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IResult<span class="token punctuation">&gt;</span></span> <span class="token function">Handle</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">string</span></span> currencyCode<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">decimal</span></span> amount<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">CurrencyApiClient</span> currencyClient<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Validate currency code format (3 uppercase letters)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">IsNullOrWhiteSpace</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">)</span> <span class="token operator">||</span></span>
<span class="line">            currencyCode<span class="token punctuation">.</span>Length <span class="token operator">!=</span> <span class="token number">3</span> <span class="token operator">||</span></span>
<span class="line">            <span class="token operator">!</span>currencyCode<span class="token punctuation">.</span><span class="token function">All</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">.</span>IsLetter<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> Results<span class="token punctuation">.</span><span class="token function">BadRequest</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token punctuation">{</span> error <span class="token operator">=</span> <span class="token string">&quot;Currency code must be a 3-letter uppercase code (e.g., EUR, GBP)&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// Validate amount (must be positive)</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>amount <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> Results<span class="token punctuation">.</span><span class="token function">BadRequest</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token punctuation">{</span> error <span class="token operator">=</span> <span class="token string">&quot;Amount must be a positive number&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name"><span class="token keyword">decimal</span><span class="token punctuation">?</span></span> rate<span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> semaphore <span class="token operator">=</span> Locks<span class="token punctuation">.</span><span class="token function">GetOrAdd</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">,</span> _ <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SemaphoreSlim</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Cache<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">var</span></span> cachedRate<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">            DateTime<span class="token punctuation">.</span>UtcNow <span class="token operator">-</span> cachedRate<span class="token punctuation">?.</span>CreatedAt <span class="token operator">&lt;</span> CacheDuration<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name"><span class="token keyword">var</span></span> acquired <span class="token operator">=</span> <span class="token keyword">await</span> semaphore<span class="token punctuation">.</span><span class="token function">WaitAsync</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>acquired<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;Could not acquire lock to fetch exchange rate.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">try</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// Double-check locking pattern: check again inside the lock</span></span>
<span class="line">                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Cache<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">,</span> <span class="token keyword">out</span> cachedRate<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span></span>
<span class="line">                    DateTime<span class="token punctuation">.</span>UtcNow <span class="token operator">-</span> cachedRate<span class="token punctuation">?.</span>CreatedAt <span class="token operator">&lt;</span> CacheDuration<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    rate <span class="token operator">=</span> <span class="token keyword">await</span> currencyClient<span class="token punctuation">.</span><span class="token function">GetExchangeRateAsync</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                    <span class="token keyword">if</span> <span class="token punctuation">(</span>rate <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span></span>
<span class="line">                    <span class="token punctuation">{</span></span>
<span class="line">                        <span class="token keyword">return</span> Results<span class="token punctuation">.</span><span class="token function">NotFound</span><span class="token punctuation">(</span></span>
<span class="line">                            <span class="token keyword">new</span> <span class="token punctuation">{</span> error <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;Exchange rate for </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">currencyCode</span><span class="token punctuation">}</span></span><span class="token string"> not found or API error occurred&quot;</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">                    Cache<span class="token punctuation">.</span><span class="token function">AddOrUpdate</span><span class="token punctuation">(</span>currencyCode<span class="token punctuation">,</span></span>
<span class="line">                        _ <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CacheEntry</span><span class="token punctuation">(</span>rate<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                        <span class="token punctuation">(</span>_<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CacheEntry</span><span class="token punctuation">(</span>rate<span class="token punctuation">.</span>Value<span class="token punctuation">,</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">                <span class="token keyword">else</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    rate <span class="token operator">=</span> cachedRate<span class="token operator">!</span><span class="token punctuation">.</span>Rate<span class="token punctuation">;</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">finally</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                semaphore<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">else</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            rate <span class="token operator">=</span> cachedRate<span class="token operator">!</span><span class="token punctuation">.</span>Rate<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> convertedAmount <span class="token operator">=</span> amount <span class="token operator">*</span> rate<span class="token punctuation">.</span>Value<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> Results<span class="token punctuation">.</span><span class="token function">Ok</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ExchangeRateResponse</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token named-parameter punctuation">Currency</span><span class="token punctuation">:</span> currencyCode<span class="token punctuation">,</span></span>
<span class="line">            <span class="token named-parameter punctuation">BaseCurrency</span><span class="token punctuation">:</span> <span class="token string">&quot;USD&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token named-parameter punctuation">Rate</span><span class="token punctuation">:</span> rate<span class="token punctuation">.</span>Value<span class="token punctuation">,</span></span>
<span class="line">            <span class="token named-parameter punctuation">Amount</span><span class="token punctuation">:</span> amount<span class="token punctuation">,</span></span>
<span class="line">            <span class="token named-parameter punctuation">ConvertedAmount</span><span class="token punctuation">:</span> convertedAmount</span>
<span class="line">        <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The next step would be to extract the core caching logic into its own reusable class. That way, you can use it in other parts of your application.</p><hr><h2 id="takeaway" tabindex="-1"><a class="header-anchor" href="#takeaway"><span>Takeaway</span></a></h2><p>Why go through all this trouble?</p><p>It&#39;s easy to look at a simple <code>ConcurrentDictionary</code> and think you&#39;re done. But as we&#39;ve seen, the gap between &quot;it works&quot; and &quot;it scales&quot; is filled with edge cases that can bring a production system to its knees.</p><p>When you use a library, it handles these edge cases for you. But building it yourself teaches you about the &quot;three pillars&quot; of high-performance code:</p><ol><li><strong>Thread safety</strong></li><li><strong>Lock contention</strong></li><li><strong>Resource protection</strong></li></ol><p>Sometimes the most &quot;boring&quot; parts of our infrastructure, like a cache, are actually the most architecturally interesting.</p><p>There&#39;s also that 1% of the time when you need a custom solution that no library can provide. So it&#39;s worth knowing the fundamentals of how these things work.</p>`,25)),s("p",null,[n[32]||(n[32]=a("Modern libraries like ",-1)),e(c,{to:"/milanjovanovic.tech/hybrid-cache-in-aspnetcore-new-caching-library.html"},{default:t(()=>[...n[30]||(n[30]=[s("strong",null,"HybridCache",-1)])]),_:1}),n[33]||(n[33]=a(" or ",-1)),s("a",R,[e(l,{icon:"iconfont icon-github"}),n[31]||(n[31]=s("code",null,"ZiggyCreatures/FusionCache",-1))]),n[34]||(n[34]=a(" handle this for you, but understanding these patterns ensures you know exactly why your application behaves the way it does under load.",-1))]),n[49]||(n[49]=s("p",null,"And since this is the last issue of the year, I wish you a fantastic New Year! 🎉",-1)),n[50]||(n[50]=s("hr",null,null,-1)),y(" TODO: add ARTICLE CARD "),e(u,r(k({title:"How to Build a High-Performance Cache Without External Libraries",desc:"Learn how to build a high-performance cache from scratch in .NET, moving from a simple ConcurrentDictionary to an optimized keyed-locking system. This deep dive explores how to master concurrency patterns like double-checked locking to protect your APIs and improve application scalability.",link:"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/how-to-build-a-high-performance-cache-without-external-libraries.html",logo:"https://milanjovanovic.tech/profile_favicon.png",background:"rgba(79,70,229,0.2)"})),null,16)])}const L=v(g,[["render",E]]),I=JSON.parse('{"path":"/milanjovanovic.tech/how-to-build-a-high-performance-cache-without-external-libraries.html","title":"How to Build a High-Performance Cache Without External Libraries","lang":"en-US","frontmatter":{"lang":"en-US","title":"How to Build a High-Performance Cache Without External Libraries","description":"Article(s) > How to Build a High-Performance Cache Without External Libraries","icon":"iconfont icon-csharp","category":["C#","DotNet","Article(s)"],"tag":["blog","milanjovanovic.tech","cs","c#","csharp","dotnet"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"How to Build a High-Performance Cache Without External Libraries\\",\\"image\\":[\\"https://milanjovanovic.tech/blog-covers/mnw_174.png\\"],\\"datePublished\\":\\"2025-12-27T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Milan Jovanović\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/how-to-build-a-high-performance-cache-without-external-libraries.html"}],["meta",{"property":"og:site_name","content":"📚Bookshelf"}],["meta",{"property":"og:title","content":"How to Build a High-Performance Cache Without External Libraries"}],["meta",{"property":"og:description","content":"Article(s) > How to Build a High-Performance Cache Without External Libraries"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://milanjovanovic.tech/blog-covers/mnw_174.png"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://milanjovanovic.tech/blog-covers/mnw_174.png"}],["meta",{"name":"twitter:image:alt","content":"How to Build a High-Performance Cache Without External Libraries"}],["meta",{"property":"article:author","content":"Milan Jovanović"}],["meta",{"property":"article:tag","content":"dotnet"}],["meta",{"property":"article:tag","content":"csharp"}],["meta",{"property":"article:tag","content":"c#"}],["meta",{"property":"article:tag","content":"cs"}],["meta",{"property":"article:tag","content":"milanjovanovic.tech"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2025-12-27T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > How to Build a High-Performance Cache Without External Libraries"},{"property":"og:description","content":"How to Build a High-Performance Cache Without External Libraries"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/how-to-build-a-high-performance-cache-without-external-libraries.html"}]],"prev":"/programming/cs/articles/README.md","date":"2025-12-27T00:00:00.000Z","isOriginal":false,"author":"Milan Jovanović","cover":"https://milanjovanovic.tech/blog-covers/mnw_174.png"},"git":{},"readingTime":{"minutes":6.38,"words":1915},"filePathRelative":"milanjovanovic.tech/how-to-build-a-high-performance-cache-without-external-libraries.md","copyright":{"author":"Milan Jovanović"}}');export{L as comp,I as data};
