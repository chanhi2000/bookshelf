import{_ as d}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as v,d as n,f as a,b as c,t as m,n as h,g,w as o,e,r,o as y}from"./app-BItykJLQ.js";const k={},b={id:"frontmatter-title-á„€á…ªá†«á„…á…§á†«",tabindex:"-1"},f={class:"header-anchor",href:"#frontmatter-title-á„€á…ªá†«á„…á…§á†«"},w={class:"table-of-contents"},C={href:"https://github.com/Netflix/eureka",target:"_blank",rel:"noopener noreferrer"},S={href:"https://consul.io/",target:"_blank",rel:"noopener noreferrer"},T={href:"https://azure.microsoft.com/en-us/products/app-configuration",target:"_blank",rel:"noopener noreferrer"},x={href:"https://docs.steeltoe.io/api/v3/discovery/",target:"_blank",rel:"noopener noreferrer"},j={href:"https://github.com/m-jovanovic/service-discovery-consul",target:"_blank",rel:"noopener noreferrer"};function q(p,s){const u=r("VPCard"),t=r("router-link"),l=r("SiteInfo"),i=r("VPIcon");return y(),v("div",null,[n("h1",b,[n("a",f,[n("span",null,m(p.$frontmatter.title)+" ê´€ë ¨",1)])]),a(u,h(g({title:"C# > Article(s)",desc:"Article(s)",link:"/programming/cs/articles/README.md",logo:"https://chanhi2000.github.io/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),n("nav",w,[n("ul",null,[n("li",null,[a(t,{to:"#what-is-service-discovery"},{default:o(()=>[...s[0]||(s[0]=[e("What is Service Discovery?",-1)])]),_:1})]),n("li",null,[a(t,{to:"#setting-up-the-consul-server"},{default:o(()=>[...s[1]||(s[1]=[e("Setting Up the Consul Server",-1)])]),_:1})]),n("li",null,[a(t,{to:"#service-registration-in-net-with-consul"},{default:o(()=>[...s[2]||(s[2]=[e("Service Registration in .NET With Consul",-1)])]),_:1})]),n("li",null,[a(t,{to:"#using-service-discovery"},{default:o(()=>[...s[3]||(s[3]=[e("Using Service Discovery",-1)])]),_:1})]),n("li",null,[a(t,{to:"#takeaway"},{default:o(()=>[...s[4]||(s[4]=[e("Takeaway",-1)])]),_:1})])])]),s[26]||(s[26]=n("hr",null,null,-1)),a(l,{name:"Service Discovery in Microservices With .NET and Consul",desc:"Service discovery is a pattern that allows developers to use logical names to refer to external services, instead of physical IP addresses and ports. In this week's issue, we'll see how to implement service discovery in your .NET microservices with Consul.",url:"https://milanjovanovic.tech/blog/service-discovery-in-microservices-with-net-and-consul/",logo:"https://milanjovanovic.tech/profile_favicon.png",preview:"https://milanjovanovic.tech/blog-covers/mnw_097.png"}),s[27]||(s[27]=c('<p>Microservices have revolutionized how we build and scale applications. By breaking down larger systems into smaller, independent services, we gain flexibility, agility, and the ability to adapt to changing requirements quickly. However, microservices systems are also very dynamic. Services can come and go, scale up or down, and even move around within your infrastructure.</p><p>This dynamic nature presents a significant challenge. How do your services find and communicate with each other reliably?</p><p>Hardcoding IP addresses and ports is a recipe for fragility. If a service instance changes location or a new instance spins up, your entire system could grind to a halt.</p><p>Service discovery acts as a central directory for your microservices. It provides a mechanism for services to register themselves and discover the locations of other services.</p><p>In this week&#39;s issue, we&#39;ll see how to implement service discovery in your .NET microservices with Consul.</p><hr><h2 id="what-is-service-discovery" tabindex="-1"><a class="header-anchor" href="#what-is-service-discovery"><span>What is Service Discovery?</span></a></h2><p>Service discovery is a pattern that allows developers to use logical names to refer to external services instead of physical IP addresses and ports. It provides a centralized location for services to register themselves. Clients can query the service registry to find out the service&#39;s physical address. This is a common pattern in large-scale distributed systems, such as Netflix and Amazon.</p><p>Here&#39;s what the service discovery flow looks like:</p><ol><li>The service will register itself with the service registry</li><li>The client must query the service registry to get the physical address</li><li>The client sends the request to the service using the resolved physical address</li></ol><figure><img src="https://milanjovanovic.tech/blogs/mnw_097/service_discovery_flow.png?imwidth=3840" alt="Service discovery flow." tabindex="0" loading="lazy"><figcaption>Service discovery flow.</figcaption></figure><p>The same concept applies when we have multiple services we want to call. Each service would register itself with the service registry. The client uses a logical name to reference a service and resolves the physical address from the service registry.</p><figure><img src="https://milanjovanovic.tech/blogs/mnw_097/service_discovery_microservices.png?imwidth=3840" alt="Service discovery with multiple microservices." tabindex="0" loading="lazy"><figcaption>Service discovery with multiple microservices.</figcaption></figure>',13)),n("p",null,[s[7]||(s[7]=e("The most popular solutions for service discovery are ",-1)),n("a",C,[a(i,{icon:"iconfont icon-github"}),s[5]||(s[5]=e("Netflix/Eureka",-1))]),s[8]||(s[8]=e(" and HashiCorp ",-1)),n("a",S,[a(i,{icon:"fas fa-globe"}),s[6]||(s[6]=e("Consul",-1))]),s[9]||(s[9]=e(".",-1))]),a(l,{name:"Netflix/eureka",desc:"desc",url:"https://github.com/Netflix/eureka",logo:"logo",preview:"preview"}),n("p",null,[s[11]||(s[11]=e("There is also a lightweight solution from Microsoft in the ",-1)),s[12]||(s[12]=n("code",null,"Microsoft.Extensions.ServiceDiscovery",-1)),s[13]||(s[13]=e(" library. It uses application settings to resolve the physical addresses for services, so some manual work is still required. However, you can store service locations in ",-1)),n("a",T,[a(i,{icon:"iconfont icon-microsoftazure"}),s[10]||(s[10]=e("Azure App Configuration",-1))]),s[14]||(s[14]=e(" for a centralized service registry.",-1))]),s[28]||(s[28]=n("p",null,"I will explore this service discovery library in some future articles.",-1)),s[29]||(s[29]=n("p",null,"But now I want to show you how to integrate Consul with .NET applications.",-1)),s[30]||(s[30]=n("hr",null,null,-1)),s[31]||(s[31]=n("h2",{id:"setting-up-the-consul-server",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#setting-up-the-consul-server"},[n("span",null,"Setting Up the Consul Server")])],-1)),s[32]||(s[32]=n("p",null,[e("The simplest way to run the Consul server locally is using a Docker container. You can create a container instance of the "),n("code",null,"hashicorp/consul"),e(" image.")],-1)),n("p",null,[s[15]||(s[15]=e("Here's an example of configuring the Consul service as part of the ",-1)),a(i,{icon:"iconfont icon-yaml"}),s[16]||(s[16]=n("code",null,"docker-compose.yml",-1)),s[17]||(s[17]=e(" file:",-1))]),s[33]||(s[33]=c(`<div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">consul</span><span class="token punctuation">:</span></span>
<span class="line">  <span class="token key atrule">image</span><span class="token punctuation">:</span> hashicorp/consul<span class="token punctuation">:</span>latest</span>
<span class="line">  <span class="token key atrule">container_name</span><span class="token punctuation">:</span> Consul</span>
<span class="line">  <span class="token key atrule">ports</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token punctuation">-</span> <span class="token string">&#39;8500:8500&#39;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If you navigate to <code>localhost:8500</code>, you will be greeted by the Consul Dashboard.</p><figure><img src="https://milanjovanovic.tech/blogs/mnw_097/consul_dashboard.png?imwidth=3840" alt="Consul dashboard" tabindex="0" loading="lazy"><figcaption>Consul dashboard</figcaption></figure><p>Now, let&#39;s see how to register our services with Consul.</p><hr><h2 id="service-registration-in-net-with-consul" tabindex="-1"><a class="header-anchor" href="#service-registration-in-net-with-consul"><span>Service Registration in .NET With Consul</span></a></h2>`,6)),n("p",null,[s[19]||(s[19]=e("We'll use the ",-1)),n("a",x,[a(i,{icon:"fas fa-globe"}),s[18]||(s[18]=e("Steeltoe Discovery",-1))]),s[20]||(s[20]=e(" library to implement service discovery with Consul. The Consul client implementation lets your applications register services with a Consul server and discover services registered by other applications.",-1))]),s[34]||(s[34]=c(`<p>Let&#39;s install the <code>Steeltoe.Discovery.Consul</code> library:</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code class="language-powershell"><span class="line"><span class="token function">Install-Package</span> Steeltoe<span class="token punctuation">.</span>Discovery<span class="token punctuation">.</span>Consul</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>We have to configure some services by calling <code>AddServiceDiscovery</code> and explicitly configuring the Consul service discovery client. The alternative is calling <code>AddDiscoveryClient</code> which uses reflection at runtime to determine which service registry is available.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">using</span> <span class="token namespace">Steeltoe<span class="token punctuation">.</span>Discovery<span class="token punctuation">.</span>Client</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">using</span> <span class="token namespace">Steeltoe<span class="token punctuation">.</span>Discovery<span class="token punctuation">.</span>Consul</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddServiceDiscovery</span><span class="token punctuation">(</span>o <span class="token operator">=&gt;</span> o<span class="token punctuation">.</span><span class="token function">UseConsul</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Finally, our service can register with Consul by configuring the logical service name through application settings. When the application starts, the <code>reporting-service</code> logical name will be added to the Consul service registry. Consul will store the respective physical address of this service.</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;Consul&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;Host&quot;</span><span class="token operator">:</span> <span class="token string">&quot;localhost&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;Port&quot;</span><span class="token operator">:</span> <span class="token number">8500</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;Discovery&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;ServiceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reporting-service&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Hostname&quot;</span><span class="token operator">:</span> <span class="token string">&quot;reporting-api&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;Port&quot;</span><span class="token operator">:</span> <span class="token number">8080</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>When we start the application and open the Consul dashboard, we should be able to see the <code>reporting-service</code> and its respective physical address.</p><figure><img src="https://milanjovanovic.tech/blogs/mnw_097/consul_dashboard_with_service.png?imwidth=3840" alt="Consul dashboard with registered service." tabindex="0" loading="lazy"><figcaption>Consul dashboard with registered service.</figcaption></figure><hr><h2 id="using-service-discovery" tabindex="-1"><a class="header-anchor" href="#using-service-discovery"><span>Using Service Discovery</span></a></h2><p>We can use service discovery when making HTTP calls with an <code>HttpClient</code>. Service discovery allows us to use a logical name for the service we want to call. When sending a network request, the service discovery client will replace the logical name with a correct physical address.</p><p>In this example, we&#39;re configuring the base address of the <code>ReportingServiceClient</code> typed client to <code>http://reporting-service</code> and adding service discovery by calling <code>AddServiceDiscovery</code>.</p><p>Load balancing is an optional step, and we can configure it by calling <code>AddRoundRobinLoadBalancer</code> or <code>AddRandomLoadBalancer</code>. You can also configure a custom load balancing strategy by providing an <code>ILoadBalancer</code> implementation.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line">builder<span class="token punctuation">.</span>Services</span>
<span class="line">    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddHttpClient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ReportingServiceClient<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>client <span class="token operator">=&gt;</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        client<span class="token punctuation">.</span>BaseAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://reporting-service&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">AddServiceDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">AddRoundRobinLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We can use the <code>ReportingServiceClient</code> typed client like a regular <code>HttpClient</code> to make requests. The service discovery client sends the request to the external service&#39;s IP address.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line">app<span class="token punctuation">.</span><span class="token function">MapGet</span><span class="token punctuation">(</span><span class="token string">&quot;articles/{id}/report&quot;</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token class-name">Guid</span> id<span class="token punctuation">,</span> <span class="token class-name">ReportingServiceClient</span> client<span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> client</span>
<span class="line">            <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetFromJsonAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Response<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;api/reports/article/</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">id</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> response<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="takeaway" tabindex="-1"><a class="header-anchor" href="#takeaway"><span>Takeaway</span></a></h2><p>Service discovery simplifies the management of microservices by automating service registration and discovery. This eliminates the need for manual configuration updates, reducing the risk of errors.</p><p>Services can discover each other&#39;s locations on demand, ensuring that communication channels remain open even as the service landscape evolves. By enabling services to discover alternative service instances in case of outages or failures, service discovery enhances the overall resilience of the microservices system.</p><p>Mastering service discovery gives you a powerful tool to build modern distributed applications.</p>`,21)),n("p",null,[s[24]||(s[24]=e("You can grab the ",-1)),n("a",j,[s[21]||(s[21]=e("source code for this example here (",-1)),a(i,{icon:"iconfont icon-github"}),s[22]||(s[22]=n("code",null,"m-jovanovic/service-discovery-consul",-1)),s[23]||(s[23]=e(")",-1))]),s[25]||(s[25]=e(".",-1))]),a(l,{name:"m-jovanovic/service-discovery-consul",desc:"Service discovery demo in .NET using Consul as a service registry.",url:"https://github.com/m-jovanovic/service-discovery-consul",logo:"https://avatars.githubusercontent.com/u/34191235?s=96&v=4",preview:"https://opengraph.githubassets.com/f9cc712abce3930270887c2badf2c24aea46c72b2ec6c5867f88379b73f84ffd/m-jovanovic/service-discovery-consul"}),s[35]||(s[35]=n("p",null,"Thanks for reading, and I'll see you next week!",-1))])}const A=d(k,[["render",q]]),E=JSON.parse('{"path":"/milanjovanovic.tech/service-discovery-in-microservices-with-net-and-consul.html","title":"Service Discovery in Microservices With .NET and Consul","lang":"ko-KR","frontmatter":{"lang":"ko-KR","title":"Service Discovery in Microservices With .NET and Consul","description":"Article(s) > Service Discovery in Microservices With .NET and Consul","icon":"iconfont icon-csharp","category":["C#","DotNet","Article(s)"],"tag":["blog","milanjovanovic.tech","cs","c#","csharp","dotnet"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Service Discovery in Microservices With .NET and Consul\\",\\"image\\":[\\"https://milanjovanovic.tech/blogs/mnw_097/service_discovery_flow.png?imwidth=3840\\",\\"https://milanjovanovic.tech/blogs/mnw_097/service_discovery_microservices.png?imwidth=3840\\",\\"https://milanjovanovic.tech/blogs/mnw_097/consul_dashboard.png?imwidth=3840\\",\\"https://milanjovanovic.tech/blogs/mnw_097/consul_dashboard_with_service.png?imwidth=3840\\"],\\"datePublished\\":\\"2024-07-13T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Milan JovanoviÄ‡\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/service-discovery-in-microservices-with-net-and-consul.html"}],["meta",{"property":"og:site_name","content":"ðŸ“šBookshelf"}],["meta",{"property":"og:title","content":"Service Discovery in Microservices With .NET and Consul"}],["meta",{"property":"og:description","content":"Article(s) > Service Discovery in Microservices With .NET and Consul"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://milanjovanovic.tech/blog-covers/mnw_097.png"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://milanjovanovic.tech/blog-covers/mnw_097.png"}],["meta",{"name":"twitter:image:alt","content":"Service Discovery in Microservices With .NET and Consul"}],["meta",{"property":"article:author","content":"Milan JovanoviÄ‡"}],["meta",{"property":"article:tag","content":"dotnet"}],["meta",{"property":"article:tag","content":"csharp"}],["meta",{"property":"article:tag","content":"c#"}],["meta",{"property":"article:tag","content":"cs"}],["meta",{"property":"article:tag","content":"milanjovanovic.tech"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2024-07-13T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Service Discovery in Microservices With .NET and Consul"},{"property":"og:description","content":"Service Discovery in Microservices With .NET and Consul"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/service-discovery-in-microservices-with-net-and-consul.html"}]],"prev":"/programming/cs/articles/README.md","date":"2024-07-13T00:00:00.000Z","isOriginal":false,"author":"Milan JovanoviÄ‡","cover":"https://milanjovanovic.tech/blog-covers/mnw_097.png"},"git":{},"readingTime":{"minutes":4.16,"words":1248},"filePathRelative":"milanjovanovic.tech/service-discovery-in-microservices-with-net-and-consul.md","copyright":{"author":"Milan JovanoviÄ‡"}}');export{A as comp,E as data};
