import{_ as y}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as f,d as s,f as t,a as o,b as l,t as w,n as k,g as v,w as e,e as a,r as i,o as I}from"./app-BItykJLQ.js";const S={},P={id:"frontmatter-title-관련",tabindex:"-1"},C={class:"header-anchor",href:"#frontmatter-title-관련"},j={class:"table-of-contents"},A={href:"https://event-driven-io.github.io/emmett/getting-started.html",target:"_blank",rel:"noopener noreferrer"},D={href:"https://event-driven-io.github.io/Pongo/getting-started.html",target:"_blank",rel:"noopener noreferrer"},x={href:"https://event-driven-io.github.io/emmett/getting-started.html#commands",target:"_blank",rel:"noopener noreferrer"},T={href:"https://discord.gg/fTpqUTMmVa",target:"_blank",rel:"noopener noreferrer"};function E(m,n){const r=i("VPCard"),d=i("router-link"),b=i("SiteInfo"),g=i("RouteLink"),p=i("VPIcon"),h=i("CodeTabs");return I(),f("div",null,[s("h1",P,[s("a",C,[s("span",null,w(m.$frontmatter.title)+" 관련",1)])]),t(r,k(v({title:"TypeScript > Article(s)",desc:"Article(s)",link:"/programming/ts/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",j,[s("ul",null,[s("li",null,[t(d,{to:"#single-stream-projections-with-pongo"},{default:e(()=>[...n[0]||(n[0]=[a("Single Stream Projections with Pongo",-1)])]),_:1})]),s("li",null,[t(d,{to:"#testing-projections"},{default:e(()=>[...n[1]||(n[1]=[a("Testing projections",-1)])]),_:1})])])]),n[17]||(n[17]=s("hr",null,null,-1)),t(b,{name:"Using event metadata in event-driven projections",desc:"Event-Driven by Oskar Dudycz",url:"https://event-driven.io/en/projections_and_event_metadata",logo:"/assets/image/event-driven.io/favicon.jfif",preview:"https://event-driven.io/static/d3b3f36478db62c37631cf815bf85de9/2a4de/2024-08-25-cover.png"}),s("p",null,[n[5]||(n[5]=a("In the ",-1)),t(g,{to:"/event-driven.io/emmett-postgresql-event-store.html"},{default:e(()=>[...n[2]||(n[2]=[s("strong",null,"previous article",-1)])]),_:1}),n[6]||(n[6]=a(", I told what happened when ",-1)),s("a",A,[t(p,{icon:"fas fa-globe"}),n[3]||(n[3]=a("Emmett",-1))]),n[7]||(n[7]=a(" and ",-1)),s("a",D,[t(p,{icon:"fas fa-globe"}),n[4]||(n[4]=a("Pongo",-1))]),n[8]||(n[8]=a(" walked into a bar. In other words, I announced that you can now do Event Sourcing in Node.js on top of PostgreSQL.** You can use Emmett as an event store and Pongo, changing PostgreSQL into a document Mongo-like database. With all the strong consistency benefits and integration happening behind the scenes.",-1))]),n[18]||(n[18]=s("p",null,[s("strong",null,"Let’s explore this in more detail today, focusing on the single-stream projection.")],-1)),n[19]||(n[19]=s("p",null,[a("In event sourcing, a stream represents the history of a specific process or object, such as a shopping cart. After each business operation, a new event is appended to the end of the stream. For business logic, we’re getting all events (so facts), interpreting them, and building the current state in memory. That works well for business logic, as streams should be short, and this shouldn’t take long. You can read more about it in "),s("a",{href:"/en/how_to_get_the_current_entity_state_in_event_sourcing/",target:"_blank",rel:"noopener noreferrer"},"How to get the current entity state from events?")],-1)),o(" TODO: /event-driven.io/how_to_get_the_current_entity_state_in_event_sourcing.md "),n[20]||(n[20]=s("p",null,[a("Yet, reading more than one record wouldn’t play well. For that, we need to materialise our data into read models. We can apply our events and store the result in the database table; then, we can apply filtering and get the set of results. Projections are functions that transform events into read models. Check more in "),s("a",{href:"/en/projections_and_read_models_in_event_driven_architecture/",target:"_blank",rel:"noopener noreferrer"},"Guide to Projections and Read Models in Event-Driven Architecture"),a(".")],-1)),o(" TODO: /event-driven.io/projections-and-read-models-in-event-driven-architecture.md "),n[21]||(n[21]=s("p",null,"Some event stores, like EventStoreDB, separate the event storage and read model storage. That allows its creators to focus on making one thing right. Still, in many cases, it’s more than enough to just use PostgreSQL. That’s what the Emmett and Pongo combination does pretty well!",-1)),n[22]||(n[22]=s("hr",null,null,-1)),n[23]||(n[23]=s("h2",{id:"single-stream-projections-with-pongo",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#single-stream-projections-with-pongo"},[s("span",null,"Single Stream Projections with Pongo")])],-1)),n[24]||(n[24]=s("p",null,"Let’s install Emmett PostgreSQL package:",-1)),t(h,{data:[{id:'<VPIcon icon="fa-brands fa-yarn"/>'},{id:'<VPIcon icon="fa-brands fa-npm"/>'}],active:0,"tab-id":"sh"},{title0:e(({value:c,isActive:u})=>[t(p,{icon:"fa-brands fa-yarn"})]),title1:e(({value:c,isActive:u})=>[t(p,{icon:"fa-brands fa-npm"})]),tab0:e(({value:c,isActive:u})=>[...n[9]||(n[9]=[s("div",{class:"language-bash line-numbers-mode","data-highlighter":"prismjs","data-ext":"sh"},[s("pre",null,[s("code",{class:"language-bash"},[s("span",{class:"line"},[s("span",{class:"token function"},"yarn"),a(),s("span",{class:"token function"},"add"),a(" @event-driven-io/emmett-postgresql")]),a(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"})])],-1)])]),tab1:e(({value:c,isActive:u})=>[...n[10]||(n[10]=[s("div",{class:"language-bash line-numbers-mode","data-highlighter":"prismjs","data-ext":"sh"},[s("pre",null,[s("code",{class:"language-bash"},[s("span",{class:"line"},[s("span",{class:"token function"},"npm"),a(" i @event-driven-io/emmett-postgresql")]),a(`
`),s("span",{class:"line"})])]),s("div",{class:"line-numbers","aria-hidden":"true",style:{"counter-reset":"line-number 0"}},[s("div",{class:"line-number"})])],-1)])]),_:1}),n[25]||(n[25]=l(`<p>Behind the scenes, it’ll also install Emmett and Pongo as peer dependencies, so you don’t need to install them separately.</p><p>Now we’ll define a simplified Shopping Cart flow, expressing it by the events that can happen:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">type</span> <span class="token class-name">Event</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@event-driven-io/emmett&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> <span class="token class-name">ProductItemAdded</span> <span class="token operator">=</span> Event<span class="token operator">&lt;</span></span>
<span class="line">  <span class="token string">&#39;ProductItemAdded&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span> productItem<span class="token operator">:</span> PricedProductItem<span class="token punctuation">;</span> addedAt<span class="token operator">:</span> Date <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">&gt;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> <span class="token class-name">ProductItemRemoved</span> <span class="token operator">=</span> Event<span class="token operator">&lt;</span></span>
<span class="line">  <span class="token string">&#39;ProductItemAdded&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span> productItem<span class="token operator">:</span> PricedProductItemm<span class="token punctuation">;</span> removedAt<span class="token operator">:</span> Date <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">&gt;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> <span class="token class-name">PricedProductItem</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  productId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></span>
<span class="line">  quantity<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line">  unitPrice<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> <span class="token class-name">DiscountApplied</span> <span class="token operator">=</span> Event<span class="token operator">&lt;</span></span>
<span class="line">  <span class="token string">&#39;DiscountApplied&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span> percent<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> couponId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> discountedAt<span class="token operator">:</span> Date <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">&gt;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> <span class="token class-name">ShoppingCartConfirmed</span> <span class="token operator">=</span> Event<span class="token operator">&lt;</span></span>
<span class="line">  <span class="token string">&#39;ShoppingCartConfirmed&#39;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span> confirmedAt<span class="token operator">:</span> Date <span class="token punctuation">}</span></span>
<span class="line"><span class="token operator">&gt;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> <span class="token class-name">ShoppingCartEvent</span> <span class="token operator">=</span> </span>
<span class="line">  <span class="token operator">|</span> ProductItemAdded</span>
<span class="line">  <span class="token operator">|</span> ProductItemRemoved </span>
<span class="line">  <span class="token operator">|</span> DiscountApplied</span>
<span class="line">  <span class="token operator">|</span> ShoppingCartConfirmed<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3)),s("p",null,[n[12]||(n[12]=a("We’ll skip the business logic part; you can learn about it in detail in ",-1)),s("a",x,[t(p,{icon:"fas fa-globe"}),n[11]||(n[11]=a("Emmett’s Getting Started Guide",-1))]),n[13]||(n[13]=a(". Let’s go straight to thinking about read models.",-1))]),n[26]||(n[26]=l(`<p>Let’s say that we want to show the summary of the shopping cart, showing just the total items count and amount. This could be used, e.g., in the top menu bar, to give users quick feedback. It could be defined as:</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="ShoppingCartSummary.ts"><span>ShoppingCartSummary.ts</span></div><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">type</span> <span class="token class-name">ShoppingCartSummary</span> <span class="token operator">=</span> <span class="token punctuation">{</span></span>
<span class="line">  _id<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></span>
<span class="line">  productItemsCount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line">  totalAmount<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>Now, let’s define how we’d like to apply those events:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">const</span> evolve <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  document<span class="token operator">:</span> ShoppingCartSummary <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span> type<span class="token punctuation">,</span> data<span class="token operator">:</span> event <span class="token punctuation">}</span><span class="token operator">:</span> ProductItemAdded <span class="token operator">|</span> ProductItemRemoved <span class="token operator">|</span> DiscountApplied<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> ShoppingCartSummary <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  document <span class="token operator">=</span> document <span class="token operator">??</span> <span class="token punctuation">{</span> totalAmount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span> productItemsCount<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&#39;ProductItemAdded&#39;</span><span class="token operator">:</span> </span>
<span class="line">      <span class="token keyword">return</span> <span class="token function">withAdjustedTotals</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        document<span class="token punctuation">,</span></span>
<span class="line">        productItem<span class="token operator">:</span> event<span class="token punctuation">.</span>productItem<span class="token punctuation">,</span></span>
<span class="line">        by<span class="token operator">:</span> <span class="token string">&#39;adding&#39;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&#39;ProductItemRemoved&#39;</span><span class="token operator">:</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token function">withAdjustedTotals</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        document<span class="token punctuation">,</span></span>
<span class="line">        productItem<span class="token operator">:</span> event<span class="token punctuation">.</span>productItem<span class="token punctuation">,</span></span>
<span class="line">        by<span class="token operator">:</span> <span class="token string">&#39;removing&#39;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&#39;DiscountApplied&#39;</span><span class="token operator">:</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token operator">...</span>document<span class="token punctuation">,</span></span>
<span class="line">        totalAmount<span class="token operator">:</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>totalAmount <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> event<span class="token punctuation">.</span>percent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> withAdjustedTotals <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  options<span class="token operator">:</span> <span class="token punctuation">{</span> </span>
<span class="line">    document<span class="token operator">:</span> ShoppingCartSummary<span class="token punctuation">;</span> </span>
<span class="line">    productItem<span class="token operator">:</span> PricedProductItem<span class="token punctuation">;</span> </span>
<span class="line">    by<span class="token operator">:</span> <span class="token string">&#39;adding&#39;</span> <span class="token operator">|</span> <span class="token string">&#39;removing&#39;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> document<span class="token punctuation">,</span> productItem<span class="token punctuation">,</span> by <span class="token punctuation">}</span> <span class="token operator">=</span> options<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">const</span> plusOrMinus <span class="token operator">=</span> by <span class="token operator">===</span> <span class="token string">&#39;adding&#39;</span> <span class="token operator">?</span> <span class="token number">1</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token operator">...</span>document<span class="token punctuation">,</span></span>
<span class="line">      totalAmount<span class="token operator">:</span></span>
<span class="line">        document<span class="token punctuation">.</span>totalAmount <span class="token operator">+</span></span>
<span class="line">        productItem<span class="token punctuation">.</span>unitPrice <span class="token operator">*</span> productItem<span class="token punctuation">.</span>quantity <span class="token operator">*</span> plusOrMinus<span class="token punctuation">,</span></span>
<span class="line">      productItemsCount<span class="token operator">:</span></span>
<span class="line">        document<span class="token punctuation">.</span>productItemsCount <span class="token operator">+</span> productItem<span class="token punctuation">.</span>quantity <span class="token operator">*</span> plusOrMinus<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span> </span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>As you see, the transformation may not need to handle all events. We don’t need to know the status (whether it’s confirmed or not); we just need information about totals.</p><p>The next step is to define our Pongo projection. We do it by:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> pongoSingleStreamProjection <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@event-driven-io/emmett-postgresql&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> collectionName <span class="token operator">=</span> <span class="token string">&#39;shopping_carts_summary&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> shoppingCartSummaryProjection <span class="token operator">=</span> <span class="token function">pongoSingleStreamProjection</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  canHandle<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;ProductItemAdded&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;ProductItemRemoved&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;DiscountApplied&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  collectionName<span class="token punctuation">,</span></span>
<span class="line">  evolve<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>By that we’re handling the specified range of events, applying it using the evolve function and storing the result in the specified Pongo collection (so the PostgreSQL table with JSONB column for document data).</p><p>If you don’t like getting a null document in the evolve function, then you can also provide the initial state:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">const</span> shoppingCartSummaryProjection <span class="token operator">=</span> <span class="token function">pongoSingleStreamProjection</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  canHandle<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;ProductItemAdded&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;ProductItemRemoved&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;DiscountApplied&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">  collectionName<span class="token punctuation">,</span></span>
<span class="line">  evolve<span class="token punctuation">,</span></span>
<span class="line">  <span class="token function-variable function">initialState</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> totalAmount<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span> productItemsCount<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Then your evolve can skip the setup step and look as follows:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">const</span> evolve <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  document<span class="token operator">:</span> ShoppingCartSummary<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span> type<span class="token punctuation">,</span> data<span class="token operator">:</span> event <span class="token punctuation">}</span><span class="token operator">:</span> ProductItemAdded <span class="token operator">|</span> ProductItemRemoved <span class="token operator">|</span> DiscountApplied<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> ShoppingCartSummary <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&#39;ProductItemAdded&#39;</span><span class="token operator">:</span> </span>
<span class="line">      <span class="token keyword">return</span> <span class="token function">withAdjustedTotals</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        document<span class="token punctuation">,</span></span>
<span class="line">        productItem<span class="token operator">:</span> event<span class="token punctuation">.</span>productItem<span class="token punctuation">,</span></span>
<span class="line">        by<span class="token operator">:</span> <span class="token string">&#39;adding&#39;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&#39;ProductItemRemoved&#39;</span><span class="token operator">:</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token function">withAdjustedTotals</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        document<span class="token punctuation">,</span></span>
<span class="line">        productItem<span class="token operator">:</span> event<span class="token punctuation">.</span>productItem<span class="token punctuation">,</span></span>
<span class="line">        by<span class="token operator">:</span> <span class="token string">&#39;removing&#39;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&#39;DiscountApplied&#39;</span><span class="token operator">:</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token operator">...</span>document<span class="token punctuation">,</span></span>
<span class="line">        totalAmount<span class="token operator">:</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>totalAmount <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> event<span class="token punctuation">.</span>percent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Emmett will provide the initial state if the document with id equal to the stream name doesn’t exist.</p><p><strong>We need to complete registration by passing it to event store options:</strong></p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> projection <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@event-driven-io/emmett&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> getPostgreSQLEventStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@event-driven-io/emmett-postgresql&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> connectionString <span class="token operator">=</span></span>
<span class="line">  <span class="token string">&quot;postgresql://dbuser:secretpassword@database.server.com:3211/mydb&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> eventStore <span class="token operator">=</span> <span class="token function">getPostgreSQLEventStore</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">  projections<span class="token operator">:</span> projections<span class="token punctuation">.</span><span class="token function">inline</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">    shoppingCartSummaryProjection<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Inline registration means that projections will update your read models in the same transaction as appending events. So, either all was stored or nothing. Of course, you need to be careful with them, as they can slow your appends, but they’re really useful. Async projections will come in future releases.</p><p>Sounds cool; now we can append a few events through regular event store append events api and query results using Pongo:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> getPostgreSQLEventStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@event-driven-io/pongo&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> connectionString <span class="token operator">=</span></span>
<span class="line">  <span class="token string">&quot;postgresql://dbuser:secretpassword@database.server.com:3211/mydb&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> pongo <span class="token operator">=</span> <span class="token function">pongoClient</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> shoppingCartsSummary <span class="token operator">=</span> pongo<span class="token punctuation">.</span><span class="token function">db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collection</span><span class="token punctuation">(</span><span class="token string">&#39;shopping_carts_summary&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> summary <span class="token operator">=</span> <span class="token keyword">await</span> shoppingCartsSummary<span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{</span> _id <span class="token operator">:</span> <span class="token string">&#39;shopping_cart-123&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Cool, but manually querying data isn’t the best long-term solution. Wouldn’t it be possible to test it automatically? Yes, it would.</p><p><strong>That’s why Emmett gives you a built-in way to test projections.</strong></p><hr><h2 id="testing-projections" tabindex="-1"><a class="header-anchor" href="#testing-projections"><span>Testing projections</span></a></h2><p>In the same way as testing other parts of your development flow (read more in <a href="/en/testing_event_sourcing_emmett_edition/" target="_blank" rel="noopener noreferrer">Testing Event Sourcing, Emmett edition</a>).</p>`,23)),o(" TODO: /event-driven.io/testing-event-sourcing-emmett-edition.md "),n[27]||(n[27]=l(`<p>Before we start, let’s install PostgreSQL Test Containers. We’ll need them soon:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">npm</span> <span class="token function">add</span> @testcontainers/postgresql</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>As I described in <a href="/en/testing_event_driven_projections/" target="_blank" rel="noopener noreferrer">How to test event-driven projections</a>, projection tests should be tested against the real database. Both querying and update capabilities and serialisation can play tricks, so it is better to be certain that it really works. Tests that don’t give us such assurance are useless. And we don’t want them to be such.</p>`,3)),o(" TODO: /event-driven.io/testing-event-driven-projections.md "),n[28]||(n[28]=l(`<p>Now, let’s start with the setup:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> PostgreSQLProjectionSpec <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@event-driven-io/emmett-postgresql&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> </span>
<span class="line">  PostgreSqlContainer<span class="token punctuation">,</span></span>
<span class="line">  StartedPostgreSqlContainer<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@testcontainers/postgresql&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> after<span class="token punctuation">,</span> before<span class="token punctuation">,</span> beforeEach<span class="token punctuation">,</span> describe<span class="token punctuation">,</span> it <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;node:test&#39;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> v4 <span class="token keyword">as</span> uuid <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;uuid&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;Shopping carts summary&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> postgres<span class="token operator">:</span> StartedPostgreSqlContainer<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> connectionString<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> given<span class="token operator">:</span> PostgreSQLProjectionSpec<span class="token operator">&lt;</span>ProductItemAdded <span class="token operator">|</span> ProductItemRemoved <span class="token operator">|</span> DiscountApplied<span class="token operator">&gt;</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">let</span> shoppingCartId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">before</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    postgres <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">PostgreSqlContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    connectionString <span class="token operator">=</span> postgres<span class="token punctuation">.</span><span class="token function">getConnectionUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    given <span class="token operator">=</span> PostgreSQLProjectionSpec<span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      projection<span class="token operator">:</span> shoppingCartShortInfoProjection<span class="token punctuation">,</span></span>
<span class="line">      connectionString<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>shoppingCartId <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">shoppingCart-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span><span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We’re setting up the PostgreSQL test container and projection specification. We’ll use it to run our tests. The first one could look as follows:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> expectPongoDocuments <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@event-driven-io/emmett-postgresql&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;Shopping carts summary&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// (...) test setup</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">void</span> <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;first added product creates document&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span>
<span class="line">    <span class="token function">given</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span><span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          type<span class="token operator">:</span> <span class="token string">&#39;ProductItemAdded&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          data<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            productItem<span class="token operator">:</span> <span class="token punctuation">{</span> unitPrice<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> productId<span class="token operator">:</span> <span class="token string">&#39;shoes&#39;</span><span class="token punctuation">,</span> quantity<span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          metadata<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            streamName<span class="token operator">:</span> shoppingCartId<span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span></span>
<span class="line">        expectPongoDocuments</span>
<span class="line">          <span class="token punctuation">.</span><span class="token generic-function"><span class="token function">fromCollection</span><span class="token generic class-name"><span class="token operator">&lt;</span>ShoppingCartSummary<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">&#39;shopping_carts_summary&#39;</span><span class="token punctuation">)</span></span>
<span class="line">          <span class="token punctuation">.</span><span class="token function">withId</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">)</span></span>
<span class="line">          <span class="token punctuation">.</span><span class="token function">toBeEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            productItemsCount<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">            totalAmount<span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span></span>
<span class="line">            appliedDiscounts<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Tests are written in <a href="/en/behaviour_driven_design_is_not_about_tests/" target="_blank" rel="noopener noreferrer">Behaviour-Driven Design</a> style, using Given/When/Then:</p>`,5)),o(" TODO: /event-driven.io/behaviour-driven-design-is-not-about-tests.md "),n[29]||(n[29]=l(`<ul><li><strong>Given</strong> existing stream of events,</li><li><strong>When</strong> new events are added,</li><li><strong>Then</strong> read model is updated.</li></ul><p>We do it this way, as we expect read models to be ONLY updated through upcoming events.</p><p>Emmett gives you also out-of-the-box test assertion helpers to make testing Pongo easier.</p><p>You may have noticed that our Given is empty, so let’s fix it!</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span></span>
<span class="line">  eventsInStream<span class="token punctuation">,</span></span>
<span class="line">  newEventsInStream<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;@event-driven-io/emmett-postgresql&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;Shopping carts summary&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// (...) test setup</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">void</span> <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;applies discount for existing shopping cart with product&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> couponId <span class="token operator">=</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">given</span><span class="token punctuation">(</span></span>
<span class="line">      <span class="token function">eventsInStream</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">,</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          type<span class="token operator">:</span> <span class="token string">&#39;ProductItemAdded&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          data<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            productItem<span class="token operator">:</span> <span class="token punctuation">{</span> unitPrice<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> productId<span class="token operator">:</span> <span class="token string">&#39;shoes&#39;</span><span class="token punctuation">,</span> quantity<span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token function">newEventsInStream</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">,</span> <span class="token punctuation">[</span></span>
<span class="line">          <span class="token punctuation">{</span></span>
<span class="line">            type<span class="token operator">:</span> <span class="token string">&#39;DiscountApplied&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            data<span class="token operator">:</span> <span class="token punctuation">{</span> percent<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> couponId <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span></span>
<span class="line">        expectPongoDocuments</span>
<span class="line">          <span class="token punctuation">.</span><span class="token generic-function"><span class="token function">fromCollection</span><span class="token generic class-name"><span class="token operator">&lt;</span>ShoppingCartShortInfo<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span></span>
<span class="line">            shoppingCartShortInfoCollectionName<span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">)</span></span>
<span class="line">          <span class="token punctuation">.</span><span class="token function">withId</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">)</span></span>
<span class="line">          <span class="token punctuation">.</span><span class="token function">toBeEqual</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">            productItemsCount<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">            totalAmount<span class="token operator">:</span> <span class="token number">9000</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You probably noticed the next helpers: _eventsInStream_and <em>newEventsInStream</em>. They’re responsible for shortening the setup. Depending on your preferences, you can use the raw events setup, including manual metadata assignment, or a more explicit intention helper. My preference would be to use the helper, but it’s up to you to decide!</p><p>You could even write tests like this:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">void</span> <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;Shopping carts summary&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// (...) test setup</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">void</span> <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;applies discount for existing shopping cart with product&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> </span>
<span class="line">    <span class="token function">given</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token function">shoppingCartWithProductItem</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">          unitPrice<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> </span>
<span class="line">          quantity<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token function">discountApplied</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">          percent<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token function">summaryUpdated</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">,</span> <span class="token punctuation">{</span></span>
<span class="line">          productItemsCount<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">          totalAmount<span class="token operator">:</span> <span class="token number">9000</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The setup methods are defined below:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">void</span> <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;Shopping carts summary&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// (...) test</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">shoppingCartWithProductItem</span> <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">      shoppingCartId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> </span>
<span class="line">      productItem<span class="token operator">:</span> Partial<span class="token operator">&lt;</span>PricedProductItem<span class="token operator">&gt;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> </span>
<span class="line">    <span class="token function">eventsInStream</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">,</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        type<span class="token operator">:</span> <span class="token string">&#39;ProductItemAdded&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        data<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          productItem<span class="token operator">:</span> <span class="token punctuation">{</span> </span>
<span class="line">            unitPrice<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> </span>
<span class="line">            productId<span class="token operator">:</span> <span class="token string">&#39;shoes&#39;</span><span class="token punctuation">,</span> </span>
<span class="line">            quantity<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token operator">...</span>productItem</span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">discountApplied</span> <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">    shoppingCartId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> </span>
<span class="line">    data<span class="token operator">:</span> <span class="token punctuation">{</span> discount<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> couponId<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> </span>
<span class="line">    <span class="token function">newEventsInStream</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">,</span> <span class="token punctuation">[</span></span>
<span class="line">      <span class="token punctuation">{</span></span>
<span class="line">        type<span class="token operator">:</span> <span class="token string">&#39;DiscountApplied&#39;</span><span class="token punctuation">,</span></span>
<span class="line">        data<span class="token operator">:</span> <span class="token punctuation">{</span> percent<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> couponId<span class="token operator">:</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">...</span>data <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">const</span> <span class="token function-variable function">summaryUpdated</span> <span class="token operator">=</span> <span class="token punctuation">(</span>shoppingCartId<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> expected<span class="token operator">:</span> ShoppingCartSummary<span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span>
<span class="line">    expectPongoDocuments</span>
<span class="line">      <span class="token punctuation">.</span><span class="token generic-function"><span class="token function">fromCollection</span><span class="token generic class-name"><span class="token operator">&lt;</span>ShoppingCartShortInfo<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span></span>
<span class="line">        shoppingCartShortInfoCollectionName<span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">withId</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">toBeEqual</span><span class="token punctuation">(</span>expected<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     </span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>That approach is more focused on the business flow and allows us to reuse those test setups. Still, the outcome is the same.</p><p><strong>Can read model data be only updated? Not only that, you can also delete it.</strong> Let’s imagine that the confirming cart should clear its read model, as we expect a new, empty shopping cart to be created when the new buying process starts.</p><p>To have that, we need to update our evolve function by adding <em>ShopingCartConfirmed</em> event:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">const</span> evolve <span class="token operator">=</span> <span class="token punctuation">(</span></span>
<span class="line">  document<span class="token operator">:</span> ShoppingCartSummary<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span> type<span class="token punctuation">,</span> data<span class="token operator">:</span> event <span class="token punctuation">}</span><span class="token operator">:</span> ShoppingCartEvent<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token operator">:</span> ShoppingCartSummary <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token comment">// &lt;= see here</span></span>
<span class="line">  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&#39;ProductItemAdded&#39;</span><span class="token operator">:</span> </span>
<span class="line">      <span class="token keyword">return</span> <span class="token function">withAdjustedTotals</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        document<span class="token punctuation">,</span></span>
<span class="line">        productItem<span class="token operator">:</span> event<span class="token punctuation">.</span>productItem<span class="token punctuation">,</span></span>
<span class="line">        by<span class="token operator">:</span> <span class="token string">&#39;adding&#39;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&#39;ProductItemRemoved&#39;</span><span class="token operator">:</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token function">withAdjustedTotals</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        document<span class="token punctuation">,</span></span>
<span class="line">        productItem<span class="token operator">:</span> event<span class="token punctuation">.</span>productItem<span class="token punctuation">,</span></span>
<span class="line">        by<span class="token operator">:</span> <span class="token string">&#39;removing&#39;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&#39;DiscountApplied&#39;</span><span class="token operator">:</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token operator">...</span>document<span class="token punctuation">,</span></span>
<span class="line">        totalAmount<span class="token operator">:</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>totalAmount <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">-</span> event<span class="token punctuation">.</span>percent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">case</span> <span class="token string">&#39;ShoppingCartConfirmed&#39;</span><span class="token operator">:</span></span>
<span class="line">      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// &lt;= and here</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We made the shopping cart confirmed event return null. That means that the document should be removed. Emmett is using the Pongo’s <em>handle</em> method internally:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">const</span> collection <span class="token operator">=</span> pongo<span class="token punctuation">.</span><span class="token function">db</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">collection</span><span class="token generic class-name"><span class="token operator">&lt;</span>Document<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>collectionName<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> event <span class="token keyword">of</span> events<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token function">getDocumentId</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>document<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">evolve</span><span class="token punctuation">(</span>document<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Pongo’s handle method loads the existing document and tries to insert, replace, or delete it depending on the function’s result. It’s a bit sneaky, but pretty useful, isn’t it?</p><p>The test checking will look as follows:</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token keyword">void</span> <span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&#39;Shopping carts summary&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> given<span class="token operator">:</span> PostgreSQLProjectionSpec<span class="token operator">&lt;</span>ShoppingCartEvent<span class="token operator">&gt;</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">// (...) test setup</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">void</span> <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&#39;confirmed event removes read mode for shopping cart with applied discount&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> couponId <span class="token operator">=</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">given</span><span class="token punctuation">(</span></span>
<span class="line">      <span class="token function">eventsInStream</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">,</span> <span class="token punctuation">[</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          type<span class="token operator">:</span> <span class="token string">&#39;ProductItemAdded&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          data<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            productItem<span class="token operator">:</span> <span class="token punctuation">{</span> unitPrice<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span> productId<span class="token operator">:</span> <span class="token string">&#39;shoes&#39;</span><span class="token punctuation">,</span> quantity<span class="token operator">:</span> <span class="token number">100</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">          type<span class="token operator">:</span> <span class="token string">&#39;DiscountApplied&#39;</span><span class="token punctuation">,</span></span>
<span class="line">          data<span class="token operator">:</span> <span class="token punctuation">{</span> percent<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> couponId <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">when</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token function">newEventsInStream</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">,</span> <span class="token punctuation">[</span></span>
<span class="line">          <span class="token punctuation">{</span></span>
<span class="line">            type<span class="token operator">:</span> <span class="token string">&#39;ShoppingCartConfirmed&#39;</span><span class="token punctuation">,</span></span>
<span class="line">            data<span class="token operator">:</span> <span class="token punctuation">{</span> confirmedAt<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span></span>
<span class="line">        expectPongoDocuments</span>
<span class="line">          <span class="token punctuation">.</span><span class="token generic-function"><span class="token function">fromCollection</span><span class="token generic class-name"><span class="token operator">&lt;</span>ShoppingCartShortInfo<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span></span>
<span class="line">            shoppingCartShortInfoCollectionName<span class="token punctuation">,</span></span>
<span class="line">          <span class="token punctuation">)</span></span>
<span class="line">          <span class="token punctuation">.</span><span class="token function">withId</span><span class="token punctuation">(</span>shoppingCartId<span class="token punctuation">)</span>          </span>
<span class="line">          <span class="token punctuation">.</span><span class="token function">notToExist</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// &lt;= see this</span></span>
<span class="line">      <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The pattern looks the same, but the assertion is different.</p><p><strong>I hope that this article shows you how powerful the combination of Emmett, Pongo, and PostgreSQL is.</strong> I also wanted to show you that I intend to give you certainty and trust in the software you’re building. Having built-in support for tests should help you with that.</p>`,21)),s("p",null,[n[15]||(n[15]=a("Go ahead, play with it, check it, and drop me a line. ",-1)),s("a",T,[t(p,{icon:"fa-brands fa-discord"}),n[14]||(n[14]=a("Joining our Discord",-1))]),n[16]||(n[16]=a(" is an excellent way to do this.",-1))]),n[30]||(n[30]=s("p",null,"Cheers!",-1)),n[31]||(n[31]=s("p",null,"Oskar",-1)),o(" TODO: add ARTICLE CARD "),t(r,k(v({title:"Writing and testing event-driven projections with Emmett, Pongo and PostgreSQL",desc:"Event-Driven by Oskar Dudycz",link:"https://chanhi2000.github.io/bookshelf/event-driven.io/emmett_projections_testing.html",logo:"https://realpython.com/static/favicon.68cbf4197b0c.png",background:"rgba(255,255,0,0.2)"})),null,16)])}const O=y(S,[["render",E]]),L=JSON.parse('{"path":"/event-driven.io/projections-and-event-metadata.html","title":"Using event metadata in event-driven projections","lang":"en-US","frontmatter":{"lang":"en-US","title":"Using event metadata in event-driven projections","description":"Article(s) > Using event metadata in event-driven projections","icon":"iconfont icon-typescript","category":["TypeScript","Article(s)"],"tag":["blog","event-driven.io","ts","typescript"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Using event metadata in event-driven projections\\",\\"image\\":[\\"https://event-driven.io/static/d3b3f36478db62c37631cf815bf85de9/2a4de/2024-08-25-cover.png\\"],\\"datePublished\\":\\"2024-08-25T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Oskar Dudycz\\",\\"url\\":\\"https://event-driven.io/en/about/\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/event-driven.io/projections-and-event-metadata.html"}],["meta",{"property":"og:site_name","content":"📚Bookshelf"}],["meta",{"property":"og:title","content":"Using event metadata in event-driven projections"}],["meta",{"property":"og:description","content":"Article(s) > Using event metadata in event-driven projections"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://event-driven.io/static/d3b3f36478db62c37631cf815bf85de9/2a4de/2024-08-25-cover.png"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://event-driven.io/static/d3b3f36478db62c37631cf815bf85de9/2a4de/2024-08-25-cover.png"}],["meta",{"name":"twitter:image:alt","content":"Using event metadata in event-driven projections"}],["meta",{"property":"article:author","content":"Oskar Dudycz"}],["meta",{"property":"article:tag","content":"typescript"}],["meta",{"property":"article:tag","content":"ts"}],["meta",{"property":"article:tag","content":"event-driven.io"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2024-08-25T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Using event metadata in event-driven projections"},{"property":"og:description","content":"Using event metadata in event-driven projections"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/event-driven.io/projections-and-event-metadata.html"}]],"prev":"/programming/ts/articles/README.md","date":"2024-08-25T00:00:00.000Z","isOriginal":false,"author":[{"name":"Oskar Dudycz","url":"https://event-driven.io/en/about/"}],"cover":"https://event-driven.io/static/d3b3f36478db62c37631cf815bf85de9/2a4de/2024-08-25-cover.png"},"git":{},"readingTime":{"minutes":7.34,"words":2202},"filePathRelative":"event-driven.io/projections-and-event-metadata.md","copyright":{"author":"Oskar Dudycz"}}');export{O as comp,L as data};
