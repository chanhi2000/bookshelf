import{_ as r}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as u,d as s,f as e,b as d,t as m,n as k,g as h,w as t,r as p,o as g,e as o}from"./app-BItykJLQ.js";const v={},y={id:"frontmatter-title-á„€á…ªá†«á„…á…§á†«",tabindex:"-1"},w={class:"header-anchor",href:"#frontmatter-title-á„€á…ªá†«á„…á…§á†«"},b={class:"table-of-contents"};function f(i,n){const l=p("VPCard"),a=p("router-link"),c=p("SiteInfo");return g(),u("div",null,[s("h1",y,[s("a",w,[s("span",null,m(i.$frontmatter.title)+" ê´€ë ¨",1)])]),e(l,k(h({title:"C# > Article(s)",desc:"Article(s)",link:"/programming/cs/articles/README.md",logo:"https://chanhi2000.github.io/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",b,[s("ul",null,[s("li",null,[e(a,{to:"#how-to-create-compiled-queries"},{default:t(()=>[...n[0]||(n[0]=[o("How To Create Compiled Queries",-1)])]),_:1})]),s("li",null,[e(a,{to:"#why-are-compiled-queries-faster"},{default:t(()=>[...n[1]||(n[1]=[o("Why Are Compiled Queries Faster?",-1)])]),_:1})]),s("li",null,[e(a,{to:"#can-we-make-compiled-queries-asynchronous"},{default:t(()=>[...n[2]||(n[2]=[o("Can We Make Compiled Queries Asynchronous?",-1)])]),_:1})]),s("li",null,[e(a,{to:"#compiled-queries-aren-t-a-silver-bullet"},{default:t(()=>[...n[3]||(n[3]=[o("Compiled Queries Aren't a Silver Bullet",-1)])]),_:1})])])]),n[4]||(n[4]=s("hr",null,null,-1)),e(c,{name:"Unleash EF Core Performance With Compiled Queries",desc:"In this week's newsletter I want to introduce you to an interesting feature in EF Core called Compiled Queries. If you have queries that you execute frequently in your application with a different set of parameters, it can be helpful to explicitly compile the query and reuse it throughout the lifetime of your application. Compiled Queries are more performant than standard EF queries, because they can take advantage of some additional optimizations. Let me show you how to use Compiled Queries, and how much performance improvement to expect.",url:"https://milanjovanovic.tech/blog/unleash-ef-core-performance-with-compiled-queries/",logo:"https://milanjovanovic.tech/profile_favicon.png",preview:"https://milanjovanovic.tech/blog-covers/mnw_020.png"}),n[5]||(n[5]=d(`<p>In this week&#39;s newsletter I want to introduce you to an interesting feature in <strong>EF Core</strong> called <strong>Compiled Queries</strong>.</p><p>If you have queries that you execute frequently in your application with a different set of parameters, it can be helpful to explicitly compile the query and reuse it throughout the lifetime of your application.</p><p><strong>Compiled Queries</strong> are more performant than standard EF queries, because they can take advantage of some additional optimizations.</p><p>Let me show you how to use <strong>Compiled Queries</strong>, and how much performance improvement to expect!</p><hr><h2 id="how-to-create-compiled-queries" tabindex="-1"><a class="header-anchor" href="#how-to-create-compiled-queries"><span>How To Create Compiled Queries</span></a></h2><p>Lets define a simple class that will represent out data model that we will use for writing <strong>EF</strong> queries:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Newsletter</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Title <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> ReadTimeInMinutes <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>How would we write a simple query to fetch a <code>Newsletter</code> by the <code>Id</code>? I think you can do this in your sleep.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> dbContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AppDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name"><span class="token keyword">var</span></span> newsletter <span class="token operator">=</span> dbContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Newsletter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>n <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>Id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, how do we convert this query into a <strong>Complied Query</strong>?</p><p>There are a few steps involved:</p><ul><li>Create a <strong>Compiled Query</strong> by calling <code>EF.CompileQuery</code></li><li>Store the <strong>Compiled Query</strong> in a static field, so that it can be reused</li><li>Execute the database query using the <strong>Compiled Query</strong></li></ul><p>You can define the <strong>Compiled Query</strong> in a static field inside of the <code>AppDbContext</code>. And then expose a method that will accept an argument, and pass it to the <strong>Compiled Query</strong> to invoke it.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppDbContext</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>AppDbContext<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">,</span> Newsletter<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> GetNewsletter <span class="token operator">=</span></span>
<span class="line">        EF<span class="token punctuation">.</span><span class="token function">CompileQuery</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token punctuation">(</span>dbContext<span class="token punctuation">,</span> id<span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span>
<span class="line">                dbContext<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Newsletter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>n <span class="token operator">=&gt;</span> n<span class="token punctuation">.</span>Id <span class="token operator">==</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name">Newsletter<span class="token punctuation">?</span></span> <span class="token function">GetNewsletter</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">long</span></span> id<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">GetNewsletter</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This is how we would call the method which invokes the <strong>Compiled Query</strong>:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> dbContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">AppDbContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name"><span class="token keyword">var</span></span> newsletter <span class="token operator">=</span> dbContext<span class="token punctuation">.</span><span class="token function">GetNewsletter</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>I ran some benchmarks, with the following setup:</p><ul><li><strong>EF Core 7</strong></li><li><strong>SQL Server 2022</strong></li><li>Table with 10,000 records</li></ul><p>The <strong>Compiled Query</strong> was consistently around <strong>10% faster</strong>.</p><p>I also tried running a no-tracking query by calling <code>AsNoTracking()</code> and observed similar results.</p><hr><h2 id="why-are-compiled-queries-faster" tabindex="-1"><a class="header-anchor" href="#why-are-compiled-queries-faster"><span>Why Are Compiled Queries Faster?</span></a></h2><p>So we can conclude that <strong>Compiled Queries</strong> are faster. But why is that?</p><p>Let&#39;s examine what happens when we execute an <strong>EF</strong> LINQ query. Before <strong>EF</strong> can convert the query into valid SQL that can be executed in the database, it needs to compile the query. The compiled query is cached and <strong>EF</strong> will be able to reuse that cached query. In some situations the query needs to be recompiled, introducing additional performance costs.</p><p>When we explicitly compile the query by calling <code>EF.CompileQuery</code>, we can utilize some optimization techniques that aren&#39;t available at runtime.</p><p>Note that <strong>Compiled Queries</strong> only improve the performance of the in-memory portion of executing an EF query. The round trip time and materializing results from the database remain unaffected.</p><hr><h2 id="can-we-make-compiled-queries-asynchronous" tabindex="-1"><a class="header-anchor" href="#can-we-make-compiled-queries-asynchronous"><span>Can We Make Compiled Queries Asynchronous?</span></a></h2><p>I showed you how to write a synchronous <strong>Compiled Query</strong>. But due to performance considerations we almost always want to execute database queries asynchronously.</p><p>Here&#39;s how we can create an asynchronous <strong>Compiled Query</strong>:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">using</span> <span class="token namespace">Microsoft<span class="token punctuation">.</span>EntityFrameworkCore</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppDbContext</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Func<span class="token punctuation">&lt;</span>AppDbContext<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">,</span> Task<span class="token punctuation">&lt;</span>Newsletter<span class="token punctuation">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> GetByTitle <span class="token operator">=</span></span>
<span class="line">        EF<span class="token punctuation">.</span><span class="token function">CompileAsyncQuery</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token punctuation">(</span><span class="token class-name">AppDbContext</span> context<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> title<span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span>
<span class="line">                context<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Set</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Newsletter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>Title <span class="token operator">==</span> title<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>Newsletter<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">GetNewsletterByTitleAsync</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> title<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">GetByTitle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>It&#39;s interesting that we aren&#39;t writing an asynchronous query in the expression passed to <code>EF.CompileAsyncQuery</code>. It will be converted to an asynchronous query during compilation.</p><hr><h2 id="compiled-queries-aren-t-a-silver-bullet" tabindex="-1"><a class="header-anchor" href="#compiled-queries-aren-t-a-silver-bullet"><span>Compiled Queries Aren&#39;t a Silver Bullet</span></a></h2><p>You might be tempted to go and convert all of your <strong>EF</strong> queries into <strong>Compiled Queries</strong>, to squeeze out that last little bit of performance. I urge you not do it. <strong>Compiled Queries</strong> are a useful tool, but they aren&#39;t the solution to all your problems.</p><p>Instead, I think we should use <strong>Compiled Queries</strong> sparingly, only in situations where we really need to do these kinds of micro-optimizations.</p><p>Although <strong>Compiled Queries</strong> seem great, we can&#39;t deny they increase the complexity of our code considerably. If you think the slight performance improvement gained from using <strong>Compiled Queries</strong> justifies the increase in complexity, then by all means, you should use them. Otherwise, I would look for other ways to improve performance.</p>`,38))])}const x=r(v,[["render",f]]),q=JSON.parse('{"path":"/milanjovanovic.tech/unleash-ef-core-performance-with-compiled-queries.html","title":"Unleash EF Core Performance With Compiled Queries","lang":"ko-KR","frontmatter":{"lang":"ko-KR","title":"Unleash EF Core Performance With Compiled Queries","description":"Article(s) > Unleash EF Core Performance With Compiled Queries","icon":"iconfont icon-csharp","category":["C#","DotNet","Article(s)"],"tag":["blog","milanjovanovic.tech","cs","c#","csharp","dotnet"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Unleash EF Core Performance With Compiled Queries\\",\\"image\\":[\\"https://milanjovanovic.tech/blog-covers/mnw_020.png\\"],\\"datePublished\\":\\"2023-01-14T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Milan JovanoviÄ‡\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/unleash-ef-core-performance-with-compiled-queries.html"}],["meta",{"property":"og:site_name","content":"ðŸ“šBookshelf"}],["meta",{"property":"og:title","content":"Unleash EF Core Performance With Compiled Queries"}],["meta",{"property":"og:description","content":"Article(s) > Unleash EF Core Performance With Compiled Queries"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://milanjovanovic.tech/blog-covers/mnw_020.png"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://milanjovanovic.tech/blog-covers/mnw_020.png"}],["meta",{"name":"twitter:image:alt","content":"Unleash EF Core Performance With Compiled Queries"}],["meta",{"property":"article:author","content":"Milan JovanoviÄ‡"}],["meta",{"property":"article:tag","content":"dotnet"}],["meta",{"property":"article:tag","content":"csharp"}],["meta",{"property":"article:tag","content":"c#"}],["meta",{"property":"article:tag","content":"cs"}],["meta",{"property":"article:tag","content":"milanjovanovic.tech"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2023-01-14T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Unleash EF Core Performance With Compiled Queries"},{"property":"og:description","content":"Unleash EF Core Performance With Compiled Queries"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/unleash-ef-core-performance-with-compiled-queries.html"}]],"prev":"/programming/cs/articles/README.md","date":"2023-01-14T00:00:00.000Z","isOriginal":false,"author":"Milan JovanoviÄ‡","cover":"https://milanjovanovic.tech/blog-covers/mnw_020.png"},"git":{},"readingTime":{"minutes":3.14,"words":943},"filePathRelative":"milanjovanovic.tech/unleash-ef-core-performance-with-compiled-queries.md","copyright":{"author":"Milan JovanoviÄ‡"}}');export{x as comp,q as data};
