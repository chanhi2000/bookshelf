import{_ as r}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as u,d as s,f as e,b as d,t as m,n as g,g as h,w as t,r as p,o as k,e as o}from"./app-BVguHYKu.js";const v={},y={id:"frontmatter-title-관련",tabindex:"-1"},b={class:"header-anchor",href:"#frontmatter-title-관련"},w={class:"table-of-contents"};function f(i,n){const l=p("VPCard"),a=p("router-link"),c=p("SiteInfo");return k(),u("div",null,[s("h1",y,[s("a",b,[s("span",null,m(i.$frontmatter.title)+" 관련",1)])]),e(l,g(h({title:"C# > Article(s)",desc:"Article(s)",link:"/programming/cs/articles/README.md",logo:"https://chanhi2000.github.io/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",w,[s("ul",null,[s("li",null,[e(a,{to:"#how-the-idempotent-consumer-pattern-works"},{default:t(()=>n[0]||(n[0]=[o("How The Idempotent Consumer Pattern Works")])),_:1,__:[0]})]),s("li",null,[e(a,{to:"#lazy-idempotent-consumer"},{default:t(()=>n[1]||(n[1]=[o("Lazy Idempotent Consumer")])),_:1,__:[1]})]),s("li",null,[e(a,{to:"#eager-idempotent-consumer"},{default:t(()=>n[2]||(n[2]=[o("Eager Idempotent Consumer")])),_:1,__:[2]})]),s("li",null,[e(a,{to:"#in-summary"},{default:t(()=>n[3]||(n[3]=[o("In Summary")])),_:1,__:[3]})])])]),n[4]||(n[4]=s("hr",null,null,-1)),e(c,{name:"Idempotent Consumer - Handling Duplicate Messages",desc:"What happens when a message is retried in an event-driven system? It happens more often than you think. The worst case scenario is that the message is processed twice, and the side effects can also be applied more than once. Do you want your bank account to be double charged? I'll assume the answer is no, of course. You can use the Idempotent Consumer pattern to solve this problem.",url:"https://milanjovanovic.tech/blog/idempotent-consumer-handling-duplicate-messages/",logo:"https://milanjovanovic.tech/profile_favicon.png",preview:"https://milanjovanovic.tech/blog-covers/mnw_034.png"}),n[5]||(n[5]=d(` What happens when a **message is retried** in an event-driven system? <p>It happens more often than you think.</p><p>The <strong>worst case scenario</strong> is that the <strong>message is processed twice</strong>, and the <strong>side effects</strong> can also be applied more than once.</p><p>Do you want your bank account to be double charged?</p><p>I&#39;ll assume the answer is no, of course.</p><p>You can use the <strong>Idempotent Consumer</strong> pattern to solve this problem.</p><p>In this week&#39;s issue I will show you:</p><ul><li>How the Idempotent Consumer pattern works</li><li>How to implement an Idempotent Consumer</li><li>The tradeoffs you need to consider</li></ul><p>Let&#39;s see why the <strong>Idempotent Consumer</strong> pattern is valuable.</p><hr><h2 id="how-the-idempotent-consumer-pattern-works" tabindex="-1"><a class="header-anchor" href="#how-the-idempotent-consumer-pattern-works"><span>How The Idempotent Consumer Pattern Works</span></a></h2><p>What&#39;s the idea behind the <strong>Idempotent Consumer pattern</strong>?</p><blockquote><p>An idempotent operation is one that has no additional effect if it is called more than once with the same input parameters.</p></blockquote><p>We want to avoid handling the same message more than once.</p><p>This would require <strong>Exactly-once</strong> message delivery guarantees from our messaging system. And this is a really hard problem to solve in distributed systems.</p><p>A looser delivery guarantee is <strong>At-least-once</strong>, where we are aware that retries can happen and we can receive the same message more than once.</p><p>The <strong>Idempotent Consumer</strong> pattern works well with <strong>At-least-once</strong> message delivery, and solves the <strong>problem of duplicate messages.</strong></p><p>Here&#39;s what the algorithm looks like from the moment we receive a message:</p><ol><li>Was the message already processed?</li><li>If yes, it&#39;s a duplicate and there&#39;s nothing to do</li><li>If not, we need to handle the message</li><li>We also need to store the message identifier</li></ol><figure><img src="https://milanjovanovic.tech/blogs/mnw_034/idempotent_consumer_algorithm.png?imwidth=828" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>We need a <strong>unique identifier</strong> for every <strong>message</strong> we receive, and a table in the database to store processed messages.</p><p>However, it&#39;s interesting how we choose the implement the message handling and storing of the processed message identifier.</p><p>You can implement the idempotent consumer as a decorator around a regular message handler.</p><p>I&#39;ll show you two implementations:</p><ul><li>Lazy idempotent consumer</li><li>Eager idempotent consumer</li></ul><hr><h2 id="lazy-idempotent-consumer" tabindex="-1"><a class="header-anchor" href="#lazy-idempotent-consumer"><span>Lazy Idempotent Consumer</span></a></h2><p>The <strong>lazy idempotent consumer</strong> matches the flow shown in the algorithm above.</p><p>Lazy refers to how we store the message identifer to mark it as processed.</p><p>In the happy path, we handle the message and store the message identifier.</p><p>If the message handler throws an exception, we never store the message identifier and the consumer can be executed again.</p><p>Here&#39;s what the implementation looks like:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentConsumer<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span></span>
<span class="line">    <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IMessage</span></span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IMessageRepository</span> _messageRepository<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> _decorated<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">IdempotentConsumer</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token class-name">IMessageRepository</span> messageRepository<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> decorated<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        _messageRepository <span class="token operator">=</span> messageRepository<span class="token punctuation">;</span></span>
<span class="line">        _decorated <span class="token operator">=</span> decorated<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>_messageRepository<span class="token punctuation">.</span><span class="token function">IsProcessed</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">await</span> _decorated<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        _messageRepository<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="eager-idempotent-consumer" tabindex="-1"><a class="header-anchor" href="#eager-idempotent-consumer"><span>Eager Idempotent Consumer</span></a></h2><p>The <strong>eager idempotent consumer</strong> is slightly different from the lazy implementation, but the end result is the same.</p><p>In this version, we eagerly store the message identifier in the database and then continue to handle the message.</p><p>If the handler throws an exception, we need to perform cleanup in the database and remove the eagerly stored message identifier.</p><p>Otherwise, we risk leaving the system in an inconsistent state since the message was never handled correctly.</p><p>Here&#39;s what the implementation looks like:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentConsumer<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span></span>
<span class="line">    <span class="token keyword">where</span> <span class="token class-name">T</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IMessage</span></span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IMessageRepository</span> _messageRepository<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> _decorated<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">IdempotentConsumer</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token class-name">IMessageRepository</span> messageRepository<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span> decorated<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        _messageRepository <span class="token operator">=</span> messageRepository<span class="token punctuation">;</span></span>
<span class="line">        _decorated <span class="token operator">=</span> decorated<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">try</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>_messageRepository<span class="token punctuation">.</span><span class="token function">IsProcessed</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">            _messageRepository<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">await</span> _decorated<span class="token punctuation">.</span><span class="token function">Handle</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            _messageRepository<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">throw</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="in-summary" tabindex="-1"><a class="header-anchor" href="#in-summary"><span>In Summary</span></a></h2><p>Idempotency is an interesting problem to solve in a software system.</p><p>Some operations are <strong>naturally idempotent</strong>, and we don&#39;t need the overhead of the <strong>Idempotent Consumer</strong> pattern.</p><p>However, for those operations that aren&#39;t naturally idempotent, the <strong>Idempotent Consumer</strong> is a great solution.</p><p>The high-level algorithm is simple, and you can take two approaches in the implementation:</p><ul><li>Lazy storing of message identifiers</li><li>Eager storing of message identifiers</li></ul><p>I prefer to use the <strong>lazy approach</strong>, and only <strong>store the message identifier</strong> in the database when the <strong>handler completes successfully.</strong></p><p>It&#39;s easier to reason about and there is one less call to the database.</p><p>Thanks for reading.</p><p>Hope that was helpful.</p>`,52))])}const C=r(v,[["render",f]]),H=JSON.parse('{"path":"/milanjovanovic.tech/idempotent-consumer-handling-duplicate-messages.html","title":"Idempotent Consumer - Handling Duplicate Messages","lang":"ko-KR","frontmatter":{"lang":"ko-KR","title":"Idempotent Consumer - Handling Duplicate Messages","description":"Article(s) > Idempotent Consumer - Handling Duplicate Messages","icon":"iconfont icon-csharp","category":["C#","DotNet","Article(s)"],"tag":["blog","milanjovanovic.tech","cs","c#","csharp","dotnet"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Idempotent Consumer - Handling Duplicate Messages\\",\\"image\\":[\\"https://milanjovanovic.tech/blogs/mnw_034/idempotent_consumer_algorithm.png?imwidth=828\\"],\\"datePublished\\":\\"2023-04-22T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Milan Jovanović\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/idempotent-consumer-handling-duplicate-messages.html"}],["meta",{"property":"og:site_name","content":"📚Bookshelf"}],["meta",{"property":"og:title","content":"Idempotent Consumer - Handling Duplicate Messages"}],["meta",{"property":"og:description","content":"Article(s) > Idempotent Consumer - Handling Duplicate Messages"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://milanjovanovic.tech/blog-covers/mnw_034.png"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://milanjovanovic.tech/blog-covers/mnw_034.png"}],["meta",{"name":"twitter:image:alt","content":"Idempotent Consumer - Handling Duplicate Messages"}],["meta",{"property":"article:author","content":"Milan Jovanović"}],["meta",{"property":"article:tag","content":"dotnet"}],["meta",{"property":"article:tag","content":"csharp"}],["meta",{"property":"article:tag","content":"c#"}],["meta",{"property":"article:tag","content":"cs"}],["meta",{"property":"article:tag","content":"milanjovanovic.tech"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2023-04-22T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Idempotent Consumer - Handling Duplicate Messages"},{"property":"og:description","content":"Idempotent Consumer - Handling Duplicate Messages"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/idempotent-consumer-handling-duplicate-messages.html"}]],"prev":"/programming/cs/articles/README.md","date":"2023-04-22T00:00:00.000Z","isOriginal":false,"author":"Milan Jovanović","cover":"https://milanjovanovic.tech/blog-covers/mnw_034.png"},"git":{},"readingTime":{"minutes":3.02,"words":907},"filePathRelative":"milanjovanovic.tech/idempotent-consumer-handling-duplicate-messages.md","copyright":{"author":"Milan Jovanović"}}');export{C as comp,H as data};
