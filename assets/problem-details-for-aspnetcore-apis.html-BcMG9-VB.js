import{_ as v}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as b,d as s,f as e,b as l,a as h,t as g,n as u,g as d,w as t,e as a,r as p,o as f}from"./app-BItykJLQ.js";const y={},P={id:"frontmatter-title-á„€á…ªá†«á„…á…§á†«",tabindex:"-1"},w={class:"header-anchor",href:"#frontmatter-title-á„€á…ªá†«á„…á…§á†«"},x={class:"table-of-contents"},D={href:"https://rfc-editor.org/rfc/rfc9457",target:"_blank",rel:"noopener noreferrer"},A={href:"https://rfc-editor.org/rfc/rfc9457",target:"_blank",rel:"noopener noreferrer"},C={href:"https://rfc-editor.org/rfc/rfc7807",target:"_blank",rel:"noopener noreferrer"};function q(m,n){const c=p("VPCard"),o=p("router-link"),k=p("SiteInfo"),i=p("VPIcon"),r=p("RouteLink");return f(),b("div",null,[s("h1",P,[s("a",w,[s("span",null,g(m.$frontmatter.title)+" ê´€ë ¨",1)])]),e(c,u(d({title:"C# > Article(s)",desc:"Article(s)",link:"/programming/cs/articles/README.md",logo:"https://chanhi2000.github.io/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",x,[s("ul",null,[s("li",null,[e(o,{to:"#understanding-problem-details"},{default:t(()=>[...n[0]||(n[0]=[a("Understanding Problem Details",-1)])]),_:1})]),s("li",null,[e(o,{to:"#implementing-problem-details"},{default:t(()=>[...n[1]||(n[1]=[a("Implementing Problem Details",-1)])]),_:1})]),s("li",null,[e(o,{to:"#global-error-handling"},{default:t(()=>[...n[2]||(n[2]=[a("Global Error Handling",-1)])]),_:1})]),s("li",null,[e(o,{to:"#using-the-problemdetailsservice"},{default:t(()=>[...n[3]||(n[3]=[a("Using The ProblemDetailsService",-1)])]),_:1})]),s("li",null,[e(o,{to:"#customizing-problem-details"},{default:t(()=>[...n[4]||(n[4]=[a("Customizing Problem Details",-1)])]),_:1})]),s("li",null,[e(o,{to:"#handling-specific-exceptions-status-codes"},{default:t(()=>[...n[5]||(n[5]=[a("Handling Specific Exceptions (Status Codes)",-1)])]),_:1})]),s("li",null,[e(o,{to:"#takeaway"},{default:t(()=>[...n[6]||(n[6]=[a("Takeaway",-1)])]),_:1})])])]),n[26]||(n[26]=s("hr",null,null,-1)),e(k,{name:"Problem Details for ASP.NET Core APIs",desc:"Discover how to leverage Problem Details in ASP.NET Core to create consistent, informative API error responses that enhance developer experience and comply with RFC 9457. This comprehensive guide explores the latest features in .NET 8 and 9, demonstrating how to implement custom exception handlers, utilize IProblemDetailsService, and apply best practices for robust error handling in your APIs.",url:"https://milanjovanovic.tech/blog/problem-details-for-aspnetcore-apis",logo:"https://milanjovanovic.tech/profile_favicon.png",preview:"https://milanjovanovic.tech/blog-covers/mnw_112.png"}),n[27]||(n[27]=s("p",null,[a("When developing HTTP APIs, providing consistent and informative error responses is crucial for a smooth developer experience. "),s("strong",null,"Problem Details"),a(" in ASP.NET Core offers a standardized solution to this challenge, ensuring your APIs communicate errors effectively and uniformly.")],-1)),n[28]||(n[28]=s("p",null,[a("In this article, we'll explore the latest developments in "),s("strong",null,"Problem Details"),a(", including:")],-1)),s("ul",null,[s("li",null,[n[8]||(n[8]=a("The new ",-1)),s("a",D,[e(i,{icon:"fas fa-globe"}),n[7]||(n[7]=a("RFC 9457",-1))]),n[9]||(n[9]=a(" that refines the Problem Details standard",-1))]),n[10]||(n[10]=s("li",null,[a("Using the .NET 8 "),s("code",null,"IExceptionHandler"),a(" for global exception handling")],-1)),n[11]||(n[11]=s("li",null,[a("Using the "),s("code",null,"IProblemDetailsService"),a(" for customizing Problem Details")],-1))]),n[29]||(n[29]=l('<p>Let&#39;s dive into these features and see how they can improve your API&#39;s error handling.</p><hr><h2 id="understanding-problem-details" tabindex="-1"><a class="header-anchor" href="#understanding-problem-details"><span>Understanding Problem Details</span></a></h2><p>Problem Details is a machine-readable format for specifying errors in HTTP API responses. HTTP status codes don&#39;t always contain enough details about errors to be helpful. The Problem Details specification defines a JSON (and XML) document format to describe problems.</p><p>Problem Details includes:</p><ul><li><code>type</code>: A URI reference that identifies the problem type</li><li><code>title</code>: A short, human-readable summary of the problem type</li><li><code>status</code>: The HTTP status code</li><li><code>detail</code>: A human-readable explanation specific to this occurrence of the problem</li><li><code>instance</code>: A URI reference that identifies the specific occurrence of the problem</li></ul>',6)),s("p",null,[s("a",A,[e(i,{icon:"fas fa-globe"}),n[12]||(n[12]=a("RFC 9457",-1))]),n[14]||(n[14]=a(", which replaces ",-1)),s("a",C,[e(i,{icon:"fas fa-globe"}),n[13]||(n[13]=a("RFC 7807",-1))]),n[15]||(n[15]=a(", introduces improvements such as clarifying the use of the type field and providing guidelines for extending ",-1)),n[16]||(n[16]=s("strong",null,"Problem Details",-1)),n[17]||(n[17]=a(".",-1))]),n[30]||(n[30]=l(`<p>Here&#39;s an example Problem Details response:</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line">Content-Type<span class="token operator">:</span> application/problem+json</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://tools.ietf.org/html/rfc9110#section-15.5.5&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Not Found&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;detail&quot;</span><span class="token operator">:</span> <span class="token string">&quot;The habit with the specified identifier was not found&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;instance&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PUT /api/habits/aadcad3f-8dc8-443d-be44-3d99893ba18a&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="implementing-problem-details" tabindex="-1"><a class="header-anchor" href="#implementing-problem-details"><span>Implementing Problem Details</span></a></h2><p>Let&#39;s see how to implement Problem Details in ASP.NET Core. We want to return a Problem Details response for unhandled exceptions. By calling <code>AddProblemDetails</code>, we&#39;re configuring the application to use the Problem Details format for failed requests. With <code>UseExceptionHandler</code>, we introduce an exception handling middleware to the request pipeline. By adding <code>UseStatusCodePages</code>, we&#39;re introducing a middleware that will convert error responses with an empty body to a Problem Details response.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Adds services for using Problem Details format</span></span>
<span class="line">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddProblemDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Converts unhandled exceptions into Problem Details responses</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">UseExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// Returns the Problem Details response for (empty) non-successful responses</span></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">UseStatusCodePages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>When we encounter an unhandled exception, it will be translated to a Problem Details response:</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line">Content-Type<span class="token operator">:</span> application/problem+json</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://tools.ietf.org/html/rfc9110#section-15.6.1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;An error occurred while processing your request.&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">500</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, let&#39;s explore how we can customize this response.</p><hr><h2 id="global-error-handling" tabindex="-1"><a class="header-anchor" href="#global-error-handling"><span>Global Error Handling</span></a></h2>`,11)),s("p",null,[n[19]||(n[19]=a("We have a few options for ",-1)),e(r,{to:"/milanjovanovic.tech/global-error-handling-in-aspnetcore-8.html"},{default:t(()=>[...n[18]||(n[18]=[a("implementing global error handling",-1)])]),_:1}),n[20]||(n[20]=a(". The most popular approach is creating a custom exception handling middleware. You wrap the API request in a ",-1)),n[21]||(n[21]=s("code",null,"try-catch",-1)),n[22]||(n[22]=a(" statement and return a response based on any caught exception.",-1))]),n[31]||(n[31]=l(`<p>With .NET 8, we can use the <code>IExceptionHandler</code> that runs in the built-in exception handling middleware. This handler allows you to tailor the Problem Details response for specific exceptions. Returning <code>true</code> from the <code>TryHandleAsync</code> method short-circuits the pipeline and returns the API response. If we return <code>false</code>, the next handler in the chain attempts to handle the exception.</p><p>We can map different exception types to appropriate HTTP status codes, providing more precise error information to API consumers.</p><p>Here&#39;s an example <code>CustomExceptionHandler</code> implementation:</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="CustomExceptionHandler.cs"><span>CustomExceptionHandler.cs</span></div><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">CustomExceptionHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IExceptionHandler</span></span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">TryHandleAsync</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token class-name">HttpContext</span> httpContext<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">Exception</span> exception<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">int</span></span> status <span class="token operator">=</span> exception <span class="token keyword">switch</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            ArgumentException <span class="token operator">=&gt;</span> StatusCodes<span class="token punctuation">.</span>Status400BadRequest<span class="token punctuation">,</span></span>
<span class="line">            _ <span class="token operator">=&gt;</span> StatusCodes<span class="token punctuation">.</span>Status500InternalServerError</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">        httpContext<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> status<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> problemDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ProblemDetails</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            Status <span class="token operator">=</span> status<span class="token punctuation">,</span></span>
<span class="line">            Title <span class="token operator">=</span> <span class="token string">&quot;An error occurred&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            Type <span class="token operator">=</span> exception<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span></span>
<span class="line">            Detail <span class="token operator">=</span> exception<span class="token punctuation">.</span>Message</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">await</span> httpContext<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsJsonAsync</span><span class="token punctuation">(</span>problemDetails<span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><div class="code-block-with-title"><div class="code-block-title-bar" data-title="Program.cs"><span>Program.cs</span></div><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddExceptionHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CustomExceptionHandler<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></div><hr><h2 id="using-the-problemdetailsservice" tabindex="-1"><a class="header-anchor" href="#using-the-problemdetailsservice"><span>Using The ProblemDetailsService</span></a></h2><p>Calling <code>AddProblemDetails</code> registers a default implementation of the <code>IProblemDetailsService</code>. The <code>IProblemDetailsService</code> will set the response status code based on the <code>ProblemDetails.Status</code>.</p><p>Here&#39;s how we can use it in the <code>CustomExceptionHandler</code>:</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="CustomExceptionHandler.cs"><span>CustomExceptionHandler.cs</span></div><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">IProblemDetailsService</span> problemDetailsService<span class="token punctuation">)</span> <span class="token punctuation">:</span> IExceptionHandler</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">bool</span><span class="token punctuation">&gt;</span></span> <span class="token function">TryHandleAsync</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token class-name">HttpContext</span> httpContext<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">Exception</span> exception<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> problemDetails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ProblemDetails</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            Status <span class="token operator">=</span> exception <span class="token keyword">switch</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                ArgumentException <span class="token operator">=&gt;</span> StatusCodes<span class="token punctuation">.</span>Status400BadRequest<span class="token punctuation">,</span></span>
<span class="line">                _ <span class="token operator">=&gt;</span> StatusCodes<span class="token punctuation">.</span>Status500InternalServerError</span>
<span class="line">            <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">            Title <span class="token operator">=</span> <span class="token string">&quot;An error occurred&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            Type <span class="token operator">=</span> exception<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span></span>
<span class="line">            Detail <span class="token operator">=</span> exception<span class="token punctuation">.</span>Message</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> problemDetailsService<span class="token punctuation">.</span><span class="token function">TryWriteAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ProblemDetailsContext</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            Exception <span class="token operator">=</span> exception<span class="token punctuation">,</span></span>
<span class="line">            HttpContext <span class="token operator">=</span> httpContext<span class="token punctuation">,</span></span>
<span class="line">            ProblemDetails <span class="token operator">=</span> problemDetails</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>This approach seems very similar to the previous one, where we wrote to the response body. However, using the <code>IProblemDetailsService</code> gives an easy way to customize all Problem Details responses.</p><p>We can return Problem Details in controllers using the <code>Problem</code> method, or <code>Results.Problem</code> in Minimal APIs. These methods respect the configured Problem Details customizations (more on this in the next section).</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token class-name">IdentityUser</span> identityUser <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> UserName <span class="token operator">=</span> registerUserDto<span class="token punctuation">.</span>UserName<span class="token punctuation">,</span> Email <span class="token operator">=</span> registerUserDto<span class="token punctuation">.</span>Email <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token class-name">IdentityResult</span> result <span class="token operator">=</span> <span class="token keyword">await</span> userManager<span class="token punctuation">.</span><span class="token function">CreateAsync</span><span class="token punctuation">(</span>identityUser<span class="token punctuation">,</span> registerUserDto<span class="token punctuation">.</span>Password<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>Succeeded<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// return Results.Problem - Minimal APIs</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">Problem</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token named-parameter punctuation">type</span><span class="token punctuation">:</span> <span class="token string">&quot;Bad Request&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token named-parameter punctuation">title</span><span class="token punctuation">:</span> <span class="token string">&quot;Identity failure&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token named-parameter punctuation">detail</span><span class="token punctuation">:</span> result<span class="token punctuation">.</span>Errors<span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Description<span class="token punctuation">,</span></span>
<span class="line">        <span class="token named-parameter punctuation">statusCode</span><span class="token punctuation">:</span> StatusCodes<span class="token punctuation">.</span>Status400BadRequest<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="customizing-problem-details" tabindex="-1"><a class="header-anchor" href="#customizing-problem-details"><span>Customizing Problem Details</span></a></h2><p>We can pass a delegate to the <code>AddProblemDetails</code> method to set the <code>CustomizeProblemDetails</code>. You can use this to add extra information to all Problem Details responses.</p><p>This is an excellent place for solving cross-cutting concerns, like setting the <code>instance</code> value and adding diagnostics information.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddProblemDetails</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    options<span class="token punctuation">.</span>CustomizeProblemDetails <span class="token operator">=</span> context <span class="token operator">=&gt;</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        context<span class="token punctuation">.</span>ProblemDetails<span class="token punctuation">.</span>Instance <span class="token operator">=</span></span>
<span class="line">            <span class="token interpolation-string"><span class="token string">$&quot;</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Method</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Path</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        context<span class="token punctuation">.</span>ProblemDetails<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span><span class="token function">TryAdd</span><span class="token punctuation">(</span><span class="token string">&quot;requestId&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>TraceIdentifier<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">Activity<span class="token punctuation">?</span></span> activity <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Features<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Get</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IHttpActivityFeature<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">?.</span>Activity<span class="token punctuation">;</span></span>
<span class="line">        context<span class="token punctuation">.</span>ProblemDetails<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span><span class="token function">TryAdd</span><span class="token punctuation">(</span><span class="token string">&quot;traceId&quot;</span><span class="token punctuation">,</span> activity<span class="token punctuation">?.</span>Id<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This customization adds the request path, a request ID, and a trace ID to every Problem Details response, enhancing debuggability and traceability of errors.</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line">Content-Type<span class="token operator">:</span> application/problem+json</span>
<span class="line"></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://tools.ietf.org/html/rfc9110#section-15.5.5&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Not Found&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">404</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;instance&quot;</span><span class="token operator">:</span> <span class="token string">&quot;PUT /api/habits/aadcad3f-8dc8-443d-be44-3d99893ba18a&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;traceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;00-63d4af1807586b0d98901ae47944192d-9a8635facb90bf76-01&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;requestId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0HN7C8PRNMGIA:00000001&quot;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can use the <code>traceId</code> to find the distributed traces and logs in a monitoring system like Seq.</p><figure><img src="https://milanjovanovic.tech/blogs/mnw_112/seq_tracing.png?imwidth=3840" alt="Seq user interface showing a distributed trace with the same trace identifier as the problem details response." tabindex="0" loading="lazy"><figcaption>Seq user interface showing a distributed trace with the same trace identifier as the problem details response.</figcaption></figure><hr><h2 id="handling-specific-exceptions-status-codes" tabindex="-1"><a class="header-anchor" href="#handling-specific-exceptions-status-codes"><span>Handling Specific Exceptions (Status Codes)</span></a></h2><p>.NET 9 introduces a simpler way to map exceptions to status codes. Great news for fans of throwing exceptions. You can use the <code>StatusCodeSelector</code> to define the mappings. This makes it easier to maintain consistent error responses across your API.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line">app<span class="token punctuation">.</span><span class="token function">UseExceptionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ExceptionHandlerOptions</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    StatusCodeSelector <span class="token operator">=</span> ex <span class="token operator">=&gt;</span> ex <span class="token keyword">switch</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        ArgumentException <span class="token operator">=&gt;</span> StatusCodes<span class="token punctuation">.</span>Status400BadRequest<span class="token punctuation">,</span></span>
<span class="line">        NotFoundException <span class="token operator">=&gt;</span> StatusCodes<span class="token punctuation">.</span>Status404NotFound<span class="token punctuation">,</span></span>
<span class="line">        _ <span class="token operator">=&gt;</span> StatusCodes<span class="token punctuation">.</span>Status500InternalServerError</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If you use this together with an <code>IExceptionHandler</code> that sets the <code>StatusCode</code>, then the <code>StatusCodeSelector</code> is ignored.</p><hr><h2 id="takeaway" tabindex="-1"><a class="header-anchor" href="#takeaway"><span>Takeaway</span></a></h2><p>Implementing Problem Details in your ASP.NET Core APIs is more than just a best practice - it&#39;s a standard for improving the developer experience of your API consumers. By providing consistent, detailed, and well-structured error responses, you make it easier for clients to understand and handle error scenarios gracefully.</p><p>As you implement these practices in your own projects, you&#39;ll discover even more ways to tailor Problem Details to your specific needs. I shared what worked well for my use cases.</p>`,31)),s("p",null,[n[24]||(n[24]=a("Problem Details is just one of the best practices covered in my upcoming ",-1)),e(r,{to:"/milanjovanovic.tech/rest-apis-in-aspnetcore/"},{default:t(()=>[...n[23]||(n[23]=[s("strong",null,"REST APIs course",-1)])]),_:1}),n[25]||(n[25]=a(". Check it out if you're looking for a comprehensive guide.",-1))]),n[32]||(n[32]=s("p",null,"Good luck out there, and I'll see you next week.",-1)),n[33]||(n[33]=s("hr",null,null,-1)),h(" TODO: add ARTICLE CARD "),e(c,u(d({title:"Problem Details for ASP.NET Core APIs",desc:"Discover how to leverage Problem Details in ASP.NET Core to create consistent, informative API error responses that enhance developer experience and comply with RFC 9457. This comprehensive guide explores the latest features in .NET 8 and 9, demonstrating how to implement custom exception handlers, utilize IProblemDetailsService, and apply best practices for robust error handling in your APIs.",link:"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/problem-details-for-aspnetcore-apis.html",logo:"https://milanjovanovic.tech/profile_favicon.png",background:"rgba(79,70,229,0.2)"})),null,16)])}const I=v(y,[["render",q]]),E=JSON.parse('{"path":"/milanjovanovic.tech/problem-details-for-aspnetcore-apis.html","title":"Problem Details for ASP.NET Core APIs","lang":"en-US","frontmatter":{"lang":"en-US","title":"Problem Details for ASP.NET Core APIs","description":"Article(s) > Problem Details for ASP.NET Core APIs","icon":"iconfont icon-csharp","category":["C#","DotNet","Article(s)"],"tag":["blog","milanjovanovic.tech","cs","c#","csharp","dotnet"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Problem Details for ASP.NET Core APIs\\",\\"image\\":[\\"https://milanjovanovic.tech/blogs/mnw_112/seq_tracing.png?imwidth=3840\\"],\\"datePublished\\":\\"2024-10-19T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Milan JovanoviÄ‡\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/problem-details-for-aspnetcore-apis.html"}],["meta",{"property":"og:site_name","content":"ðŸ“šBookshelf"}],["meta",{"property":"og:title","content":"Problem Details for ASP.NET Core APIs"}],["meta",{"property":"og:description","content":"Article(s) > Problem Details for ASP.NET Core APIs"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://milanjovanovic.tech/blog-covers/mnw_112.png"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://milanjovanovic.tech/blog-covers/mnw_112.png"}],["meta",{"name":"twitter:image:alt","content":"Problem Details for ASP.NET Core APIs"}],["meta",{"property":"article:author","content":"Milan JovanoviÄ‡"}],["meta",{"property":"article:tag","content":"dotnet"}],["meta",{"property":"article:tag","content":"csharp"}],["meta",{"property":"article:tag","content":"c#"}],["meta",{"property":"article:tag","content":"cs"}],["meta",{"property":"article:tag","content":"milanjovanovic.tech"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2024-10-19T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Problem Details for ASP.NET Core APIs"},{"property":"og:description","content":"Problem Details for ASP.NET Core APIs"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/problem-details-for-aspnetcore-apis.html"}]],"prev":"/programming/cs/articles/README.md","date":"2024-10-19T00:00:00.000Z","isOriginal":false,"author":"Milan JovanoviÄ‡","cover":"https://milanjovanovic.tech/blog-covers/mnw_112.png"},"git":{},"readingTime":{"minutes":4.86,"words":1457},"filePathRelative":"milanjovanovic.tech/problem-details-for-aspnetcore-apis.md","copyright":{"author":"Milan JovanoviÄ‡"}}');export{I as comp,E as data};
