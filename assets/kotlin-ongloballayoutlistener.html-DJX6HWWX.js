import{_ as r}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as u,d as a,f as e,b as d,t as k,n as m,g as h,w as t,r as i,o as b,e as o}from"./app-BVguHYKu.js";const v="/bookshelf/assets/image/antonioleiva.com/kotlin-ongloballayoutlistener/banner.png",g={},y={id:"frontmatter-title-관련",tabindex:"-1"},f={class:"header-anchor",href:"#frontmatter-title-관련"},w={class:"table-of-contents"};function L(l,n){const p=i("VPCard"),s=i("router-link"),c=i("SiteInfo");return b(),u("div",null,[a("h1",y,[a("a",f,[a("span",null,k(l.$frontmatter.title)+" 관련",1)])]),e(p,m(h({title:"Android > Article(s)",desc:"Article(s)",link:"/programming/java-android/articles/README.md",logo:"https://chanhi2000.github.io/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),a("nav",w,[a("ul",null,[a("li",null,[e(s,{to:"#what-is-ongloballayoutlistener-for"},{default:t(()=>n[0]||(n[0]=[o("What is OnGlobalLayoutListener for?")])),_:1,__:[0]})]),a("li",null,[e(s,{to:"#finding-a-better-alternative"},{default:t(()=>n[1]||(n[1]=[o("Finding a better alternative")])),_:1,__:[1]})]),a("li",null,[e(s,{to:"#but-we-can-improve-it"},{default:t(()=>n[2]||(n[2]=[o("But we can improve it")])),_:1,__:[2]})]),a("li",null,[e(s,{to:"#conclusion"},{default:t(()=>n[3]||(n[3]=[o("Conclusion")])),_:1,__:[3]})])])]),n[4]||(n[4]=a("hr",null,null,-1)),e(c,{name:"Kotlin recipes for Android (I): OnGlobalLayoutListener",desc:"OnGlobalLayoutListener doesn't look good on Kotlin, but we can make it shine if we make use of extension functions, and convert it to a more usable tool.",url:"https://antonioleiva.com/kotlin-ongloballayoutlistener",logo:"/assets/image/antonioleiva.com/favicon.png",preview:"/assets/image/antonioleiva.com/kotlin-ongloballayoutlistener/banner.png"}),n[5]||(n[5]=d('<figure><img src="'+v+`" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Today a mate asked me how he could do an <code>OnGlobalLayoutListener</code> properly without incurring in the need of too much boilerplate. This was a tricky question because of a couple of things, let’s see it a little more deeply.</p><hr><h2 id="what-is-ongloballayoutlistener-for" tabindex="-1"><a class="header-anchor" href="#what-is-ongloballayoutlistener-for"><span>What is OnGlobalLayoutListener for?</span></a></h2><p>This listener is available for any view’s <code>ViewTreeObserver</code> and it’s quite often used to get a callback when the view is inflated and measured, and we already have a width and height available to do any kind of calculations, animations, etc.</p><blockquote><p>If you’re going to use this method, make sure it’s really what you need. Check this tweet from Chris Banes</p></blockquote><p>Thanks to the awesome Java interoperability that Kotlin provides, we can do this on a very clean way using its simulated properties and lambdas for single-method interfaces:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line">recycler<span class="token punctuation">.</span>viewTreeObserver<span class="token punctuation">.</span><span class="token function">addOnGlobalLayoutListener</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// do whatever</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>What’s the issue here? To prevent leaks, a recommended practice is to remove the listener once you’ve finished using it. But we don’t have a reference to the object because we used a lambda, and a lambda is not exactly the same as an object.</p><p>We could still use the old-fashioned style, but a kitten dies every time we use an anonymous object directly in Kotlin. We are not changing to a nicer language if we still need to do things like this:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line">recycler<span class="token punctuation">.</span>viewTreeObserver<span class="token punctuation">.</span><span class="token function">addOnGlobalLayoutListener</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token keyword">object</span> <span class="token operator">:</span> ViewTreeObserver<span class="token punctuation">.</span><span class="token function">OnGlobalLayoutListener</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onGlobalLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            recycler<span class="token punctuation">.</span>viewTreeObserver<span class="token punctuation">.</span><span class="token function">removeOnGlobalLayoutListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token comment">// do whatever</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="finding-a-better-alternative" tabindex="-1"><a class="header-anchor" href="#finding-a-better-alternative"><span>Finding a better alternative</span></a></h2><p>Ok, we know we don’t want that. But what can we do to make it better? We are forced to use the not-so-good-looking way, but a good alternative would be to hide this behind an extension function.</p><p>We will then create a new function for views that receives another function and creates and removes the listener by itself. Something like:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">inline</span> <span class="token keyword">fun</span> View<span class="token punctuation">.</span><span class="token function">waitForLayout</span><span class="token punctuation">(</span><span class="token keyword">crossinline</span> f<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">with</span><span class="token punctuation">(</span>viewTreeObserver<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">addOnGlobalLayoutListener</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> ViewTreeObserver<span class="token punctuation">.</span><span class="token function">OnGlobalLayoutListener</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onGlobalLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token function">removeOnGlobalLayoutListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can now just call the function and be sure that the listener is added and removed by itself. Besides, you’ll never forget about removing it anymore:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line">recycler<span class="token punctuation">.</span><span class="token function">waitForLayout</span> <span class="token punctuation">{</span></span>
<span class="line">     <span class="token comment">// do whatever</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If you prefer, you could apply the extension function to the <code>ViewTreeObserver</code> instead of directly to the <code>View</code>. That’s up to you.</p><hr><h2 id="but-we-can-improve-it" tabindex="-1"><a class="header-anchor" href="#but-we-can-improve-it"><span>But we can improve it</span></a></h2><p>This layout listener is usually used to do something after a view is measured, so you typically would need to wait until width and height are greater than 0. And we probably want to do something with the view that called it, so why don’t we <strong>convert the parameter function into an extension function</strong> too?</p><p>I also <strong>generified the function</strong> so that it can be used by any object that extends View and also be able to access to all its specific functions and properties from the function we’ll write.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">inline</span> <span class="token keyword">fun</span>  T<span class="token punctuation">.</span><span class="token function">afterMeasured</span><span class="token punctuation">(</span><span class="token keyword">crossinline</span> f<span class="token operator">:</span> T<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    viewTreeObserver<span class="token punctuation">.</span><span class="token function">addOnGlobalLayoutListener</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> ViewTreeObserver<span class="token punctuation">.</span><span class="token function">OnGlobalLayoutListener</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onGlobalLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">if</span> <span class="token punctuation">(</span>measuredWidth <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> measuredHeight <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">                viewTreeObserver<span class="token punctuation">.</span><span class="token function">removeOnGlobalLayoutListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span></span>
<span class="line">                <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This <code>afterMeasured</code> function is very similar to the previous one, but you can use the properties and public methods of the view directly inside the lambda. We can, for instance, get the width of the recycler and set a layout with a dynamic number of columns depending on it.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line">recycler<span class="token punctuation">.</span><span class="token function">afterMeasured</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">val</span> columnCount <span class="token operator">=</span> width <span class="token operator">/</span> columnWidth</span>
<span class="line">    layoutManager <span class="token operator">=</span> <span class="token function">GridLayoutManager</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> columnCount<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="conclusion" tabindex="-1"><a class="header-anchor" href="#conclusion"><span>Conclusion</span></a></h2><p>It’s true that there are still some things that don’t look nice when working with Android, even moving to Kotlin, but we can always find an alternative that improves readability and avoids boilerplate, by hiding this boilerplate behind other structures. At least you’ll have to only write it once and the rest of the code will look awesome!</p>`,29))])}const _=r(g,[["render",L]]),T=JSON.parse('{"path":"/antonioleiva.com/kotlin-ongloballayoutlistener.html","title":"Kotlin recipes for Android (I): OnGlobalLayoutListener","lang":"ko-KR","frontmatter":{"lang":"ko-KR","title":"Kotlin recipes for Android (I): OnGlobalLayoutListener","description":"Article(s) > Kotlin recipes for Android (I): OnGlobalLayoutListener","icon":"fa-brands fa-android","category":["Java","Kotlin","Android","Article(s)"],"tag":["blog","antonioleiva.com","java","kotlin","kt","android"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Kotlin recipes for Android (I): OnGlobalLayoutListener\\",\\"image\\":[\\"https://chanhi2000.github.io/bookshelf/assets/image/antonioleiva.com/kotlin-ongloballayoutlistener/banner.png\\"],\\"datePublished\\":\\"2016-03-16T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/antonioleiva.com/kotlin-ongloballayoutlistener.html"}],["meta",{"property":"og:site_name","content":"📚Bookshelf"}],["meta",{"property":"og:title","content":"Kotlin recipes for Android (I): OnGlobalLayoutListener"}],["meta",{"property":"og:description","content":"Article(s) > Kotlin recipes for Android (I): OnGlobalLayoutListener"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://chanhi2000.github.io/bookshelf/assets/image/antonioleiva.com/kotlin-ongloballayoutlistener/banner.png"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://chanhi2000.github.io/bookshelf/assets/image/antonioleiva.com/kotlin-ongloballayoutlistener/banner.png"}],["meta",{"name":"twitter:image:alt","content":"Kotlin recipes for Android (I): OnGlobalLayoutListener"}],["meta",{"property":"article:tag","content":"android"}],["meta",{"property":"article:tag","content":"kt"}],["meta",{"property":"article:tag","content":"kotlin"}],["meta",{"property":"article:tag","content":"java"}],["meta",{"property":"article:tag","content":"antonioleiva.com"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2016-03-16T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Kotlin recipes for Android (I): OnGlobalLayoutListener"},{"property":"og:description","content":"Kotlin recipes for Android (I): OnGlobalLayoutListener"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/antonioleiva.com/kotlin-ongloballayoutlistener.html"}]],"prev":"/programming/java-android/articles/README.md","date":"2016-03-16T00:00:00.000Z","isOriginal":false,"cover":"/assets/image/antonioleiva.com/kotlin-ongloballayoutlistener/banner.png"},"git":{},"readingTime":{"minutes":2.59,"words":778},"filePathRelative":"antonioleiva.com/kotlin-ongloballayoutlistener.md"}');export{_ as comp,T as data};
