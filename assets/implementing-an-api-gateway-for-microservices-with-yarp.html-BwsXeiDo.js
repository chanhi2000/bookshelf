import{_ as m}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as v,d as s,f as e,b as l,t as g,n as h,g as k,w as o,e as a,r as i,o as y}from"./app-BItykJLQ.js";const b={},f={id:"frontmatter-title-á„€á…ªá†«á„…á…§á†«",tabindex:"-1"},w={class:"header-anchor",href:"#frontmatter-title-á„€á…ªá†«á„…á…§á†«"},q={class:"table-of-contents"},A={href:"https://github.com/m-jovanovic/yarp-api-gateway-sample",target:"_blank",rel:"noopener noreferrer"},P={href:"https://github.com/m-jovanovic/yarp-api-gateway-sample",target:"_blank",rel:"noopener noreferrer"},I={href:"https://microsoft.github.io/reverse-proxy/articles/authn-authz.html",target:"_blank",rel:"noopener noreferrer"},x={href:"https://microsoft.github.io/reverse-proxy/articles/index.html",target:"_blank",rel:"noopener noreferrer"},R={href:"https://microsoft.github.io/reverse-proxy/articles/load-balancing.html",target:"_blank",rel:"noopener noreferrer"},j={href:"https://microsoft.github.io/reverse-proxy/articles/session-affinity.html",target:"_blank",rel:"noopener noreferrer"},Y={href:"https://microsoft.github.io/reverse-proxy/articles/transforms.html",target:"_blank",rel:"noopener noreferrer"},M={class:"hint-container info"},T={href:"https://github.com/m-jovanovic/yarp-api-gateway-sample",target:"_blank",rel:"noopener noreferrer"};function C(u,n){const d=i("VPCard"),p=i("router-link"),r=i("SiteInfo"),t=i("VPIcon"),c=i("RouteLink");return y(),v("div",null,[s("h1",f,[s("a",w,[s("span",null,g(u.$frontmatter.title)+" ê´€ë ¨",1)])]),e(d,h(k({title:"C# > Article(s)",desc:"Article(s)",link:"/programming/cs/articles/README.md",logo:"https://chanhi2000.github.io/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",q,[s("ul",null,[s("li",null,[e(p,{to:"#what-s-the-difference-between-an-api-gateway-and-a-reverse-proxy"},{default:o(()=>[...n[0]||(n[0]=[a("What's The Difference Between an API Gateway And a Reverse Proxy?",-1)])]),_:1})]),s("li",null,[e(p,{to:"#installing-and-configuring-yarp"},{default:o(()=>[...n[1]||(n[1]=[a("Installing And Configuring YARP",-1)])]),_:1})]),s("li",null,[e(p,{to:"#implementing-an-api-gateway-with-yarp"},{default:o(()=>[...n[2]||(n[2]=[a("Implementing an API Gateway With YARP",-1)])]),_:1})]),s("li",null,[e(p,{to:"#adding-authentication"},{default:o(()=>[...n[3]||(n[3]=[a("Adding Authentication",-1)])]),_:1})]),s("li",null,[e(p,{to:"#adding-rate-limiting"},{default:o(()=>[...n[4]||(n[4]=[a("Adding Rate Limiting",-1)])]),_:1})]),s("li",null,[e(p,{to:"#in-summary"},{default:o(()=>[...n[5]||(n[5]=[a("In Summary",-1)])]),_:1})])])]),n[35]||(n[35]=s("hr",null,null,-1)),e(r,{name:"Implementing an API Gateway For Microservices With YARP",desc:"Large Microservice-based systems can consist of tens or even hunders of individual services. A client application needs to have all of this information to be able to make requests to the relevant microservice directly. However, this has numerous issues such as security concerns, complexity, and coupling. We can solve this by introducing an API gateway that acts as a reverse proxy to accept API calls from the client application, forwarding this traffic to the appropriate service. The API gateway also enforces security and ensures scalability and high availability. In this week's newsletter, I'll show you how to implement an API gateway using the YARP reverse proxy.",url:"https://milanjovanovic.tech/blog/implementing-an-api-gateway-for-microservices-with-yarp/",logo:"https://milanjovanovic.tech/profile_favicon.png",preview:"https://milanjovanovic.tech/blog-covers/mnw_045.png"}),n[36]||(n[36]=l(`<p>Large <strong>Microservice-based</strong> systems can consist of tens or even hundreds of individual services. A client application needs to have all of this information to be able to make requests to the relevant <strong>microservice</strong> directly.</p><p>However, this has numerous issues, such as security concerns, increased complexity, and coupling.</p><p>We can solve this by introducing an <strong>API gateway</strong> that acts as a <strong>reverse proxy</strong> to accept API calls from the client application and forward them to the appropriate service.</p><p>The <strong>API gateway</strong> also enforces security and ensures scalability and high availability.</p><p>In this week&#39;s newsletter, I&#39;ll show you how to implement an <strong>API gateway</strong> for your <strong>microservices system</strong> using the <strong>YARP reverse proxy</strong>.</p><p>Here&#39;s what we will cover:</p><ul><li>Difference between <strong>API gateway</strong> and <strong>reverse proxy</strong></li><li>Installing and configuring <strong>YARP</strong></li><li>Creating an <strong>API gateway</strong> with <strong>YARP</strong></li><li><strong>Authentication</strong> and <strong>rate limiting</strong> on the <strong>API gateway</strong></li></ul><p>Let&#39;s dive in.</p><hr><h2 id="what-s-the-difference-between-an-api-gateway-and-a-reverse-proxy" tabindex="-1"><a class="header-anchor" href="#what-s-the-difference-between-an-api-gateway-and-a-reverse-proxy"><span>What&#39;s The Difference Between an API Gateway And a Reverse Proxy?</span></a></h2><p>A <strong>reverse proxy</strong> and an <strong>API gateway</strong> are similar concepts, but they serve different purposes.</p><p>A <strong>reverse proxy</strong> acts as an intermediary between clients and servers. The clients can only call the backend servers through the <strong>reverse proxy</strong>, which forwards the request to the appropriate server. It hides the implementation details of individual servers inside the internal network.</p><p>A <strong>reverse proxy</strong> is commonly used for:</p><ul><li>Load balancing</li><li>Caching</li><li>Security</li><li>SSL termination</li></ul><figure><img src="https://milanjovanovic.tech/blogs/mnw_045/reverse_proxy.png?imwidth=3840" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>An <strong>API gateway</strong> is a specific type of <strong>reverse proxy</strong> designed for managing APIs. It acts as a single entry point for API consumers to the various backend services.</p><p>The key characteristics of an <strong>API gateway</strong> are:</p><ul><li>Request routing and composition</li><li>Request/response transformations</li><li>Authentication and authorization</li><li>Rate limiting</li><li>Monitoring</li></ul><p>Also, note that an <strong>API gateway</strong> can perform <strong>load balancing</strong> and other functionalities mentioned for reverse proxies.</p><p>Now let&#39;s see how to use a <strong>reverse proxy</strong> to implement an <strong>API gateway</strong>.</p><hr><h2 id="installing-and-configuring-yarp" tabindex="-1"><a class="header-anchor" href="#installing-and-configuring-yarp"><span>Installing And Configuring YARP</span></a></h2><p><strong>YARP</strong> (Yet Another Reverse Proxy) is a library developed by Microsoft to address the needs of various teams needing to build a <strong>reverse proxy</strong>. It&#39;s open source and built with .NET, so it integrates nicely with the existing ecosystem.</p><p>Let&#39;s install <code>Yarp.ReverseProxy</code> <strong>NuGet</strong> package to get started:</p><div class="language-powershell line-numbers-mode" data-highlighter="prismjs" data-ext="powershell"><pre><code class="language-powershell"><span class="line"><span class="token function">Install-Package</span> Yarp<span class="token punctuation">.</span>ReverseProxy</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Next, we&#39;re going to call:</p><ul><li><code>AddReverseProxy</code> to add the required services for <strong>YARP</strong></li><li><code>LoadFromConfig</code> to load the <strong>reverse proxy</strong> configuration from application settings</li><li><code>MapReverseProxy</code> to introduce the <strong>reverse proxy</strong> middleware</li></ul><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token class-name"><span class="token keyword">var</span></span> builder <span class="token operator">=</span> WebApplication<span class="token punctuation">.</span><span class="token function">CreateBuilder</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddReverseProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">LoadFromConfig</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">&quot;ReverseProxy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token class-name"><span class="token keyword">var</span></span> app <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">MapReverseProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We need to tell the <strong>YARP</strong> reverse proxy how to route the incoming requests to the individual microservices.</p><p><strong>YARP</strong> uses the concept of <code>Routes</code> to represent request patterns for the proxy and <code>Clusters</code> to represent the services to forward those requests.</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;ReverseProxy&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;Routes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            ...</span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;Clusters&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            ...</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Here&#39;s an example <strong>YARP configuration</strong> with a <code>{**catch-all}</code> pattern that will route all incoming requests to the one destination server.</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;ReverseProxy&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;Routes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;ROUTE_NAME&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;ClusterId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;CLUSTER_NAME&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;Match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;Path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{**catch-all}&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;Clusters&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;CLUSTER_NAME&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;Destinations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;destination1&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">&quot;Address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://www.milanjovanovic.tech/&quot;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="implementing-an-api-gateway-with-yarp" tabindex="-1"><a class="header-anchor" href="#implementing-an-api-gateway-with-yarp"><span>Implementing an API Gateway With YARP</span></a></h2><p>We can use <strong>YARP</strong> to build an <strong>API gateway</strong> by providing the configuration for the services we want to route traffic to.</p>`,36)),s("p",null,[n[9]||(n[9]=a("I created a sample ",-1)),s("a",A,[n[6]||(n[6]=a("API gateway implementation with YARP (",-1)),e(t,{icon:"iconfont icon-github"}),n[7]||(n[7]=s("code",null,"m-jovanovic/yarp-api-gateway-sample",-1)),n[8]||(n[8]=a(")",-1))]),n[10]||(n[10]=a(" on GitHub, so you can give it a try. The system has two services, the ",-1)),n[11]||(n[11]=s("code",null,"Users.Api",-1)),n[12]||(n[12]=a(" and ",-1)),n[13]||(n[13]=s("code",null,"Products.Api",-1)),n[14]||(n[14]=a(", which are .NET 7 applications.",-1))]),n[37]||(n[37]=l(`<p>If a request comes in matching the <code>/users-service/{**catch-all}</code>, for example <code>/users-service/users</code>, it will be routed to the <code>users-cluster</code>. The same logic applies for the <code>products-cluster</code>. We can apply more advanced transformations through the <code>Transforms</code> section.</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line"><span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;ReverseProxy&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;Routes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;users-route&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;ClusterId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;users-cluster&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;Match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;Path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/users-service/{**catch-all}&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;Transforms&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token property">&quot;PathPattern&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{**catch-all}&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;products-route&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;ClusterId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;products-cluster&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;Match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;Path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/products-service/{**catch-all}&quot;</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token property">&quot;Transforms&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token property">&quot;PathPattern&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{**catch-all}&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token property">&quot;Clusters&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token property">&quot;users-cluster&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;Destinations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;destination1&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">&quot;Address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://localhost:5201/&quot;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token property">&quot;products-cluster&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token property">&quot;Destinations&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token property">&quot;destination1&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token property">&quot;Address&quot;</span><span class="token operator">:</span> <span class="token string">&quot;https://localhost:5101/&quot;</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We now have a functioning <strong>API gateway</strong> built with <strong>YARP</strong>, routing requests to two individual services.</p><p>But what else can we do with <strong>YARP</strong>?</p><hr><h2 id="adding-authentication" tabindex="-1"><a class="header-anchor" href="#adding-authentication"><span>Adding Authentication</span></a></h2><p>The <strong>API gateway</strong> can enforce <strong>authentication</strong> and <strong>authorization</strong> at the entry point to the system before letting authenticated requests proceed.</p><p>And <strong>YARP</strong> supports integrating with the existing authentication &amp; authorization middleware.</p><p>You first need to define an <strong>authorization policy</strong>:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span><span class="token string">&quot;authenticated&quot;</span><span class="token punctuation">,</span> policy <span class="token operator">=&gt;</span></span>
<span class="line">        policy<span class="token punctuation">.</span><span class="token function">RequireAuthenticatedUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>And call <code>UseAuthentication</code> and <code>UseAuthorization</code> to add the respective middleware to the request pipeline. It&#39;s important to add them before calling <code>MapReverseProxy</code>.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line">app<span class="token punctuation">.</span><span class="token function">UseAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">UseAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">MapReverseProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now all you have to do is add the <code>AuthorizationPolicy</code> section to the reverse proxy configuration:</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line"><span class="token property">&quot;users-route&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;ClusterId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;users-cluster&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;AuthorizationPolicy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;authenticated&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;Match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;Path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/users-service/{**catch-all}&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;Transforms&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token property">&quot;PathPattern&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{**catch-all}&quot;</span> <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>YARP</strong> will forward most credentials to the proxied services, such as cookies or bearer tokens because it might be important to identify the user in the individual microservices.</p><hr><h2 id="adding-rate-limiting" tabindex="-1"><a class="header-anchor" href="#adding-rate-limiting"><span>Adding Rate Limiting</span></a></h2><p>You can also use an <strong>API gateway</strong> to introduce <strong>rate limiting</strong> to your system. It&#39;s a technique to limit the number of requests to your API to <strong>improve security</strong> and reduce the load on the servers.</p>`,18)),s("p",null,[n[16]||(n[16]=a("You can learn more about ",-1)),e(c,{to:"/milanjovanovic.tech/how-to-use-rate-limiting-in-aspnet-core.html"},{default:o(()=>[...n[15]||(n[15]=[a("how to use rate limiting in .NET here",-1)])]),_:1}),n[17]||(n[17]=a(".",-1))]),n[38]||(n[38]=l(`<p>As you can already guess, <strong>YARP</strong> supports the native <strong>rate limiting</strong> mechanism added in .NET 7.</p><p>All you need to do is define a <strong>rate limit policy</strong>:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddRateLimiter</span><span class="token punctuation">(</span>rateLimiterOptions <span class="token operator">=&gt;</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    rateLimiterOptions<span class="token punctuation">.</span><span class="token function">AddFixedWindowLimiter</span><span class="token punctuation">(</span><span class="token string">&quot;fixed&quot;</span><span class="token punctuation">,</span> options <span class="token operator">=&gt;</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        options<span class="token punctuation">.</span>Window <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        options<span class="token punctuation">.</span>PermitLimit <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Then you need to call <code>UseRateLimiter</code> to add the rate limiter middleware to the request pipeline. It&#39;s important to do it before calling <code>MapReverseProxy</code>.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line">app<span class="token punctuation">.</span><span class="token function">UseRateLimiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">app<span class="token punctuation">.</span><span class="token function">MapReverseProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>And then, you can apply rate limiting to the desired route using the <code>RateLimiterPolicy</code> section in the reverse proxy configuration:</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json"><pre><code class="language-json"><span class="line"><span class="token property">&quot;products-route&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token property">&quot;ClusterId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;products-cluster&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;RateLimiterPolicy&quot;</span><span class="token operator">:</span> <span class="token string">&quot;fixed&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;Match&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token property">&quot;Path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/products-service/{**catch-all}&quot;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token property">&quot;Transforms&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span></span>
<span class="line">    <span class="token punctuation">{</span> <span class="token property">&quot;PathPattern&quot;</span><span class="token operator">:</span> <span class="token string">&quot;{**catch-all}&quot;</span> <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="in-summary" tabindex="-1"><a class="header-anchor" href="#in-summary"><span>In Summary</span></a></h2><p>An <strong>API gateway</strong> is a critical component for a robust <strong>microservices system</strong> implementation.</p><p>And <strong>YARP</strong> is an excellent option if you want to build an <strong>API gateway</strong> with .NET.</p>`,11)),s("p",null,[n[21]||(n[21]=a("I created a sample API gateway implementation with YARP, which you can find ",-1)),s("a",P,[n[18]||(n[18]=a("here (",-1)),e(t,{icon:"iconfont icon-github"}),n[19]||(n[19]=s("code",null,"m-jovanovic/yarp-api-gateway-sample",-1)),n[20]||(n[20]=a(")",-1))]),n[22]||(n[22]=a(". The system consists of two APIs, and the API gateway is configured to route requests between them. It also implements:",-1))]),s("ul",null,[s("li",null,[s("a",I,[e(t,{icon:"fa-brands fa-microsoft"}),n[23]||(n[23]=a("Authentication",-1))])]),s("li",null,[e(c,{to:"/milanjovanovic.tech/how-to-use-rate-limiting-in-aspnet-core.html"},{default:o(()=>[...n[24]||(n[24]=[a("Rate limiting",-1)])]),_:1})])]),n[39]||(n[39]=s("p",null,[a("In this newsletter, we only scratched the surface of what's possible with "),s("strong",null,"YARP"),a(".")],-1)),n[40]||(n[40]=s("p",null,"Here are some useful resources if you want to learn more:",-1)),s("ul",null,[s("li",null,[s("a",x,[e(t,{icon:"fa-brands fa-microsoft"}),n[25]||(n[25]=a("YARP docs",-1))])]),s("li",null,[s("a",R,[e(t,{icon:"fa-brands fa-microsoft"}),n[26]||(n[26]=a("Load balancing",-1))])]),s("li",null,[s("a",j,[e(t,{icon:"fa-brands fa-microsoft"}),n[27]||(n[27]=a("Session affinity",-1))])]),s("li",null,[s("a",Y,[e(t,{icon:"fa-brands fa-microsoft"}),n[28]||(n[28]=a("Request/response transformations",-1))])])]),n[41]||(n[41]=s("p",null,"That's all for today.",-1)),n[42]||(n[42]=s("p",null,"Hope it was helpful.",-1)),s("div",M,[n[34]||(n[34]=s("p",{class:"hint-container-title"},"Today's action step",-1)),s("p",null,[n[32]||(n[32]=a("Download the ",-1)),s("a",T,[n[29]||(n[29]=a("source code (",-1)),e(t,{icon:"iconfont icon-github"}),n[30]||(n[30]=s("code",null,"m-jovanovic/yarp-api-gateway-sample",-1)),n[31]||(n[31]=a(")",-1))]),n[33]||(n[33]=a(" for the sample application implementing an API gateway with YARP, and take it for a spin. You can challenge yourself by creating multiple instances of a single service and configuring load balancing with the various load balancing algorithms.",-1))]),e(r,{name:"m-jovanovic/yarp-api-gateway-sample",desc:"Example showing how to use the YARP reverse proxy as a gateway/load balancer for 2 APIs",url:"https://github.com/m-jovanovic/yarp-api-gateway-sample",logo:"https://avatars.githubusercontent.com/u/34191235?s=96&v=4",preview:"https://opengraph.githubassets.com/87e144ea3879069326643b4e47fbb3fdbe25c57e4f4da9e13457cb5db6db0ab3/m-jovanovic/yarp-api-gateway-sample"})])])}const S=m(b,[["render",C]]),G=JSON.parse('{"path":"/milanjovanovic.tech/implementing-an-api-gateway-for-microservices-with-yarp.html","title":"Implementing an API Gateway For Microservices With YARP","lang":"ko-KR","frontmatter":{"lang":"ko-KR","title":"Implementing an API Gateway For Microservices With YARP","description":"Article(s) > Implementing an API Gateway For Microservices With YARP","icon":"iconfont icon-csharp","category":["C#","DotNet","Article(s)"],"tag":["blog","milanjovanovic.tech","cs","c#","csharp","dotnet"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Implementing an API Gateway For Microservices With YARP\\",\\"image\\":[\\"https://milanjovanovic.tech/blogs/mnw_045/reverse_proxy.png?imwidth=3840\\"],\\"datePublished\\":\\"2023-07-08T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Milan JovanoviÄ‡\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/implementing-an-api-gateway-for-microservices-with-yarp.html"}],["meta",{"property":"og:site_name","content":"ðŸ“šBookshelf"}],["meta",{"property":"og:title","content":"Implementing an API Gateway For Microservices With YARP"}],["meta",{"property":"og:description","content":"Article(s) > Implementing an API Gateway For Microservices With YARP"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://milanjovanovic.tech/blog-covers/mnw_045.png"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://milanjovanovic.tech/blog-covers/mnw_045.png"}],["meta",{"name":"twitter:image:alt","content":"Implementing an API Gateway For Microservices With YARP"}],["meta",{"property":"article:author","content":"Milan JovanoviÄ‡"}],["meta",{"property":"article:tag","content":"dotnet"}],["meta",{"property":"article:tag","content":"csharp"}],["meta",{"property":"article:tag","content":"c#"}],["meta",{"property":"article:tag","content":"cs"}],["meta",{"property":"article:tag","content":"milanjovanovic.tech"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2023-07-08T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Implementing an API Gateway For Microservices With YARP"},{"property":"og:description","content":"Implementing an API Gateway For Microservices With YARP"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/implementing-an-api-gateway-for-microservices-with-yarp.html"}]],"prev":"/programming/cs/articles/README.md","date":"2023-07-08T00:00:00.000Z","isOriginal":false,"author":"Milan JovanoviÄ‡","cover":"https://milanjovanovic.tech/blog-covers/mnw_045.png"},"git":{},"readingTime":{"minutes":5.24,"words":1572},"filePathRelative":"milanjovanovic.tech/implementing-an-api-gateway-for-microservices-with-yarp.md","copyright":{"author":"Milan JovanoviÄ‡"}}');export{S as comp,G as data};
