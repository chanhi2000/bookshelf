import{_ as d}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as m,d as s,f as e,b as o,t as k,n as v,g as f,w as p,e as a,r as l,o as h}from"./app-BItykJLQ.js";const b={},g={id:"frontmatter-title-á„€á…ªá†«á„…á…§á†«",tabindex:"-1"},y={class:"header-anchor",href:"#frontmatter-title-á„€á…ªá†«á„…á…§á†«"},w={class:"table-of-contents"},C={href:"https://learn.microsoft.com/en-us/aspnet/core/security/authorization/claims",target:"_blank",rel:"noopener noreferrer"},T={href:"https://microsoft.com/en-us/security/business/identity-access/microsoft-entra-id",target:"_blank",rel:"noopener noreferrer"},A={href:"https://auth0.com",target:"_blank",rel:"noopener noreferrer"},P={href:"https://en.wikipedia.org/wiki/Unified_Modeling_Language",target:"_blank",rel:"noopener noreferrer"},x={href:"https://en.wikipedia.org/wiki/Sequence_diagram",target:"_blank",rel:"noopener noreferrer"},I={href:"https://learn.microsoft.com/en-us/aspnet/core/security/authentication/claims#extend-or-add-custom-claims-using-iclaimstransformation",target:"_blank",rel:"noopener noreferrer"},S={href:"https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.authentication.iclaimstransformation",target:"_blank",rel:"noopener noreferrer"},z={href:"https://auth0.com/docs/manage-users/access-control/rbac",target:"_blank",rel:"noopener noreferrer"},q={href:"https://youtube.com/playlist?list=PLYpjLpq5ZDGtJOHUbv7KHuxtYLk1nJPw5",target:"_blank",rel:"noopener noreferrer"};function E(c,n){const r=l("VPCard"),i=l("router-link"),u=l("SiteInfo"),t=l("VPIcon");return h(),m("div",null,[s("h1",g,[s("a",y,[s("span",null,k(c.$frontmatter.title)+" ê´€ë ¨",1)])]),e(r,v(f({title:"C# > Article(s)",desc:"Article(s)",link:"/programming/cs/articles/README.md",logo:"https://chanhi2000.github.io/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",w,[s("ul",null,[s("li",null,[e(i,{to:"#how-does-claims-transformation-work"},{default:p(()=>[...n[0]||(n[0]=[a("How Does Claims Transformation Work?",-1)])]),_:1})]),s("li",null,[e(i,{to:"#simple-claims-transformation"},{default:p(()=>[...n[1]||(n[1]=[a("Simple Claims Transformation",-1)])]),_:1})]),s("li",null,[e(i,{to:"#implementing-rbac-with-claims-transformation"},{default:p(()=>[...n[2]||(n[2]=[a("Implementing RBAC With Claims Transformation",-1)])]),_:1})]),s("li",null,[e(i,{to:"#takeaway"},{default:p(()=>[...n[3]||(n[3]=[a("Takeaway",-1)])]),_:1})])])]),n[27]||(n[27]=s("hr",null,null,-1)),e(u,{name:"Master Claims Transformation for Flexible ASP.NET Core Authorization",desc:"Claims-based authorization mechanisms are central to modern authorization in ASP.NET Core. However, the access tokens issued by your Identity Provider (IDP) might not always perfectly align with your application's internal authorization needs. The solution? Claims transformation.",url:"https://milanjovanovic.tech/blog/master-claims-transformation-for-flexible-aspnetcore-authorization/",logo:"https://milanjovanovic.tech/profile_favicon.png",preview:"https://milanjovanovic.tech/blog-covers/mnw_084.png"}),s("p",null,[s("a",C,[e(t,{icon:"fa-brands fa-microsoft"}),n[4]||(n[4]=a("Claims-based authorization",-1))]),n[5]||(n[5]=a(" mechanisms are central to modern authorization in ASP.NET Core. However, the access tokens issued by your Identity Provider (IDP) might not always perfectly align with your application's internal authorization needs.",-1))]),s("p",null,[n[8]||(n[8]=a("External IDPs like ",-1)),s("a",T,[e(t,{icon:"fa-brands fa-microsoft"}),n[6]||(n[6]=a("Microsoft Entra ID",-1))]),n[9]||(n[9]=a(" (previously Azure AD) or ",-1)),s("a",A,[e(t,{icon:"fas fa-globe"}),n[7]||(n[7]=a("Auth0",-1))]),n[10]||(n[10]=a(" might have their own schema for claims or might not directly issue all the claims your application needs for its authorization logic.",-1))]),n[28]||(n[28]=o('<p>The solution? Claims transformation.</p><p>Claims transformation allows you to modify the claims before the application uses them for authorization.</p><p>In today&#39;s issue, we will:</p><ul><li>Explore the concept of claims transformation in ASP.NET Core</li><li>Explore the <code>IClaimsTransformation</code> interface with practical examples</li><li>Address considerations for security and RBAC (Role-Based Access Control)</li></ul><hr><h2 id="how-does-claims-transformation-work" tabindex="-1"><a class="header-anchor" href="#how-does-claims-transformation-work"><span>How Does Claims Transformation Work?</span></a></h2>',6)),s("p",null,[n[12]||(n[12]=a("They say a picture is worth a thousand words. In software engineering, we have something called ",-1)),s("a",P,[e(t,{icon:"fa-brands fa-wikipedia-w"}),n[11]||(n[11]=a("UML",-1))]),n[13]||(n[13]=a(" diagrams that we can use to paint a picture.",-1))]),s("p",null,[n[15]||(n[15]=a("Here's a ",-1)),s("a",x,[e(t,{icon:"fa-brands fa-wikipedia-w"}),n[14]||(n[14]=a("sequence diagram",-1))]),n[16]||(n[16]=a(" showing the claims transformation flow:",-1))]),n[29]||(n[29]=o('<ol><li>The user authenticates with the Identity Provider</li><li>The user calls the backend API and provides an access token</li><li>The backend API performs claims transformation and authorization</li><li>If the user is correctly authorized, the backend API returns a response</li></ol><figure><img src="https://milanjovanovic.tech/blogs/mnw_084/claims_transformation_sequence_diagram.png?imwidth=3840" alt="Claims transformation sequence diagram." tabindex="0" loading="lazy"><figcaption>Claims transformation sequence diagram.</figcaption></figure><p>Let&#39;s see how to implement this in ASP.NET Core.</p><hr><h2 id="simple-claims-transformation" tabindex="-1"><a class="header-anchor" href="#simple-claims-transformation"><span>Simple Claims Transformation</span></a></h2><p>Claims can be created from any user or identity data issued by a trusted identity provider. A claim is a name-value pair that represents the subject&#39;s identity, not what the subject can do.</p>',6)),s("p",null,[n[19]||(n[19]=a("The core of ",-1)),s("a",I,[e(t,{icon:"fa-brands fa-microsoft"}),n[17]||(n[17]=a("claims transformation",-1))]),n[20]||(n[20]=a(" in ASP.NET Core is the ",-1)),s("a",S,[e(t,{icon:"fa-brands fa-microsoft"}),n[18]||(n[18]=s("code",null,"IClaimsTransformation",-1))]),n[21]||(n[21]=a(" interface.",-1))]),n[30]||(n[30]=o(`<p>It exposes a single method to transform claims:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IClaimsTransformation</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ClaimsPrincipal<span class="token punctuation">&gt;</span></span> <span class="token function">TransformAsync</span><span class="token punctuation">(</span><span class="token class-name">ClaimsPrincipal</span> principal<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Here&#39;s a simple example of using <code>IClaimsTransformation</code> to add a custom claim:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">internal</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CustomClaims</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">internal</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> CardType <span class="token operator">=</span> <span class="token string">&quot;card_type&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">CustomClaimsTransformation</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IClaimsTransformation</span></span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ClaimsPrincipal<span class="token punctuation">&gt;</span></span> <span class="token function">TransformAsync</span><span class="token punctuation">(</span><span class="token class-name">ClaimsPrincipal</span> principal<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>principal<span class="token punctuation">.</span><span class="token function">HasClaim</span><span class="token punctuation">(</span>claim <span class="token operator">=&gt;</span> claim<span class="token punctuation">.</span>Type <span class="token operator">==</span> CustomClaims<span class="token punctuation">.</span>CardType<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>principal<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">ClaimsIdentity</span> claimsIdentity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClaimsIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        claimsIdentity<span class="token punctuation">.</span><span class="token function">AddClaim</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>CustomClaims<span class="token punctuation">.</span>CardType<span class="token punctuation">,</span> <span class="token string">&quot;platinum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        principal<span class="token punctuation">.</span><span class="token function">AddIdentity</span><span class="token punctuation">(</span>claimsIdentity<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> Task<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span>principal<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <code>CustomClaimsTransformation</code> class should be registered as a service:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line">builder<span class="token punctuation">.</span>Services</span>
<span class="line">    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddTransient</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IClaimsTransformation<span class="token punctuation">,</span> CustomClaimsTransformation<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Finally, you can define a custom authorization policy that uses this claim:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddAuthorization</span><span class="token punctuation">(</span>options <span class="token operator">=&gt;</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    options<span class="token punctuation">.</span><span class="token function">AddPolicy</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token string">&quot;HasPlatinumCard&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        builder <span class="token operator">=&gt;</span> builder</span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">RequireAuthenticatedUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">.</span><span class="token function">RequireClaim</span><span class="token punctuation">(</span>CustomClaims<span class="token punctuation">.</span>CardType<span class="token punctuation">,</span> <span class="token string">&quot;platinum&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>There are a few caveats with using <code>IClaimsTransformation</code> you should be aware of:</p><ul><li><strong>Might execute multiple times</strong>: The <code>TransformAsync</code> method might get called multiple times. Claims transformation should be idempotent to avoid adding the same claim multiple times to the <code>ClaimsPrincipal</code>.</li><li><strong>Potential performance impact</strong>: Since it&#39;s executed on authentication requests, be mindful of your transformation logic&#39;s performance, especially if it involves external calls (database, APIs). Consider caching where appropriate.</li></ul><hr><h2 id="implementing-rbac-with-claims-transformation" tabindex="-1"><a class="header-anchor" href="#implementing-rbac-with-claims-transformation"><span>Implementing RBAC With Claims Transformation</span></a></h2>`,12)),s("p",null,[s("a",z,[e(t,{icon:"fas fa-globe"}),n[22]||(n[22]=a("Role-Based Access Control (RBAC)",-1))]),n[23]||(n[23]=a(" is an authorization model where permissions are assigned to roles, and users are granted roles. Claims transformation helps implement RBAC smoothly. By adding role claims and potentially permission claims, authorization logic throughout your application can be implified. Another benefit is that you can keep the access token smaller and free of any role or permission claims.",-1))]),n[31]||(n[31]=o(`<p>Let&#39;s consider a scenario where your application manages resources at a granular level, but your identity provider only provides coarse-grained roles like <code>Registered</code> or <code>Member</code>. You could use claims transformation to map the <code>Member</code> role to specific fine-grained permissions like <code>SubmitOrder</code> and <code>PurchaseTicket</code>.</p><p>Here&#39;s a more complex <code>CustomClaimsTransformation</code> implementation. We send a database query using <code>GetUserPermissionsQuery</code> and get the <code>PermissionsResponse</code> back. The <code>PermissionsResponse</code> contains the user&#39;s permissions, which are added as custom claims.</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">CustomClaimsTransformation</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token class-name">IServiceProvider</span> serviceProvider<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">:</span> IClaimsTransformation</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>ClaimsPrincipal<span class="token punctuation">&gt;</span></span> <span class="token function">TransformAsync</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token class-name">ClaimsPrincipal</span> principal<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>principal<span class="token punctuation">.</span><span class="token function">HasClaim</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>Type <span class="token operator">==</span> CustomClaims<span class="token punctuation">.</span>Sub <span class="token operator">||</span></span>
<span class="line">                                    c<span class="token punctuation">.</span>Type <span class="token operator">==</span> CustomClaims<span class="token punctuation">.</span>Permission<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> principal<span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">using</span> <span class="token class-name">IServiceScope</span> scope <span class="token operator">=</span> serviceProvider<span class="token punctuation">.</span><span class="token function">CreateScope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">ISender</span> sender <span class="token operator">=</span> scope<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>ISender<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name"><span class="token keyword">string</span></span> identityId <span class="token operator">=</span> principal<span class="token punctuation">.</span><span class="token function">GetIdentityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">Result<span class="token punctuation">&lt;</span>PermissionsResponse<span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> sender<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GetUserPermissionsQuery</span><span class="token punctuation">(</span>identityId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>IsFailure<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClaimsAuthorizationException</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token keyword">nameof</span><span class="token punctuation">(</span>GetUserPermissionsQuery<span class="token punctuation">)</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>Error<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> claimsIdentity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ClaimsIdentity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        claimsIdentity<span class="token punctuation">.</span><span class="token function">AddClaim</span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>CustomClaims<span class="token punctuation">.</span>Sub<span class="token punctuation">,</span> result<span class="token punctuation">.</span>Value<span class="token punctuation">.</span>UserId<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> permission <span class="token keyword">in</span> result<span class="token punctuation">.</span>Value<span class="token punctuation">.</span>Permissions<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            claimsIdentity<span class="token punctuation">.</span><span class="token function">AddClaim</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Claim</span><span class="token punctuation">(</span>CustomClaims<span class="token punctuation">.</span>Permission<span class="token punctuation">,</span> permission<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        principal<span class="token punctuation">.</span><span class="token function">AddIdentity</span><span class="token punctuation">(</span>claimsIdentity<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> principal<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now that the <code>ClaimsPrincipal</code> contains the permissions as custom claims, you can do some interesting things. For example, you can implement a permission-based <code>AuthorizationHandler</code>:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">PermissionAuthorizationHandler</span></span>
<span class="line">    <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">AuthorizationHandler<span class="token punctuation">&lt;</span>PermissionRequirement<span class="token punctuation">&gt;</span></span></span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">HandleRequirementAsync</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token class-name">AuthorizationHandlerContext</span> context<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">PermissionRequirement</span> requirement<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line"><span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">&quot;code-line highlight-line&quot;</span><span class="token operator">&gt;</span>        <span class="token class-name">HashSet<span class="token punctuation">&lt;</span><span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> permissions <span class="token operator">=</span> context<span class="token punctuation">.</span>User<span class="token punctuation">.</span><span class="token function">GetPermissions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>permissions<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>requirement<span class="token punctuation">.</span>Permission<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            context<span class="token punctuation">.</span><span class="token function">Succeed</span><span class="token punctuation">(</span>requirement<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="takeaway" tabindex="-1"><a class="header-anchor" href="#takeaway"><span>Takeaway</span></a></h2><p>Claims transformation is an elegant way to bridge the gap between claims provided by identity providers and the needs of your ASP.NET Core application. The <code>IClaimsTransformation</code> interface enables you to customize the claims of the current <code>ClaimsPrincipal</code>. Whether you need to add roles, map external groups to internal permissions, or extract additional information from a user profile, claims transformation offers the flexibility to do so.</p><p>However, it&#39;s important to use claims transformation with a few key considerations in mind:</p><ul><li>Claims transformations are executed on each request.</li><li>The <code>IClaimsTransformation</code> should be idempotent. It should not add existing claims to the <code>ClaimsPrincipal</code> if executed multiple times.</li><li>Design your transformations efficiently, and consider caching the results if you&#39;re fetching external data to enrich your claims.</li></ul>`,10)),s("p",null,[n[25]||(n[25]=a("If you want to see a complete implementation of RBAC in ASP.NET Core, check out this ",-1)),s("a",q,[e(t,{icon:"fa-brands fa-youtube"}),n[24]||(n[24]=a("Authentication & Authorization playlist",-1))]),n[26]||(n[26]=a(".",-1))]),n[32]||(n[32]=s("p",null,"Hope this was helpful.",-1)),n[33]||(n[33]=s("p",null,"See you next week.",-1))])}const N=d(b,[["render",E]]),M=JSON.parse('{"path":"/milanjovanovic.tech/master-claims-transformation-for-flexible-aspnetcore-authorization.html","title":"Master Claims Transformation for Flexible ASP.NET Core Authorization","lang":"ko-KR","frontmatter":{"lang":"ko-KR","title":"Master Claims Transformation for Flexible ASP.NET Core Authorization","description":"Article(s) > Master Claims Transformation for Flexible ASP.NET Core Authorization","icon":"iconfont icon-csharp","category":["C#","DotNet","Article(s)"],"tag":["blog","milanjovanovic.tech","cs","c#","csharp","dotnet"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Master Claims Transformation for Flexible ASP.NET Core Authorization\\",\\"image\\":[\\"https://milanjovanovic.tech/blogs/mnw_084/claims_transformation_sequence_diagram.png?imwidth=3840\\"],\\"datePublished\\":\\"2024-04-06T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Milan JovanoviÄ‡\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/master-claims-transformation-for-flexible-aspnetcore-authorization.html"}],["meta",{"property":"og:site_name","content":"ðŸ“šBookshelf"}],["meta",{"property":"og:title","content":"Master Claims Transformation for Flexible ASP.NET Core Authorization"}],["meta",{"property":"og:description","content":"Article(s) > Master Claims Transformation for Flexible ASP.NET Core Authorization"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://milanjovanovic.tech/blog-covers/mnw_084.png"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://milanjovanovic.tech/blog-covers/mnw_084.png"}],["meta",{"name":"twitter:image:alt","content":"Master Claims Transformation for Flexible ASP.NET Core Authorization"}],["meta",{"property":"article:author","content":"Milan JovanoviÄ‡"}],["meta",{"property":"article:tag","content":"dotnet"}],["meta",{"property":"article:tag","content":"csharp"}],["meta",{"property":"article:tag","content":"c#"}],["meta",{"property":"article:tag","content":"cs"}],["meta",{"property":"article:tag","content":"milanjovanovic.tech"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2024-04-06T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Master Claims Transformation for Flexible ASP.NET Core Authorization"},{"property":"og:description","content":"Master Claims Transformation for Flexible ASP.NET Core Authorization"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/master-claims-transformation-for-flexible-aspnetcore-authorization.html"}]],"prev":"/programming/cs/articles/README.md","date":"2024-04-06T00:00:00.000Z","isOriginal":false,"author":"Milan JovanoviÄ‡","cover":"https://milanjovanovic.tech/blog-covers/mnw_084.png"},"git":{},"readingTime":{"minutes":3.88,"words":1165},"filePathRelative":"milanjovanovic.tech/master-claims-transformation-for-flexible-aspnetcore-authorization.md","copyright":{"author":"Milan JovanoviÄ‡"}}');export{N as comp,M as data};
