import{_ as v}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as b,d as s,f as e,b as l,a as g,t as h,n as u,g as d,w as t,e as a,r as i,o as y}from"./app-BVguHYKu.js";const w={},f={id:"frontmatter-title-관련",tabindex:"-1"},x={class:"header-anchor",href:"#frontmatter-title-관련"},O={class:"table-of-contents"},T={href:"https://cloudcomputingpatterns.org/at_least_once_delivery/",target:"_blank",rel:"noopener noreferrer"},I={href:"https://microservices.io/patterns/data/transaction-log-tailing.html",target:"_blank",rel:"noopener noreferrer"},E={href:"https://npgsql.org/doc/replication.html",target:"_blank",rel:"noopener noreferrer"};function P(m,n){const r=i("VPCard"),p=i("router-link"),k=i("SiteInfo"),o=i("RouteLink"),c=i("VPIcon");return y(),b("div",null,[s("h1",f,[s("a",x,[s("span",null,h(m.$frontmatter.title)+" 관련",1)])]),e(r,u(d({title:"C# > Article(s)",desc:"Article(s)",link:"/programming/cs/articles/README.md",logo:"https://chanhi2000.github.io/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",O,[s("ul",null,[s("li",null,[e(p,{to:"#why-do-we-need-the-outbox-pattern"},{default:t(()=>n[0]||(n[0]=[a("Why Do We Need the Outbox Pattern?")])),_:1,__:[0]})]),s("li",null,[e(p,{to:"#implementing-the-outbox-pattern"},{default:t(()=>n[1]||(n[1]=[a("Implementing the Outbox Pattern")])),_:1,__:[1]})]),s("li",null,[e(p,{to:"#processing-the-outbox"},{default:t(()=>n[2]||(n[2]=[a("Processing the Outbox")])),_:1,__:[2]})]),s("li",null,[e(p,{to:"#considerations-and-tradeoffs"},{default:t(()=>n[3]||(n[3]=[a("Considerations and Tradeoffs")])),_:1,__:[3]})]),s("li",null,[e(p,{to:"#scaling-outbox-processing"},{default:t(()=>n[4]||(n[4]=[a("Scaling Outbox Processing")])),_:1,__:[4]})]),s("li",null,[e(p,{to:"#wrapping-up"},{default:t(()=>n[5]||(n[5]=[a("Wrapping Up")])),_:1,__:[5]})])])]),n[34]||(n[34]=s("hr",null,null,-1)),e(k,{name:"Implementing the Outbox Pattern",desc:"Discover how the Outbox pattern solves the dual-write problem in distributed systems, ensuring data consistency between your database and external components. This article provides practical strategies for implementing and scaling the Outbox pattern in .NET applications.",url:"https://milanjovanovic.tech/blog/implementing-the-outbox-pattern",logo:"https://milanjovanovic.tech/profile_favicon.png",preview:"https://milanjovanovic.tech/blog-covers/mnw_110.png"}),n[35]||(n[35]=s("p",null,"In distributed systems, we often face the challenge of keeping our database and external systems in sync. Imagine saving an order to a database and then publishing a message to a message broker. If either operation fails, your system ends up in an inconsistent state.",-1)),s("p",null,[n[7]||(n[7]=a("The ")),e(o,{to:"/milanjovanovic.tech/outbox-pattern-for-reliable-microservices-messaging.html"},{default:t(()=>n[6]||(n[6]=[a("Outbox pattern")])),_:1,__:[6]}),n[8]||(n[8]=a(" solves this problem by treating message publication as part of your database transaction. Instead of publishing messages directly, we save them to an Outbox table in our database, ensuring atomic operations. A separate process then reliably publishes these messages."))]),n[36]||(n[36]=l(`<p>In this newsletter, we&#39;ll dive into implementing this pattern in .NET, covering everything from setup to scaling.</p><hr><h2 id="why-do-we-need-the-outbox-pattern" tabindex="-1"><a class="header-anchor" href="#why-do-we-need-the-outbox-pattern"><span>Why Do We Need the Outbox Pattern?</span></a></h2><p>The transactional Outbox pattern fixes a common problem in distributed systems. This problem happens when you need to do two things at once: save data and communicate with an external component.</p><p>Consider scenarios like sending order confirmation emails, notifying other systems about new client registrations, or updating inventory levels after an order is placed. Each of these involves a local data change coupled with an external communication or update.</p><p>For example, imagine a microservice that needs to:</p><ul><li>Save a new order in its database</li><li>Tell other systems about this new order</li></ul><p>If one of these steps fails, your system could end up in an inconsistent state. Maybe the order is saved, but no one else knows about it. Or everyone thinks there&#39;s a new order, but it&#39;s not actually in the database.</p><p>Here&#39;s a <code>CreateOrderCommandHandler</code> without the Outbox pattern:</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="CreateOrderCommandHandler.cs"><span>CreateOrderCommandHandler.cs</span></div><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateOrderCommandHandler</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token class-name">IOrderRepository</span> orderRepository<span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">IProductInventoryChecker</span> inventoryChecker<span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">IUnitOfWork</span> unitOfWork<span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">IEventBus</span> eventBus<span class="token punctuation">)</span> <span class="token punctuation">:</span> IRequestHandler<span class="token operator">&lt;</span>CreateOrderCommand<span class="token punctuation">,</span> OrderDto<span class="token operator">&gt;</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>OrderDto<span class="token punctuation">&gt;</span></span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">CreateOrderCommand</span> request<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> cancellationToken<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Order</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>CustomerId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>ProductId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>Quantity<span class="token punctuation">,</span> inventoryChecker<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">await</span> orderRepository<span class="token punctuation">.</span><span class="token function">AddAsync</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">await</span> unitOfWork<span class="token punctuation">.</span><span class="token function">CommitAsync</span><span class="token punctuation">(</span>cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// The database transaction is completed at this point.</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">await</span> eventBus<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrderCreatedIntegrationEvent</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OrderDto</span> <span class="token punctuation">{</span> Id <span class="token operator">=</span> order<span class="token punctuation">.</span>Id<span class="token punctuation">,</span> Total <span class="token operator">=</span> order<span class="token punctuation">.</span>Total <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>This code has a potential consistency problem. After the database transaction is committed, two things could go wrong:</p><ol><li>The application might crash right after the transaction is committed but before the event is sent. The order would be created in the database, but other systems wouldn&#39;t know about it.</li><li>The event bus might be down or unreachable when we try to send the event. This would result in the order being created without notifying other systems.</li></ol><p>The transactional Outbox pattern helps solve this problem by ensuring that the database update and event publication are treated as a single atomic operation.</p><figure><img src="https://milanjovanovic.tech/blogs/mnw_110/outbox_pattern.png?imwidth=3840" alt="Flow diagram explaining how the Outbox Pattern works." tabindex="0" loading="lazy"><figcaption>Flow diagram explaining how the Outbox Pattern works.</figcaption></figure><p>The sequence diagram illustrates how the Outbox pattern solves our consistency challenge. Instead of trying to save data and send a message as separate steps, we save both the order and an Outbox message in a <strong>single database transaction</strong>. This is an all-or-nothing operation - we can&#39;t end up in an inconsistent state.</p><p>A separate Outbox processor handles the actual message sending. It continuously checks for unsent messages in the Outbox table and publishes them to the message queue. The processor marks messages as sent after successful publishing, preventing duplicates.</p>`,16)),s("p",null,[n[10]||(n[10]=a("An important thing to realize here is that the Outbox pattern gives us ")),s("a",T,[e(c,{icon:"fas fa-globe"}),n[9]||(n[9]=a("at-least-once delivery"))]),n[11]||(n[11]=a(". The Outbox message will be sent at least once, but it could also be sent multiple times in case of retries. This means we have to make our message consumers idempotent."))]),n[37]||(n[37]=l(`<hr><h2 id="implementing-the-outbox-pattern" tabindex="-1"><a class="header-anchor" href="#implementing-the-outbox-pattern"><span>Implementing the Outbox Pattern</span></a></h2><p>First, let&#39;s create our Outbox table where we will store messages:</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> outbox_messages <span class="token punctuation">(</span></span>
<span class="line">    id UUID <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token keyword">type</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    content JSONB <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    occurred_on_utc <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    processed_on_utc <span class="token keyword">TIMESTAMP</span> <span class="token keyword">WITH</span> <span class="token keyword">TIME</span> ZONE <span class="token boolean">NULL</span><span class="token punctuation">,</span></span>
<span class="line">    error <span class="token keyword">TEXT</span> <span class="token boolean">NULL</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">-- We can consider adding this index since we will be querying for unprocessed messages often</span></span>
<span class="line"><span class="token comment">-- and it will contain the rows in the correct sort order for our query.</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> idx_outbox_messages_unprocessed</span>
<span class="line"><span class="token keyword">ON</span> outbox_messages <span class="token punctuation">(</span>occurred_on_utc<span class="token punctuation">,</span> processed_on_utc<span class="token punctuation">)</span></span>
<span class="line">INCLUDE <span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token punctuation">,</span> content<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">WHERE</span> processed_on_utc <span class="token operator">IS</span> <span class="token boolean">NULL</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>I&#39;ll use PostgreSQL as the database for this example. Notice the <code>jsonb</code> type for the <code>content</code> column. It allows for indexing and querying of the JSON data if needed in the future.</p><p>Now, let&#39;s create a class to represent our Outbox entry:</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="OutboxMessage.cs"><span>OutboxMessage.cs</span></div><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">OutboxMessage</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Type <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Content <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> OccurredOnUtc <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime<span class="token punctuation">?</span></span> ProcessedOnUtc <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span><span class="token punctuation">?</span></span> Error <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>Here&#39;s how we can add a message to the Outbox:</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="AddToOutbox.cs"><span>AddToOutbox.cs</span></div><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token generic-method"><span class="token function">AddToOutbox</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name">T</span> message<span class="token punctuation">,</span> <span class="token class-name">NpgsqlDataSource</span> dataSource<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name"><span class="token keyword">var</span></span> outboxMessage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OutboxMessage</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        Id <span class="token operator">=</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">        OccurredOnUtc <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span></span>
<span class="line">        Type <span class="token operator">=</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">.</span>FullName<span class="token punctuation">,</span> <span class="token comment">// We&#39;ll need this for deserialization</span></span>
<span class="line">        Content <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">await</span> <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> connection <span class="token operator">=</span> <span class="token keyword">await</span> dataSource<span class="token punctuation">.</span><span class="token function">OpenConnectionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token string">@&quot;&quot;&quot;</span>
<span class="line">        INSERT INTO outbox_messages (id, occurred_on_utc, type, content)</span>
<span class="line">        VALUES (@Id, @OccurredOnUtc, @Type, @Content::jsonb)</span>
<span class="line">        &quot;&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">        outboxMessage<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>`,9)),s("p",null,[n[14]||(n[14]=a("An elegant approach to implementing this is using ")),e(o,{to:"/milanjovanovic.tech/how-to-use-domain-events-to-build-loosely-coupled-systems.html"},{default:t(()=>n[12]||(n[12]=[a("domain events")])),_:1,__:[12]}),n[15]||(n[15]=a(" to represent notifications. When something significant happens in the domain, we will raise a domain event. Before completing the transaction, we can pick up all events and store them as Outbox messages. You could do this from the unit of work or with an ")),e(o,{to:"/milanjovanovic.tech/how-to-use-ef-core-interceptors.html"},{default:t(()=>n[13]||(n[13]=[a("EF Core interceptor")])),_:1,__:[13]}),n[16]||(n[16]=a("."))]),n[38]||(n[38]=s("hr",null,null,-1)),n[39]||(n[39]=s("h2",{id:"processing-the-outbox",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#processing-the-outbox"},[s("span",null,"Processing the Outbox")])],-1)),n[40]||(n[40]=s("p",null,[a("The Outbox processor is the next component we'll need. This could be a "),s("em",null,"physically"),a(" separate process or a background worker in the same process.")],-1)),s("p",null,[n[18]||(n[18]=a("I'll use Quartz to ")),e(o,{to:"/milanjovanovic.tech/scheduling-background-jobs-with-quartz-net.html"},{default:t(()=>n[17]||(n[17]=[a("schedule background jobs")])),_:1,__:[17]}),n[19]||(n[19]=a(" for Outbox processing. It's a robust library with excellent support for scheduling recurring jobs."))]),n[41]||(n[41]=l(`<p>Now, let&#39;s implement the <code>OutboxProcessorJob</code>:</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="OutboxProcessorJob.cs"><span>OutboxProcessorJob.cs</span></div><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">DisallowConcurrentExecution</span></span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OutboxProcessorJob</span><span class="token punctuation">(</span></span>
<span class="line">    <span class="token class-name">NpgsqlDataSource</span> dataSource<span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">IPublishEndpoint</span> publishEndpoint<span class="token punctuation">,</span></span>
<span class="line">    <span class="token class-name">Assembly</span> integrationEventsAssembly<span class="token punctuation">)</span> <span class="token punctuation">:</span> IJob</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token class-name">IJobExecutionContext</span> context<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> connection <span class="token operator">=</span> <span class="token keyword">await</span> dataSource<span class="token punctuation">.</span><span class="token function">OpenConnectionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">await</span> <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> transaction <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">BeginTransactionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// You can make the limit a parameter, to control the batch size.</span></span>
<span class="line">        <span class="token comment">// We can also select just the id, type, and content columns.</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> messages <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">QueryAsync</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OutboxMessage<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span></span>
<span class="line">            <span class="token string">@&quot;&quot;&quot;</span>
<span class="line">            SELECT id AS Id, type AS Type, content AS Content</span>
<span class="line">            FROM outbox_messages</span>
<span class="line">            WHERE processed_on_utc IS NULL</span>
<span class="line">            ORDER BY occurred_on_utc LIMIT 100</span>
<span class="line">            &quot;&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">            <span class="token named-parameter punctuation">transaction</span><span class="token punctuation">:</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> message <span class="token keyword">in</span> messages<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">try</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token class-name"><span class="token keyword">var</span></span> messageType <span class="token operator">=</span> integrationEventsAssembly<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Type<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">                <span class="token class-name"><span class="token keyword">var</span></span> deserializedMessage <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token function">Deserialize</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>Content<span class="token punctuation">,</span> messageType<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token comment">// We should introduce retries here to improve reliability.</span></span>
<span class="line">                <span class="token keyword">await</span> publishEndpoint<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span>deserializedMessage<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">                <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span></span>
<span class="line">                    <span class="token string">@&quot;&quot;&quot;</span>
<span class="line">                    UPDATE outbox_messages</span>
<span class="line">                    SET processed_on_utc = @ProcessedOnUtc</span>
<span class="line">                    WHERE id = @Id</span>
<span class="line">                    &quot;&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token keyword">new</span> <span class="token punctuation">{</span> ProcessedOnUtc <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span> message<span class="token punctuation">.</span>Id <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token named-parameter punctuation">transaction</span><span class="token punctuation">:</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span></span>
<span class="line">            <span class="token punctuation">{</span></span>
<span class="line">                <span class="token comment">// We can also introduce error logging here.</span></span>
<span class="line"></span>
<span class="line">                <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span></span>
<span class="line">                    <span class="token string">@&quot;&quot;&quot;</span>
<span class="line">                    UPDATE outbox_messages</span>
<span class="line">                    SET processed_on_utc = @ProcessedOnUtc, error = @Error</span>
<span class="line">                    WHERE id = @Id</span>
<span class="line">                    &quot;&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token keyword">new</span> <span class="token punctuation">{</span> ProcessedOnUtc <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">,</span> Error <span class="token operator">=</span> ex<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>Id <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">                    <span class="token named-parameter punctuation">transaction</span><span class="token punctuation">:</span> transaction<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">await</span> transaction<span class="token punctuation">.</span><span class="token function">CommitAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>This approach uses polling to periodically fetch unprocessed messages from the database. Polling can increase the load on the database, as we&#39;ll need to query for unprocessed messages frequently.</p>`,3)),s("p",null,[n[22]||(n[22]=a("An alternative way to process Outbox messages is by using ")),s("a",I,[e(c,{icon:"fas fa-globe"}),n[20]||(n[20]=a("Transaction log tailing"))]),n[23]||(n[23]=a(". We can implement this using ")),s("a",E,[e(c,{icon:"fas fa-globe"}),n[21]||(n[21]=a("Postgres logical replication"))]),n[24]||(n[24]=a(". The database will stream changes from the Write-Ahead Log (WAL) to our application, and we'll process these messages and publish them to the message broker. You can use this to implement a push-based Outbox processor."))]),n[42]||(n[42]=s("hr",null,null,-1)),n[43]||(n[43]=s("h2",{id:"considerations-and-tradeoffs",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#considerations-and-tradeoffs"},[s("span",null,"Considerations and Tradeoffs")])],-1)),n[44]||(n[44]=s("p",null,"The Outbox pattern, while effective, introduces additional complexity and database writes. In high-throughput systems, it's crucial to monitor its performance to ensure it doesn't become a bottleneck.",-1)),s("p",null,[n[26]||(n[26]=a("I recommend implementing retry mechanisms in the Outbox processor to ")),e(o,{to:"/milanjovanovic.tech/building-resilient-cloud-applications-with-dotnet.html"},{default:t(()=>n[25]||(n[25]=[a("improve reliability")])),_:1,__:[25]}),n[27]||(n[27]=a(". Consider using exponential backoff for transient failures and a circuit breaker for persistent issues to prevent system overload during outages."))]),s("p",null,[n[29]||(n[29]=a("It's essential that you implement ")),e(o,{to:"/milanjovanovic.tech/idempotent-consumer-handling-duplicate-messages.html"},{default:t(()=>n[28]||(n[28]=[a("idempotent message consumers")])),_:1,__:[28]}),n[30]||(n[30]=a(". Network issues or processor restarts can lead to multiple deliveries of the same message, so your consumers must handle repeated processing safely."))]),n[45]||(n[45]=l('<p>Over time, the Outbox table can grow significantly, potentially impacting database performance. It&#39;s important to implement an archiving strategy early on. Consider moving processed messages to cold storage or deleting them after a set period.</p><hr><h2 id="scaling-outbox-processing" tabindex="-1"><a class="header-anchor" href="#scaling-outbox-processing"><span>Scaling Outbox Processing</span></a></h2><p>As your system grows, you may find that a single Outbox processor can&#39;t keep up with the volume of messages. This can lead to increased latency between when an event occurs and when it&#39;s processed by consumers.</p><p>One straightforward approach is to increase the frequency of the Outbox processor job. You should consider running it every few seconds. This can significantly reduce the delay in message processing.</p><p>Another effective strategy is to increase the batch size when fetching unprocessed messages. By processing more messages in each run, you can improve throughput. However, be cautious not to make the batches so large that they cause long-running transactions.</p><p>For high-volume systems, processing the Outbox in parallel can be very effective. Implement a locking mechanism to claim batches of messages, allowing multiple processors to work simultaneously without conflict. You can use <code>SELECT ... FOR UPDATE SKIP LOCKED</code> to claim a batch of messages. This approach can dramatically increase your processing capacity.</p><hr><h2 id="wrapping-up" tabindex="-1"><a class="header-anchor" href="#wrapping-up"><span>Wrapping Up</span></a></h2><p>The Outbox pattern is a powerful tool for maintaining data consistency in distributed systems. By decoupling database operations from message publishing, the Outbox pattern ensures that your system remains reliable even in the face of failures.</p><p>Remember to keep your consumers idempotent, implement proper scaling strategies, and manage your Outbox table growth.</p><p>While it adds some complexity, the benefits of guaranteed message delivery make it a valuable pattern in many scenarios.</p>',12)),s("p",null,[n[32]||(n[32]=a("If you're looking to implement the Outbox pattern in a robust, production-ready way, you can check out ")),e(o,{to:"/milanjovanovic.tech/pragmatic-clean-architecture/"},{default:t(()=>n[31]||(n[31]=[a("Pragmatic Clean Architecture")])),_:1,__:[31]}),n[33]||(n[33]=a(". It includes an entire section on implementing the Outbox pattern, along with other essential patterns for building maintainable and scalable .NET applications."))]),n[46]||(n[46]=s("p",null,"That's all for today. Stay awesome, and I'll see you next week.",-1)),n[47]||(n[47]=s("hr",null,null,-1)),g(" TODO: add ARTICLE CARD "),e(r,u(d({title:"Implementing the Outbox Pattern",desc:"Discover how the Outbox pattern solves the dual-write problem in distributed systems, ensuring data consistency between your database and external components. This article provides practical strategies for implementing and scaling the Outbox pattern in .NET applications.",link:"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/implementing-the-outbox-pattern.html",logo:"https://milanjovanovic.tech/profile_favicon.png",background:"rgba(79,70,229,0.2)"})),null,16)])}const q=v(w,[["render",P]]),N=JSON.parse('{"path":"/milanjovanovic.tech/implementing-the-outbox-pattern.html","title":"Implementing the Outbox Pattern","lang":"en-US","frontmatter":{"lang":"en-US","title":"Implementing the Outbox Pattern","description":"Article(s) > Implementing the Outbox Pattern","icon":"iconfont icon-csharp","category":["C#","DotNet","Article(s)"],"tag":["blog","milanjovanovic.tech","cs","c#","csharp","dotnet"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Implementing the Outbox Pattern\\",\\"image\\":[\\"https://milanjovanovic.tech/blogs/mnw_110/outbox_pattern.png?imwidth=3840\\"],\\"datePublished\\":\\"2024-10-05T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Milan Jovanović\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/implementing-the-outbox-pattern.html"}],["meta",{"property":"og:site_name","content":"📚Bookshelf"}],["meta",{"property":"og:title","content":"Implementing the Outbox Pattern"}],["meta",{"property":"og:description","content":"Article(s) > Implementing the Outbox Pattern"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://milanjovanovic.tech/blog-covers/mnw_110.png"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://milanjovanovic.tech/blog-covers/mnw_110.png"}],["meta",{"name":"twitter:image:alt","content":"Implementing the Outbox Pattern"}],["meta",{"property":"article:author","content":"Milan Jovanović"}],["meta",{"property":"article:tag","content":"dotnet"}],["meta",{"property":"article:tag","content":"csharp"}],["meta",{"property":"article:tag","content":"c#"}],["meta",{"property":"article:tag","content":"cs"}],["meta",{"property":"article:tag","content":"milanjovanovic.tech"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2024-10-05T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Implementing the Outbox Pattern"},{"property":"og:description","content":"Implementing the Outbox Pattern"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/implementing-the-outbox-pattern.html"}]],"prev":"/programming/cs/articles/README.md","date":"2024-10-05T00:00:00.000Z","isOriginal":false,"author":"Milan Jovanović","cover":"https://milanjovanovic.tech/blog-covers/mnw_110.png"},"git":{},"readingTime":{"minutes":6.35,"words":1906},"filePathRelative":"milanjovanovic.tech/implementing-the-outbox-pattern.md","copyright":{"author":"Milan Jovanović"}}');export{q as comp,N as data};
