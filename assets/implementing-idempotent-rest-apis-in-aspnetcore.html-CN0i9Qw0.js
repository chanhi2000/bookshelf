import{_ as v}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as h,d as s,f as a,b as u,a as b,t as y,n as c,g as l,w as t,e,r as o,o as g}from"./app-BItykJLQ.js";const w={},f={id:"frontmatter-title-관련",tabindex:"-1"},I={class:"header-anchor",href:"#frontmatter-title-관련"},A={class:"table-of-contents"},T={href:"https://rfc-editor.org/rfc/rfc9110",target:"_blank",rel:"noopener noreferrer"},C={class:"hint-container info"},S={class:"hint-container info"},P={class:"hint-container note"};function R(r,n){const i=o("VPCard"),p=o("router-link"),d=o("SiteInfo"),k=o("VPIcon"),m=o("RouteLink");return g(),h("div",null,[s("h1",f,[s("a",I,[s("span",null,y(r.$frontmatter.title)+" 관련",1)])]),a(i,c(l({title:"C# > Article(s)",desc:"Article(s)",link:"/programming/cs/articles/README.md",logo:"https://chanhi2000.github.io/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",A,[s("ul",null,[s("li",null,[a(p,{to:"#what-is-idempotence"},{default:t(()=>[...n[0]||(n[0]=[e("What is Idempotence?",-1)])]),_:1})]),s("li",null,[a(p,{to:"#which-http-methods-are-idempotent"},{default:t(()=>[...n[1]||(n[1]=[e("Which HTTP Methods are Idempotent?",-1)])]),_:1})]),s("li",null,[a(p,{to:"#implementing-idempotency-in-asp-net-core"},{default:t(()=>[...n[2]||(n[2]=[e("Implementing Idempotency in ASP.NET Core",-1)])]),_:1}),s("ul",null,[s("li",null,[a(p,{to:"#idempotency-with-minimal-apis"},{default:t(()=>[...n[3]||(n[3]=[e("Idempotency with Minimal APIs",-1)])]),_:1})])])]),s("li",null,[a(p,{to:"#best-practices-and-considerations"},{default:t(()=>[...n[4]||(n[4]=[e("Best Practices and Considerations",-1)])]),_:1})]),s("li",null,[a(p,{to:"#summary"},{default:t(()=>[...n[5]||(n[5]=[e("Summary",-1)])]),_:1})])])]),n[19]||(n[19]=s("hr",null,null,-1)),a(d,{name:"Implementing Idempotent REST APIs in ASP.NET Core",desc:"Learn how to implement idempotency in ASP.NET Core Web APIs to improve reliability and prevent duplicate operations in distributed systems.",url:"https://milanjovanovic.tech/blog/implementing-idempotent-rest-apis-in-aspnetcore",logo:"https://milanjovanovic.tech/profile_favicon.png",preview:"https://milanjovanovic.tech/blog-covers/mnw_113.png"}),n[20]||(n[20]=u('<p>Idempotency is a crucial concept for REST APIs that ensures the reliability and consistency of your system. An idempotent operation can be repeated multiple times without changing the result beyond the initial API request. This property is especially important in distributed systems, where network failures or timeouts can lead to repeated requests.</p><p>Implementing idempotency in your API brings several benefits:</p><ul><li>It prevents unintended duplicate operations</li><li>It improves reliability in distributed systems</li><li>It helps handle network issues and retries gracefully</li></ul><p>In this week&#39;s issue, we&#39;ll explore how to implement idempotency in ASP.NET Core APIs, ensuring your system remains robust and reliable.</p><hr><h2 id="what-is-idempotence" tabindex="-1"><a class="header-anchor" href="#what-is-idempotence"><span>What is Idempotence?</span></a></h2><p>Idempotence, in the context of web APIs, means that making multiple identical requests should have the same effect as making a single request. In other words, no matter how many times a client sends the same request, the server-side effect should only occur once.</p>',7)),s("p",null,[n[7]||(n[7]=e("The ",-1)),s("a",T,[a(k,{icon:"fas fa-globe"}),n[6]||(n[6]=e("RFC 9110",-1))]),n[8]||(n[8]=e(" standard about HTTP Semantics offers a definition we could use. Here's what it says about ",-1)),n[9]||(n[9]=s("strong",null,"idempotent methods",-1)),n[10]||(n[10]=e(":",-1))]),s("div",C,[n[11]||(n[11]=s("p",{class:"hint-container-title"},"RFC 9110 (HTTP Semantics), Section 9.2.2, Paragraph 1",-1)),n[12]||(n[12]=s("blockquote",null,[s("p",null,'A request method is considered "idempotent" if the intended effect on the server of multiple identical requests with that method is the same as the effect for a single such request.'),s("p",null,"Of the request methods defined by this specification, PUT, DELETE, and safe request methods [(GET, HEAD, OPTIONS, and TRACE) - author's note] are idempotent.")],-1)),a(i,c(l({title:"RFC 9110: HTTP Semantics",desc:"",link:"https://rfc-editor.org/rfc/rfc9110#section-9.2.2-1/",logo:"https://rfc-editor.org/wp-content/uploads/favicon-1.ico",background:"rgba(227,227,227,0.2)"})),null,16)]),n[21]||(n[21]=s("p",null,`However, the following paragraph is quite interesting. It clarifies that the server can implement "other non-idempotent side effects" that don't apply to the resource.`,-1)),s("div",S,[n[13]||(n[13]=s("p",{class:"hint-container-title"},"RFC 9110 (HTTP Semantics), Section 9.2.2, Paragraph 2",-1)),n[14]||(n[14]=s("blockquote",null,[s("p",null,"... the idempotent property only applies to what has been requested by the user; a server is free to log each request separately, retain a revision control history, or implement other non-idempotent side effects for each idempotent request.")],-1)),a(i,c(l({title:"RFC 9110: HTTP Semantics",desc:"",link:"https://rfc-editor.org/rfc/rfc9110#section-9.2.2-2/",logo:"https://rfc-editor.org/wp-content/uploads/favicon-1.ico",background:"rgba(227,227,227,0.2)"})),null,16)]),n[22]||(n[22]=u(`<p>The benefits of implementing idempotency extend beyond just adhering to HTTP method semantics. It significantly improves the reliability of your API, especially in distributed systems where network issues can lead to retried requests. By implementing idempotency, you prevent duplicate operations that could occur due to client retries.</p><hr><h2 id="which-http-methods-are-idempotent" tabindex="-1"><a class="header-anchor" href="#which-http-methods-are-idempotent"><span>Which HTTP Methods are Idempotent?</span></a></h2><p>Several HTTP methods are inherently idempotent:</p><ul><li><code>GET</code>, <code>HEAD</code>: Retrieve data without modifying the server state.</li><li><code>PUT</code>: Update a resource, resulting in the same state regardless of repetition.</li><li><code>DELETE</code>: Remove a resource with the same outcome for multiple requests.</li><li><code>OPTIONS</code>: Retrieve communication options information.</li></ul><p><code>POST</code> is not inherently idempotent, as it typically creates resources or processes data. Repeated <code>POST</code> requests could create multiple resources or trigger multiple actions.</p><p>However, we can implement idempotency for <code>POST</code> methods using custom logic.</p><div class="hint-container note"><p class="hint-container-title">Note</p><p>While <code>POST</code> requests aren&#39;t naturally idempotent, we can design them to be. For example, checking for existing resources before creation ensures that repeated <code>POST</code> requests don&#39;t result in duplicate actions or resources.</p></div><hr><h2 id="implementing-idempotency-in-asp-net-core" tabindex="-1"><a class="header-anchor" href="#implementing-idempotency-in-asp-net-core"><span>Implementing Idempotency in ASP.NET Core</span></a></h2><p>To implement idempotency, we&#39;ll use a strategy involving idempotency keys:</p><ol><li>The client generates a unique key for each operation and sends it in a custom header.</li><li>The server checks if it has seen this key before: <ul><li>For a new key, process the request and store the result.</li><li>For a known key, return the stored result without reprocessing.</li></ul></li></ol><p>This ensures that retried requests (e.g., due to network issues) are processed only once on the server.</p><p>We can implement idempotency for controllers by combining an <code>Attribute</code> and <code>IAsyncActionFilter</code>. Now, we can specify the <code>IdempotentAttribute</code> to apply idempotency to a controller endpoint.</p><div class="hint-container note"><p class="hint-container-title">Note</p><p>When a request fails (returns 4xx/5xx), we don&#39;t cache the response. This allows clients to retry with the same idempotency key. However, this means a failed request followed by a successful one with the same key will succeed - make sure this aligns with your business requirements.</p></div><div class="code-block-with-title"><div class="code-block-title-bar" data-title="IdempotentAttribute.cs"><span>IdempotentAttribute.cs</span></div><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">AttributeUsage</span><span class="token attribute-arguments"><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>Method<span class="token punctuation">)</span></span></span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentAttribute</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Attribute</span><span class="token punctuation">,</span> <span class="token class-name">IAsyncActionFilter</span></span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> DefaultCacheTimeInMinutes <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">TimeSpan</span> _cacheDuration<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">IdempotentAttribute</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> cacheTimeInMinutes <span class="token operator">=</span> DefaultCacheTimeInMinutes<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        _cacheDuration <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span>minutes<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">OnActionExecutionAsync</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token class-name">ActionExecutingContext</span> context<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">ActionExecutionDelegate</span> next<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Parse the Idempotence-Key header from the request</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>HttpContext<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>Headers<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span></span>
<span class="line">                <span class="token string">&quot;Idempotence-Key&quot;</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token keyword">out</span> <span class="token class-name">StringValues</span> idempotenceKeyValue<span class="token punctuation">)</span> <span class="token operator">||</span></span>
<span class="line">            <span class="token operator">!</span>Guid<span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>idempotenceKeyValue<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name">Guid</span> idempotenceKey<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            context<span class="token punctuation">.</span>Result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">BadRequestObjectResult</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid or missing Idempotence-Key header&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">IDistributedCache</span> cache <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext</span>
<span class="line">            <span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDistributedCache<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// Check if we already processed this request and return a cached response (if it exists)</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">string</span></span> cacheKey <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;Idempotent_</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">idempotenceKey</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">?</span></span> cachedResult <span class="token operator">=</span> <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">GetStringAsync</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedResult <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token keyword">null</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">IdempotentResponse</span> response <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IdempotentResponse<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>cachedResult<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token class-name"><span class="token keyword">var</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ObjectResult</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>Value<span class="token punctuation">)</span> <span class="token punctuation">{</span> StatusCode <span class="token operator">=</span> response<span class="token punctuation">.</span>StatusCode <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">            context<span class="token punctuation">.</span>Result <span class="token operator">=</span> result<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// Execute the request and cache the response for the specified duration</span></span>
<span class="line">        <span class="token class-name">ActionExecutedContext</span> executedContext <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>executedContext<span class="token punctuation">.</span>Result <span class="token keyword">is</span> <span class="token class-name">ObjectResult</span> <span class="token punctuation">{</span> StatusCode<span class="token punctuation">:</span> <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token keyword">and</span> <span class="token operator">&lt;</span> <span class="token number">300</span> <span class="token punctuation">}</span> objectResult<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name"><span class="token keyword">int</span></span> statusCode <span class="token operator">=</span> objectResult<span class="token punctuation">.</span>StatusCode <span class="token operator">??</span> StatusCodes<span class="token punctuation">.</span>Status200OK<span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">IdempotentResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">,</span> objectResult<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">SetStringAsync</span><span class="token punctuation">(</span></span>
<span class="line">                cacheKey<span class="token punctuation">,</span></span>
<span class="line">                JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DistributedCacheEntryOptions</span> <span class="token punctuation">{</span> AbsoluteExpirationRelativeToNow <span class="token operator">=</span> _cacheDuration <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentResponse</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">JsonConstructor</span></span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">IdempotentResponse</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> statusCode<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> <span class="token keyword">value</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        StatusCode <span class="token operator">=</span> statusCode<span class="token punctuation">;</span></span>
<span class="line">        Value <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> StatusCode <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> Value <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div>`,16)),s("div",P,[n[18]||(n[18]=s("p",{class:"hint-container-title"},"Note",-1)),s("p",null,[n[16]||(n[16]=e("There's a small ",-1)),a(m,{to:"/milanjovanovic.tech/solving-race-conditions-with-ef-core-optimistic-locking.html"},{default:t(()=>[...n[15]||(n[15]=[s("strong",null,"race condition",-1)])]),_:1}),n[17]||(n[17]=e(" window between checking and setting the cache. For absolute consistency, we should consider using a distributed lock pattern, though this adds complexity and latency.",-1))])]),n[23]||(n[23]=u(`<p>Now, we can apply this attribute to our controller actions:</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="OrdersController.cs"><span>OrdersController.cs</span></div><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;api/[controller]&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrdersController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span></span>
<span class="line highlighted">    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Idempotent</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token named-parameter punctuation">cacheTimeInMinutes</span><span class="token punctuation">:</span> <span class="token number">60</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name">IActionResult</span> <span class="token function">CreateOrder</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromBody</span></span><span class="token punctuation">]</span> <span class="token class-name">CreateOrderRequest</span> request<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Process the order...</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">CreatedAtAction</span><span class="token punctuation">(</span><span class="token keyword">nameof</span><span class="token punctuation">(</span>GetOrder<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token punctuation">{</span> id <span class="token operator">=</span> orderDto<span class="token punctuation">.</span>Id <span class="token punctuation">}</span><span class="token punctuation">,</span> orderDto<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><h3 id="idempotency-with-minimal-apis" tabindex="-1"><a class="header-anchor" href="#idempotency-with-minimal-apis"><span>Idempotency with Minimal APIs</span></a></h3><p>To implement idempotency with Minimal APIs, we can use an <code>IEndpointFilter</code>.</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="IdempotencyFilter.cs"><span>IdempotencyFilter.cs</span></div><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">IdempotencyFilter</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> cacheTimeInMinutes <span class="token operator">=</span> <span class="token number">60</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">:</span> IEndpointFilter</span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">InvokeAsync</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token class-name">EndpointFilterInvocationContext</span> context<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">EndpointFilterDelegate</span> next<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// Parse the Idempotence-Key header from the request</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TryGetIdempotenceKey</span><span class="token punctuation">(</span><span class="token keyword">out</span> <span class="token class-name">Guid</span> idempotenceKey<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> Results<span class="token punctuation">.</span><span class="token function">BadRequest</span><span class="token punctuation">(</span><span class="token string">&quot;Invalid or missing Idempotence-Key header&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name">IDistributedCache</span> cache <span class="token operator">=</span> context<span class="token punctuation">.</span>HttpContext</span>
<span class="line">            <span class="token punctuation">.</span>RequestServices<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDistributedCache<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// Check if we already processed this request and return a cached response (if it exists)</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">string</span></span> cacheKey <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$&quot;Idempotent_</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">idempotenceKey</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">?</span></span> cachedResult <span class="token operator">=</span> <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">GetStringAsync</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedResult <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token keyword">null</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name">IdempotentResponse</span> response <span class="token operator">=</span> JsonSerializer<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Deserialize</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IdempotentResponse<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>cachedResult<span class="token punctuation">)</span><span class="token operator">!</span><span class="token punctuation">;</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IdempotentResult</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>StatusCode<span class="token punctuation">,</span> response<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token comment">// Execute the request and cache the response for the specified duration</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token keyword">is</span> <span class="token class-name">IStatusCodeHttpResult</span> <span class="token punctuation">{</span> StatusCode<span class="token punctuation">:</span> <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token keyword">and</span> <span class="token operator">&lt;</span> <span class="token number">300</span> <span class="token punctuation">}</span> statusCodeResult</span>
<span class="line">            <span class="token keyword">and</span> <span class="token class-name">IValueHttpResult</span> valueResult<span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">{</span></span>
<span class="line">            <span class="token class-name"><span class="token keyword">int</span></span> statusCode <span class="token operator">=</span> statusCodeResult<span class="token punctuation">.</span>StatusCode <span class="token operator">??</span> StatusCodes<span class="token punctuation">.</span>Status200OK<span class="token punctuation">;</span></span>
<span class="line">            <span class="token class-name">IdempotentResponse</span> response <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span>statusCode<span class="token punctuation">,</span> valueResult<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">            <span class="token keyword">await</span> cache<span class="token punctuation">.</span><span class="token function">SetStringAsync</span><span class="token punctuation">(</span></span>
<span class="line">                cacheKey<span class="token punctuation">,</span></span>
<span class="line">                JsonSerializer<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">                <span class="token keyword">new</span> <span class="token constructor-invocation class-name">DistributedCacheEntryOptions</span></span>
<span class="line">                <span class="token punctuation">{</span></span>
<span class="line">                    AbsoluteExpirationRelativeToNow <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromMinutes</span><span class="token punctuation">(</span>cacheTimeInMinutes<span class="token punctuation">)</span></span>
<span class="line">                <span class="token punctuation">}</span></span>
<span class="line">            <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// We have to implement a custom result to write the status code</span></span>
<span class="line"><span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentResult</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IResult</span></span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">int</span></span> _statusCode<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> _value<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">IdempotentResult</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> statusCode<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> <span class="token keyword">value</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        _statusCode <span class="token operator">=</span> statusCode<span class="token punctuation">;</span></span>
<span class="line">        _value <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">ExecuteAsync</span><span class="token punctuation">(</span><span class="token class-name">HttpContext</span> httpContext<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        httpContext<span class="token punctuation">.</span>Response<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> _statusCode<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">return</span> httpContext<span class="token punctuation">.</span>Response<span class="token punctuation">.</span><span class="token function">WriteAsJsonAsync</span><span class="token punctuation">(</span>_value<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>Now, we can apply this endpoint filter to our Minimal API endpoint:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line">app<span class="token punctuation">.</span><span class="token function">MapPost</span><span class="token punctuation">(</span><span class="token string">&quot;/api/orders&quot;</span><span class="token punctuation">,</span> CreateOrder<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">RequireAuthorization</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">WithOpenApi</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddEndpointFilter</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IdempotencyFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>An alternative to the previous two implementations is implementing idempotency logic in a custom middleware.</p><hr><h2 id="best-practices-and-considerations" tabindex="-1"><a class="header-anchor" href="#best-practices-and-considerations"><span>Best Practices and Considerations</span></a></h2><p>Here are the key things I always keep in mind when implementing idempotency.</p><p>Cache duration is tricky. I aim to cover reasonable retry windows without holding onto stale data. A reasonable cache time typically ranges from a few minutes to 24-48 hours, depending on your specific use case.</p><p>Concurrency can be a pain, especially in high-traffic APIs. A thread-safe implementation using a distributed lock works great. It keeps things in check when multiple requests hit at once. But this should be a rare occurrence.</p><p>For distributed setups, Redis is my go-to. It&#39;s perfect as a shared cache, keeping idempotency consistent across all your API instances. Plus, it handles distributed locking.</p><p>What if a client reuses an idempotency key with a different request body? I return an error in this case. My approach is to hash the request body and store it with the idempotency key. When a request comes in, I compare the request body hashes. If they differ, I return an error. This prevents misuse of idempotency keys and maintains the integrity of your API.</p><hr><h2 id="summary" tabindex="-1"><a class="header-anchor" href="#summary"><span>Summary</span></a></h2><p>Implementing idempotency in REST APIs enhances service reliability and consistency. It ensures identical requests yield the same result, preventing unintended duplicates and gracefully handling network issues.</p><p>While our implementation provides a foundation, I recommend adapting it to your needs. Focus on critical operations in your APIs, especially those that modify the system state or trigger important business processes.</p><p>By embracing idempotency, you&#39;re building more robust and user-friendly APIs.</p><p>That&#39;s all for today.</p><p>See you next week.</p><hr>`,23)),b(" TODO: add ARTICLE CARD "),a(i,c(l({title:"Implementing Idempotent REST APIs in ASP.NET Core",desc:"Learn how to implement idempotency in ASP.NET Core Web APIs to improve reliability and prevent duplicate operations in distributed systems.",link:"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/implementing-idempotent-rest-apis-in-aspnetcore.html",logo:"https://milanjovanovic.tech/profile_favicon.png",background:"rgba(79,70,229,0.2)"})),null,16)])}const E=v(w,[["render",R]]),j=JSON.parse('{"path":"/milanjovanovic.tech/implementing-idempotent-rest-apis-in-aspnetcore.html","title":"Implementing Idempotent REST APIs in ASP.NET Core","lang":"en-US","frontmatter":{"lang":"en-US","title":"Implementing Idempotent REST APIs in ASP.NET Core","description":"Article(s) > Implementing Idempotent REST APIs in ASP.NET Core","icon":"iconfont icon-csharp","category":["C#","DotNet","Article(s)"],"tag":["blog","milanjovanovic.tech","cs","c#","csharp","dotnet"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Implementing Idempotent REST APIs in ASP.NET Core\\",\\"image\\":[\\"https://milanjovanovic.tech/blog-covers/mnw_113.png\\"],\\"datePublished\\":\\"2024-10-26T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Milan Jovanović\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/implementing-idempotent-rest-apis-in-aspnetcore.html"}],["meta",{"property":"og:site_name","content":"📚Bookshelf"}],["meta",{"property":"og:title","content":"Implementing Idempotent REST APIs in ASP.NET Core"}],["meta",{"property":"og:description","content":"Article(s) > Implementing Idempotent REST APIs in ASP.NET Core"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://milanjovanovic.tech/blog-covers/mnw_113.png"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://milanjovanovic.tech/blog-covers/mnw_113.png"}],["meta",{"name":"twitter:image:alt","content":"Implementing Idempotent REST APIs in ASP.NET Core"}],["meta",{"property":"article:author","content":"Milan Jovanović"}],["meta",{"property":"article:tag","content":"dotnet"}],["meta",{"property":"article:tag","content":"csharp"}],["meta",{"property":"article:tag","content":"c#"}],["meta",{"property":"article:tag","content":"cs"}],["meta",{"property":"article:tag","content":"milanjovanovic.tech"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2024-10-26T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Implementing Idempotent REST APIs in ASP.NET Core"},{"property":"og:description","content":"Implementing Idempotent REST APIs in ASP.NET Core"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/implementing-idempotent-rest-apis-in-aspnetcore.html"}]],"prev":"/programming/cs/articles/README.md","date":"2024-10-26T00:00:00.000Z","isOriginal":false,"author":"Milan Jovanović","cover":"https://milanjovanovic.tech/blog-covers/mnw_113.png"},"git":{},"readingTime":{"minutes":5.56,"words":1669},"filePathRelative":"milanjovanovic.tech/implementing-idempotent-rest-apis-in-aspnetcore.md","copyright":{"author":"Milan Jovanović"}}');export{E as comp,j as data};
