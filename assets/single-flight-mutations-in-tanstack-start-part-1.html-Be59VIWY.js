import{_ as h}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as f,d as s,f as t,a as i,b as u,t as y,n as d,g as k,w as e,e as a,r as l,o as w}from"./app-BItykJLQ.js";const b={},v={id:"frontmatter-title-á„€á…ªá†«á„…á…§á†«",tabindex:"-1"},S={class:"header-anchor",href:"#frontmatter-title-á„€á…ªá†«á„…á…§á†«"},q={class:"table-of-contents"},T={href:"https://tanstack.com/query/latest",target:"_blank",rel:"noopener noreferrer"},j={href:"https://tanstack.com/router/latest",target:"_blank",rel:"noopener noreferrer"},I={href:"https://tanstack.com/start/latest",target:"_blank",rel:"noopener noreferrer"},O={href:"https://tkdodo.eu/blog/all",target:"_blank",rel:"noopener noreferrer"},A={href:"https://github.com/arackaf/tanstack-start-single-flight-mutations-blog-post",target:"_blank",rel:"noopener noreferrer"};function x(g,n){const c=l("VPCard"),o=l("router-link"),m=l("SiteInfo"),p=l("VPIcon"),r=l("RouteLink");return w(),f("div",null,[s("h1",v,[s("a",S,[s("span",null,y(g.$frontmatter.title)+" ê´€ë ¨",1)])]),t(c,d(k({title:"React.js > Article(s)",desc:"Article(s)",link:"/programming/js-react/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",q,[s("ul",null,[s("li",null,[t(o,{to:"#laying-the-groundwork"},{default:e(()=>[...n[0]||(n[0]=[a("Laying the Groundwork",-1)])]),_:1})]),s("li",null,[t(o,{to:"#why-single-flight-mutations"},{default:e(()=>[...n[1]||(n[1]=[a("Why Single Flight Mutations",-1)])]),_:1})]),s("li",null,[t(o,{to:"#our-app"},{default:e(()=>[...n[2]||(n[2]=[a("Our App",-1)])]),_:1})]),s("li",null,[t(o,{to:"#simplest-possible-single-flight-mutation"},{default:e(()=>[...n[3]||(n[3]=[a("Simplest Possible Single Flight Mutation",-1)])]),_:1})]),s("li",null,[t(o,{to:"#updating-the-ui"},{default:e(()=>[...n[4]||(n[4]=[a("Updating the UI",-1)])]),_:1})]),s("li",null,[t(o,{to:"#iterating"},{default:e(()=>[...n[5]||(n[5]=[a("Iterating",-1)])]),_:1})])])]),n[31]||(n[31]=s("hr",null,null,-1)),t(m,{name:"Single Flight Mutations in TanStack Start: Part 1",desc:"What if we could mutate data *and* get all the data back we need to properly update the UI in just one network round-trip?",url:"https://frontendmasters.com/blog/single-flight-mutations-in-tanstack-start-part-1/",logo:"https://frontendmasters.com/favicon.ico",preview:"https://frontendmasters.com/blog/wp-json/social-image-generator/v1/image/8334"}),n[32]||(n[32]=s("p",null,[a("A "),s("strong",null,"â€œsingle flight mutationâ€"),a(" is a fancy way of saying: mutate the data "),s("em",null,"and"),a(" update the UI with just "),s("em",null,"one"),a(" round trip to the network.")],-1)),s("p",null,[n[9]||(n[9]=a("The beautiful thing about implementing this with TanStack is that we can leverage the tools we already know, and love: ",-1)),s("a",T,[t(p,{icon:"fas fa-globe"}),n[6]||(n[6]=a("TanStack Query",-1))]),n[10]||(n[10]=a(" (formerly react-query), ",-1)),s("a",j,[t(p,{icon:"fas fa-globe"}),n[7]||(n[7]=a("TanStack Router",-1))]),n[11]||(n[11]=a(", and ",-1)),s("a",I,[t(p,{icon:"fas fa-globe"}),n[8]||(n[8]=a("TanStack Start",-1))]),n[12]||(n[12]=a(".",-1))]),s("p",null,[n[16]||(n[16]=a("If youâ€™re not familiar with these tools, TanStack Router is a client-only SPA framework (see my ",-1)),t(r,{to:"/frontendmasters.com/introducing-tanstack-router.html"},{default:e(()=>[...n[13]||(n[13]=[s("strong",null,"three-part introduction series",-1)])]),_:1}),n[17]||(n[17]=a("). TanStack Start is a server layer for Router that enables things like SSR, API routes, and server functions (see my ",-1)),t(r,{to:"/frontendmasters.com/introducing-tanstack-start.html"},{default:e(()=>[...n[14]||(n[14]=[s("strong",null,"introduction for it",-1)])]),_:1}),n[18]||(n[18]=a(" and ",-1)),t(r,{to:"/frontendmasters.com/introducing-tanstack-start-middleware.html"},{default:e(()=>[...n[15]||(n[15]=[s("strong",null,"a post on its middleware feature",-1)])]),_:1}),n[19]||(n[19]=a(").",-1))]),s("p",null,[n[21]||(n[21]=a("Iâ€™ve never written about TanStack Query, but itâ€™s one of the most widely used React libraries, and there are tons of resources about it. One of the best would be ",-1)),s("a",O,[t(p,{icon:"fas fa-globe"}),n[20]||(n[20]=a("TkDodoâ€™s blog",-1))]),n[22]||(n[22]=a(". Heâ€™s the lead maintainer of TanStack Query, and his blog is superb.",-1))]),n[33]||(n[33]=s("p",null,"In this first post, weâ€™ll cover some fundamentals and then implement the simplest imaginable single flight mutation with a TanStack Start Server Function. In the next part, weâ€™ll dive deep into middleware and implement a more serious solution, while having some fun with TypeScript in the process.",-1)),n[34]||(n[34]=s("hr",null,null,-1)),n[35]||(n[35]=s("h2",{id:"laying-the-groundwork",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#laying-the-groundwork"},[s("span",null,"Laying the Groundwork")])],-1)),s("p",null,[n[24]||(n[24]=a("In my ",-1)),t(r,{to:"/frontendmasters.com/introducing-tanstack-start.html"},{default:e(()=>[...n[23]||(n[23]=[s("strong",null,"post on TanStack Start",-1)])]),_:1}),n[25]||(n[25]=a(", I included this image, which is how client-driven single-page applications (SPAs) almost always behave.",-1))]),n[36]||(n[36]=s("figure",null,[s("img",{src:"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img1.png?ssl=1",alt:"A flow diagram illustrating the sequence of actions between a browser and a web server when loading a webpage, highlighting the steps of rendering an empty app shell, loading scripts, requesting data, and finally displaying the full page.",tabindex:"0",loading:"lazy"}),s("figcaption",null,"A flow diagram illustrating the sequence of actions between a browser and a web server when loading a webpage, highlighting the steps of rendering an empty app shell, loading scripts, requesting data, and finally displaying the full page.")],-1)),i(" TODO: mermaidí™” "),n[37]||(n[37]=s("p",null,"The initial request for whatever URL youâ€™re viewing returns an empty skeleton of a page. From there, more networks requests happen to fetch scripts and styles, and most likely some data, which eventually results in your actual content page being rendered.",-1)),n[38]||(n[38]=s("p",null,[a("The network round trips will almost always be the single most expensive thing your web application will do. To look at it another way, there are few things you can do to improve performance as much as "),s("em",null,"removing"),a(" network roundtrips. And this is why server-side rendering can be so beneficial: it allows us to display content to our users "),s("em",null,"immediately"),a(", after the initial request is responded to.")],-1)),n[39]||(n[39]=s("p",null,"I expressed this in the Start post with this image.",-1)),n[40]||(n[40]=s("figure",null,[s("img",{src:"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img2.png?ssl=1",alt:"Diagram illustrating the sequence of actions in client-driven single-page applications, showing the initial GET request for an HTML document, followed by script file requests, and the transition from page display to interactivity.",tabindex:"0",loading:"lazy"}),s("figcaption",null,"Diagram illustrating the sequence of actions in client-driven single-page applications, showing the initial GET request for an HTML document, followed by script file requests, and the transition from page display to interactivity.")],-1)),i(" TODO: mermaidí™” "),n[41]||(n[41]=u('<p>Those scripts and styles still have to load for your page to be interactive, but that initial response from the server can immediately display content for the user.</p><hr><h2 id="why-single-flight-mutations" tabindex="-1"><a class="header-anchor" href="#why-single-flight-mutations"><span>Why Single Flight Mutations</span></a></h2><p>Letâ€™s think about how youâ€™d normally update a piece of data in a web application.</p><p>You probably make a network request to some sort of <code>/update</code> endpoint, along with a post packet for whatever youâ€™re trying to change. The endpoint will probably return a success flag, possibly with the actual piece of data you just updated. Your UI will usually then request updated data. You might think that returning the updated piece of data you just changed is all youâ€™d need in order to update the UI, but frequently thatâ€™s not the case.</p><p>Imagine youâ€™re looking at a list of TODO tasks, and you just edited one of them. Just updating the item on the screen isnâ€™t good enough; maybe the edit causes this TODO to no longer even be in this list, depending on your filters. Or perhaps your edit causes this TODO to move to a different page in your results, based on your sort order. Or maybe you just <em>created</em> a <em>brand new</em> todo. In that case, who knows where, or even <em>if</em> this todo will show up in your list, again based on your filters and sorts.</p><p>So we re-fetch whatever query produces our list. It usually looks like this</p><figure><img src="https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img3.png?resize=1024%2C922&amp;ssl=1" alt="A flowchart illustrating the interaction between a browser and web server, detailing the process of posting updated data, receiving an update result, requesting updated data, and updating the UI accordingly." tabindex="0" loading="lazy"><figcaption>A flowchart illustrating the interaction between a browser and web server, detailing the process of posting updated data, receiving an update result, requesting updated data, and updating the UI accordingly.</figcaption></figure>',8)),i(" TODO: mermaidí™” "),n[42]||(n[42]=s("p",null,[a("This works, and if weâ€™re honest with ourselves, itâ€™s usually good enough. But can we do better? We wouldnâ€™t be good engineers if we didnâ€™t at least "),s("em",null,"try"),a(". Conceptually weâ€™d like to get something like this")],-1)),n[43]||(n[43]=s("figure",null,[s("img",{src:"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img4.png?ssl=1",alt:"A diagram illustrating the flow of data between the browser and web server during a single flight mutation. It shows a POST request to '/update-data' from the browser, followed by a response that includes both the result and new data for UI updates.",tabindex:"0",loading:"lazy"}),s("figcaption",null,"A diagram illustrating the flow of data between the browser and web server during a single flight mutation. It shows a POST request to '/update-data' from the browser, followed by a response that includes both the result and new data for UI updates.")],-1)),i(" TODO: mermaidí™” "),n[44]||(n[44]=s("p",null,"Weâ€™ll implement a dead simple solution to this here in part 1, and then part 2 will discuss increasingly flexible ways of accomplishing it with middleware.",-1)),n[45]||(n[45]=s("hr",null,null,-1)),n[46]||(n[46]=s("h2",{id:"our-app",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#our-app"},[s("span",null,"Our App")])],-1)),s("p",null,[n[29]||(n[29]=a("As with prior posts about TanStack Start and Router, this post will use our cheap, simple, and frankly ugly Jira clone. ",-1)),s("a",A,[n[26]||(n[26]=a("Hereâ€™s a repo for it (",-1)),t(p,{icon:"iconfont icon-github"}),n[27]||(n[27]=s("code",null,"arackaf/tanstack-start-single-flight-mutations-blog-post",-1)),n[28]||(n[28]=a(")",-1))]),n[30]||(n[30]=a(". Itâ€™s a trivial app that runs on an SQLite database. The epics page looks like this:",-1))]),n[47]||(n[47]=u(`<figure><img src="https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img5.png?resize=830%2C1024&amp;ssl=1" alt="Screenshot of a web application displaying an overview of epics with a list of tasks, including buttons for viewing and editing." tabindex="0" loading="lazy"><figcaption>Screenshot of a web application displaying an overview of epics with a list of tasks, including buttons for viewing and editing.</figcaption></figure><p>As you can see, zero effort was put into the design. But thereâ€™s a few sources of data on the screen, which will help us implement single flight mutations: the main list of epics; the count of all epics (12) just above the list; and above that we have a summary list of epics, with the numbers of tasks therein.</p><p>This is the page weâ€™ll be focusing on for this post. If youâ€™re following along at home, you can run the app with <code>npm run dev</code> and then visit <code>http://localhost:3000/app/epics</code>.</p><p>Our queries for our list of epics and our summary data are driven by react-query. Iâ€™ve put the query options into helper utilities, like so.</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">epicsQueryOptions</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">page</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">queryOptions</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">queryKey</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;epics&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> page<span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token function-variable function">queryFn</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getEpicsList</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> page <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">staleTime</span><span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token literal-property property">gcTime</span><span class="token operator">:</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This allows me to query data using the normal <code>useQuery</code> or <code>useSuspenseQuery</code> hook.</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> epicsData <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useSuspenseQuery</span><span class="token punctuation">(</span><span class="token function">epicsQueryOptions</span><span class="token punctuation">(</span>deferredPage<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>And also prefetch these queries in TanStack loaders, without duplicating code.</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">async</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> context<span class="token punctuation">,</span> deps <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> queryClient <span class="token operator">=</span> context<span class="token punctuation">.</span>queryClient<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    queryClient<span class="token punctuation">.</span><span class="token function">ensureQueryData</span><span class="token punctuation">(</span><span class="token function">epicsQueryOptions</span><span class="token punctuation">(</span>deps<span class="token punctuation">.</span>page<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    queryClient<span class="token punctuation">.</span><span class="token function">ensureQueryData</span><span class="token punctuation">(</span><span class="token function">epicsCountQueryOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>As you can see, this query (and all our other queries) are just straight calls to a single server function (<code>getEpicsList</code> in this case), with the result passed through. This is a key detail that will come in handy in part 2.</p><hr><h2 id="simplest-possible-single-flight-mutation" tabindex="-1"><a class="header-anchor" href="#simplest-possible-single-flight-mutation"><span>Simplest Possible Single Flight Mutation</span></a></h2><p>Letâ€™s implement a dirt simple single flight mutation, and then iterate on it, to make it more and more scalable. Our main epics page has an edit button, which allows for inline editing.</p><figure><img src="https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img6.png?resize=792%2C1024&amp;ssl=1" alt="A user interface displaying a list of epics with their respective task counts, including buttons for viewing and editing each epic." tabindex="0" loading="lazy"><figcaption>A user interface displaying a list of epics with their respective task counts, including buttons for viewing and editing each epic.</figcaption></figure><p>When we hit save, letâ€™s just refetch the list of epics, as well as the epics summary data inside the edit epic server function, and send those new data down to the client, so the client can update the UI.</p><p>Hereâ€™s the entire server function:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> updateWithSimpleRefetch <span class="token operator">=</span> <span class="token function">createServerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">&quot;POST&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">inputValidator</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">obj</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> number<span class="token punctuation">;</span> name<span class="token operator">:</span> string <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> data <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>epicsTable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">name</span><span class="token operator">:</span> data<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>epicsTable<span class="token punctuation">.</span>id<span class="token punctuation">,</span> data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">[</span>epicsList<span class="token punctuation">,</span> epicsSummaryData<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">await</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">getEpicsList</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getEpicsSummary</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token punctuation">{</span> epicsList<span class="token punctuation">,</span> epicsSummaryData <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We save our epic, and then fetch the updated data from the <code>getEpicsList</code>, and <code>getEpicsSummary</code> server functions, which we call in parallel with <code>Promise.all</code>. Note that a production-ready application would likely have some error handling.</p><p>Now when we call our server function, the data for those queries will be attached to the result. In fact, since weâ€™re using server functions, these things will even be statically typed!</p><figure><img src="https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img7.png?resize=1024%2C150&amp;ssl=1" alt="Code snippet displaying a loop over result.epicsList with properties of each epic highlighted, showing &#39;id&#39; and &#39;name&#39; attributes." tabindex="0" loading="lazy"><figcaption>Code snippet displaying a loop over result.epicsList with properties of each epic highlighted, showing &#39;id&#39; and &#39;name&#39; attributes.</figcaption></figure><hr><h2 id="updating-the-ui" tabindex="-1"><a class="header-anchor" href="#updating-the-ui"><span>Updating the UI</span></a></h2><p>With updated data for our queries coming back after the save, we can now insert it back into the UI. TanStack Query makes this simple. We need a reference to the QueryClient:</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> queryClient <span class="token operator">=</span> <span class="token function">useQueryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Then we can update the query payload for a given query with the <code>setQueryData</code> method. It takes the query key and the data.</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line"><span class="token keyword">const</span> <span class="token function-variable function">handleSaveSimple</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> newValue <span class="token operator">=</span> inputRef<span class="token punctuation">.</span>current<span class="token operator">?.</span>value <span class="token operator">||</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">runSaveSimple</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token literal-property property">id</span><span class="token operator">:</span> epic<span class="token punctuation">.</span>id<span class="token punctuation">,</span></span>
<span class="line">      <span class="token literal-property property">name</span><span class="token operator">:</span> newValue<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  queryClient<span class="token punctuation">.</span><span class="token function">setQueryData</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;epics&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>epicsList<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  queryClient<span class="token punctuation">.</span><span class="token function">setQueryData</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;epics&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;summary&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>epicsSummaryData<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token function">setIsEditing</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If hard-coding those query keys feels gross to you, donâ€™t forget about those helper utilities we added before.</p><div class="language-javascript line-numbers-mode" data-highlighter="prismjs" data-ext="js"><pre><code class="language-javascript"><span class="line">queryClient<span class="token punctuation">.</span><span class="token function">setQueryData</span><span class="token punctuation">(</span><span class="token function">epicsQueryOptions</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>queryKey<span class="token punctuation">,</span> result<span class="token punctuation">.</span>epicsList<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">queryClient<span class="token punctuation">.</span><span class="token function">setQueryData</span><span class="token punctuation">(</span><span class="token function">epicsSummaryQueryOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>queryKey<span class="token punctuation">,</span> result<span class="token punctuation">.</span>epicsSummaryData<span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">updatedAt</span><span class="token operator">:</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="iterating" tabindex="-1"><a class="header-anchor" href="#iterating"><span>Iterating</span></a></h2><p>Our solution works, but itâ€™s fragile. Our server function hard codes which data to fetch. What if our update function were to be called from different parts of the UI, which each needed different slices of data to be refetched? We certainly donâ€™t want to redefine our server function N times, for each place it needs to be called.</p><p>Fortunately, TanStack has the perfect feature to help reduce this coupling: Middleware. We can remove the refetching from the server function, and move it to a reusable middleware which can be attached to server functions.</p><p>Stay tuned for part 2 where weâ€™ll dive into all of this.</p>`,33)),i(" TODO: add ARTICLE CARD "),t(c,d(k({title:"Single Flight Mutations in TanStack Start: Part 1",desc:"What if we could mutate data *and* get all the data back we need to properly update the UI in just one network round-trip?",link:"https://chanhi2000.github.io/bookshelf/frontendmasters.com/single-flight-mutations-in-tanstack-start-part-1.html",logo:"https://frontendmasters.com/favicon.ico",background:"rgba(188,75,52,0.2)"})),null,16)])}const D=h(b,[["render",x]]),M=JSON.parse('{"path":"/frontendmasters.com/single-flight-mutations-in-tanstack-start-part-1.html","title":"Single Flight Mutations in TanStack Start: Part 1","lang":"en-US","frontmatter":{"lang":"en-US","title":"Single Flight Mutations in TanStack Start: Part 1","description":"Article(s) > Single Flight Mutations in TanStack Start: Part 1","icon":"fa-brands fa-react","category":["Node.js","React.js","Article(s)"],"tag":["blog","frontendmasters.com","node","nodejs","node-js","react","reactjs","react-js"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Single Flight Mutations in TanStack Start: Part 1\\",\\"image\\":[\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img1.png?ssl=1\\",\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img2.png?ssl=1\\",\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img3.png?resize=1024%2C922&ssl=1\\",\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img4.png?ssl=1\\",\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img5.png?resize=830%2C1024&ssl=1\\",\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img6.png?resize=792%2C1024&ssl=1\\",\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2026/01/img7.png?resize=1024%2C150&ssl=1\\"],\\"datePublished\\":\\"2026-01-23T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Adam Rackis\\",\\"url\\":\\"https://frontendmasters.com/blog/author/adamrackis/\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/frontendmasters.com/single-flight-mutations-in-tanstack-start-part-1.html"}],["meta",{"property":"og:site_name","content":"ðŸ“šBookshelf"}],["meta",{"property":"og:title","content":"Single Flight Mutations in TanStack Start: Part 1"}],["meta",{"property":"og:description","content":"Article(s) > Single Flight Mutations in TanStack Start: Part 1"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://frontendmasters.com/blog/wp-json/social-image-generator/v1/image/8334"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://frontendmasters.com/blog/wp-json/social-image-generator/v1/image/8334"}],["meta",{"name":"twitter:image:alt","content":"Single Flight Mutations in TanStack Start: Part 1"}],["meta",{"property":"article:author","content":"Adam Rackis"}],["meta",{"property":"article:tag","content":"react-js"}],["meta",{"property":"article:tag","content":"reactjs"}],["meta",{"property":"article:tag","content":"react"}],["meta",{"property":"article:tag","content":"node-js"}],["meta",{"property":"article:tag","content":"nodejs"}],["meta",{"property":"article:tag","content":"node"}],["meta",{"property":"article:tag","content":"frontendmasters.com"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2026-01-23T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Single Flight Mutations in TanStack Start: Part 1"},{"property":"og:description","content":"Single Flight Mutations in TanStack Start: Part 1"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/frontendmasters.com/single-flight-mutations-in-tanstack-start-part-1.html"}]],"prev":"/programming/js-react/articles/README.md","date":"2026-01-23T00:00:00.000Z","isOriginal":false,"author":[{"name":"Adam Rackis","url":"https://frontendmasters.com/blog/author/adamrackis/"}],"cover":"https://frontendmasters.com/blog/wp-json/social-image-generator/v1/image/8334"},"git":{},"readingTime":{"minutes":6.54,"words":1963},"filePathRelative":"frontendmasters.com/single-flight-mutations-in-tanstack-start-part-1.md","copyright":{"author":"Adam Rackis"}}');export{D as comp,M as data};
