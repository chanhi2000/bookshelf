import{_ as f}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as g,d as t,f as o,b as d,a as k,t as w,n as p,g as h,w as r,e as n,r as a,o as v}from"./app-BItykJLQ.js";const y={},b={id:"frontmatter-title-·ÑÄ·Ö™·Ü´·ÑÖ·Öß·Ü´",tabindex:"-1"},D={class:"header-anchor",href:"#frontmatter-title-·ÑÄ·Ö™·Ü´·ÑÖ·Öß·Ü´"},S={class:"table-of-contents"},E={href:"https://unsplash.com/@pluyar",target:"_blank",rel:"noopener noreferrer"},U={href:"https://unsplash.com/s/photos/gear",target:"_blank",rel:"noopener noreferrer"},F={href:"https://docs.docker.com/docker-for-windows/edge-release-notes/#docker-desktop-community-2170",target:"_blank",rel:"noopener noreferrer"},I={href:"https://docker.com/blog/new-filesharing-implementation-in-docker-desktop-windows/",target:"_blank",rel:"noopener noreferrer"},x={href:"https://youtu.be/UIJaRp8ESDU",target:"_blank",rel:"noopener noreferrer"},P={href:"https://github.com/djs55/linux/tree/v4.19.76-linuxkit-fuse",target:"_blank",rel:"noopener noreferrer"};function N(c,e){const l=a("VPCard"),s=a("router-link"),u=a("SiteInfo"),i=a("VPIcon"),m=a("VidStack");return v(),g("div",null,[t("h1",b,[t("a",D,[t("span",null,w(c.$frontmatter.title)+" Í¥ÄÎ†®",1)])]),o(l,p(h({title:"Docker > Article(s)",desc:"Article(s)",link:"/devops/docker/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),t("nav",S,[t("ul",null,[t("li",null,[o(s,{to:"#new-architecture"},{default:r(()=>[...e[0]||(e[0]=[n("New Architecture",-1)])]),_:1}),t("ul",null,[t("li",null,[o(s,{to:"#hypervisor-sockets"},{default:r(()=>[...e[1]||(e[1]=[n("Hypervisor Sockets",-1)])]),_:1})]),t("li",null,[o(s,{to:"#fuse-server"},{default:r(()=>[...e[2]||(e[2]=[n("FUSE Server",-1)])]),_:1})]),t("li",null,[o(s,{to:"#event-injection"},{default:r(()=>[...e[3]||(e[3]=[n("Event Injection",-1)])]),_:1})])])]),t("li",null,[o(s,{to:"#caching"},{default:r(()=>[...e[4]||(e[4]=[n("Caching",-1)])]),_:1})]),t("li",null,[o(s,{to:"#future-evolution"},{default:r(()=>[...e[5]||(e[5]=[n("Future Evolution",-1)])]),_:1})])])]),e[27]||(e[27]=t("hr",null,null,-1)),o(u,{name:"Deep Dive Into the New Docker Desktop filesharing Implementation Using FUSE",desc:"The latest Edge release of Docker Desktop for Windows 2.1.7.0 has a completely new filesharing system using FUSE instead of Samba. Part 1 in the series presented the performance improvements and explains how to give feedback. Part 2 gives more insight about the new architecture.",url:"https://docker.com/blog/deep-dive-into-new-docker-desktop-filesharing-implementation",logo:"https://docker.com/app/uploads/2024/02/cropped-docker-logo-favicon-192x192.png",preview:"https://docker.com/app/uploads/2020/01/shane-aldendorff-mQHEgroKw2k-unsplash-scaled.jpg"}),t("figure",null,[e[10]||(e[10]=t("img",{src:"https://docker.com/app/uploads/2020/01/shane-aldendorff-mQHEgroKw2k-unsplash-scaled.jpg?fit=1110%2C740&ssl=1",alt:'Photo by <VPIcon icon="fas fa-globe"/>Shane Aldendorff on <VPIcon icon="fas fa-globe"/>Unsplash',tabindex:"0",loading:"lazy"},null,-1)),t("figcaption",null,[e[8]||(e[8]=n("Photo by ",-1)),t("a",E,[o(i,{icon:"fas fa-globe"}),e[6]||(e[6]=n("Shane Aldendorff",-1))]),e[9]||(e[9]=n(" on ",-1)),t("a",U,[o(i,{icon:"fas fa-globe"}),e[7]||(e[7]=n("Unsplash",-1))])])]),t("p",null,[e[13]||(e[13]=n("The latest ",-1)),t("a",F,[o(i,{icon:"fa-brands fa-docker"}),e[11]||(e[11]=n("Edge release of Docker Desktop for Windows 2.1.7.0",-1))]),e[14]||(e[14]=n(" has a completely new filesharing system using FUSE instead of Samba. The ",-1)),t("a",I,[o(i,{icon:"fa-brands fa-docker"}),e[12]||(e[12]=n("initial blog post",-1))]),e[15]||(e[15]=n(" we released presents the performance improvements of this new implementation and explains how to give feedback. Please try it out and let us know what you think. Now, we are going to go into details to give you more insight about the new architecture.",-1))]),e[28]||(e[28]=d(`<hr><h2 id="new-architecture" tabindex="-1"><a class="header-anchor" href="#new-architecture"><span>New Architecture</span></a></h2><p>Instead of Samba running over a Hyper-V virtual network, the new system uses a Filesystem in Userspace (FUSE) server running over gRPC over Hypervisor sockets.</p><p>The following diagram shows the path taken by a single request from a container, for example to read a PHP file:</p><figure><img src="https://docker.com/app/uploads/2019/12/new_windows_filesharing_dd_01.png?fit=1110%2C599&amp;ssl=1" alt="new windows filesharing dd 01" tabindex="0" loading="lazy"><figcaption>new windows filesharing dd 01</figcaption></figure><p>In step (1) the web-server in the container calls ‚Äúread‚Äù which is a Linux system call handled by the kernel‚Äôs Virtual File System (VFS) layer. The VFS is modular and supports many different filesystem implementations. In our case we use Filesystem in Userspace (FUSE) which sends the request to a helper process running inside the VM labelled ‚ÄúFUSE client.‚Äù This process runs within the same namespace as the Docker engine. The FUSE client can handle some requests locally, but when it needs to access the host filesystem it connects to the host via ‚ÄúHypervisor sockets.‚Äù</p><h3 id="hypervisor-sockets" tabindex="-1"><a class="header-anchor" href="#hypervisor-sockets"><span>Hypervisor Sockets</span></a></h3><p>Hypervisor sockets are a shared-memory communication mechanism which enables VMs to communicate with each other and with the host. Hypervisor sockets have a number of advantages over using regular virtual networking, including:</p><ol><li>since the traffic does not flow over a virtual ethernet/IP network, it is not affected by firewall policies</li><li>since the traffic is not routed like IP, it cannot be mis-routed by VPN clients</li><li>since the traffic uses shared memory, it can never leave the machine so we don‚Äôt have to worry about third parties intercepting it</li></ol><p>Docker Desktop already uses these sockets to forward the Docker API, to forward container ports, and now we use them for filesharing on Windows too!</p><p>Returning to the diagram, the FUSE client creates sockets using the AF_VSOCK address family, see step (3). The kernel contains a number of low-level transports, one per hypervisor. Since the underlying hypervisor is Hyper-V, we use the VMBus transport. In step (4) filesystem requests are written into the shared memory and read by the VMBus implementation in the Windows kernel. A FUSE server userspace process running in Windows reads the filesystem request over an AF_HYPERV socket in step (5).</p><h3 id="fuse-server" tabindex="-1"><a class="header-anchor" href="#fuse-server"><span>FUSE Server</span></a></h3><p>The request to open/close/read/write etc is received by the FUSE server, which is running as a regular Windows process. Finally in step (6) the FUSE server uses the Windows APIs to perform the read or write and then returns the result to the caller.</p><p>The FUSE server runs as the user who is running the Docker app, so it only has access to the user‚Äôs files and folders. There is no possibility of the VM gaining access to any other files, as could happen in the previous design if a local admin account is used to mount the drive in the VM.</p><h3 id="event-injection" tabindex="-1"><a class="header-anchor" href="#event-injection"><span>Event Injection</span></a></h3><p>When files are modified in Linux, the kernel generates inotify events. Interested applications can watch for these events and take action. For example, a React app run with</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token function">npm</span> start</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div>`,17)),t("p",null,[e[17]||(e[17]=n("will watch for inotify events and automatically recompile when code changes and trigger the browser to refresh automatically, as shown in ",-1)),t("a",x,[o(i,{icon:"fa-brands fa-youtube"}),e[16]||(e[16]=n("this video",-1))]),e[18]||(e[18]=n(". In previous versions of Docker Desktop on Windows we weren‚Äôt able to generate inotify events so these styles of development simply wouldn‚Äôt work.",-1))]),o(m,{src:"youtube/UIJaRp8ESDU"}),e[29]||(e[29]=d('<p>Injecting inotify events is quite tricky. Normally a Linux VFS implementation like FUSE wouldn‚Äôt generate the events itself; instead the common code in the higher layer generates events as a side-effect of performing actions. For example when the VFS ‚Äúunlink‚Äù is called and returns successfully then the ‚Äúunlink‚Äù event will be generated. So when the user calls ‚Äúunlink‚Äù under Windows, how does Linux find out about it?</p><p>Docker Desktop watches for events on the host when the user runs <code>docker run -v</code>. When an ‚Äúunlink‚Äù event is received on the host, a request to ‚Äúplease inject unlink‚Äù is forwarded over gRPC to the Linux VM. The following diagram shows the sequence of operations:</p><figure><img src="https://docker.com/app/uploads/2019/12/new_windows_filesharing_dd_02.png?fit=1110%2C954&amp;ssl=1" alt="new windows filesharing dd 02" tabindex="0" loading="lazy"><figcaption>new windows filesharing dd 02</figcaption></figure><p>A thread with a well-known pid inside the FUSE client in Linux ‚Äúreplays‚Äù the request by calling ‚Äúunlink,‚Äù even though the directory has actually already been removed. The FUSE client intercepts requests from this well-known pid and pretends that the unlink hasn‚Äôt happened yet. For example, when FUSE_GETATTR is called, the FUSE client will say, ‚Äúyes the directory is still here‚Äù (instead of ENOENT). When the FUSE_UNLINK is called, the FUSE client will say, ‚Äúyes that worked‚Äù (instead of ENOENT). As a result of the successful FUSE_UNLINK the Linux kernel generates the inotify event.</p><hr><h2 id="caching" tabindex="-1"><a class="header-anchor" href="#caching"><span>Caching</span></a></h2><p>As you can see from the architecture diagram above, each I/O request has to make several user/kernel transitions and VM/host transitions to complete. This means the latency of a filesystem operation is much higher than the case when all the files are local in the VM. We have mitigated this with aggressive use of kernel caching, so many requests can be avoided altogether. We:</p>',7)),t("ol",null,[e[23]||(e[23]=t("li",null,"use the file attribute cache which minimises FUSE_GETATTR requests",-1)),e[24]||(e[24]=t("li",null,[n("set "),t("code",null,"FOPEN_CACHE_DIR"),n(" which caches directory contents in the kernel page cache")],-1)),e[25]||(e[25]=t("li",null,[n("set "),t("code",null,"FOPEN_KEEP_CACHE"),n(" which caches file contents")],-1)),e[26]||(e[26]=t("li",null,[n("we set "),t("code",null,"CAP_MAX_PAGES"),n(" to increase the maximum request size")],-1)),t("li",null,[e[22]||(e[22]=n("We use a modern 4.19 series kernel with the ",-1)),t("a",P,[e[19]||(e[19]=n("latest FUSE patches backported (",-1)),o(i,{icon:"iconfont icon-github"}),e[20]||(e[20]=t("code",null,"djs55/linux",-1)),e[21]||(e[21]=n(")",-1))])])]),e[30]||(e[30]=t("p",null,[n("Since we have enabled so many caches we have to carefully handle cache invalidation. When a user runs "),t("code",null,"docker run -v"),n(" and we are monitoring the filesystem events for inotify event injection, we also use these events to invalidate cache entries. When the "),t("code",null,"docker run -v"),n(" exits and the watches are disabled we invalidate all the cache entries.")],-1)),e[31]||(e[31]=t("hr",null,null,-1)),e[32]||(e[32]=t("h2",{id:"future-evolution",tabindex:"-1"},[t("a",{class:"header-anchor",href:"#future-evolution"},[t("span",null,"Future Evolution")])],-1)),e[33]||(e[33]=t("p",null,"We have lots of ideas to improve the performance further by even more aggressive use of caching. For example, in the Symfony benchmark above, the majority of the remaining FUSE calls in the cached case are calls to open and close file handles; even though the file contents is itself cached (and hasn‚Äôt changed). We may be able to make these open and close calls lazy and only call them when needed.",-1)),e[34]||(e[34]=t("p",null,"The new filesystem implementation is not relevant on WSL 2 (currently available on early Windows Insider builds), since that already has a native filesharing mode which uses 9P. Of course we will keep benchmarking, optimising and incorporating user feedback to always use the best available filesharing implementation across all OS versions.",-1)),k(" TODO: add ARTICLE CARD "),o(l,p(h({title:"Deep Dive Into the New Docker Desktop filesharing Implementation Using FUSE",desc:"The latest Edge release of Docker Desktop for Windows 2.1.7.0 has a completely new filesharing system using FUSE instead of Samba. Part 1 in the series presented the performance improvements and explains how to give feedback. Part 2 gives more insight about the new architecture.",link:"https://chanhi2000.github.io/bookshelf/docker.com/deep-dive-into-new-docker-desktop-filesharing-implementation.html",logo:"https://docker.com/app/uploads/2024/02/cropped-docker-logo-favicon-192x192.png",background:"rgba(29,99,237,0.2)"})),null,16)])}const A=f(y,[["render",N]]),C=JSON.parse('{"path":"/docker.com/deep-dive-into-new-docker-desktop-filesharing-implementation.html","title":"Deep Dive Into the New Docker Desktop filesharing Implementation Using FUSE","lang":"en-US","frontmatter":{"lang":"en-US","title":"Deep Dive Into the New Docker Desktop filesharing Implementation Using FUSE","description":"Article(s) > Deep Dive Into the New Docker Desktop filesharing Implementation Using FUSE","icon":"fa-brands fa-docker","category":["DevOps","Docker","Article(s)"],"tag":["blog","docker.com","devops","docker"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Deep Dive Into the New Docker Desktop filesharing Implementation Using FUSE\\",\\"image\\":[\\"https://unsplash.com/@pluyar\\",\\"https://docker.com/app/uploads/2019/12/new_windows_filesharing_dd_01.png?fit=1110%2C599&ssl=1\\",\\"https://docker.com/app/uploads/2019/12/new_windows_filesharing_dd_02.png?fit=1110%2C954&ssl=1\\"],\\"datePublished\\":\\"2019-12-17T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"David Scott\\",\\"url\\":\\"https://docker.com/author/dscott/\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/docker.com/deep-dive-into-new-docker-desktop-filesharing-implementation.html"}],["meta",{"property":"og:site_name","content":"üìöBookshelf"}],["meta",{"property":"og:title","content":"Deep Dive Into the New Docker Desktop filesharing Implementation Using FUSE"}],["meta",{"property":"og:description","content":"Article(s) > Deep Dive Into the New Docker Desktop filesharing Implementation Using FUSE"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://docker.com/app/uploads/2020/01/shane-aldendorff-mQHEgroKw2k-unsplash-scaled.jpg"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://docker.com/app/uploads/2020/01/shane-aldendorff-mQHEgroKw2k-unsplash-scaled.jpg"}],["meta",{"name":"twitter:image:alt","content":"Deep Dive Into the New Docker Desktop filesharing Implementation Using FUSE"}],["meta",{"property":"article:author","content":"David Scott"}],["meta",{"property":"article:tag","content":"docker"}],["meta",{"property":"article:tag","content":"devops"}],["meta",{"property":"article:tag","content":"docker.com"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2019-12-17T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Deep Dive Into the New Docker Desktop filesharing Implementation Using FUSE"},{"property":"og:description","content":"Deep Dive Into the New Docker Desktop filesharing Implementation Using FUSE"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/docker.com/deep-dive-into-new-docker-desktop-filesharing-implementation.html"}]],"prev":"/devops/docker/articles/README.md","date":"2019-12-17T00:00:00.000Z","isOriginal":false,"author":[{"name":"David Scott","url":"https://docker.com/author/dscott/"}],"cover":"https://docker.com/app/uploads/2020/01/shane-aldendorff-mQHEgroKw2k-unsplash-scaled.jpg"},"git":{},"readingTime":{"minutes":5.14,"words":1543},"filePathRelative":"docker.com/deep-dive-into-new-docker-desktop-filesharing-implementation.md","copyright":{"author":"David Scott"}}');export{A as comp,C as data};
