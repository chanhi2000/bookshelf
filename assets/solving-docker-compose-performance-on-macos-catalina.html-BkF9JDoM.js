import{_ as h}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as k,d as o,f as n,b as c,a as f,t as y,n as d,g as p,w as r,e as t,r as s,o as b}from"./app-BItykJLQ.js";const w={},v={id:"frontmatter-title-·ÑÄ·Ö™·Ü´·ÑÖ·Öß·Ü´",tabindex:"-1"},C={class:"header-anchor",href:"#frontmatter-title-·ÑÄ·Ö™·Ü´·ÑÖ·Öß·Ü´"},S={class:"table-of-contents"},x={href:"https://unsplash.com/@casparrubin",target:"_blank",rel:"noopener noreferrer"},D={href:"https://unsplash.com/s/photos/developer",target:"_blank",rel:"noopener noreferrer"},P={href:"https://github.com/docker/compose",target:"_blank",rel:"noopener noreferrer"},A={href:"https://pyinstaller.org/",target:"_blank",rel:"noopener noreferrer"},I={href:"https://charlesproxy.com/",target:"_blank",rel:"noopener noreferrer"};function R(m,e){const l=s("VPCard"),i=s("router-link"),u=s("SiteInfo"),a=s("VPIcon"),g=s("RouteLink");return b(),k("div",null,[o("h1",v,[o("a",C,[o("span",null,y(m.$frontmatter.title)+" Í¥ÄÎ†®",1)])]),n(l,d(p({title:"Docker > Article(s)",desc:"Article(s)",link:"/devops/docker/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),n(l,d(p({title:"macOS > Article(s)",desc:"Article(s)",link:"/devops/macos/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),o("nav",S,[o("ul",null,[o("li",null,[n(i,{to:"#a-one-line-bug-report"},{default:r(()=>[...e[0]||(e[0]=[t("A one-line bug report",-1)])]),_:1})]),o("li",null,[n(i,{to:"#investigating-the-issue"},{default:r(()=>[...e[1]||(e[1]=[t("Investigating the issue",-1)])]),_:1})]),o("li",null,[n(i,{to:"#confirming-the-hypothesis"},{default:r(()=>[...e[2]||(e[2]=[t("Confirming the hypothesis",-1)])]),_:1})]),o("li",null,[n(i,{to:"#the-resolution"},{default:r(()=>[...e[3]||(e[3]=[t("The resolution",-1)])]),_:1})])])]),e[39]||(e[39]=o("hr",null,null,-1)),n(u,{name:"How We Solved a Report on `docker-compose` Performance on macOS CatalinaDocker",desc:"As a Docker Compose maintainer, my daily duty is to check for newly reported issues and try to help users through misunderstanding and possible underlying bugs. Sometimes issues are very well documented, sometimes they are nothing much but some ‚Äúplease help‚Äù message. And sometimes they look really weird and can result in funny investigations. Here is the story...",url:"https://docker.com/blog/solving-docker-compose-performance-on-macos-catalina",logo:"https://docker.com/app/uploads/2024/02/cropped-docker-logo-favicon-192x192.png",preview:"https://docker.com/app/uploads/2020/01/caspar-camille-rubin-fPkvU7RDmCo-unsplash-1110x740.jpg"}),o("figure",null,[e[8]||(e[8]=o("img",{src:"https://docker.com/app/uploads/2020/01/caspar-camille-rubin-fPkvU7RDmCo-unsplash-scaled.jpg?fit=1110%2C740&ssl=1",alt:'Photo by <VPIcon icon="fas fa-globe"/>Caspar Camille Rubin on <VPIcon icon="fas fa-globe"/>Unsplash',tabindex:"0",loading:"lazy"},null,-1)),o("figcaption",null,[e[6]||(e[6]=t("Photo by ",-1)),o("a",x,[n(a,{icon:"fas fa-globe"}),e[4]||(e[4]=t("Caspar Camille Rubin",-1))]),e[7]||(e[7]=t(" on ",-1)),o("a",D,[n(a,{icon:"fas fa-globe"}),e[5]||(e[5]=t("Unsplash",-1))])])]),o("p",null,[e[12]||(e[12]=t("As a ",-1)),o("a",P,[e[9]||(e[9]=t("Docker Compose (",-1)),n(a,{icon:"iconfont icon-github"}),e[10]||(e[10]=o("code",null,"docker/compose)",-1)),e[11]||(e[11]=t(")",-1))]),e[13]||(e[13]=t(" maintainer, my daily duty is to check for newly reported issues and try to help users through misunderstanding and possible underlying bugs. Sometimes issues are very well documented, sometimes they are nothing much but some ",-1)),e[14]||(e[14]=o("em",null,"‚Äúplease help‚Äù",-1)),e[15]||(e[15]=t(" message. And sometimes they look really weird and can result in funny investigations. Here is the story of how we solved one such report‚Ä¶",-1))]),e[40]||(e[40]=c('<hr><h2 id="a-one-line-bug-report" tabindex="-1"><a class="header-anchor" href="#a-one-line-bug-report"><span>A one-line bug report</span></a></h2><p>An issue was reported as <em>‚Äúdocker-compose super slow on macOS Catalina‚Äù</em> ‚Äì no version, no details. How should I prioritize this? I don‚Äôt even know if the reporter is using the latest version of the tool ‚Äì the opened issue doesn‚Äôt follow the bug reporting template. This is just a one-liner. But for some reason, I decided to take a look at it anyway and diagnose the issue.</p><p>Without any obvious explanation for super-slowness, I decided to take a risk and upgrade my own MacBook to OSX Catalina. I was able to reproduce significant slow down in <code>docker-compose</code> execution, waiting seconds for the very first line printed on the console even to display usage on invalid command.</p><hr><h2 id="investigating-the-issue" tabindex="-1"><a class="header-anchor" href="#investigating-the-issue"><span>Investigating the issue</span></a></h2>',6)),o("p",null,[e[17]||(e[17]=t("In the meantime, some users reported getting correct performance when installing ",-1)),e[18]||(e[18]=o("code",null,"docker-compose",-1)),e[19]||(e[19]=t(" as a plain python software, not with the packaged executable. The ",-1)),e[20]||(e[20]=o("code",null,"docker-compose",-1)),e[21]||(e[21]=t(" executable is packaged using ",-1)),o("a",A,[n(a,{icon:"fas fa-globe"}),e[16]||(e[16]=t("PyInstaller",-1))]),e[22]||(e[22]=t(", which embeds a Python runtime and libraries with application code in a single executable file. As a result, one gets a distributable binary that can be created for Windows, Linux and OSX. I wrote a minimalist ‚Äú",-1)),e[23]||(e[23]=o("em",null,"hello world",-1)),e[24]||(e[24]=t("‚Äù python application and was able to reproduce the same weird behaviour once packaged the same way ",-1)),e[25]||(e[25]=o("code",null,"docker-compose",-1)),e[26]||(e[26]=t(" is, i.e. a few second startup delay.",-1))]),e[41]||(e[41]=o("p",null,[t("Here comes the funny part. I‚Äôm a remote worker on the Docker team, and I sometimes have trouble with my Internet connection. It happened this exact day, as my network router had to reboot. And during the reboot sequence, "),o("code",null,"docker-compose"),t(" performance suddenly became quite good ‚Ä¶ but eventually, the initial execution delay came back. How do you explain such a thing?")],-1)),o("p",null,[e[28]||(e[28]=t("So I installed ",-1)),o("a",I,[n(a,{icon:"fas fa-globe"}),e[27]||(e[27]=t("Charles proxy",-1))]),e[29]||(e[29]=t(" to analyze network traffic, and discovered a request sent to api.apple-cloudkit.com each and everytime ",-1)),e[30]||(e[30]=o("code",null,"docker-compose",-1)),e[31]||(e[31]=t(" was run. Apple Cloudkit is Apple cloud storage SDK, and there‚Äôs no obvious relation between ",-1)),e[32]||(e[32]=o("code",null,"docker-compose",-1)),e[33]||(e[33]=t(" and this service.",-1))]),e[42]||(e[42]=c('<p>As the Docker Desktop team was investigating Catalina support during this period, I heard about the notarization constraints introduced by the Apple OS upgrade. I decided to reconfigure my system with system integrity check disabled (you have to run ‚Äòcsrutil disable‚Äô from recovery console on boot). Here again, <code>docker-compose</code> suddenly went reasonably fast.</p><p>Looking into PyInstaller implementation details, when executed <code>docker-compose</code> binary extracts itself into a temporary folder, then executes the embedded Python runtime to run the packaged application. This bootstrap sequence takes a blink of an eye on a recent computer with tmp folder mapped to memory, but on my Catalina-upgraded MacBook it took up to 10 seconds ‚Äì until I disabled integrity check.</p><hr><h2 id="confirming-the-hypothesis" tabindex="-1"><a class="header-anchor" href="#confirming-the-hypothesis"><span>Confirming the hypothesis</span></a></h2><p>My assumption was: OSX Catalina reinforced security constraints do apply to the python runtime as it gets extracted, as a security scan, and the system does send a scan report to apple over its own cloud storage service. I can‚Äôt remember having approved sending such data to Apple, but I admit I didn‚Äôt carefully read the upgrade guide and service agreement before I hit the ‚Äúupgrade to Catalina‚Äù button. As a fresh new Python runtime is extracted for temporary execution, this takes place each and every time we run a <code>docker-compose</code> command: new system scan, new report sent to apple ‚Äì not even as a background task.</p><p>To confirm this hypothesis, I built a custom flavour of <code>docker-compose</code> using an alternate PyInstaller configuration, so it doesn‚Äôt create a single binary, but a folder with runtime and libraries. The first execution of this custom <code>docker-compose</code> packaging took 10 seconds again (initial scan by the system), but subsequent commands were as efficient as expected.</p><hr><h2 id="the-resolution" tabindex="-1"><a class="header-anchor" href="#the-resolution"><span>The resolution</span></a></h2>',8)),o("p",null,[e[35]||(e[35]=t("A few weeks later, a release candidate build was included in the Docker Desktop Edge channel to confirm that Catalina users get good performance using this alternate packaging, while not introducing unexpected bugs. ",-1)),n(g,{to:"/docker.com/faster-builds-in-compose-thanks-to-buildkit-support.html"},{default:r(()=>[...e[34]||(e[34]=[o("strong",null,"Docker Compose 1.25.1 was released",-1)])]),_:1}),e[36]||(e[36]=t(" one month later with the bug fix confirmed. Starting with this release, ",-1)),e[37]||(e[37]=o("code",null,"docker-compose",-1)),e[38]||(e[38]=t(" is available both as single binary packaging and as a tar.gz for OSX Catalina.",-1))]),f(" TODO: add ARTICLE CARD "),n(l,d(p({title:"How We Solved a Report on `docker-compose` Performance on macOS CatalinaDocker",desc:"As a Docker Compose maintainer, my daily duty is to check for newly reported issues and try to help users through misunderstanding and possible underlying bugs. Sometimes issues are very well documented, sometimes they are nothing much but some ‚Äúplease help‚Äù message. And sometimes they look really weird and can result in funny investigations. Here is the story...",link:"https://chanhi2000.github.io/bookshelf/docker.com/solving-docker-compose-performance-on-macos-catalina.html",logo:"https://docker.com/app/uploads/2024/02/cropped-docker-logo-favicon-192x192.png",background:"rgba(29,99,237,0.2)"})),null,16)])}const T=h(w,[["render",R]]),W=JSON.parse('{"path":"/docker.com/solving-docker-compose-performance-on-macos-catalina.html","title":"How We Solved a Report on `docker-compose` Performance on macOS CatalinaDocker","lang":"en-US","frontmatter":{"lang":"en-US","title":"How We Solved a Report on `docker-compose` Performance on macOS CatalinaDocker","description":"Article(s) > How We Solved a Report on `docker-compose` Performance on macOS CatalinaDocker","icon":"fa-brands fa-docker","category":["DevOps","Docker","Apple","macOS","Article(s)"],"tag":["blog","docker.com","devops","docker","apple","macos"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"How We Solved a Report on `docker-compose` Performance on macOS CatalinaDocker\\",\\"image\\":[\\"https://unsplash.com/@casparrubin\\"],\\"datePublished\\":\\"2020-01-29T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/docker.com/solving-docker-compose-performance-on-macos-catalina.html"}],["meta",{"property":"og:site_name","content":"üìöBookshelf"}],["meta",{"property":"og:title","content":"How We Solved a Report on `docker-compose` Performance on macOS CatalinaDocker"}],["meta",{"property":"og:description","content":"Article(s) > How We Solved a Report on `docker-compose` Performance on macOS CatalinaDocker"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://docker.com/app/uploads/2020/01/caspar-camille-rubin-fPkvU7RDmCo-unsplash-1110x740.jpg"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://docker.com/app/uploads/2020/01/caspar-camille-rubin-fPkvU7RDmCo-unsplash-1110x740.jpg"}],["meta",{"name":"twitter:image:alt","content":"How We Solved a Report on `docker-compose` Performance on macOS CatalinaDocker"}],["meta",{"property":"article:tag","content":"macos"}],["meta",{"property":"article:tag","content":"apple"}],["meta",{"property":"article:tag","content":"docker"}],["meta",{"property":"article:tag","content":"devops"}],["meta",{"property":"article:tag","content":"docker.com"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2020-01-29T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > How We Solved a Report on `docker-compose` Performance on macOS CatalinaDocker"},{"property":"og:description","content":"How We Solved a Report on `docker-compose` Performance on macOS CatalinaDocker"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/docker.com/solving-docker-compose-performance-on-macos-catalina.html"}]],"prev":"/devops/docker/articles/README.md","date":"2020-01-29T00:00:00.000Z","isOriginal":false,"author":null,"cover":"https://docker.com/app/uploads/2020/01/caspar-camille-rubin-fPkvU7RDmCo-unsplash-1110x740.jpg"},"git":{},"readingTime":{"minutes":3.91,"words":1172},"filePathRelative":"docker.com/solving-docker-compose-performance-on-macos-catalina.md"}');export{T as comp,W as data};
