import{_ as m}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as h,d as s,f as e,b as g,t as b,n as v,g as k,w as l,e as a,r as t,o as y}from"./app-BVguHYKu.js";const f={},w={id:"frontmatter-title-관련",tabindex:"-1"},x={class:"header-anchor",href:"#frontmatter-title-관련"},_={class:"table-of-contents"},O={href:"https://se.rit.edu/~se442/doc/fallacies.pdf",target:"_blank",rel:"noopener noreferrer"},R={href:"https://youtu.be/BimfDeDV4yU",target:"_blank",rel:"noopener noreferrer"},M={href:"https://youtu.be/XALvnX7MPeo",target:"_blank",rel:"noopener noreferrer"},P={href:"https://youtu.be/xajVttkZntU",target:"_blank",rel:"noopener noreferrer"};function I(p,n){const c=t("VPCard"),o=t("router-link"),u=t("SiteInfo"),i=t("VPIcon"),d=t("PDF"),r=t("VidStack");return y(),h("div",null,[s("h1",w,[s("a",x,[s("span",null,b(p.$frontmatter.title)+" 관련",1)])]),e(c,v(k({title:"C# > Article(s)",desc:"Article(s)",link:"/programming/cs/articles/README.md",logo:"https://chanhi2000.github.io/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",_,[s("ul",null,[s("li",null,[e(o,{to:"#what-problem-does-the-outbox-pattern-solve"},{default:l(()=>n[0]||(n[0]=[a("What Problem Does The Outbox Pattern Solve?")])),_:1,__:[0]})]),s("li",null,[e(o,{to:"#implementing-the-outbox-pattern"},{default:l(()=>n[1]||(n[1]=[a("Implementing The Outbox Pattern")])),_:1,__:[1]})]),s("li",null,[e(o,{to:"#architecture-diagram-with-outbox"},{default:l(()=>n[2]||(n[2]=[a("Architecture Diagram With Outbox")])),_:1,__:[2]})]),s("li",null,[e(o,{to:"#further-reading"},{default:l(()=>n[3]||(n[3]=[a("Further Reading")])),_:1,__:[3]})])])]),n[12]||(n[12]=s("hr",null,null,-1)),e(u,{name:"Outbox Pattern For Reliable Microservices Messaging",desc:"Working with Microservices, or any distributed system for that matter, is difficult. In a distributed system many things can go wrong, and there are even research papers about this. If you want to explore this topic futher, I suggest that you read about the fallacies of distributed computing. Reducing the surface area for things to go wrong should be one of your goals, as an engineer. In this week's newsletter, we'll try to achieve exactly that using the Outbox pattern. How can you implement reliable communication between components in a distributed system? The Outbox pattern is an elegant solution to this problem, allowing you to achieve transactional guarantees in a single service and at-least-once message delivery to external systems.",url:"https://milanjovanovic.tech/blog/outbox-pattern-for-reliable-microservices-messaging/",logo:"https://milanjovanovic.tech/profile_favicon.png",preview:"https://milanjovanovic.tech/blog-covers/mnw_026.png"}),s("p",null,[n[5]||(n[5]=a("Working with ")),n[6]||(n[6]=s("strong",null,"Microservices",-1)),n[7]||(n[7]=a(", or any distributed system for that matter, is difficult. In a distributed system many things can go wrong, and there are even research papers about this. If you want to explore this topic further, I suggest that you read about the ")),s("a",O,[e(i,{icon:"fas fa-file-pdf"}),n[4]||(n[4]=a("fallacies of distributed computing"))]),n[8]||(n[8]=a("."))]),e(d,{url:"https://se.rit.edu/~se442/doc/fallacies.pdf"}),n[13]||(n[13]=g(`<p>Reducing the surface area for things to go wrong should be one of your goals, as an engineer. In this week&#39;s newsletter, we&#39;ll try to achieve exactly that using the <strong>Outbox pattern</strong>.</p><p>How can you implement reliable communication between components in a distributed system?</p><p>The <strong>Outbox pattern</strong> is an elegant solution to this problem, allowing you to achieve transactional guarantees in a single service and at-least-once message delivery to external systems.</p><p>Let&#39;s see how the <strong>Outbox pattern</strong> solves this and how can we implement it.</p><hr><h2 id="what-problem-does-the-outbox-pattern-solve" tabindex="-1"><a class="header-anchor" href="#what-problem-does-the-outbox-pattern-solve"><span>What Problem Does The Outbox Pattern Solve?</span></a></h2><p>To understand what problem the <strong>Outbox pattern</strong> solves, first we need a problem, of course.</p><p>Here&#39;s an example of a user registration flow. There are a few things going on here:</p><ul><li>Saving the <code>User</code> to the database</li><li>Sending a welcome email to the <code>User</code></li><li>Publishing a <code>UserRegisteredEvent</code> to a message bus</li></ul><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RegisterUserAsync</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> token<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    _userRepository<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">await</span> _unitOfWork<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">await</span> _emailService<span class="token punctuation">.</span><span class="token function">SendWelcomeEmailAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">await</span> _eventBus<span class="token punctuation">.</span><span class="token function">PublishAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">UserRegisteredEvent</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>In the happy path, all of the operations complete without any issues and all is well.</p><p>But what happens if any one of these operations fail?</p><ul><li>The database is unavailable, and saving the <code>User</code> fails</li><li>The email service is down and sending an email crashes</li><li>Publishing an event to the service bus doesn&#39;t succeed</li></ul><p>Also, imagine a situation where you manage to save a <code>User</code> to the database, send him a welcome email, but fail to publish the <code>UserRegisteredEvent</code> to notify other services. How are you going to recover from this scenario?</p><p>The <strong>Outbox pattern</strong> allows you to <strong>atommically</strong> update the database and send messages to the message bus.</p><hr><h2 id="implementing-the-outbox-pattern" tabindex="-1"><a class="header-anchor" href="#implementing-the-outbox-pattern"><span>Implementing The Outbox Pattern</span></a></h2><p>The first step is to introduce a table in your database to represent the <strong>Outbox</strong>. We can call this table <code>OutboxMessages</code>, and it&#39;s intended to store all messages that need to be delivered. Now instead of directly making requests to external services, we simply store a message as a new row in the <strong>Outbox</strong> table. The messages are usually stored as JSON in the database.</p><p>The second step is to introduce a <strong>background process</strong> that will periodically poll the <code>OutboxMessages</code> table. If the worker process finds a row with an unprocessed message, it&#39;s going to publish that message and mark it as sent. If publishing the message fails for some reason, the work process can <strong>retry</strong> in the next execution.</p><p>Notice that with retries, you now have <strong>at-least-once message delivery</strong> implemented. The message will be published exactly once for the happy path, and more than one time in case or retries.</p><p>We can rewrite the <code>RegisterUserAsync</code> method from the previous example, now using an <strong>Outbox</strong>:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">RegisterUserAsync</span><span class="token punctuation">(</span><span class="token class-name">User</span> user<span class="token punctuation">,</span> <span class="token class-name">CancellationToken</span> token<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    _userRepository<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    _outbox<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">UserRegisteredEvent</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">await</span> _unitOfWork<span class="token punctuation">.</span><span class="token function">SaveChangesAsync</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The <strong>Outbox</strong> is part of the same transaction as our unit of work, so we can atomically save the <code>User</code> to the database and also persist the <code>OutboxMessage</code>. If saving to the database fails, the entire transaction is rolled back and no messages are sent to the message bus.</p><p>And since we now moved the publishing of the <code>UserRegisteredEvent</code> to the worker process, we need to add a handler so that we can send the welcome email to the user. Here&#39;s an example of that in the <code>SendWelcomeEmailHandler</code> class:</p><div class="language-csharp line-numbers-mode" data-highlighter="prismjs" data-ext="cs"><pre><code class="language-csharp"><span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendWelcomeEmailHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHandle<span class="token punctuation">&lt;</span>UserRegisteredEvent<span class="token punctuation">&gt;</span></span></span></span>
<span class="line"><span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IUserRepository</span> _userRepository<span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IEmailService</span> _emailService<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token function">SendWelcomeEmailHandler</span><span class="token punctuation">(</span></span>
<span class="line">        <span class="token class-name">IUserRepository</span> userRepository<span class="token punctuation">,</span></span>
<span class="line">        <span class="token class-name">IEmailService</span> emailService<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        _userRepository <span class="token operator">=</span> userRepository<span class="token punctuation">;</span></span>
<span class="line">        _emailService <span class="token operator">=</span> emailService<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">UserRegisteredEvent</span> message<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">{</span></span>
<span class="line">        <span class="token class-name"><span class="token keyword">var</span></span> user <span class="token operator">=</span> <span class="token keyword">await</span> _userRepository<span class="token punctuation">.</span><span class="token function">GetByIdAsync</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span>UserId<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">await</span> _emailService<span class="token punctuation">.</span><span class="token function">SendWelcomeEmailAsync</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="architecture-diagram-with-outbox" tabindex="-1"><a class="header-anchor" href="#architecture-diagram-with-outbox"><span>Architecture Diagram With Outbox</span></a></h2><p>Here&#39;s a high level overview of the system architecture with the <strong>Outbox</strong> introduced to the system. You can see the <code>Outbox</code> table in the database. What changes now is that you store messages to the <code>Outbox</code> table in the same transaction along with your entities.</p><figure><img src="https://milanjovanovic.tech/blogs/mnw_026/outbox.png?imwidth=3840" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><hr><h2 id="further-reading" tabindex="-1"><a class="header-anchor" href="#further-reading"><span>Further Reading</span></a></h2><p>After reading this newsletter you should have a pretty good understanding of what the <strong>Outbox pattern</strong> is and what problems it solves. If you need to implement reliable messaging in a distributed system, it&#39;s a great solution for your problem.</p><p>What&#39;s missing is more details about how to implement the <strong>Outbox pattern</strong>, so here are a few videos you can watch:</p>`,33)),s("ul",null,[s("li",null,[s("a",R,[e(i,{icon:"fa-brands fa-youtube"}),n[9]||(n[9]=a("How to use the Domain Events pattern"))])]),s("li",null,[s("a",M,[e(i,{icon:"fa-brands fa-youtube"}),n[10]||(n[10]=a("How to implement the Outbox pattern"))])]),s("li",null,[s("a",P,[e(i,{icon:"fa-brands fa-youtube"}),n[11]||(n[11]=a("How to add retries to the Outbox with Polly"))])])]),e(r,{src:"youtube/BimfDeDV4yU"}),e(r,{src:"youtube/XALvnX7MPeo"}),e(r,{src:"youtube/xajVttkZntU"}),n[14]||(n[14]=s("p",null,"Thanks for reading, and have an amazing Saturday.",-1))])}const A=m(f,[["render",I]]),U=JSON.parse('{"path":"/milanjovanovic.tech/outbox-pattern-for-reliable-microservices-messaging.html","title":"Outbox Pattern For Reliable Microservices Messaging","lang":"ko-KR","frontmatter":{"lang":"ko-KR","title":"Outbox Pattern For Reliable Microservices Messaging","description":"Article(s) > Outbox Pattern For Reliable Microservices Messaging","icon":"iconfont icon-csharp","category":["C#","DotNet","Article(s)"],"tag":["blog","milanjovanovic.tech","cs","c#","csharp","dotnet"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Outbox Pattern For Reliable Microservices Messaging\\",\\"image\\":[\\"https://milanjovanovic.tech/blogs/mnw_026/outbox.png?imwidth=3840\\"],\\"datePublished\\":\\"2023-02-28T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Milan Jovanović\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/outbox-pattern-for-reliable-microservices-messaging.html"}],["meta",{"property":"og:site_name","content":"📚Bookshelf"}],["meta",{"property":"og:title","content":"Outbox Pattern For Reliable Microservices Messaging"}],["meta",{"property":"og:description","content":"Article(s) > Outbox Pattern For Reliable Microservices Messaging"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://milanjovanovic.tech/blog-covers/mnw_026.png"}],["meta",{"property":"og:locale","content":"ko-KR"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://milanjovanovic.tech/blog-covers/mnw_026.png"}],["meta",{"name":"twitter:image:alt","content":"Outbox Pattern For Reliable Microservices Messaging"}],["meta",{"property":"article:author","content":"Milan Jovanović"}],["meta",{"property":"article:tag","content":"dotnet"}],["meta",{"property":"article:tag","content":"csharp"}],["meta",{"property":"article:tag","content":"c#"}],["meta",{"property":"article:tag","content":"cs"}],["meta",{"property":"article:tag","content":"milanjovanovic.tech"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2023-02-28T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Outbox Pattern For Reliable Microservices Messaging"},{"property":"og:description","content":"Outbox Pattern For Reliable Microservices Messaging"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/milanjovanovic.tech/outbox-pattern-for-reliable-microservices-messaging.html"}]],"prev":"/programming/cs/articles/README.md","date":"2023-02-28T00:00:00.000Z","isOriginal":false,"author":"Milan Jovanović","cover":"https://milanjovanovic.tech/blog-covers/mnw_026.png"},"git":{},"readingTime":{"minutes":3.71,"words":1114},"filePathRelative":"milanjovanovic.tech/outbox-pattern-for-reliable-microservices-messaging.md","copyright":{"author":"Milan Jovanović"}}');export{A as comp,U as data};
