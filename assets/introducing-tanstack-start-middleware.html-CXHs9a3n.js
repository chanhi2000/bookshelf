import{_ as m}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as h,d as s,f as t,b as l,a as g,t as b,n as u,g as r,w as e,e as a,r as c,o as w}from"./app-BItykJLQ.js";const f={},y={id:"frontmatter-title-관련",tabindex:"-1"},x={class:"header-anchor",href:"#frontmatter-title-관련"},S={class:"table-of-contents"},T={href:"https://tanstack.com/start/latest",target:"_blank",rel:"noopener noreferrer"},I={href:"https://tanstack.com/router/latest",target:"_blank",rel:"noopener noreferrer"},q={href:"https://tanstack.com/start/latest/docs/framework/react/server-functions",target:"_blank",rel:"noopener noreferrer"},M={href:"https://github.com/arackaf/tanstack-start-middleware-blog-post",target:"_blank",rel:"noopener noreferrer"},j={href:"https://amazon.com/Observability-Engineering-Achieving-Production-Excellence/dp/1492076449",target:"_blank",rel:"noopener noreferrer"},C={href:"https://honeycomb.io/",target:"_blank",rel:"noopener noreferrer"},E={href:"https://orm.drizzle.team/",target:"_blank",rel:"noopener noreferrer"},L={href:"https://amazon.com/Observability-Engineering-Achieving-Production-Excellence/dp/1492076449",target:"_blank",rel:"noopener noreferrer"},A={href:"https://honeycomb.io/",target:"_blank",rel:"noopener noreferrer"};function O(d,n){const i=c("VPCard"),p=c("router-link"),k=c("SiteInfo"),o=c("VPIcon"),v=c("RouteLink");return w(),h("div",null,[s("h1",y,[s("a",x,[s("span",null,b(d.$frontmatter.title)+" 관련",1)])]),t(i,u(r({title:"CSS > Article(s)",desc:"Article(s)",link:"/programming/css/articles/README.md",logo:"/images/ico-wind.svg",background:"rgba(10,10,10,0.2)"})),null,16),s("nav",S,[s("ul",null,[s("li",null,[t(p,{to:"#why-ssr"},{default:e(()=>[...n[0]||(n[0]=[a("Why SSR?",-1)])]),_:1})]),s("li",null,[t(p,{to:"#prelude-server-functions"},{default:e(()=>[...n[1]||(n[1]=[a("Prelude: Server Functions",-1)])]),_:1})]),s("li",null,[t(p,{to:"#getting-started"},{default:e(()=>[...n[2]||(n[2]=[a("Getting Started",-1)])]),_:1})]),s("li",null,[t(p,{to:"#our-middleware-use-case"},{default:e(()=>[...n[3]||(n[3]=[a("Our Middleware Use Case",-1)])]),_:1})]),s("li",null,[t(p,{to:"#our-first-server-function"},{default:e(()=>[...n[4]||(n[4]=[a("Our First Server Function",-1)])]),_:1})]),s("li",null,[t(p,{to:"#our-first-middleware"},{default:e(()=>[...n[5]||(n[5]=[a("Our First Middleware",-1)])]),_:1}),s("ul",null,[s("li",null,[t(p,{to:"#let-s-run-it"},{default:e(()=>[...n[6]||(n[6]=[a("Let’s Run It",-1)])]),_:1})]),s("li",null,[t(p,{to:"#the-server"},{default:e(()=>[...n[7]||(n[7]=[a("The Server",-1)])]),_:1})]),s("li",null,[t(p,{to:"#when-client-middleware-runs-on-the-server"},{default:e(()=>[...n[8]||(n[8]=[a("When Client Middleware Runs on the Server",-1)])]),_:1})])])]),s("li",null,[t(p,{to:"#building-real-middleware"},{default:e(()=>[...n[9]||(n[9]=[a("Building Real Middleware",-1)])]),_:1}),s("ul",null,[s("li",null,[t(p,{to:"#the-client"},{default:e(()=>[...n[10]||(n[10]=[a("The Client",-1)])]),_:1})]),s("li",null,[t(p,{to:"#the-server-1"},{default:e(()=>[...n[11]||(n[11]=[a("The Server",-1)])]),_:1})])])]),s("li",null,[t(p,{to:"#the-problem"},{default:e(()=>[...n[12]||(n[12]=[a("The Problem",-1)])]),_:1})]),s("li",null,[t(p,{to:"#going-deeper"},{default:e(()=>[...n[13]||(n[13]=[a("Going Deeper",-1)])]),_:1}),s("ul",null,[s("li",null,[t(p,{to:"#when-server-functions-call-server-functions"},{default:e(()=>[...n[14]||(n[14]=[a("When Server Functions Call Server Functions",-1)])]),_:1})])])]),s("li",null,[t(p,{to:"#parting-thoughts"},{default:e(()=>[...n[15]||(n[15]=[a("Parting Thoughts",-1)])]),_:1})])])]),n[50]||(n[50]=s("hr",null,null,-1)),t(k,{name:"Introducing TanStack Start Middleware",desc:"TanStack Start is one of the most exciting full-stack web development frameworks I’ve seen. I’ve written about it before. In essence, TanStack Start takes TanStack Router, a superb, strongly-typed client-side JavaScript framework, and adds server-side support. This serves two purposes: it gives you a place to execute server-side code, like database access; and it enables […]",url:"https://frontendmasters.com/blog/introducing-tanstack-start-middleware/",logo:"https://frontendmasters.com/favicon.ico",preview:"https://frontendmasters.com/blog/wp-json/social-image-generator/v1/image/7452"}),s("p",null,[s("a",T,[t(o,{icon:"iconfont icon-tanstack"}),n[16]||(n[16]=a("TanStack Start",-1))]),n[18]||(n[18]=a(" is one of the most exciting full-stack web development frameworks I’ve seen. ",-1)),t(v,{to:"/frontendmasters.com/introducing-tanstack-start.html"},{default:e(()=>[...n[17]||(n[17]=[s("strong",null,"I’ve written about it before",-1)])]),_:1}),n[19]||(n[19]=a(".",-1))]),s("p",null,[n[21]||(n[21]=a("In essence, TanStack Start takes ",-1)),s("a",I,[t(o,{icon:"iconfont icon-tanstack"}),n[20]||(n[20]=a("TanStack Router",-1))]),n[22]||(n[22]=a(", a superb, strongly-typed client-side JavaScript framework, and adds server-side support. This serves two purposes: it gives you a place to execute server-side code, like database access; and it enables server-side rendering, or SSR.",-1))]),n[51]||(n[51]=l('<p>This post is all about one particular, especially powerful feature of TanStack Start: <strong>Middleware</strong>.</p><p>The elevator pitch for Middleware is that it allows you to execute code in conjunction with your server-side operations, executing code on both the client and the server, both before and after your underlying server-side action, and even passing data between the client and server.</p><p>This post will be a gentle introduction to Middleware. We’ll build some <em>very</em> rudimentary observability for a toy app. Then, in a future post, we’ll really see what Middleware can do when we use it to achieve single-flight mutations.</p><hr><h2 id="why-ssr" tabindex="-1"><a class="header-anchor" href="#why-ssr"><span>Why SSR?</span></a></h2><p>SSR will usually improve LCP (Largest Contentful Paint) render performance compared to a client-rendered SPA. With SPAs, the server usually sends down an empty shell of a page. The browser then parses the script files, and fetches your application components. Those components then render and, usually, <em>request some data</em>. Only <em>then</em> can you render actual content for your user.</p><p>These round trips are neither free nor cheap; SSR allows you to send the initial content down directly, via the <em>initial</em> request, which the user can see <em>immediately</em>, without needing those extra round trips. See the post above for some deeper details; this post is all about Middleware.</p><hr><h2 id="prelude-server-functions" tabindex="-1"><a class="header-anchor" href="#prelude-server-functions"><span>Prelude: Server Functions</span></a></h2>',9)),s("p",null,[n[24]||(n[24]=a("Any full-stack web application will need a place to execute code on the server. It could be for a database query, to update data, or to validate a user against your authentication solution. Server functions are the main mechanism TanStack Start provides for this purpose, and are documented ",-1)),s("a",q,[t(o,{icon:"iconfont icon-tanstack"}),n[23]||(n[23]=a("here",-1))]),n[25]||(n[25]=a(". The quick introduction is that you can write code like this:",-1))]),n[52]||(n[52]=l(`<div class="language-jsx line-numbers-mode" data-highlighter="prismjs" data-ext="jsx"><pre><code class="language-jsx"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createServerFn <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@tanstack/react-start&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> getServerTime <span class="token operator">=</span> <span class="token function">createServerFn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">resolve</span> <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Then you can call that function from <em>anywhere</em> (client or server), to get a value computed on the server. If you call it from the server, it will just execute the code. If you call that function from the browser, TanStack will handle making a network request to an internal URL containing that server function.</p><hr><h2 id="getting-started" tabindex="-1"><a class="header-anchor" href="#getting-started"><span>Getting Started</span></a></h2>`,4)),s("p",null,[n[29]||(n[29]=a("All of my prior posts on TanStack Start and Router used the same contrived Jira clone, and this one will be no different. ",-1)),s("a",M,[n[26]||(n[26]=a("The repo is here (",-1)),t(o,{icon:"iconfont icon-github"}),n[27]||(n[27]=s("code",null,"arackaf/tanstack-start-middleware-blog-post",-1)),n[28]||(n[28]=a(")",-1))]),n[30]||(n[30]=a(", but the underlying code is the same. If you want to follow along, you can ",-1)),n[31]||(n[31]=s("code",null,"npm i",-1)),n[32]||(n[32]=a(" and then ",-1)),n[33]||(n[33]=s("code",null,"npm run dev",-1)),n[34]||(n[34]=a(" and then run the relevant portion of the app at ",-1)),n[35]||(n[35]=s("code",null,"http://localhost:3000/app/epics?page=1",-1)),n[36]||(n[36]=a(".",-1))]),n[53]||(n[53]=l('<p>The epics section of this app uses server functions for all data and updates. We have an overview showing:</p><ul><li>A count of all tasks associated with each individual epic (for those that contain tasks).</li><li>A total count of all epics in the system.</li><li>A pageable list of individual epics which the user can view and edit.</li></ul><figure><img src="https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2025/10/img3-1.png?resize=715%2C1024&amp;ssl=1" alt="This is a contrived example. It’s just to give us a few different data sources along with mutations." tabindex="0" loading="lazy"><figcaption>This is a contrived example. It’s just to give us a few different data sources along with mutations.</figcaption></figure><hr><h2 id="our-middleware-use-case" tabindex="-1"><a class="header-anchor" href="#our-middleware-use-case"><span>Our Middleware Use Case</span></a></h2><p>We’ll explore middleware by building a rudimentary observability system for our Jira-like app.</p><p>What is observability? If you think of basic logging as a caterpillar, observability would be the beautiful butterfly it matures into. Observability is about setting up systems that allow you to holistically observe how your application is behaving. High-level actions are assigned a globally unique trace id, and the pieces of work that action performs are logged against that same trace id. Then your observability system will allow you to intelligently introspect that data, and discover where your problems or weaknesses are.</p>',7)),s("p",null,[n[39]||(n[39]=a("I’m no observability expert, so if you’d like to learn more, Charity Majors ",-1)),s("a",j,[t(o,{icon:"fa-brands fa-amazon"}),n[37]||(n[37]=a("co-authored a superb book on this very topic",-1))]),n[40]||(n[40]=a(". She’s the co-founder of ",-1)),s("a",C,[t(o,{icon:"iconfont icon-honeycomb"}),n[38]||(n[38]=a("Honeycomb IO",-1))]),n[41]||(n[41]=a(", a mature observability platform.",-1))]),n[54]||(n[54]=l(`<p>We won’t be building a mature observability platform here; we’ll be putting together some rudimentary logging with trace id’s. What we’ll be building is not suitable for use in a production software system, but it <em>will</em> be a great way to explore TanStack Start’s Middleware.</p><hr><h2 id="our-first-server-function" tabindex="-1"><a class="header-anchor" href="#our-first-server-function"><span>Our First Server Function</span></a></h2><p>This is a post about Middleware, which is applied to server functions. Let’s take a very quick look at a server function</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> getEpicsList <span class="token operator">=</span> <span class="token function">createServerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> method<span class="token operator">:</span> <span class="token string">&quot;GET&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">inputValidator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> page<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> epics <span class="token operator">=</span> <span class="token keyword">await</span> db</span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>epicsTable<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> epics<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,5)),s("p",null,[n[43]||(n[43]=a("This is a simple server function to query our epics. We configure it to use the GET http verb. We specify and potentially validate our input, and then the handler function runs our actual code, which is just a basic query against our SQLite database. This particular code uses ",-1)),s("a",E,[t(o,{icon:"iconfont icon-drizzle"}),n[42]||(n[42]=a("Drizzle",-1))]),n[44]||(n[44]=a(" for the data access, but you can of course use whatever you want.",-1))]),n[55]||(n[55]=l(`<p>Server functions by definition always run on the server, so you can do things like connect to a database, access secrets, etc.</p><hr><h2 id="our-first-middleware" tabindex="-1"><a class="header-anchor" href="#our-first-middleware"><span>Our First Middleware</span></a></h2><p>Let’s add some empty middleware so we can see what it looks like.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@tanstack/react-start&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> middlewareDemo <span class="token operator">=</span> <span class="token function">createMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;function&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> next<span class="token punctuation">,</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;client before&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        hello<span class="token operator">:</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;client after&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">server</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> next<span class="token punctuation">,</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server before&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        value<span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server after&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Let’s step through it.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> middlewareDemo <span class="token operator">=</span> <span class="token function">createMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;function&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>This declares the middleware. <code>type: &quot;function&quot;</code> means that this middleware is intended to run against server “functions” – there’s also “request” middleware, which can run against either server functions, or server routes (server routes are what other frameworks sometimes call “API routes”). But “function” middleware has some additional powers, which is why we’re using them here.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> next<span class="token punctuation">,</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>This allows us to run code on the client. Note the arguments: <code>next</code> is how we tell TanStack to proceed with the rest of the middlewares in our chain, as well as the underlying server function this middleware is attached to. And <code>context</code> holds the mutable “context” of the middleware chain.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;client before&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    hello<span class="token operator">:</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;client after&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We do some logging, then tell TanStack to run the underlying server function (as well as any other middlewares we have in the chain), and then, after everything has run, we log again.</p><p>Note the <code>sendContext</code> we pass into the call to <code>next</code></p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line">sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">  hello<span class="token operator">:</span> <span class="token string">&quot;world&quot;</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This allows us to pass data from the client, up to the server. Now this <code>hello</code> property will be in the context object on the server.</p><p>And of course don’t forget to return the actual result.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>You can <code>return next()</code>, but separating the call to <code>next</code> with the return statement allows you to do additional work after the call chain is finished: modify context, perform logging, etc.</p><p>And now we essentially restart the same process on the server.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token punctuation">.</span><span class="token function">server</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> next<span class="token punctuation">,</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server before&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">        value<span class="token operator">:</span> <span class="token number">12</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;server after&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We do some logging and inject an artificial delay of one second to simulate work. Then, as before, we call <code>next()</code> which triggers the underlying server function (as well as any <em>other</em> Middleware in the chain), and then return the result.</p><p>Note again the <code>sendContext</code>.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    value<span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This allows us to send data from the server back down to the client.</p><h3 id="let-s-run-it" tabindex="-1"><a class="header-anchor" href="#let-s-run-it"><span>Let’s Run It</span></a></h3><p>We’ll add this middleware to the server function we just saw.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> getEpicsList <span class="token operator">=</span> <span class="token function">createServerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> method<span class="token operator">:</span> <span class="token string">&quot;GET&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">inputValidator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>page<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> page<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span>middlewareDemo<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> epics <span class="token operator">=</span> <span class="token keyword">await</span> db</span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>epicsTable<span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">(</span>data <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> epics<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>When we run it, this is what the <em>browser’s</em> console shows:</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="output"><span>output</span></div><div class="language-plaintext line-numbers-mode" data-highlighter="prismjs" data-ext="plaintext"><pre><code class="language-plaintext"><span class="line">client before  </span>
<span class="line">client after {value: 12}</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></div><p>With a one second delay before the final client log, since that was the time execution was on the server with the delay we saw.</p><p>Nothing too shocking. The client logs, then sends execution to the server, and then logs again with whatever context came back from the server. Note we use <code>result.context</code> to get what the server sent back, rather than the <code>context</code> argument that was passed to the <code>client</code> callback. This makes sense: that context was created before the server was ever invoked with the <code>next()</code> call, so there’s no way for it to magically, mutably update based on whatever happens to get returned from the server. So we just read <code>result.context</code> to get what the server sent back.</p><h3 id="the-server" tabindex="-1"><a class="header-anchor" href="#the-server"><span>The Server</span></a></h3><p>Now let’s see what the server console shows.</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="output"><span>output</span></div><div class="language-plaintext line-numbers-mode" data-highlighter="prismjs" data-ext="plaintext"><pre><code class="language-plaintext"><span class="line">server before { hello: &#39;world&#39; }  </span>
<span class="line">server after { hello: &#39;world&#39; }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></div><p>Nothing too interesting here, either. As we can see, the server’s <code>context</code> argument does in fact contain what was sent to it from the client.</p><h3 id="when-client-middleware-runs-on-the-server" tabindex="-1"><a class="header-anchor" href="#when-client-middleware-runs-on-the-server"><span>When Client Middleware Runs on the Server</span></a></h3><p>Don’t forget, TanStack Start will server render your initial path by default. So what happens when a server function executes as a part of that process, with Middleware? How can the client middleware possibly run, when there’s no client in existence yet—only a request, currently being executed on the server.</p><p>During SSR, client Middleware will run on the server. This makes sense: whatever functionality you’re building will still work, but the client portion of it will run on the server. So be sure not to use any browser-only APIs like <code>localStorage</code>.</p><p>Let’s see this in action, but during the SSR run. The prior logs I showed were the result of browsing to a page via navigation. Now I’ll just refresh that page, and show the <em>server</em> logs.</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="output"><span>output</span></div><div class="language-plaintext line-numbers-mode" data-highlighter="prismjs" data-ext="plaintext"><pre><code class="language-plaintext"><span class="line">client before  </span>
<span class="line">server before { hello: &#39;world&#39; }  </span>
<span class="line">server after { hello: &#39;world&#39; }  </span>
<span class="line">client after { value: 12 }</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>This is the same as before, but now server, and client logs are together, since this code all runs during the server render phase. The server function is called from the server, while it generates the HTML to send down for the initial render. And as before, there’s a one second delay while the server is working.</p><hr><h2 id="building-real-middleware" tabindex="-1"><a class="header-anchor" href="#building-real-middleware"><span>Building Real Middleware</span></a></h2>`,43)),s("p",null,[n[47]||(n[47]=a("Let’s build some actual logging Middleware with an observability flair. If you want to look at real observability solutions, please check out ",-1)),s("a",L,[t(o,{icon:"fa-brands fa-amazon"}),n[45]||(n[45]=a("the book",-1))]),n[48]||(n[48]=a(" I mentioned above, or a real Observability solution like ",-1)),s("a",A,[t(o,{icon:"iconfont icon-honeycomb"}),n[46]||(n[46]=a("Honeycomb",-1))]),n[49]||(n[49]=a(". But our focus will be on TanStack Middleware, not a robust observability solution.",-1))]),n[56]||(n[56]=l(`<h3 id="the-client" tabindex="-1"><a class="header-anchor" href="#the-client"><span>The Client</span></a></h3><p>Let’s start our Middleware with our client section. It will record the local time that this Middleware began. This will allow us to measure the total end-to-end time that our action took, including server latency.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">loggingMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span>
<span class="line">  <span class="token function">createMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;function&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> next<span class="token punctuation">,</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;middleware for&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">&quot;client&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> clientStart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now let’s call the rest of our Middleware chain and our server function.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">    clientStart<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Once the <code>await next</code> completes, we know that everything has finished on the server, and we’re back on the client. Let’s grab the date and time that everything finished, as well as a logging id that was sent back from the server. With that in hand, we’ll call <code>setClientEnd</code>, which is just a simple server function to update the relevant row in our log table with the <code>clientEnd</code> time.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">const</span> clientEnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">const</span> loggingId <span class="token operator">=</span> result<span class="token punctuation">.</span>context<span class="token punctuation">.</span>loggingId<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">await</span> <span class="token function">setClientEnd</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> loggingId<span class="token punctuation">,</span> clientEnd <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>For completeness, that server function looks like this:</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> setClientEnd <span class="token operator">=</span> <span class="token function">createServerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> method<span class="token operator">:</span> <span class="token string">&quot;POST&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">inputValidator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span> clientEnd<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> payload<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>actionLog<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> clientEnd<span class="token operator">:</span> data<span class="token punctuation">.</span>clientEnd <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>actionLog<span class="token punctuation">.</span>id<span class="token punctuation">,</span> data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="the-server-1" tabindex="-1"><a class="header-anchor" href="#the-server-1"><span>The Server</span></a></h3><p>Let’s look at our server handler.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line">    <span class="token punctuation">.</span><span class="token function">server</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> next<span class="token punctuation">,</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> traceId <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          loggingId<span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token keyword">as</span> <span class="token builtin">string</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We start by creating a <code>traceId</code>. This is the single identifier that represents the entirety of the action the user is performing; it’s not a log id. In fact, for real observability systems, there will be many, many log entries against a single <code>traceId</code>, representing all the sub-steps involved in that action.</p><p>For now, there’ll just be a single log entry, but in a bit we’ll have some fun and go a little further.</p><p>Once we have the <code>traceId</code>, we note the start time, and then we call <code>await next</code> to finish our work on the server. We add a <code>loggingId</code> to the context we’ll be sending <em>back down</em> to the client. It’ll use this to update the log entry with the <code>clientEnd</code> time, so we can see the total end-to-end network time.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">const</span> end <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">addLog</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">  data<span class="token operator">:</span> <span class="token punctuation">{</span> actionName<span class="token operator">:</span> name<span class="token punctuation">,</span> clientStart<span class="token operator">:</span> context<span class="token punctuation">.</span>clientStart<span class="token punctuation">,</span> traceId<span class="token operator">:</span> traceId<span class="token punctuation">,</span> duration<span class="token operator">:</span> end <span class="token operator">-</span> start <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">result<span class="token punctuation">.</span>sendContext<span class="token punctuation">.</span>loggingId <span class="token operator">=</span> id<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Next we get the end time after the work has completed. We add a log entry, and then we update the context we’re sending back down to the client (the <code>sendContext</code> object) with the correct <code>loggingId</code>. Recall that the client callback used this to add the <code>clientEnd</code> time.</p><p>And then we return the result, which then finishes the processing on the server, and allows control to return to the client.</p><p>The <code>addLog</code> function is pretty boring; it just inserts a row in our log table with Drizzle.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> addLog <span class="token operator">=</span> <span class="token function">createServerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> method<span class="token operator">:</span> <span class="token string">&quot;POST&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">inputValidator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>payload<span class="token operator">:</span> AddLogPayload<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> payload<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> <span class="token punctuation">{</span> actionName<span class="token punctuation">,</span> clientStart<span class="token punctuation">,</span> traceId<span class="token punctuation">,</span> duration <span class="token punctuation">}</span> <span class="token operator">=</span> data<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> id <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>actionLog<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      id<span class="token punctuation">,</span></span>
<span class="line">      traceId<span class="token punctuation">,</span></span>
<span class="line">      clientStart<span class="token punctuation">,</span></span>
<span class="line">      clientEnd<span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      actionName<span class="token punctuation">,</span></span>
<span class="line">      actionDuration<span class="token operator">:</span> duration<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> id <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The value of <code>clientEnd</code> is empty, initially, since the client callback will fill that in.</p><p>Let’s run our Middleware. We’ll add it to a serverFn that updates an epic.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> updateEpic <span class="token operator">=</span> </span>
<span class="line">  <span class="token function">createServerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> method<span class="token operator">:</span> <span class="token string">&quot;POST&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">loggingMiddleware</span><span class="token punctuation">(</span><span class="token string">&quot;update epic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">inputValidator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>epicsTable<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> data<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>epicsTable<span class="token punctuation">.</span>id<span class="token punctuation">,</span> data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>And when this executes, we can see our logs!</p><figure><img src="https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2025/10/img1-1.png?resize=1024%2C97&amp;ssl=1" alt="A database logging table displaying columns for id, trace_id, client_start, client_end, action_name, and action_duration, with several entries showing recorded data." tabindex="0" loading="lazy"><figcaption>A database logging table displaying columns for id, trace_id, client_start, client_end, action_name, and action_duration, with several entries showing recorded data.</figcaption></figure><hr><h2 id="the-problem" tabindex="-1"><a class="header-anchor" href="#the-problem"><span>The Problem</span></a></h2><p>There’s one small problem: we have a TypeScript error.</p><p>Here’s the entire middleware, with the TypeScript error pasted as a comment above the offending line</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@tanstack/react-start&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> addLog<span class="token punctuation">,</span> setClientEnd <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./logging&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">loggingMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span>
<span class="line">  <span class="token function">createMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;function&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> next<span class="token punctuation">,</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;middleware for&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">&quot;client&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">const</span> clientStart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        sendContext<span class="token operator">:</span> <span class="token punctuation">{</span> </span>
<span class="line">          clientStart<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">      <span class="token keyword">const</span> clientEnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line highlighted">      <span class="token comment">// ERROR: &#39;result.context&#39; is possibly &#39;undefined&#39;</span></span>
<span class="line highlighted">      <span class="token keyword">const</span> loggingId <span class="token operator">=</span> result<span class="token punctuation">.</span>context<span class="token punctuation">.</span>loggingId<span class="token punctuation">;</span> </span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">await</span> <span class="token function">setClientEnd</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> loggingId<span class="token punctuation">,</span> clientEnd <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">server</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> next<span class="token punctuation">,</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> traceId <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">      </span>
<span class="line">      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          loggingId<span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">const</span> end <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">addLog</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">      data<span class="token operator">:</span> <span class="token punctuation">{</span> </span>
<span class="line">        actionName<span class="token operator">:</span> name<span class="token punctuation">,</span></span>
<span class="line">        clientStart<span class="token operator">:</span> context<span class="token punctuation">.</span>clientStart<span class="token punctuation">,</span></span>
<span class="line">        traceId<span class="token operator">:</span> traceId<span class="token punctuation">,</span></span>
<span class="line">        duration<span class="token operator">:</span> end <span class="token operator">-</span> start </span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> </span>
<span class="line">    result<span class="token punctuation">.</span>sendContext<span class="token punctuation">.</span>loggingId <span class="token operator">=</span> id<span class="token punctuation">;</span> </span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">return</span> result<span class="token punctuation">;</span> </span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Why does TypeScript dislike this line?</p><p>We call it on the client, after we call <code>await next</code>. Our server does in fact add a <code>loggingId</code> to its <code>sendContext</code> object. And it’s there: the value is logged.</p><p>The problem is a technical one. Our server callback can see the things the client callback added to <code>sendContext</code>. But the client callback is <em>not</em> able to “look ahead” and see what the server callback added to <em>its</em> <code>sendContext</code> object. The solution is to split the Middleware up.</p><p>Here’s a version 2 of the same Middleware. I’ve added it to a new loggingMiddlewareV2.ts module.</p><p>I’ll post the entirety of it below, but it’s the same code as before, except all the stuff in the <code>.client</code> handler <em>after</em> the call to <code>await next</code> has been moved to a second Middleware. This new, second Middleware, which only contains the second half of the <code>.client</code> callback, then takes the other Middleware as its <em>own</em> Middleware input.</p><p>Here’s the code:</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> createMiddleware <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;@tanstack/react-start&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> addLog<span class="token punctuation">,</span> setClientEnd <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./logging&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> <span class="token function-variable function">loggingMiddlewarePre</span> <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span>
<span class="line">  <span class="token function">createMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;function&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> next<span class="token punctuation">,</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;middleware for&quot;</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token string">&quot;client&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> clientStart <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          clientStart<span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">server</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> next<span class="token punctuation">,</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> traceId <span class="token operator">=</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">          loggingId<span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> end <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> id <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">addLog</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">        data<span class="token operator">:</span> <span class="token punctuation">{</span> actionName<span class="token operator">:</span> name<span class="token punctuation">,</span> clientStart<span class="token operator">:</span> context<span class="token punctuation">.</span>clientStart<span class="token punctuation">,</span> traceId<span class="token operator">:</span> traceId<span class="token punctuation">,</span> duration<span class="token operator">:</span> end <span class="token operator">-</span> start <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      result<span class="token punctuation">.</span>sendContext<span class="token punctuation">.</span>loggingId <span class="token operator">=</span> id<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">loggingMiddleware</span> <span class="token operator">=</span> <span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span></span>
<span class="line">  <span class="token function">createMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">&quot;function&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">loggingMiddlewarePre</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> next <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> clientEnd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toISOString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> loggingId <span class="token operator">=</span> result<span class="token punctuation">.</span>context<span class="token punctuation">.</span>loggingId<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">await</span> <span class="token function">setClientEnd</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> loggingId<span class="token punctuation">,</span> clientEnd <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We export that <em>second</em> Middleware. It takes the other one as <em>its own</em> middleware. That runs everything, as before. But now when the <code>.client</code> callback calls <code>await next</code>, it knows what’s in the resulting context object. It knows this because that other Middleware is now <em>input</em> to <em>this</em> Middleware, and the typings can readily be seen.</p><hr><h2 id="going-deeper" tabindex="-1"><a class="header-anchor" href="#going-deeper"><span>Going Deeper</span></a></h2><p>We could end the post here. I don’t have anything new to show with respect to TanStack Start. But let’s make our observability system just a <em>little</em> bit more realistic, and in the process see a cool Node feature that’s not talked about enough, and also has the distinction of being the worst named API in software engineering history: <code>asyncLocalStorage</code>.</p><p>You’d be forgiven for thinking <code>asyncLocalStorage</code> was some kind of async version of your browser’s <code>localStorage</code>. But no: it’s a way to set and maintain context for the entirety of an async operation in Node.</p><h3 id="when-server-functions-call-server-functions" tabindex="-1"><a class="header-anchor" href="#when-server-functions-call-server-functions"><span>When Server Functions Call Server Functions</span></a></h3><p>Let’s imagine our <code>updateEpic</code> server function also wants to <em>read</em> the epic it just updated. It does this by calling the <code>getEpic</code> serverFn. So far so good, but if our <code>getEpic</code> serverFn also has logging Middleware configured, we really would want it to use the <code>traceId</code> we already created, rather than create its own.</p><p>Think about React context: it allows you to put arbitrary state onto an object that can be read by any component in the tree. Well, Node’s <code>asyncLocalStorage</code> allows this same kind of thing, except instead of being read anywhere inside of a component tree, the state we set can be read anywhere within the current async operation. This is exactly what we need.</p><p>Note that TanStack Start did have a <code>getContext</code> / <code>setContext</code> set of api’s in an earlier beta version, which maintained state for the current, entire <em>request</em>, but they were removed. If they wind up being re-added at some point (possibly with a different name) you can just use them.</p><p>Let’s start by importing <code>AsyncLocalStorage</code>, and creating an instance.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> AsyncLocalStorage <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;node:async_hooks&quot;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">const</span> asyncLocalStorage <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AsyncLocalStorage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now let’s create a function for <em>reading</em> the traceId that some middleware <em>higher up</em> in our callstack <em>might</em> have added</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">function</span> <span class="token function">getExistingTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">const</span> store <span class="token operator">=</span> asyncLocalStorage<span class="token punctuation">.</span><span class="token function">getStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">any</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> store<span class="token operator">?.</span>traceId<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>All that’s left is to <em>read</em> the <code>traceId</code> that was <em>possibly</em> set already, and if none was set, create one. And then, crucially, use <code>asyncLocalStorage</code> to <em>set</em> our <code>traceId</code> for any other Middleware that will be called during our operation.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line">    <span class="token punctuation">.</span><span class="token function">server</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> next<span class="token punctuation">,</span> context <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token keyword">const</span> priorTraceId <span class="token operator">=</span> <span class="token function">getExistingTraceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">const</span> traceId <span class="token operator">=</span> priorTraceId <span class="token operator">??</span> crypto<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> start <span class="token operator">=</span> <span class="token operator">+</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">      <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> asyncLocalStorage<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span> traceId <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">          sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">            loggingId<span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token keyword">as</span> <span class="token builtin">string</span></span>
<span class="line">          <span class="token punctuation">}</span></span>
<span class="line">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The magic line is this:</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> asyncLocalStorage<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">{</span> traceId <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    sendContext<span class="token operator">:</span> <span class="token punctuation">{</span></span>
<span class="line">      loggingId<span class="token operator">:</span> <span class="token string">&quot;&quot;</span> <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Our call to next is wrapped in <code>asyncLocalStorage.run</code>, which means <em>virtually anything</em> that gets called in there can see the <code>traceId</code> we set. There are a few exceptions at the margins, for things like WorkerThreads. But any normal async operations which happen inside of the run callback will see the <code>traceId</code> we set.</p><p>The rest of the Middleware is the same, and I’ve saved it in a loggingMiddlewareV3 module. Let’s take it for a spin. First, we’ll add it to our <code>getEpic</code> serverFn.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> getEpic <span class="token operator">=</span> <span class="token function">createServerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> method<span class="token operator">:</span> <span class="token string">&quot;GET&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">loggingMiddlewareV3</span><span class="token punctuation">(</span><span class="token string">&quot;get epic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">inputValidator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">Number</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">const</span> epic <span class="token operator">=</span> <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>epicsTable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>epicsTable<span class="token punctuation">.</span>id<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> epic<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now let’s add it to <code>updateEpic</code>, and update it to also call our <code>getEpic</code> server function.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> updateEpic <span class="token operator">=</span> <span class="token function">createServerFn</span><span class="token punctuation">(</span><span class="token punctuation">{</span> method<span class="token operator">:</span> <span class="token string">&quot;POST&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">middleware</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token function">loggingMiddlewareV3</span><span class="token punctuation">(</span><span class="token string">&quot;update epic&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">inputValidator</span><span class="token punctuation">(</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span> name<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> obj<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Promise</span></span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> <span class="token number">1000</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">await</span> db<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>epicsTable<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">{</span> name<span class="token operator">:</span> data<span class="token punctuation">.</span>name <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token function">eq</span><span class="token punctuation">(</span>epicsTable<span class="token punctuation">.</span>id<span class="token punctuation">,</span> data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">const</span> updatedEpic <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getEpic</span><span class="token punctuation">(</span><span class="token punctuation">{</span> data<span class="token operator">:</span> data<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> updatedEpic<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Our server function now updates our epic, and then <em>calls</em> the other serverFn to <em>read</em> the newly updated epic.</p><p>Let’s clear our logging table, then give it a run. I’ll edit, and save an individual epic. Opening the log table now shows this:</p><figure><img src="https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2025/10/img2-1.png?resize=1024%2C98&amp;ssl=1" alt="A screenshot of a database table displaying log entries with columns for id, , , , , and ." tabindex="0" loading="lazy"><figcaption>A screenshot of a database table displaying log entries with columns for id, <code>trace_id</code>, <code>client_start</code>, <code>client_end</code>, <code>action_name</code>, and <code>action_duration</code>.</figcaption></figure><p>Note there’s <em>three</em> log entries. In order to edit the epic, the UI first <em>reads</em> it. That’s the first entry. Then the update happens, and then the second read, from the <code>updateEpic</code> serverFn. Crucially, notice how the last two rows, the update and the last read, both share the same <code>traceId</code>!</p><p>Our “observability” system is pretty basic right now. The <code>clientStart</code> and <code>clientEnd</code> probably don’t make much sense for these secondary actions that are all fired off from the server, since there’s not really any end-to-end latency. A real observability system would likely have separate, isolated rows just for client-to-server latency measures. But combining everything together made it easier to put something simple together, and showing off TanStack Start Middleware was the goal, not creating a real observability system.</p><p>Besides, we’ve now seen all the pieces you’d need if you wanted to actually build this into something more realistic: TanStack’s Middleware gives you everything you need to do anything you can imagine.</p><hr><h2 id="parting-thoughts" tabindex="-1"><a class="header-anchor" href="#parting-thoughts"><span>Parting Thoughts</span></a></h2><p>We’ve barely scratched the surface of Middleware. Stay tuned for a future post where we’ll push middleware to its limit and achieve single-flight mutations.</p>`,68)),g(" TODO: add ARTICLE CARD "),t(i,u(r({title:"Introducing TanStack Start Middleware",desc:"TanStack Start is one of the most exciting full-stack web development frameworks I’ve seen. I’ve written about it before. In essence, TanStack Start takes TanStack Router, a superb, strongly-typed client-side JavaScript framework, and adds server-side support. This serves two purposes: it gives you a place to execute server-side code, like database access; and it enables […]",link:"https://chanhi2000.github.io/bookshelf/frontendmasters.com/introducing-tanstack-start-middleware.html",logo:"https://frontendmasters.com/favicon.ico",background:"rgba(188,75,52,0.2)"})),null,16)])}const D=m(f,[["render",O]]),W=JSON.parse('{"path":"/frontendmasters.com/introducing-tanstack-start-middleware.html","title":"Introducing TanStack Start Middleware","lang":"en-US","frontmatter":{"lang":"en-US","title":"Introducing TanStack Start Middleware","description":"Article(s) > Introducing TanStack Start Middleware","icon":"fa-brands fa-react","category":["Node.js","React.js","Article(s)"],"tag":["blog","frontendmasters.com","node","nodejs","node-js","react","reactjs","react-js"],"head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Introducing TanStack Start Middleware\\",\\"image\\":[\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2025/10/img3-1.png?resize=715%2C1024&ssl=1\\",\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2025/10/img1-1.png?resize=1024%2C97&ssl=1\\",\\"https://i0.wp.com/frontendmasters.com/blog/wp-content/uploads/2025/10/img2-1.png?resize=1024%2C98&ssl=1\\"],\\"datePublished\\":\\"2025-10-24T00:00:00.000Z\\",\\"dateModified\\":null,\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Adam Rackis\\",\\"url\\":\\"https://frontendmasters.com/blog/author/adamrackis/\\"}]}"],["meta",{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/frontendmasters.com/introducing-tanstack-start-middleware.html"}],["meta",{"property":"og:site_name","content":"📚Bookshelf"}],["meta",{"property":"og:title","content":"Introducing TanStack Start Middleware"}],["meta",{"property":"og:description","content":"Article(s) > Introducing TanStack Start Middleware"}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://frontendmasters.com/blog/wp-json/social-image-generator/v1/image/7452"}],["meta",{"property":"og:locale","content":"en-US"}],["meta",{"name":"twitter:card","content":"summary_large_image"}],["meta",{"name":"twitter:image:src","content":"https://frontendmasters.com/blog/wp-json/social-image-generator/v1/image/7452"}],["meta",{"name":"twitter:image:alt","content":"Introducing TanStack Start Middleware"}],["meta",{"property":"article:author","content":"Adam Rackis"}],["meta",{"property":"article:tag","content":"react-js"}],["meta",{"property":"article:tag","content":"reactjs"}],["meta",{"property":"article:tag","content":"react"}],["meta",{"property":"article:tag","content":"node-js"}],["meta",{"property":"article:tag","content":"nodejs"}],["meta",{"property":"article:tag","content":"node"}],["meta",{"property":"article:tag","content":"frontendmasters.com"}],["meta",{"property":"article:tag","content":"blog"}],["meta",{"property":"article:published_time","content":"2025-10-24T00:00:00.000Z"}],[{"meta":null},{"property":"og:title","content":"Article(s) > Introducing TanStack Start Middleware"},{"property":"og:description","content":"Introducing TanStack Start Middleware"},{"property":"og:url","content":"https://chanhi2000.github.io/bookshelf/frontendmasters.com/introducing-tanstack-start-middleware.html"}]],"prev":"/programming/css/articles/README.md","date":"2025-10-24T00:00:00.000Z","isOriginal":false,"author":[{"name":"Adam Rackis","url":"https://frontendmasters.com/blog/author/adamrackis/"}],"cover":"https://frontendmasters.com/blog/wp-json/social-image-generator/v1/image/7452"},"git":{},"readingTime":{"minutes":14.12,"words":4236},"filePathRelative":"frontendmasters.com/introducing-tanstack-start-middleware.md","copyright":{"author":"Adam Rackis"}}');export{D as comp,W as data};
