<!doctype html>
<html lang="ko-KR" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.26" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.99" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Next.js 캐싱으로 웹 서버 성능 최적화","image":["https://fanstore.melon.com/ko/malls/1210462545352527872/products","https://developer.mozilla.org/en-US/docs/Web/API/Performance_API/Navigation_timing","https://nextjs.org/docs/app/building-your-application/caching#request-memoization","https://nextjs.org/docs/app/building-your-application/caching#revalidating-1","https://nextjs.org/docs/app/building-your-application/caching#static-and-dynamic-rendering","https://fe-developers.kakaoent.com/static/8bb8cfa0c38eb16056dfbfb184503196/587b0/fanstore-product-list.png","https://fe-developers.kakaoent.com/static/26b7112ec5e50e997392a3df747ff9b5/587b0/fanstore-product-detail.png","https://fe-developers.kakaoent.com/static/38e2dae2f2fe6c8bbfd7a45839d2feac/d43b4/ngrinder.png","https://fe-developers.kakaoent.com/static/e4e7d3deedc51ecb9623e90bd8bfc119/9d76a/fanstore-filter.png","https://fe-developers.kakaoent.com/static/65b8d5d61ed01b63cbd17bee3f02afdc/d30ee/result-before.png    ","https://fe-developers.kakaoent.com/static/5d5eb3c9c50690c0d8d1b38dc20078c9/d30ee/result-after.png","https://fe-developers.kakaoent.com/static/7ce47e1db33f39e258141334298f99b0/e03bf/mtt-before.png","https://fe-developers.kakaoent.com/static/709512ad6d82f80fe9d2e8e8a06b8692/48c0e/mtt-after.png"],"datePublished":"2024-05-03T00:00:00.000Z","dateModified":null,"author":[]}</script><meta property="og:url" content="https://chanhi2000.github.io/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html"><meta property="og:site_name" content="📚Bookshelf"><meta property="og:title" content="Next.js 캐싱으로 웹 서버 성능 최적화"><meta property="og:description" content="Article(s) > Next.js 캐싱으로 웹 서버 성능 최적화"><meta property="og:type" content="article"><meta property="og:image" content="https://fe-developers.kakaoent.com/static/64f999e746db02b310c7a08bb93709ac/afa5c/thumbnail.png"><meta property="og:locale" content="ko-KR"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:src" content="https://fe-developers.kakaoent.com/static/64f999e746db02b310c7a08bb93709ac/afa5c/thumbnail.png"><meta name="twitter:image:alt" content="Next.js 캐싱으로 웹 서버 성능 최적화"><meta property="article:tag" content="next-js"><meta property="article:tag" content="nextjs"><meta property="article:tag" content="next"><meta property="article:tag" content="node-js"><meta property="article:tag" content="nodejs"><meta property="article:tag" content="node"><meta property="article:tag" content="fe-developers.kakaoent.com"><meta property="article:tag" content="blog"><meta property="article:published_time" content="2024-05-03T00:00:00.000Z"><link rel="icon" href="/bookshelf/assets/icon/favicon.svg"><title>Next.js 캐싱으로 웹 서버 성능 최적화 | 📚Bookshelf</title><meta name="description" content="Article(s) > Next.js 캐싱으로 웹 서버 성능 최적화">
    <link rel="preload" href="/bookshelf/assets/style-Bhb-QcDa.css" as="style"><link rel="stylesheet" href="/bookshelf/assets/style-Bhb-QcDa.css">
    
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/bookshelf/" aria-label="Take me home"><img class="vp-nav-logo" src="/bookshelf/assets/icon/favicon.svg" alt><!----><span class="vp-site-name hide-in-pad">📚Bookshelf</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/bookshelf/news.html" aria-label><!--[--><i class="vp-icon fas fa-rss" sizing="height"></i><!--]--><!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label><!--[--><i class="vp-icon fas fa-keyboard" sizing="height"></i><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/hackingwithswift.com/" aria-label="hackingwithswift.com"><!--[--><img class="vp-icon" src="https://hackingwithswift.com/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->hackingwithswift.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/fcc/" aria-label="freecodecamp.org"><!--[--><img class="vp-icon" src="https://cdn.freecodecamp.org/universal/favicons/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->freecodecamp.org<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/kodeco.com/" aria-label="kodeco.com"><!--[--><img class="vp-icon" src="https://kodeco.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->kodeco.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.kotzilla.io/" aria-label="blog.kotzilla.io"><!--[--><img class="vp-icon" src="https://blog.kotzilla.io/hubfs/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->blog.kotzilla.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/kt.academy/" aria-label="kt.academy"><!--[--><img class="vp-icon" src="https://kt.academy/logo.png" alt aria-hidden no-view sizing="both"><!--]-->kt.academy<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/droidcon.com/" aria-label="droidcon.com"><!--[--><img class="vp-icon" src="https://droidcon.com/wp-content/uploads/2021/07/favicon-300x300.png" alt aria-hidden no-view sizing="both"><!--]-->droidcon.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/outcomeschool.com/" aria-label="outcomeschool.com"><!--[--><img class="vp-icon" src="https://outcomeschool.com/static/favicons/apple-touch-icon.png" alt aria-hidden no-view sizing="both"><!--]-->outcomeschool.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/frontendmasters.com/" aria-label="frontendmasters.com"><!--[--><img class="vp-icon" src="https://frontendmasters.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->frontendmasters.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/css-tricks.com/" aria-label="css-tricks.com"><!--[--><img class="vp-icon" src="https://css-tricks.com/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->css-tricks.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/smashingmagazine.com/" aria-label="smashingmagazine.com"><!--[--><img class="vp-icon" src="https://smashingmagazine.com/images/favicon/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->smashingmagazine.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/smashingmagazine.com/" aria-label="oddbird.net"><!--[--><img class="vp-icon" src="https://oddbird.net/safari-pinned-tab.svg" alt aria-hidden no-view sizing="both"><!--]-->oddbird.net<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/zeroheight.com/" aria-label="zeroheight.com"><!--[--><img class="vp-icon" src="https://zeroheight.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->zeroheight.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/typescript.tv/" aria-label="typescript.tv"><!--[--><img class="vp-icon" src="https://typescript.tv/_astro/android-chrome-192x192.BhQ8hcWh.png" alt aria-hidden no-view sizing="both"><!--]-->typescript.tv<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.logrocket.com/" aria-label="blog.logrocket.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/blog.logrocket.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->blog.logrocket.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/realpython.com/" aria-label="realpython.com"><!--[--><img class="vp-icon" src="https://realpython.com/static/favicon.68cbf4197b0c.png" alt aria-hidden no-view sizing="both"><!--]-->realpython.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/digitalocean.com/" aria-label="digitalocean.com"><!--[--><img class="vp-icon" src="https://digitalocean.com/_next/static/media/favicon.594d6067.ico" alt aria-hidden no-view sizing="both"><!--]-->digitalocean.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/antonioleiva.com/" aria-label="antonioleiva.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/antonioleiva.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->antonioleiva.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/johnnyreilly.com/" aria-label="johnnyreilly.com"><!--[--><img class="vp-icon" src="https://johnnyreilly.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->johnnyreilly.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/code-maze.com/" aria-label="code-maze.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/code-maze.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->code-maze.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/milanjovanovic.tech/" aria-label="milanjovanovic.tech"><!--[--><img class="vp-icon" src="https://milanjovanovic.tech/profile_favicon.png" alt aria-hidden no-view sizing="both"><!--]-->milanjovanovic.tech<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/shopify.engineering/" aria-label="shopify.engineering"><!--[--><img class="vp-icon" src="https://cdn.shopify.com/static/shopify-favicon.png" alt aria-hidden no-view sizing="both"><!--]-->shopify.engineering<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/devtoolstips.org/" aria-label="devtoolstips.org"><!--[--><img class="vp-icon" src="https://devtoolstips.org/assets/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->devtoolstips.org<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/piccalil.li/" aria-label="piccalil.li"><!--[--><img class="vp-icon" src="https://piccalil.li/favicons/apple-touch-icon.png" alt aria-hidden no-view sizing="both"><!--]-->piccalil.li<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/sitepoint.com/" aria-label="sitepoint.com"><!--[--><img class="vp-icon" src="https://sitepoint.com/favicons/512x512.png" alt aria-hidden no-view sizing="both"><!--]-->sitepoint.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/event-driven.io/" aria-label="event-driven.io"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/event-driven.io/favicon.jfif" alt aria-hidden no-view sizing="both"><!--]-->event-driven.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/packagemain.tech/" aria-label="packagemain.tech"><!--[--><img class="vp-icon" src="https://substack-post-media.s3.amazonaws.com/public/images/2ea54e25-eaa6-4630-bfc0-10b8cfdce894/apple-touch-icon-1024x1024.png" alt aria-hidden no-view sizing="both"><!--]-->packagemain.tech<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/gosolve.io/" aria-label="gosolve.io"><!--[--><img class="vp-icon" src="https://gosolve.io/wp-content/uploads/2022/03/cropped-ikona1-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->gosolve.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/bram.us/" aria-label="bram.us"><!--[--><img class="vp-icon" src="https://bram.us/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->bram.us<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/una.im/" aria-label="una.im"><!--[--><img class="vp-icon" src="https://una.im/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->una.im<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/joshwcomeau.com/" aria-label="joshwcomeau.com"><!--[--><img class="vp-icon" src="https://joshwcomeau.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->joshwcomeau.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/css-tip.com/" aria-label="css-tip.com"><!--[--><img class="vp-icon" src="https://css-tip.com/img/fav.png" alt aria-hidden no-view sizing="both"><!--]-->css-tip.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/nerdy.dev/" aria-label="nerdy.dev"><!--[--><img class="vp-icon" src="https://nerdy.dev/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->nerdy.dev<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/towardsdatascience.com/" aria-label="towardsdatascience.com"><!--[--><img class="vp-icon" src="https://cdn-images-1.medium.com/v2/resize:fill:128:128/1*VzTUkfeGymHP4Bvav-T-lA.png" alt aria-hidden no-view sizing="both"><!--]-->towardsdatascience.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/douggregor.net/" aria-label="douggregor.net"><!--[--><i class="vp-icon fas fa-globe" sizing="both"></i><!--]-->douggregor.net<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/d2.naver.com/" aria-label="d2.naver.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/d2.naver.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->d2.naver.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tech.kakao.com/" aria-label="tech.kakao.com"><!--[--><img class="vp-icon" src="https://www.kakaocorp.com/page/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tech.kakao.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tech.kakaopay.com/" aria-label="tech.kakaopay.com"><!--[--><img class="vp-icon" src="https://tech.kakaopay.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tech.kakaopay.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/bookshelf/fe-developers.kakaoent.com/" aria-label="fe-developers.kakaoent.com"><!--[--><img class="vp-icon" src="https://fe-developers.kakaoent.com/favicon-32x32.png?v=44803cb16c1e2debd3984cf2e8cb2ded" alt aria-hidden no-view sizing="both"><!--]-->fe-developers.kakaoent.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/yozm.wishket.com/" aria-label="yozm.wishket.com"><!--[--><img class="vp-icon" src="https://yozm.wishket.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->yozm.wishket.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/popit.kr/" aria-label="popit.kr"><!--[--><img class="vp-icon" src="https://popit.kr/wp-content/uploads/2016/08/favicon_32x32.png" alt aria-hidden no-view sizing="both"><!--]-->popit.kr<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/devkuma.com/" aria-label="devkuma.com"><!--[--><img class="vp-icon" src="https://devkuma.com/favicons/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->devkuma.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.gangnamunni.com/" aria-label="blog.gangnamunni.com"><!--[--><img class="vp-icon" src="https://blog.gangnamunni.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->blog.gangnamunni.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/codingeverybody.kr/" aria-label="codingeverybody.kr"><!--[--><img class="vp-icon" src="https://codingeverybody.kr/wp-content/uploads/cropped-favicon-origin-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->codingeverybody.kr<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label><!--[--><i class="vp-icon fas fa-network-wired" sizing="height"></i><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tecmint.com/" aria-label="tecmint.com"><!--[--><img class="vp-icon" src="https://tecmint.com/wp-content/uploads/2020/07/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tecmint.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/docker.com/" aria-label="docker.com"><!--[--><img class="vp-icon" src="https://docker.com/app/uploads/2024/02/cropped-docker-logo-favicon-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->docker.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/learnkube.com/" aria-label="learnkube.com"><!--[--><img class="vp-icon" src="https://static.learnkube.com/f7e5160d4744cf05c46161170b5c11c9.svg" alt aria-hidden no-view sizing="both"><!--]-->learnkube.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/itsfoss.com/" aria-label="itsfoss.com"><!--[--><img class="vp-icon" src="https://itsfoss.com/content/images/size/w256h256/2022/12/android-chrome-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->itsfoss.com<!----></a></li></ul></button></div></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/chanhi2000/bookshelf" target="_blank" rel="noopener noreferrer" aria-label="Github"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><!----></div><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><img class="vp-icon" src="https://fe-developers.kakaoent.com/favicon-32x32.png?v=44803cb16c1e2debd3984cf2e8cb2ded" alt aria-hidden no-view sizing="both"><span class="vp-sidebar-title">fe-developers.kakaoent.com</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/fe-developers.kakaoent.com/230612-aws-amplify-serverless.html" aria-label="AWS amplify로 서버리스 웹 애플리케이션 구축하기"><!--[--><i class="vp-icon fa-brands fa-aws" sizing="both"></i><!--]-->AWS amplify로 서버리스 웹 애플리케이션 구축하기<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/fe-developers.kakaoent.com/230720-react-query.html" aria-label="React Query의 구조와 useQuery 실행 흐름 살펴보기"><!--[--><i class="vp-icon fa-brands fa-react" sizing="both"></i><!--]-->React Query의 구조와 useQuery 실행 흐름 살펴보기<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/fe-developers.kakaoent.com/230816-backstopjs-vrt2.html" aria-label="BackstopJS 적용 후기 (Visual Regression Test)"><!--[--><i class="vp-icon iconfont icon-nextjs" sizing="both"></i><!--]-->BackstopJS 적용 후기 (Visual Regression Test)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/fe-developers.kakaoent.com/240116-common-component.html" aria-label="더 가치 있는 공통 컴포넌트 만들기"><!--[--><i class="vp-icon fa-brands fa-react" sizing="both"></i><!--]-->더 가치 있는 공통 컴포넌트 만들기<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html" aria-label="Next.js 캐싱으로 웹 서버 성능 최적화"><!--[--><i class="vp-icon iconfont icon-nextjs" sizing="both"></i><!--]-->Next.js 캐싱으로 웹 서버 성능 최적화<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/fe-developers.kakaoent.com/240715-handling-file-variables.html" aria-label="파일 변수 Deep-Dive"><!--[--><i class="vp-icon fa-brands fa-react" sizing="both"></i><!--]-->파일 변수 Deep-Dive<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><div class="page-cover"><img src="https://fe-developers.kakaoent.com/static/64f999e746db02b310c7a08bb93709ac/afa5c/thumbnail.png" alt no-view></div><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>Next.js 캐싱으로 웹 서버 성능 최적화</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">24. 5. 3.</span><meta property="datePublished" content="2024-05-03T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 4 min</span><meta property="timeRequired" content="PT4M"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color1" role>Node.js</span><span class="page-category-item color4" role>Next.js</span><span class="page-category-item color8" role>Article(s)</span><!--]--><meta property="articleSection" content="Node.js,Next.js,Article(s)"></span><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color8" role>blog</span><span class="page-tag-item color3" role>fe-developers.kakaoent.com</span><span class="page-tag-item color2" role>node</span><span class="page-tag-item color6" role>nodejs</span><span class="page-tag-item color3" role>node-js</span><span class="page-tag-item color5" role>next</span><span class="page-tag-item color0" role>nextjs</span><span class="page-tag-item color8" role>next-js</span><!--]--><meta property="keywords" content="blog,fe-developers.kakaoent.com,node,nodejs,node-js,next,nextjs,next-js"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><h1 id="frontmatter-title-관련" tabindex="-1"><a class="header-anchor" href="#frontmatter-title-관련"><span>Next.js 캐싱으로 웹 서버 성능 최적화 관련</span></a></h1><a class="route-link vp-card" href="/bookshelf/programming/js-next/articles/" style="background:rgba(10,10,10,0.2);"><img class="vp-card-logo" src="https://chanhi2000.github.io/images/ico-wind.svg" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">Next.js > Article(s)</div><hr><div class="vp-card-desc">Article(s)</div></div></a><hr><div class="vp-site-info" data-name="Next.js 캐싱으로 웹 서버 성능 최적화 | 카카오엔터테인먼트 FE 기술블로그"><a class="vp-site-info-navigator no-external-link-icon" title="Next.js 캐싱으로 웹 서버 성능 최적화 | 카카오엔터테인먼트 FE 기술블로그" href="https://fe-developers.kakaoent.com/2024/240418-optimizing-nextjs-cache/" target="_blank"></a><div class="vp-site-info-preview" style="background:url(https://fe-developers.kakaoent.com/static/64f999e746db02b310c7a08bb93709ac/afa5c/thumbnail.png) center/cover no-repeat;"></div><div class="vp-site-info-detail"><img class="vp-site-info-logo" src="https://fe-developers.kakaoent.com/favicon-32x32.png?v=44803cb16c1e2debd3984cf2e8cb2ded" alt loading="lazy" no-view><div class="vp-site-info-name">Next.js 캐싱으로 웹 서버 성능 최적화 | 카카오엔터테인먼트 FE 기술블로그</div><div class="vp-site-info-desc">Next.js의 Full Route Cache를 적극 활용함으로써, 서버 렌더링에 사용되는 CPU 리소스를 최소화한 경험을 공유합니다.</div></div><!----></div><p>올해 초 저희 팀에서는 신규 커머스 서비스를 오픈했습니다. 아무래도 커머스에서는 SEO가 중요하다보니 <code>Next.js</code> 의 App Router를 사용해서 SSR(Server Side Rendering)을 구성했는데요.</p><figure><img src="https://fe-developers.kakaoent.com/static/2c329b8ae854e8f903b58938529d79dc/712f7/fanstore.png" alt="&lt;VPIcon icon=&quot;fas fa-globe&quot;/&gt;fanstore.melon.com" tabindex="0" loading="lazy"><figcaption><a href="https://fanstore.melon.com/ko/malls/1210462545352527872/products" target="_blank" rel="noopener noreferrer"><i class="vp-icon fas fa-globe" sizing="height"></i>fanstore.melon.com</a></figcaption></figure><p>오픈전 부하테스트 과정에서 예상보다 낮은 TPS(Transaction Per Second)가 확인되어 당황했었습니다. 이 글에서는 저희 팀이 <code>Next.js</code>의 Full Route Cache를 적극 활용함으로써, 서버 렌더링에 사용되는 CPU 리소스를 최소화한 경험을 소개합니다.</p><nav class="table-of-contents"><ul><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#웹-서버의-성능은-왜-중요할까요" class="router-link-active router-link-exact-active">웹 서버의 성능은 왜 중요할까요?</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#웹-서버의-성능을-향상시키기-위해서-우리는-무엇을-해야-할까요" class="router-link-active router-link-exact-active">웹 서버의 성능을 향상시키기 위해서 우리는 무엇을 해야 할까요?</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#next-js의-캐싱-매커니즘" class="router-link-active router-link-exact-active">Next.js의 캐싱 매커니즘</a><ul><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#request-memoization" class="router-link-active router-link-exact-active">Request Memoization</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#data-cache" class="router-link-active router-link-exact-active">Data Cache</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#full-route-cache" class="router-link-active router-link-exact-active">Full Route Cache</a></li></ul></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#next-js의-캐싱-적용하기" class="router-link-active router-link-exact-active">Next.js의 캐싱 적용하기</a><ul><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#_1-캐싱-대상-정하기" class="router-link-active router-link-exact-active">1. 캐싱 대상 정하기</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#_2-변경-범위-파악-및-테스트-코드-보강" class="router-link-active router-link-exact-active">2. 변경 범위 파악 및 테스트 코드 보강</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#_3-as-is-부하-테스트" class="router-link-active router-link-exact-active">3. AS-IS 부하 테스트</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#_4-캐시-디버깅-컴포넌트-구현" class="router-link-active router-link-exact-active">4. 캐시 디버깅 컴포넌트 구현</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#_5-코드-변경" class="router-link-active router-link-exact-active">5. 코드 변경</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#_5-1-url-path" class="router-link-active router-link-exact-active">5.1 URL PATH</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#_5-2-dynamic-functions" class="router-link-active router-link-exact-active">5.2 Dynamic Functions</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#_5-3-full-route-cache-적용" class="router-link-active router-link-exact-active">5.3 Full Route Cache 적용</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#효과는-굉장했다" class="router-link-active router-link-exact-active">효과는 굉장했다</a></li><li><a aria-current="page" href="/bookshelf/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.html#정리" class="router-link-active router-link-exact-active">정리</a></li></ul></li></ul></nav><hr><h2 id="웹-서버의-성능은-왜-중요할까요" tabindex="-1"><a class="header-anchor" href="#웹-서버의-성능은-왜-중요할까요"><span>웹 서버의 성능은 왜 중요할까요?</span></a></h2><p>축구경기에서 좋은 패스를 받은 공격수가 슛을 느리게 하는 바람에 골을 놓치는 경우가 종종 있는데요. 마찬가지로 웹 페이지에서도 좋은 컨텐츠, 좋은 상품을 느리게 로딩하는 바람에 고객을 놓치는 사례를 쉽게 확인할 수 있습니다.</p><ul><li><a href="https://medium.com/pinterest-engineering/driving-user-growth-with-performance-improvements-cfc50dafadd7#.wwimdmkpp" target="_blank" rel="noopener noreferrer">Pinterest는 로딩속도를 40% 개선한 후, 트래픽이 15% 증가하고 회원가입이 15% 증가했습니다. (<i class="vp-icon fa-brands fa-medium" sizing="height"></i><code>pinterest-engineering</code>)</a></li><li><a href="https://zdnet.co.kr/view/?no=20190418142445" target="_blank" rel="noopener noreferrer"><i class="vp-icon fas fa-globe" sizing="height"></i>Amazon은 로딩속도가 1초 빨라지면, 매출이 68억달러가 증가한다고 발표했습니다.</a></li><li><a href="https://neilpatel.com/blog/loading-time/" target="_blank" rel="noopener noreferrer"><i class="vp-icon fas fa-globe" sizing="height"></i>온라인 쇼핑몰의 빠른 로딩속도는 사이트의 신뢰도까지 향상 시킨다는 통계도 있습니다.</a></li></ul><p>웹 서버의 성능은 당연하게도 <strong>웹페이지의 로딩속도</strong>를 결정하는 중요한 요소 중 하나입니다. 웹 페이지 요청 과정을 표현한 아래 다이어그램에서 노란색 부분, 즉 <a href="https://web.dev/articles/ttfb?hl=ko" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-webdev" sizing="height"></i>TTFB(Time to First Byte)</a>에 해당하는 영역이 웹 서버의 성능으로부터 영향을 받습니다.</p><figure><img src="https://fe-developers.kakaoent.com/fb6f7d36d4bf64e68cc3417a4fecfa26/performance-navigation-timing-timestamp-diagram.svg" alt="&lt;VPIcon icon=&quot;fa-brands fa-firefox&quot; /&gt;developer.mozilla.org" tabindex="0" loading="lazy"><figcaption><a href="https://developer.mozilla.org/en-US/docs/Web/API/Performance_API/Navigation_timing" target="_blank" rel="noopener noreferrer"><i class="vp-icon fa-brands fa-firefox" sizing="height"></i>developer.mozilla.org</a></figcaption></figure><p>승리를 하는 데에 (이익을 내는 데에) 골을 잘 넣는 것만큼이나 중요한 게 골을 덜 먹히는 것인데요. 웹 서버의 성능을 개선하면 동일한 수준의 트래픽을 처리하는 데 필요한 <strong>인프라 비용</strong>을 낮춤으로써 이익에 기여할 수 있습니다.</p><hr><h2 id="웹-서버의-성능을-향상시키기-위해서-우리는-무엇을-해야-할까요" tabindex="-1"><a class="header-anchor" href="#웹-서버의-성능을-향상시키기-위해서-우리는-무엇을-해야-할까요"><span>웹 서버의 성능을 향상시키기 위해서 우리는 무엇을 해야 할까요?</span></a></h2><p><a href="https://medium.com/@surksha8/10-proven-strategies-to-boost-your-next-js-app-performance-2de166dcff50" target="_blank" rel="noopener noreferrer">웹 서버의 성능을 향상시키기 위해 알려진 방법 (<i class="vp-icon fa-brands fa-medium" sizing="height"></i><code>@surksha8</code>)</a>들은 여러 가지 있지만, 우리의 에너지는 한정적이기 때문에 효과가 가장 높은 방법을 선택적으로 적용해야 합니다. 그러기 위해 앞에서 잠깐 언급한 저희 팀 신규 서비스의 특징을 살펴봤습니다.</p><ol><li>공연 티켓 구매자들에게만 공연 관련 상품을 판매하는 서비스다 보니 <strong>상품의 개수가 적습니다.</strong> (그마저도 공연이 끝나면 사라집니다.)</li><li>핫한 공연은 오픈 시점에 <strong>갑자기 엄청난 트래픽이 발생</strong>할 수 있습니다.</li><li>트래픽은 <strong>상품 목록, 상품 상세 페이지에 집중</strong>될 것으로 예상됩니다.</li><li>상품 목록, 상품 상세 페이지는 상품 재고 값을 제외하면 <strong>데이터 변경이 거의 없습니다.</strong></li></ol><p>이미 눈치채셨겠지만, 저희는 상품 관련 페이지의 서버 렌더링 결과에 캐싱을 적용하는 것이 가장 효과가 클 것이라 의견을 모았습니다. 상품의 개수가 적고, 트래픽이 발생할 때 특정 상품으로 집중되는 특징은 <a href="https://stackpath.com/edge-academy/what-is-cache-hit-ratio/" target="_blank" rel="noopener noreferrer"><i class="vp-icon fas fa-globe" sizing="height"></i>Cache Hit Ratio</a>에 너무나 유리한 조건입니다.</p><hr><h2 id="next-js의-캐싱-매커니즘" tabindex="-1"><a class="header-anchor" href="#next-js의-캐싱-매커니즘"><span>Next.js의 캐싱 매커니즘</span></a></h2><p>Next.js는 13 버전에서 <a href="https://nextjs.org/docs/app" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>App router</a>와 함께 <a href="https://nextjs.org/docs/app/building-your-application/caching" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>새로운 캐싱 매커니즘</a>을 소개했습니다.</p><table><thead><tr><th style="text-align:right;">매커니즘</th><th style="text-align:left;">대상</th><th style="text-align:center;">장소</th><th style="text-align:left;">목적</th><th style="text-align:left;">기간</th></tr></thead><tbody><tr><td style="text-align:right;">Request Memoization</td><td style="text-align:left;">fetch 함수의 return값</td><td style="text-align:center;">서버</td><td style="text-align:left;">React Component tree에서 data의 재사용</td><td style="text-align:left;">request 생명주기 동안</td></tr><tr><td style="text-align:right;">Data Cache</td><td style="text-align:left;">Data</td><td style="text-align:center;">서버</td><td style="text-align:left;">유저 요청이나 deployment에 의해 저장된 데이터</td><td style="text-align:left;">영구적(revalidate 가능)</td></tr><tr><td style="text-align:right;">Full Route Cache</td><td style="text-align:left;">HTML, RSC Payload</td><td style="text-align:center;">서버</td><td style="text-align:left;"><strong>렌더링 cost 감소 및 성능 향상</strong></td><td style="text-align:left;">영구적(revalidate 가능)</td></tr><tr><td style="text-align:right;">Router Cache</td><td style="text-align:left;">RSC Payload</td><td style="text-align:center;">클라이언트</td><td style="text-align:left;">네비게이션에 의한 서버 요청 감소</td><td style="text-align:left;">세션 또는 정해진 시간 동안</td></tr></tbody></table><p>이 글에서는 웹 서버의 성능에 집중하고 있기 때문에, 서버에 적용되는 캐시 매커니즘에 대해서만 간단히 소개하겠습니다.</p><h3 id="request-memoization" tabindex="-1"><a class="header-anchor" href="#request-memoization"><span>Request Memoization</span></a></h3><p>웹 서버로 페이지 요청이 들어오면 페이지에 필요한 데이터들을 fetch하게 되는데, 이때 동일한 endpoint로의 API fetch를 여러 컴포넌트에서 수행할 필요가 있다면 Request Memoization이 동작합니다. (React가 <code>fetch</code> 함수를 확장해놓았기 때문에 별도 설정은 필요 없습니다.)</p><p>상위 컴포넌트에서 API fetch 결과를 prop drilling 하는것 대신, 각 컴포넌트에서 fetch를 수행하도록 구현해도 실제 API 요청은 최초 1회만 전송되고 나머지는 응답값을 재사용합니다.</p><figure><img src="https://fe-developers.kakaoent.com/static/43b14b536ac3b3d14cf6640d30ef9550/b17f8/deduplicated-fetch-requests.jpg" alt="&lt;VPIcon icon=&quot;iconfont icon-nextjs&quot;/&gt;request-memoization" tabindex="0" loading="lazy"><figcaption><a href="https://nextjs.org/docs/app/building-your-application/caching#request-memoization" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>request-memoization</a></figcaption></figure><p>Request Memoization은 서버에서 호출되는 <code>GET</code> 메서드에만 적용되므로, <code>POST</code>나 <code>DELETE</code> API 또는 클라이언트에서 호출되는 API에는 적용되지 않습니다. 그리고 한 번의 서버 렌더링 동안만 유효하기 때문에 따로 <code>revalidate</code> 할 필요가 없을 뿐 아니라 할 수도 없습니다.</p><h3 id="data-cache" tabindex="-1"><a class="header-anchor" href="#data-cache"><span>Data Cache</span></a></h3><p>우리가 일반적으로 생각할 수 있는 API 캐싱입니다.</p><div class="language-typescript line-numbers-mode" data-highlighter="prismjs" data-ext="ts"><pre><code class="language-typescript"><span class="line"><span class="token comment">// Revalidate at most every hour</span></span>
<span class="line"><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&#39;https://...&#39;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> next<span class="token operator">:</span> <span class="token punctuation">{</span> revalidate<span class="token operator">:</span> <span class="token number">3600</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Next.js</code>가 확장해놓은 <code>fetch</code> 함수에 <code>next.revalidate</code> 옵션을 넘기면 Data Cache가 동작합니다. 성공적으로 데이터를 가져왔다면 그 응답값을 저장해두었다가 동일한 경로로 <code>fetch</code> 함수를 실행할 때 실제 API 호출은 건너뛰고 저장해놓은 응답값을 반환합니다.</p><p>하나의 요청 동안만 유효한 Request Memoization과 다르게 Data Cache는 일정 시간 동안에 웹 서버로 들어오는 모든 요청에 대해 동작합니다. 만약 <code>next.revalidate</code>를 1초로 설정했다면, 1초에 1000명의 사용자가 접속해도 실제 API 요청은 1회 전송됩니다.</p><figure><img src="https://fe-developers.kakaoent.com/static/af82b51d26f067e6ca3b50d8ed107789/b17f8/time-based-revalidation.jpg" alt="&lt;VPIcon icon=&quot;iconfont icon-nextjs&quot;/&gt;caching#revalidating" tabindex="0" loading="lazy"><figcaption><a href="https://nextjs.org/docs/app/building-your-application/caching#revalidating-1" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>caching#revalidating</a></figcaption></figure><p>Data Cache를 설명하는 위 이미지에서 한 가지 짚고 싶은 부분은 revalidate 시간이 지나더라도 첫 요청은 캐싱된 값을 (STALE 상태여도) 반환한다는 것입니다. 반환 후 백그라운드에서 API를 호출해서 값을 업데이트하는데, 개발자 의도와 다르게 동작할 수 있기 때문에 캐시를 적용할 때 주의가 필요합니다.</p><blockquote><p><code>router.refresh</code>로는 Data Cache가 <code>revalidate</code>되지 않고, <a href="https://nextjs.org/docs/app/building-your-application/caching#revalidatepath" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>revalidatePath</a>를 사용해야 합니다. (이때는 즉시 <code>revalidate</code> 되기 때문에, 다음 첫 요청에도 새로운 값을 반환합니다.)</p></blockquote><h3 id="full-route-cache" tabindex="-1"><a class="header-anchor" href="#full-route-cache"><span>Full Route Cache</span></a></h3><p>웹 서버의 성능을 눈에 띄게 향상시키려면 Full Route Cache를 적용해야 합니다. 서버 렌더링 과정에서 웹 서버의 리소스(특히 CPU)를 대부분 사용하게 되는데, Full Route Cache는 서버 렌더링 결과를 재사용함으로써 이를 줄일 수 있습니다.</p><figure><img src="https://fe-developers.kakaoent.com/static/48739fa056e8eb0f04b8ded88308de87/b17f8/static-and-dynamic-routes.jpg" alt="&lt;VPIcon icon=&quot;iconfont icon-nextjs&quot;/&gt;static-and-dynamic-rendering" tabindex="0" loading="lazy"><figcaption><a href="https://nextjs.org/docs/app/building-your-application/caching#static-and-dynamic-rendering" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>static-and-dynamic-rendering</a></figcaption></figure><p>Full Route Cache를 적용하려면 페이지를 Static 렌더링 되도록 구성해야 합니다. 다시 말해 <a href="https://nextjs.org/docs/app/building-your-application/caching#dynamic-functions" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>Dynamic Function</a>을 사용하지 않아야 하는데, 그렇지 않으면 그림과 같이 Full Route Cache 단계가 SKIP 됩니다. Full Route Cache를 좀 더 자세히 알고 싶다면 <a href="https://nextjs.org/docs/app/building-your-application/caching#full-route-cache" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>공식문서</a>를 참고하시길 바랍니다.</p><hr><h2 id="next-js의-캐싱-적용하기" tabindex="-1"><a class="header-anchor" href="#next-js의-캐싱-적용하기"><span>Next.js의 캐싱 적용하기</span></a></h2><h3 id="_1-캐싱-대상-정하기" tabindex="-1"><a class="header-anchor" href="#_1-캐싱-대상-정하기"><span>1. 캐싱 대상 정하기</span></a></h3><p>개인화된 페이지(장바구니, 결제 등)은 폐쇄형 쇼핑몰 특성상 트래픽이 적을 뿐 아니라, 동일한 응답을 내려줘서는 안 되기 때문에 캐싱 적용 대상에서 제외했습니다. 앞서 말했듯 상품 목록/상세 페이지는 비로그인 상태에서도 누구나 조회 가능하고 트래픽이 몰릴 가능성이 있기 때문에 아주 적절한 대상입니다.</p><figure><img src="https://fe-developers.kakaoent.com/static/8bb8cfa0c38eb16056dfbfb184503196/587b0/fanstore-product-list.png" alt="상품 목록 페이지" tabindex="0" loading="lazy"><figcaption>상품 목록 페이지</figcaption></figure><figure><img src="https://fe-developers.kakaoent.com/static/26b7112ec5e50e997392a3df747ff9b5/587b0/fanstore-product-detail.png" alt="상품 상세 페이지" tabindex="0" loading="lazy"><figcaption>상품 상세 페이지</figcaption></figure><h3 id="_2-변경-범위-파악-및-테스트-코드-보강" tabindex="-1"><a class="header-anchor" href="#_2-변경-범위-파악-및-테스트-코드-보강"><span>2. 변경 범위 파악 및 테스트 코드 보강</span></a></h3><p>Full Route Cache가 동작하게 하려면 <a href="https://nextjs.org/docs/app/building-your-application/routing/dynamic-routes" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>Dynamic routes</a>에 <a href="https://nextjs.org/docs/pages/building-your-application/data-fetching/incremental-static-regeneration" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>ISR</a>을 적용하고, 사용 중인 <a href="https://nextjs.org/docs/app/building-your-application/caching#dynamic-functions" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>Dynamic Function</a>을 제거해야 했습니다. <code>cookies</code>, <code>headers</code>, <code>pathParams</code>, <code>searchParams</code> 모두 여기저기에서 사용 중이다 보니 광범위한 변경이 필요했고, 안정적인 변경을 위해서 단위를 쪼개고 관련해서 테스트 코드를 보강했습니다.</p><h3 id="_3-as-is-부하-테스트" tabindex="-1"><a class="header-anchor" href="#_3-as-is-부하-테스트"><span>3. AS-IS 부하 테스트</span></a></h3><p>성과를 수치화하는 것은 직장인에게 중요한 덕목입니다. 결과에 영향을 줄 수 있는 조건들을 통제하여 부하테스트를 진행했습니다. (with. <a href="https://naver.github.io/ngrinder/" target="_blank" rel="noopener noreferrer"><i class="vp-icon fas fa-globe" sizing="height"></i>nGrinder</a>)</p><figure><img src="https://fe-developers.kakaoent.com/static/38e2dae2f2fe6c8bbfd7a45839d2feac/d43b4/ngrinder.png" alt="곧 괜찮아 질거야" tabindex="0" loading="lazy"><figcaption>곧 괜찮아 질거야</figcaption></figure><h3 id="_4-캐시-디버깅-컴포넌트-구현" tabindex="-1"><a class="header-anchor" href="#_4-캐시-디버깅-컴포넌트-구현"><span>4. 캐시 디버깅 컴포넌트 구현</span></a></h3><p>브라우저에 렌더링 된 페이지가 Full Route Cache를 HIT 했는지를 확인하기 위해 간단한 서버 컴포넌트 하나를 추가했습니다.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">function</span> <span class="token function">DebugCache</span><span class="token punctuation">(</span><span class="token punctuation">{</span>path<span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">(</span></span>
<span class="line">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span><span class="token plain-text"></span>
<span class="line">      </span><span class="token punctuation">{</span><span class="token function">dayjs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token plain-text"></span>
<span class="line">      </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">RevalidateButton</span></span> <span class="token attr-name">path</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span>path<span class="token punctuation">}</span></span><span class="token punctuation">/&gt;</span></span><span class="token plain-text"></span>
<span class="line">    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token string">&#39;use client&#39;</span></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">RevalidateButton</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{</span>path<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onClick</span><span class="token script language-javascript"><span class="token script-punctuation punctuation">=</span><span class="token punctuation">{</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">revalidateFullRouteCache</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token punctuation">&gt;</span></span><span class="token plain-text">revalidate</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token string">&#39;use server&#39;</span></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">{</span> revalidatePath <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;next/cache&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">revalidateFullRouteCache</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">revalidatePath</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">&#39;layout&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>브라우저에서 새로고침을 해도 <code>dayjs().valueOf()</code>값이 동일하다면 Full Route Cache가 HIT 했다고 판단할 수 있습니다.</p><h3 id="_5-코드-변경" tabindex="-1"><a class="header-anchor" href="#_5-코드-변경"><span>5. 코드 변경</span></a></h3><p>목표는 <code>generateStaticParams</code>를 통해서 <a href="https://nextjs.org/docs/pages/building-your-application/data-fetching/incremental-static-regeneration" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>ISR</a> 방식의 static route로 바꿈으로써 Full Route Cache를 적용하는 것입니다.</p><h3 id="_5-1-url-path" tabindex="-1"><a class="header-anchor" href="#_5-1-url-path"><span>5.1 URL PATH</span></a></h3><p>저희 서비스는 다국어를 지원하며 url path에 언어값이 포함되어있습니다. 지원하는 언어는 고정돼 있기 때문에, <code>generateStaticParams</code>에 바로 적용해서 static 페이지로 만듭니다.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token comment">// app&gt;[lang]&gt;layout.tsx</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">generateStaticParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token constant">SUPPORTED_LANGS</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>locale <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span> locale <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>상품 상세 페이지도 url path에 상품 ID 값이 포함되어있습니다. 하지만 다국어와는 다르게 상품의 ID 값은 고정된 값이 아니기 때문에 <code>generateStaticParams</code>에서 빈 배열을 리턴해줍니다. 이렇게 하면 ISR로 동작하게됩니다.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token comment">// app&gt;[lang]&gt;(static)&gt;상품상세&gt;[id]&gt;page.tsx</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">generateStaticParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>그리고 상품 목록 페이지에서는 태그를 선택해서 상품들을 조회할 수 있는데요.</p><figure><img src="https://fe-developers.kakaoent.com/static/e4e7d3deedc51ecb9623e90bd8bfc119/9d76a/fanstore-filter.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>선택된 태그를 기존에 <code>searchParams</code>로 다뤘는데, static route를 위해서 <code>pathParams</code>로 변경했습니다.</p><p><code>/products?tagId={tagId}</code> -&gt; <code>/{tagId}/products</code></p><p>그렇게 하면 상품 상세 페이지와 동일하게 <code>generateStaticParams</code>를 사용해서 ISR로 동작하게 할 수 있습니다.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token comment">// app&gt;[lang]&gt;(static)&gt;상품목록&gt;[tagId]&gt;page.tsx</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">generateStaticParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-2-dynamic-functions" tabindex="-1"><a class="header-anchor" href="#_5-2-dynamic-functions"><span>5.2 Dynamic Functions</span></a></h3><p>저희 서비스는 여러 가지 인증 체계를 사용하기 때문에 일관된 인증 처리를 위해 <a href="https://nextjs.org/docs/app/building-your-application/routing/middleware" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>middleware</a>에서 <code>cookies</code>, <code>headers</code>, <code>searchParams</code>를 사용해서 전처리하고 있습니다. 모두 dynamic function이기 때문에 middleware 대신 클라이언트에서 전처리하도록 AuthProvider 추가했습니다.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token comment">// before</span></span>
<span class="line"><span class="token comment">// middleware(Server)에서 Client로 마이그레이션 돼야 하는 코드 예시입니다.</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">middleware</span><span class="token punctuation">(</span>request<span class="token operator">:</span> NextRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> nextUrl <span class="token punctuation">}</span> <span class="token operator">=</span> request<span class="token punctuation">;</span></span>
<span class="line">  nextUrl<span class="token punctuation">.</span>searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">SEARCH_PARAM_KEYS</span><span class="token punctuation">.</span><span class="token constant">REGION_TYPE</span><span class="token punctuation">,</span> regionType<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">const</span> responseForSetCookie <span class="token operator">=</span> NextResponse<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span>nextUrl<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  responseForSetCookie<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">COOKIE_KEYS</span><span class="token punctuation">.</span><span class="token constant">USER_TYPE</span><span class="token punctuation">,</span> <span class="token function">getUserType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line">  <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> responseForSetCookie<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token comment">// after</span></span>
<span class="line"><span class="token string">&#39;use client&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">function</span> <span class="token function">AuthProvider</span><span class="token punctuation">(</span><span class="token punctuation">{</span> children <span class="token punctuation">}</span><span class="token operator">:</span> PropsWithChildren<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    document<span class="token punctuation">.</span>cookie <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">COOKIE_KEYS</span><span class="token punctuation">.</span><span class="token constant">USER_TYPE</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token function">getUserType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">; domain=.melon.com; path:/;</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token keyword">const</span> searchParams <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    searchParams<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token constant">SEARCH_PARAM_KEYS</span><span class="token punctuation">.</span><span class="token constant">REGION_TYPE</span><span class="token punctuation">,</span> <span class="token function">getRegionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    </span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line">    <span class="token operator">...</span></span>
<span class="line"></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> children<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>이외에도 API를 호출하는 함수에서 인증을 위해 사용하고 있는 dynamic function을 (인증이 필요 없는) 상품 목록/상세 페이지에서는 사용하지 않도록 처리했습니다.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token comment">// before</span></span>
<span class="line"><span class="token comment">// API 호출하는 부분에서 제거돼야 하는 코드 예시입니다.</span></span>
<span class="line">  <span class="token keyword">const</span> <span class="token punctuation">{</span> cookies <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;next/headers&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">const</span> cookieStore <span class="token operator">=</span> <span class="token function">cookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token constant">HEADER_KEYS</span><span class="token punctuation">.</span><span class="token constant">CHANNEL_TYPE</span><span class="token punctuation">]</span><span class="token operator">:</span> cookieStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">COOKIE_KEYS</span><span class="token punctuation">.</span><span class="token constant">CHANNEL_TYPE</span><span class="token punctuation">)</span><span class="token operator">?.</span>value <span class="token keyword">as</span> ChannelTypes<span class="token punctuation">,</span></span>
<span class="line">    <span class="token punctuation">[</span><span class="token constant">HEADER_KEYS</span><span class="token punctuation">.</span><span class="token constant">REGION_TYPE</span><span class="token punctuation">]</span><span class="token operator">:</span> cookieStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">COOKIE_KEYS</span><span class="token punctuation">.</span><span class="token constant">REGION_TYPE</span><span class="token punctuation">)</span><span class="token operator">?.</span>value <span class="token keyword">as</span> RegionTypes<span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Header/Footer 컴포넌트에서는 인증이 필요한(개인화된) 데이터가 사용되고 있었습니다. 때문에 캐시 적용이 어려워서 서버 컴포넌트에서 클라이언트 컴포넌트로 변경했습니다. 이렇게 되면 Header와 Footer가 클라이언트에서 dynamic import 되는데, Layout Shift가 발생하지 않도록 Placeholder 컴포넌트도 추가해 줬습니다.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token keyword">const</span> Footer <span class="token operator">=</span> <span class="token function">dynamic</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">&#39;@/common/Footer.client&#39;</span><span class="token punctuation">)</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span> ssr<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token function-variable function">loading</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token class-name">ComponentPlaceholder</span></span> <span class="token punctuation">/&gt;</span></span> <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-full-route-cache-적용" tabindex="-1"><a class="header-anchor" href="#_5-3-full-route-cache-적용"><span>5.3 Full Route Cache 적용</span></a></h3><p>static route가 가능하게 되었다면, <code>layout.tsx</code>에 <a href="https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config#revalidate" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>revalidate</a> 시간을 설정해서 Full Route Cache가 동작하도록 해줍니다.</p><div class="language-tsx line-numbers-mode" data-highlighter="prismjs" data-ext="tsx"><pre><code class="language-tsx"><span class="line"><span class="token comment">// app&gt;[lang]&gt;(static)&gt;상품상세&gt;[id]&gt;layout.tsx</span></span>
<span class="line"><span class="token keyword">export</span> <span class="token keyword">const</span> revalidate <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// seconds</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">Info</p><p>Full Route Cache는 Data Cache가 HIT 되었을 때에만 동작합니다. 따라서 Full Route Cache를 적용하려는 페이지의 모든 <code>fetch</code>에는 <code>next.revalidate</code> 값이 (Full Route Cache의 revalidate 값보다 크거나 같게) 설정돼야 합니다.</p><p>next.js <a href="https://github.com/vercel/next.js/releases/tag/v14.0.2-canary.3" target="_blank" rel="noopener noreferrer">14.0.2 (<i class="vp-icon iconfont icon-github" sizing="height"></i><code>vercel/next.js</code>)</a> 이전 버전에서 <a href="https://nextjs.org/docs/pages/api-reference/next-config-js/output#automatically-copying-traced-files" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-nextjs" sizing="height"></i>standalone</a> 빌드 하면, <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/304" target="_blank" rel="noopener noreferrer"><i class="vp-icon fa-brands fa-firefox" sizing="height"></i>304</a> 응답을 무한으로 캐싱 하는 <a href="https://github.com/vercel/next.js/pull/57737" target="_blank" rel="noopener noreferrer">버그 (<i class="vp-icon iconfont icon-github" sizing="height"></i><code>vercel/next.js</code>)</a>가 존재합니다. 저희는 13대 버전을 사용하고 있기 때문에, major 버전업 대신 해당 부분만 몽키패치해서 해결했습니다.</p></div><h3 id="효과는-굉장했다" tabindex="-1"><a class="header-anchor" href="#효과는-굉장했다"><span>효과는 굉장했다</span></a></h3><p>Full Route Cache 적용 외에도 정적 리소스들(js, css)을 Load Balancer에서 캐싱하도록 적용한 후에 부하테스트를 진행했습니다.</p><figure><img src="https://fe-developers.kakaoent.com/static/65b8d5d61ed01b63cbd17bee3f02afdc/d30ee/result-before.png" alt="before - 평균 TPS 34" tabindex="0" loading="lazy"><figcaption><em>before - 평균 TPS 34</em></figcaption></figure><figure><img src="https://fe-developers.kakaoent.com/static/5d5eb3c9c50690c0d8d1b38dc20078c9/d30ee/result-after.png" alt="after - 평균 TPS 220" tabindex="0" loading="lazy"><figcaption><em>after - 평균 TPS 220</em></figcaption></figure><p>여러 번의 부하테스트 비교군 중 대표 한 쌍을 가져와 봤습니다. 다른 조건의 부하테스트도 비슷한 수준의 차이를 보입니다. 적게는 5배에서 많게는 10배까지도 TPS가 개선된 것을 확인할 수 있었습니다. TPS의 개선은 당연하게도 응답시간(Mean Test Time)과 CPU 사용률이 개선되었음을 의미합니다.</p><figure><img src="https://fe-developers.kakaoent.com/static/7ce47e1db33f39e258141334298f99b0/e03bf/mtt-before.png" alt="before" tabindex="0" loading="lazy"><figcaption><em>before</em></figcaption></figure><figure><img src="https://fe-developers.kakaoent.com/static/709512ad6d82f80fe9d2e8e8a06b8692/48c0e/mtt-after.png" alt="after" tabindex="0" loading="lazy"><figcaption><em>after</em></figcaption></figure><h3 id="정리" tabindex="-1"><a class="header-anchor" href="#정리"><span>정리</span></a></h3><p>이 글에서는 자세히 다루지 않았지만 <a href="https://servercomponents.dev/" target="_blank" rel="noopener noreferrer"><i class="vp-icon fa-brands fa-react" sizing="height"></i>React Server Component</a>를 비롯해서 Next.js의 App Router가 아직은 공식적으로 <code>experimental</code> 단계인 기능이나 숨어있는 버그들이 있다 보니 프로덕션 단계까지 구현하는 데에 어려움이 많았습니다. 디버깅 툴이 더 고도화되면 좋겠다 생각했고, 다른 라이브러리들의 적절한 대응도 필요해 보였습니다. 그럼에도 이 글의 사례처럼 장점을 적절하게 활용한다면 골을 더 많이 넣는 공격수가 될 수 있지 않을까 생각하며 글을 마칩니다.</p></div><!----><!----><!----></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/chanhi2000/bookshelf/edit/main/src/fe-developers.kakaoent.com/240418-optimizing-nextjs-cache.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/bookshelf/programming/js-next/articles/" aria-label="/programming/js-next/articles/"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->/programming/js-next/articles/</div></a><a class="route-link auto-link next" href="/bookshelf/fe-developers.kakaoent.com/240715-handling-file-variables.html" aria-label="파일 변수 Deep-Dive"><div class="hint">Next<span class="arrow end"></span></div><div class="link">파일 변수 Deep-Dive<i class="vp-icon fa-brands fa-react" sizing="height"></i></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">MIT Licensed | Copyright © 2022-present <a href="https://github.com/chanhi2000">Chan Hee Lee</a></div><!----></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/bookshelf/assets/app-BItykJLQ.js" defer></script>
  </body>
</html>
