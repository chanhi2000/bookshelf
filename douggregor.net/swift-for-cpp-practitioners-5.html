<!doctype html>
<html lang="ko-KR" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.26" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.99" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Swift for C++ Practitioners, Part 5: Type erasure & metatypes","image":[""],"datePublished":"2024-04-11T00:00:00.000Z","dateModified":null,"author":[]}</script><meta property="og:url" content="https://chanhi2000.github.io/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html"><meta property="og:site_name" content="ðŸ“šBookshelf"><meta property="og:title" content="Swift for C++ Practitioners, Part 5: Type erasure & metatypes"><meta property="og:description" content="Article(s) > Swift for C++ Practitioners, Part 5: Type erasure & metatypes"><meta property="og:type" content="article"><meta property="og:locale" content="ko-KR"><meta property="article:tag" content="cpp"><meta property="article:tag" content="c++"><meta property="article:tag" content="ios"><meta property="article:tag" content="swift"><meta property="article:tag" content="douggregor.net"><meta property="article:tag" content="blog"><meta property="article:published_time" content="2024-04-11T00:00:00.000Z"><link rel="icon" href="/bookshelf/assets/icon/favicon.svg"><title>Swift for C++ Practitioners, Part 5: Type erasure & metatypes | ðŸ“šBookshelf</title><meta name="description" content="Article(s) > Swift for C++ Practitioners, Part 5: Type erasure & metatypes">
    <link rel="preload" href="/bookshelf/assets/style-Bhb-QcDa.css" as="style"><link rel="stylesheet" href="/bookshelf/assets/style-Bhb-QcDa.css">
    
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/bookshelf/" aria-label="Take me home"><img class="vp-nav-logo" src="/bookshelf/assets/icon/favicon.svg" alt><!----><span class="vp-site-name hide-in-pad">ðŸ“šBookshelf</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/bookshelf/news.html" aria-label><!--[--><i class="vp-icon fas fa-rss" sizing="height"></i><!--]--><!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label><!--[--><i class="vp-icon fas fa-keyboard" sizing="height"></i><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/hackingwithswift.com/" aria-label="hackingwithswift.com"><!--[--><img class="vp-icon" src="https://hackingwithswift.com/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->hackingwithswift.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/fcc/" aria-label="freecodecamp.org"><!--[--><img class="vp-icon" src="https://cdn.freecodecamp.org/universal/favicons/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->freecodecamp.org<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/kodeco.com/" aria-label="kodeco.com"><!--[--><img class="vp-icon" src="https://kodeco.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->kodeco.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.kotzilla.io/" aria-label="blog.kotzilla.io"><!--[--><img class="vp-icon" src="https://blog.kotzilla.io/hubfs/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->blog.kotzilla.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/kt.academy/" aria-label="kt.academy"><!--[--><img class="vp-icon" src="https://kt.academy/logo.png" alt aria-hidden no-view sizing="both"><!--]-->kt.academy<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/droidcon.com/" aria-label="droidcon.com"><!--[--><img class="vp-icon" src="https://droidcon.com/wp-content/uploads/2021/07/favicon-300x300.png" alt aria-hidden no-view sizing="both"><!--]-->droidcon.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/outcomeschool.com/" aria-label="outcomeschool.com"><!--[--><img class="vp-icon" src="https://outcomeschool.com/static/favicons/apple-touch-icon.png" alt aria-hidden no-view sizing="both"><!--]-->outcomeschool.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/frontendmasters.com/" aria-label="frontendmasters.com"><!--[--><img class="vp-icon" src="https://frontendmasters.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->frontendmasters.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/css-tricks.com/" aria-label="css-tricks.com"><!--[--><img class="vp-icon" src="https://css-tricks.com/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->css-tricks.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/smashingmagazine.com/" aria-label="smashingmagazine.com"><!--[--><img class="vp-icon" src="https://smashingmagazine.com/images/favicon/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->smashingmagazine.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/smashingmagazine.com/" aria-label="oddbird.net"><!--[--><img class="vp-icon" src="https://oddbird.net/safari-pinned-tab.svg" alt aria-hidden no-view sizing="both"><!--]-->oddbird.net<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/zeroheight.com/" aria-label="zeroheight.com"><!--[--><img class="vp-icon" src="https://zeroheight.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->zeroheight.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/typescript.tv/" aria-label="typescript.tv"><!--[--><img class="vp-icon" src="https://typescript.tv/_astro/android-chrome-192x192.BhQ8hcWh.png" alt aria-hidden no-view sizing="both"><!--]-->typescript.tv<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.logrocket.com/" aria-label="blog.logrocket.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/blog.logrocket.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->blog.logrocket.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/realpython.com/" aria-label="realpython.com"><!--[--><img class="vp-icon" src="https://realpython.com/static/favicon.68cbf4197b0c.png" alt aria-hidden no-view sizing="both"><!--]-->realpython.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/digitalocean.com/" aria-label="digitalocean.com"><!--[--><img class="vp-icon" src="https://digitalocean.com/_next/static/media/favicon.594d6067.ico" alt aria-hidden no-view sizing="both"><!--]-->digitalocean.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/antonioleiva.com/" aria-label="antonioleiva.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/antonioleiva.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->antonioleiva.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/johnnyreilly.com/" aria-label="johnnyreilly.com"><!--[--><img class="vp-icon" src="https://johnnyreilly.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->johnnyreilly.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/code-maze.com/" aria-label="code-maze.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/code-maze.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->code-maze.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/milanjovanovic.tech/" aria-label="milanjovanovic.tech"><!--[--><img class="vp-icon" src="https://milanjovanovic.tech/profile_favicon.png" alt aria-hidden no-view sizing="both"><!--]-->milanjovanovic.tech<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/shopify.engineering/" aria-label="shopify.engineering"><!--[--><img class="vp-icon" src="https://cdn.shopify.com/static/shopify-favicon.png" alt aria-hidden no-view sizing="both"><!--]-->shopify.engineering<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/devtoolstips.org/" aria-label="devtoolstips.org"><!--[--><img class="vp-icon" src="https://devtoolstips.org/assets/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->devtoolstips.org<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/piccalil.li/" aria-label="piccalil.li"><!--[--><img class="vp-icon" src="https://piccalil.li/favicons/apple-touch-icon.png" alt aria-hidden no-view sizing="both"><!--]-->piccalil.li<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/sitepoint.com/" aria-label="sitepoint.com"><!--[--><img class="vp-icon" src="https://sitepoint.com/favicons/512x512.png" alt aria-hidden no-view sizing="both"><!--]-->sitepoint.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/event-driven.io/" aria-label="event-driven.io"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/event-driven.io/favicon.jfif" alt aria-hidden no-view sizing="both"><!--]-->event-driven.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/packagemain.tech/" aria-label="packagemain.tech"><!--[--><img class="vp-icon" src="https://substack-post-media.s3.amazonaws.com/public/images/2ea54e25-eaa6-4630-bfc0-10b8cfdce894/apple-touch-icon-1024x1024.png" alt aria-hidden no-view sizing="both"><!--]-->packagemain.tech<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/gosolve.io/" aria-label="gosolve.io"><!--[--><img class="vp-icon" src="https://gosolve.io/wp-content/uploads/2022/03/cropped-ikona1-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->gosolve.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/bram.us/" aria-label="bram.us"><!--[--><img class="vp-icon" src="https://bram.us/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->bram.us<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/una.im/" aria-label="una.im"><!--[--><img class="vp-icon" src="https://una.im/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->una.im<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/joshwcomeau.com/" aria-label="joshwcomeau.com"><!--[--><img class="vp-icon" src="https://joshwcomeau.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->joshwcomeau.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/css-tip.com/" aria-label="css-tip.com"><!--[--><img class="vp-icon" src="https://css-tip.com/img/fav.png" alt aria-hidden no-view sizing="both"><!--]-->css-tip.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/nerdy.dev/" aria-label="nerdy.dev"><!--[--><img class="vp-icon" src="https://nerdy.dev/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->nerdy.dev<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/towardsdatascience.com/" aria-label="towardsdatascience.com"><!--[--><img class="vp-icon" src="https://cdn-images-1.medium.com/v2/resize:fill:128:128/1*VzTUkfeGymHP4Bvav-T-lA.png" alt aria-hidden no-view sizing="both"><!--]-->towardsdatascience.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/bookshelf/douggregor.net/" aria-label="douggregor.net"><!--[--><i class="vp-icon fas fa-globe" sizing="both"></i><!--]-->douggregor.net<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/d2.naver.com/" aria-label="d2.naver.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/d2.naver.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->d2.naver.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tech.kakao.com/" aria-label="tech.kakao.com"><!--[--><img class="vp-icon" src="https://www.kakaocorp.com/page/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tech.kakao.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tech.kakaopay.com/" aria-label="tech.kakaopay.com"><!--[--><img class="vp-icon" src="https://tech.kakaopay.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tech.kakaopay.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/fe-developers.kakaoent.com/" aria-label="fe-developers.kakaoent.com"><!--[--><img class="vp-icon" src="https://fe-developers.kakaoent.com/favicon-32x32.png?v=44803cb16c1e2debd3984cf2e8cb2ded" alt aria-hidden no-view sizing="both"><!--]-->fe-developers.kakaoent.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/yozm.wishket.com/" aria-label="yozm.wishket.com"><!--[--><img class="vp-icon" src="https://yozm.wishket.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->yozm.wishket.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/popit.kr/" aria-label="popit.kr"><!--[--><img class="vp-icon" src="https://popit.kr/wp-content/uploads/2016/08/favicon_32x32.png" alt aria-hidden no-view sizing="both"><!--]-->popit.kr<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/devkuma.com/" aria-label="devkuma.com"><!--[--><img class="vp-icon" src="https://devkuma.com/favicons/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->devkuma.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.gangnamunni.com/" aria-label="blog.gangnamunni.com"><!--[--><img class="vp-icon" src="https://blog.gangnamunni.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->blog.gangnamunni.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/codingeverybody.kr/" aria-label="codingeverybody.kr"><!--[--><img class="vp-icon" src="https://codingeverybody.kr/wp-content/uploads/cropped-favicon-origin-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->codingeverybody.kr<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label><!--[--><i class="vp-icon fas fa-network-wired" sizing="height"></i><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tecmint.com/" aria-label="tecmint.com"><!--[--><img class="vp-icon" src="https://tecmint.com/wp-content/uploads/2020/07/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tecmint.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/docker.com/" aria-label="docker.com"><!--[--><img class="vp-icon" src="https://docker.com/app/uploads/2024/02/cropped-docker-logo-favicon-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->docker.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/learnkube.com/" aria-label="learnkube.com"><!--[--><img class="vp-icon" src="https://static.learnkube.com/f7e5160d4744cf05c46161170b5c11c9.svg" alt aria-hidden no-view sizing="both"><!--]-->learnkube.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/itsfoss.com/" aria-label="itsfoss.com"><!--[--><img class="vp-icon" src="https://itsfoss.com/content/images/size/w256h256/2022/12/android-chrome-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->itsfoss.com<!----></a></li></ul></button></div></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/chanhi2000/bookshelf" target="_blank" rel="noopener noreferrer" aria-label="Github"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><!----></div><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><i class="vp-icon fas fa-globe" sizing="both"></i><span class="vp-sidebar-title">douggregor.net</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-1.html" aria-label="Swift for C++ Practitioners, Part 1: Intro &amp; Value Types"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 1: Intro &amp; Value Types<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-2.html" aria-label="Swift for C++ Practitioners, Part 2: Reference Types &amp; Optionals"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 2: Reference Types &amp; Optionals<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-3.html" aria-label="Swift for C++ Practitioners, Part 3: Extensions and Access Control"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 3: Extensions and Access Control<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-4.html" aria-label="Swift for C++ Practitioners, Part 4: Generics"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 4: Generics<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html" aria-label="Swift for C++ Practitioners, Part 5: Type erasure &amp; metatypes"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 5: Type erasure &amp; metatypes<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-6.html" aria-label="Swift for C++ Practitioners, Part 6: Error Handling"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 6: Error Handling<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html" aria-label="Swift for C++ Practitioners, Part 7: Closures"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 7: Closures<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-8.html" aria-label="Swift for C++ Practitioners, Part 8: Global Variables"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 8: Global Variables<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-9.html" aria-label="Swift for C++ Practitioners, Part 9: Extensible Literals"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 9: Extensible Literals<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><i class="vp-icon fa-brands fa-swift" sizing="height"></i>Swift for C++ Practitioners, Part 5: Type erasure &amp; metatypes</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="Writing DateðŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">24. 4. 11.</span><meta property="datePublished" content="2024-04-11T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading TimeâŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 19 min</span><meta property="timeRequired" content="PT19M"></span><span class="page-category-info" aria-label="CategoryðŸŒˆ" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color3" role>Swift</span><span class="page-category-item color6" role>C++</span><span class="page-category-item color8" role>Article(s)</span><!--]--><meta property="articleSection" content="Swift,C++,Article(s)"></span><span class="page-tag-info" aria-label="TagðŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color8" role>blog</span><span class="page-tag-item color8" role>douggregor.net</span><span class="page-tag-item color6" role>swift</span><span class="page-tag-item color8" role>ios</span><span class="page-tag-item color8" role>c++</span><span class="page-tag-item color4" role>cpp</span><!--]--><meta property="keywords" content="blog,douggregor.net,swift,ios,c++,cpp"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><h1 id="frontmatter-title-á„€á…ªá†«á„…á…§á†«" tabindex="-1"><a class="header-anchor" href="#frontmatter-title-á„€á…ªá†«á„…á…§á†«"><span>Swift for C++ Practitioners, Part 5: Type erasure &amp; metatypes ê´€ë ¨</span></a></h1><a class="route-link vp-card" href="/bookshelf/programming/swift/articles/" style="background:rgba(10,10,10,0.2);"><img class="vp-card-logo" src="https://chanhi2000.github.io/images/ico-wind.svg" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">Swift > Article(s)</div><hr><div class="vp-card-desc">Article(s)</div></div></a><a class="route-link vp-card" href="/bookshelf/programming/cpp/articles/" style="background:rgba(10,10,10,0.2);"><img class="vp-card-logo" src="https://chanhi2000.github.io/images/ico-wind.svg" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">C++ > Article(s)</div><hr><div class="vp-card-desc">Article(s)</div></div></a><nav class="table-of-contents"><ul><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#the-basics-of-type-erasure" class="router-link-active router-link-exact-active">The basics of type erasure</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#dynamic-casting" class="router-link-active router-link-exact-active">Dynamic casting</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#metatypes" class="router-link-active router-link-exact-active">Metatypes</a><ul><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#class-metatypes" class="router-link-active router-link-exact-active">Class metatypes</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#any-metatypes" class="router-link-active router-link-exact-active">any metatypes</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#explicitly-specified-generic-function-arguments" class="router-link-active router-link-exact-active">Explicitly-specified generic function arguments</a></li></ul></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#associated-types" class="router-link-active router-link-exact-active">Associated types</a><ul><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#erasure-of-associated-types" class="router-link-active router-link-exact-active">Erasure of associated types</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#equality-of-types" class="router-link-active router-link-exact-active">Equality of types</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#opening-any-types" class="router-link-active router-link-exact-active">Opening any types</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#primary-associated-types" class="router-link-active router-link-exact-active">Primary associated types</a></li></ul></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#when-to-type-erase" class="router-link-active router-link-exact-active">When to type-erase?</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#implementation-hiding-with-opaque-types" class="router-link-active router-link-exact-active">Implementation hiding with opaque types</a><ul><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#some-vs-any" class="router-link-active router-link-exact-active">some vs. any</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#hiding-complicated-result-types" class="router-link-active router-link-exact-active">Hiding complicated result types</a></li></ul></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html#wrap-up" class="router-link-active router-link-exact-active">Wrap up</a></li></ul></nav><hr><a class="vp-card" href="https://www.douggregor.net/posts/swift-for-cxx-practitioners-type-erasure/" target="_blank" style="background:rgba(22,22,22,0.2);"><!----><div class="vp-card-content"><div class="vp-card-title">Swift for C++ Practitioners, Part 5: Type erasure & metatypes | Doug's Compiler Corner</div><hr><div class="vp-card-desc">Swift for C++ Practitioners, Part 5: Type erasure & metatypes</div></div></a><p>What do you do in C++ when you want to support different types, but don&#39;t want to have one template instantiation per type? Yes, you can introduce a class hierarchy with virtual functions, but more often a better answer is to use <em>type erasure</em>. Type erasure is a mechanism for <em>runtime polymorphism</em>, allowing you to provide different types at runtime while using the same code expressed with a single, concrete type. The C++ standard library contains two type-erased utility types: <a href="https://en.cppreference.com/w/cpp/utility/any" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-cpp" sizing="height"></i><code>std::any</code></a> and <a href="https://en.cppreference.com/w/cpp/utility/functional/function" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-cpp" sizing="height"></i><code>std::function</code></a>. In both cases, you can have a concrete value whose underlying type can change:</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line">std<span class="token double-colon punctuation">::</span>any a <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>              <span class="token comment">// okay, stores an int</span></span>
<span class="line">a <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// now it stores a std::string!</span></span>
<span class="line"></span>
<span class="line">std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> op <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// okay, it adds integers</span></span>
<span class="line">op <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span> <span class="token punctuation">}</span>                               <span class="token comment">// now it multiplies them!</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Type erasure in C++ has been around for a long time, and it&#39;s a useful technique. <a href="https://www.boost.org/doc/libs/1_84_0/doc/html/any.html" target="_blank" rel="noopener noreferrer"><i class="vp-icon fas fa-globe" sizing="height"></i>Boost.Any</a> popularized the idea, and now there are numerous blog posts describing implementation techniques and C++ libraries implementing them. In Swift, it&#39;s part of the language, and you can type-erase any protocol using the keyword <code>any</code>. In this post, we&#39;re going to dive into how Swift handles type erasure, and explore related features like <em>metatypes</em> and <em>opaque types</em>.</p><hr><h2 id="the-basics-of-type-erasure" tabindex="-1"><a class="header-anchor" href="#the-basics-of-type-erasure"><span>The basics of type erasure</span></a></h2><p>For example, let&#39;s bring back that the <code>Quantifiable</code> protocol from the last post. It looked like this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">protocol</span> <span class="token class-name">Quantifiable</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">func</span> <span class="token function-definition function">cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Double</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>One can conform types to <code>Quantifiable</code> and write generic algorithms using <code>Quantifiable</code> as a constraint. If we want to use runtime polymorphism to store a value of any <code>Quantifiable</code> type, we can do so with <code>any Quantifiable</code> like this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> q<span class="token punctuation">:</span> any <span class="token class-name">Quantifiable</span> <span class="token operator">=</span> <span class="token number">1</span>   <span class="token comment">// okay, Int conforms to Quantifiable</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span><span class="token function">cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>               <span class="token comment">// can use the members of the Quantifiable protocol</span></span>
<span class="line"></span>
<span class="line">q <span class="token operator">=</span> <span class="token string-literal"><span class="token string">&quot;Hello&quot;</span></span>                   <span class="token comment">// okay, String conforms to Quantifiable</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can think of the type of <code>q</code> as being &quot;anything that is <code>Quantifiable</code>&quot;: the actual type isn&#39;t known until runtime, and can change by reassigning the variable to another value with a different type. One can compose multiple protocols together using the <code>&amp;</code> sign. For example, a value of type <code>any Quantifiable &amp; Describable</code> can hold a value of any type that conforms to both <code>Quantifiable</code> and <code>Describable</code>, and you can use any operations that are available to a <code>Describable</code> type or <code>Quantifiable</code> type:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> dq<span class="token punctuation">:</span> any <span class="token class-name">Quantifiable</span> <span class="token operator">&amp;</span> <span class="token class-name">Describable</span> <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line">dq<span class="token punctuation">.</span><span class="token function">cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">dq<span class="token punctuation">.</span><span class="token function">describe</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The Swift equivalent to <code>std::any</code> is called, simply, <code>Any</code>: it is effectively an <code>any</code> type with no protocols listed, so it can store a value of any type in it. Now, just like with <code>std::any</code>, you can&#39;t do much with a value of type <code>Any</code> other than copy it around, because there are aren&#39;t many operations that work on all types.</p><hr><h2 id="dynamic-casting" tabindex="-1"><a class="header-anchor" href="#dynamic-casting"><span>Dynamic casting</span></a></h2><p>One thing you can do with values of <code>Any</code> type is to perform a runtime check of the actual stored type. This is accomplished with the same <code>as?</code> cast we introduced for downcasting to a subclass. For example, here&#39;s a function that checks whether a value of type <code>Any</code> is actually an <code>Int</code>:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">maybeIntValue</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> value<span class="token punctuation">:</span> <span class="token keyword">Any</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span><span class="token operator">?</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token keyword">let</span> integer <span class="token operator">=</span> value <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">Int</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> integer</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">return</span> <span class="token nil constant">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The same works for <code>switch</code> statements, where a <code>case</code> can use the <code>as</code> operator to apply only when a dynamic cast to the type succeeds. Here&#39;s a <code>switch</code> to identify a number of concrete types:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">whatAmI</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> value<span class="token punctuation">:</span> <span class="token keyword">Any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">switch</span> value <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token keyword">let</span> bool <span class="token keyword">as</span> <span class="token class-name">Bool</span><span class="token punctuation">:</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Bool </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">bool</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token keyword">let</span> integer <span class="token keyword">as</span> <span class="token class-name">Int</span><span class="token punctuation">:</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Integer </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">integer</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token keyword">let</span> double <span class="token keyword">as</span> <span class="token class-name">Double</span><span class="token punctuation">:</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Double </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">double</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">case</span> <span class="token keyword">let</span> string <span class="token keyword">as</span> <span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;String </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">string</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;I don&#39;t know what this is&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Such a <code>switch</code> must have a <code>default</code> clause, because there&#39;s no way to enumerate every type. The Swift compiler will produce an error <code>switch must be exhaustive</code> if you forget. One particularly important aspect of dynamic casting is that you can cast to an <code>any</code> type, which lets you discover the capabilities of a value at runtime. For example, one can cast to <code>any Quantifiable</code> to determine whether a value conforms to <code>Quantifiable</code>.</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> value<span class="token punctuation">:</span> <span class="token keyword">Any</span> <span class="token operator">=</span> <span class="token number">1</span></span>
<span class="line"><span class="token keyword">if</span> <span class="token keyword">let</span> q <span class="token operator">=</span> value <span class="token keyword">as</span><span class="token operator">?</span> any <span class="token class-name">Quantifiable</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">&quot;Cost is </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">q<span class="token punctuation">.</span><span class="token function">cost</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Dynamic casting allows one to rediscover type information that has been removed by type erasure. It&#39;s common in very dynamic programs where values are dynamically produced in one place, such as via a global registry or deserialization, and consumed elsewhere. To build something like that, which dynamically creates values of potentially unknown type, we need one more Swift feature: metatypes.</p><hr><h2 id="metatypes" tabindex="-1"><a class="header-anchor" href="#metatypes"><span>Metatypes</span></a></h2><p>In the prior post on generics, I noted that Swift doesn&#39;t have an equivalent to the <code>decltype</code> type in C++. Swift does, however, have a function named <code>type(of:)</code>, which produces the type of its argument. However, it&#39;s not producing a type, but a value representing the type, i.e., a <em>metatype</em>. Metatypes in Swift are spelled with the <code>.Type</code> suffix, so if we have a type <code>Point</code>:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">struct</span> <span class="token class-name">Point</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> x<span class="token punctuation">:</span> <span class="token class-name">Double</span></span>
<span class="line">  <span class="token keyword">var</span> y<span class="token punctuation">:</span> <span class="token class-name">Double</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">var</span> origin<span class="token punctuation">:</span> <span class="token class-name">Point</span> <span class="token operator">=</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The metatype of <code>Point</code> has the type <code>Point.Type</code>. One can form a value of this type with the expression <code>Point.self</code>.</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">let</span> pointType<span class="token punctuation">:</span> <span class="token class-name">Point</span><span class="token punctuation">.</span><span class="token keyword">Type</span> <span class="token operator">=</span> <span class="token class-name">Point</span><span class="token punctuation">.</span><span class="token keyword">self</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>What can you do with a metatype? For one thing, you can access static methods and properties, or call an initializer of that type to produce a new value, like this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">let</span> point <span class="token operator">=</span> pointType<span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token number">0.0</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">let</span> origin <span class="token operator">=</span> pointType<span class="token punctuation">.</span>origin</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Technically, when you write <code>Point(x: 0.0, y: 0.0)</code>, you&#39;re using syntactic sugar for <code>PointType.self.init(x: 0.0, y: 0.0)</code>. The <code>type(of:)</code> operation has this generic signature:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">type</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>of value<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">T</span><span class="token punctuation">.</span><span class="token keyword">Type</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>So if we pass an instance of <code>Point</code> to <code>type(of:)</code>, we get back a <code>Point.Type</code> instance.</p><h3 id="class-metatypes" tabindex="-1"><a class="header-anchor" href="#class-metatypes"><span>Class metatypes</span></a></h3><p>Metatypes of structs and enums, by themselves, aren&#39;t very interesting, because you could generally just refer to the type. With classes, metatypes become a lot more interesting because an instance of class type could actually store one of its subclasses. Let&#39;s build a small class hierarchy:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">required</span> <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">self</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">class</span> <span class="token keyword">var</span> serializedTypeName<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token punctuation">{</span> <span class="token string-literal"><span class="token string">&quot;PERSON&quot;</span></span><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> <span class="token class-name">Programmer</span><span class="token punctuation">:</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> favoriteLanguage<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">required</span> <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> name<span class="token punctuation">,</span> favoriteLanguage<span class="token punctuation">:</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> favoriteLanguage<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">self</span><span class="token punctuation">.</span>favoriteLanguage <span class="token operator">=</span> favoriteLanguage</span>
<span class="line">    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> name<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">override</span> <span class="token keyword">class</span> <span class="token keyword">var</span> serializedTypeName<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token punctuation">{</span> <span class="token string-literal"><span class="token string">&quot;PROGRAMMER&quot;</span></span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Please ignore the <code>required</code> and <code>class var</code> for the moment---we&#39;ll get there shortly. First, let&#39;s imagine that we have a <code>person</code> instance, and we ask for its type via <code>type(of: person)</code>:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> person<span class="token punctuation">:</span> <span class="token class-name">Person</span> <span class="token operator">=</span> <span class="token comment">/*build some kind of person */</span></span>
<span class="line"><span class="token keyword">var</span> personType<span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">Type</span> <span class="token operator">=</span> <span class="token function">type</span><span class="token punctuation">(</span>of<span class="token punctuation">:</span> person<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Statically, the type of <code>person</code> can only be expressed as <code>Person.Type</code>. But dynamically, the <code>person</code> instance can store a <code>Person</code> object, or a <code>Programmer</code> object, or any instance of any other subclass of <code>Person</code>. The <code>type(of:)</code> operation produces a value of (static) type <code>Person.Type</code>, which dynamically could be <code>Person.self</code>, <code>Programmer.self</code>, or any other subclass&#39;s metatype. It&#39;s obvious, and a little mind-bending, but then it&#39;s obvious again. What can we do with a metatype? For one, we can use <code>class</code> methods and properties, which are the overridable equivalent of <code>static</code> methods and properties. (Within a class, <code>static</code> is a synonym for <code>class final</code>). For example, the following:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token function">print</span><span class="token punctuation">(</span>personType<span class="token punctuation">.</span>serializecClassName<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>If <code>person</code> dynamically stores a <code>Person</code> instance, the metatype in <code>personType</code> will be <code>Person.self</code>, and it&#39;ll print <code>PERSON</code>. If <code>person</code> dynamically stores a <code>Programmer</code> instance, the metatype in <code>personType</code> will be <code>Programmer.self</code> and it&#39;ll print <code>PROGRAMMER</code>. We can also initialize a new object by calling <code>personType.init(name:)</code>:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">let</span> newPerson <span class="token operator">=</span> personType<span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token string-literal"><span class="token string">&quot;Doug&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>and <code>newPerson</code> will have the same type as <code>person</code>. Note that this needs the initializer to be marked <code>required</code>: a <code>required</code> initializer must be implemented by every subclass. They&#39;re also needed to satisfy <code>init</code> requirements of a protocol to which the class conforms. For example:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">protocol</span> <span class="token class-name">InitByName</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">extension</span> <span class="token class-name">Person</span><span class="token punctuation">:</span> <span class="token class-name">InitByName</span> <span class="token punctuation">{</span> </span>
<span class="line">  <span class="token comment">// okay, because init(name:) is a required initializer</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Why do we need <code>required</code>? Making <code>Person</code> conform to <code>InitByName</code> implies that every subclass of <code>Person</code> also conforms to <code>InitByName</code>, because one should always be able to substitute an instance of a subclass where the superclass was expected (this is the <a href="https://en.wikipedia.org/wiki/Liskov_substitution_principle" target="_blank" rel="noopener noreferrer"><i class="vp-icon fa-brands fa-wikipedia-w" sizing="height"></i>Liskov Substitution Principle</a>). That means you need to be able to create an instance of any subclass by calling <code>init(name:)</code>. Making an initializer <code>required</code> ensures that all subclasses (and subclasses of subclasses, and so on) implement it. At this point, we could build a simple registry mapping from the serialized class names to actual <code>Person</code> types:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> knownPersonTypes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token punctuation">.</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function-definition function">addPersonType</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> personType<span class="token punctuation">:</span> <span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">Type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  knownPersonTypes<span class="token punctuation">[</span>personType<span class="token punctuation">.</span>serializedTypeName<span class="token punctuation">]</span> <span class="token operator">=</span> personType</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token function">addPersonType</span><span class="token punctuation">(</span><span class="token class-name">Person</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token function">addPersonType</span><span class="token punctuation">(</span><span class="token class-name">Programmer</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Then we can build a <code>Person</code> instance based on the serialized name and the <code>name</code> field:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">instantiatePerson</span><span class="token punctuation">(</span>className<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Person</span><span class="token operator">?</span> <span class="token punctuation">{</span></span>
<span class="line">  knownPersonTypes<span class="token punctuation">[</span>className<span class="token punctuation">]</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> name<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="any-metatypes" tabindex="-1"><a class="header-anchor" href="#any-metatypes"><span><code>any</code> metatypes</span></a></h3><p>Class metatypes opened up the ability to use dynamic dispatch via subclassing, but there&#39;s a more general way: metatypes work with <code>any</code>, so we can express the &quot;type of a some type that conforms to a protocol.&quot; For example, a value of type <code>any InitByName.Type</code> stores the metatype for some type that conforms to <code>InitByName</code>. That can be <code>Person</code> (or any of its subclasses), or some <code>struct</code> or <code>enum</code> that conforms to the protocol:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">struct</span> <span class="token class-name">Fruit</span><span class="token punctuation">:</span> <span class="token class-name">InitByName</span> <span class="token punctuation">{</span></span>
<span class="line">	<span class="token keyword">var</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">var</span> serializedTypeName<span class="token punctuation">:</span> <span class="token class-name">String</span> <span class="token punctuation">{</span> <span class="token string-literal"><span class="token string">&quot;FRUIT&quot;</span></span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The same registry code from before works just as well when we generalize <code>Person</code> to <code>any InitByName</code>. Here it is:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> knownTypes<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">String</span><span class="token punctuation">:</span> any <span class="token class-name">InitByName</span><span class="token punctuation">.</span><span class="token keyword">Type</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">]</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function-definition function">addInitByNameType</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> type<span class="token punctuation">:</span> any <span class="token class-name">InitByName</span><span class="token punctuation">.</span><span class="token keyword">Type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  knownTypes<span class="token punctuation">[</span>type<span class="token punctuation">.</span>serializedTypeName<span class="token punctuation">]</span> <span class="token operator">=</span> type</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function-definition function">instantiate</span><span class="token punctuation">(</span>typeName<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span>any <span class="token class-name">InitByName</span><span class="token punctuation">)</span><span class="token operator">?</span> <span class="token punctuation">{</span></span>
<span class="line">  knownTypes<span class="token punctuation">[</span>typeName<span class="token punctuation">]</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token keyword">init</span><span class="token punctuation">(</span>name<span class="token punctuation">:</span> name<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Note how the result of calling the initializer of a value of type <code>any InitByName.Type</code> is a value of type <code>any InitByName</code>. We don&#39;t know what metatype will be stored in the <code>any InitByName.Type</code> (although we could check with <code>as?</code> or a <code>case</code>), but we do know that its instance will conform to <code>InitByName</code>, so it&#39;s represented as <code>any InitByName</code>.</p><h3 id="explicitly-specified-generic-function-arguments" tabindex="-1"><a class="header-anchor" href="#explicitly-specified-generic-function-arguments"><span>Explicitly-specified generic function arguments</span></a></h3><p>C++ allows you to explicitly specify the template arguments for a function template. C++ libraries tend to make use of this feature when a type should be explicitly specified by the caller. For example, imagine a &quot;numeric cast&quot; template like this:</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">To</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">From</span><span class="token operator">&gt;</span></span>
<span class="line">To <span class="token function">numeric_cast</span><span class="token punctuation">(</span><span class="token keyword">const</span> From<span class="token operator">&amp;</span> from<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>In C++, the template argument for <code>To</code> can&#39;t be inferred by a normal call like <code>numeric_cast(d)</code>, so we explicitly specify the type at the call site, e.g.,:</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token keyword">double</span> d <span class="token operator">=</span> <span class="token number">17.0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token generic-function"><span class="token function">numeric_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, Swift is actually a bit different here. We can write essentially the same generic function:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">numericCast</span><span class="token operator">&lt;</span><span class="token class-name">To</span><span class="token punctuation">:</span> <span class="token class-name">Numeric</span><span class="token punctuation">,</span> <span class="token class-name">From</span><span class="token punctuation">:</span> <span class="token class-name">Numeric</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> value<span class="token punctuation">:</span> <span class="token class-name">From</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">To</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>but it&#39;s going to behave differently at the call site. Swift&#39;s type inference uses more contextual cues that C++&#39;s template argument deduction, so a call like this will work fine in Swift:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">let</span> x<span class="token punctuation">:</span> <span class="token class-name">Int</span> <span class="token operator">=</span> <span class="token function">numericCast</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>If you don&#39;t have type context to infer the type, i.e., if you just write:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token function">numericCast</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>  <span class="token comment">// type inference fails to find a `To` type</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>then type inference will fail to infer a <code>To</code> type. An <code>as</code> coercion can fix this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token function">numericCast</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">Int</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Given that type inference usually figures out the types for us, and Swift already has the general notion of using <code>as</code> to provide type information when it doesn&#39;t, Swift never got the ability to explicitly provide generic arguments for functions. <code>numericCast&lt;Int&gt;(d)</code> is an error in Swift.</p><p>But what if you <em>want</em> to require the type to be specified at the call site, and not rely entirely on type inference? Turns out that you can use metatypes, and the result is really nice:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">numericCast</span><span class="token operator">&lt;</span><span class="token class-name">From</span><span class="token punctuation">:</span> <span class="token class-name">Numeric</span><span class="token punctuation">,</span> <span class="token class-name">To</span><span class="token punctuation">:</span> <span class="token class-name">Numeric</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> value<span class="token punctuation">:</span> <span class="token class-name">From</span><span class="token punctuation">,</span> to type<span class="token punctuation">:</span> <span class="token class-name">To</span><span class="token punctuation">.</span><span class="token keyword">Type</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">To</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Here, we&#39;ve added a <code>to</code> parameter of the metatype of <code>To</code>. The user specifies the metatype of the type to convert to at the call site, like this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">numericCast</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> to<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">.</span><span class="token keyword">self</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>The type of <code>To</code> is inferred from the argument. It also reads really nicely: &quot;numeric cast <code>d</code> to <code>Int</code>&quot;.</p><p>Will Swift eventually gain the ability to explicitly specify the generic arguments of a generic function? Maybe someday, but not having this feature led to the discovery of the metatype-based solution above, and I think the end result is better for readability.</p><hr><h2 id="associated-types" tabindex="-1"><a class="header-anchor" href="#associated-types"><span>Associated types</span></a></h2><p>Associated types have some interesting interactions with type erasure. Let&#39;s explore those now, bringing back the <code>Collection</code> protocol from the prior post on Swift generics to develop these ideas further:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">protocol</span> <span class="token class-name">Collection</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">associatedtype</span> <span class="token class-name">Value</span></span>
<span class="line">  <span class="token keyword">associatedtype</span> <span class="token class-name">Index</span><span class="token punctuation">:</span> <span class="token class-name">Equatable</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">var</span> startIndex<span class="token punctuation">:</span> <span class="token class-name">Index</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">var</span> endIndex<span class="token punctuation">:</span> <span class="token class-name">Index</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">func</span> <span class="token function-definition function">index</span><span class="token punctuation">(</span>after index<span class="token punctuation">:</span> <span class="token class-name">Index</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Index</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">subscript</span><span class="token punctuation">(</span>index<span class="token punctuation">:</span> <span class="token class-name">Index</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Value</span> <span class="token punctuation">{</span> <span class="token keyword">get</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">extension</span> <span class="token class-name">Collection</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> first<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token operator">?</span> <span class="token punctuation">{</span> </span>
<span class="line">    startIndex <span class="token operator">==</span> endIndex <span class="token operator">?</span> <span class="token nil constant">nil</span> <span class="token punctuation">:</span> <span class="token keyword">self</span><span class="token punctuation">[</span>startIndex<span class="token punctuation">]</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="erasure-of-associated-types" tabindex="-1"><a class="header-anchor" href="#erasure-of-associated-types"><span>Erasure of associated types</span></a></h3><p>Let&#39;s say we have a value <code>c</code> of type <code>any Collection</code>:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> c<span class="token punctuation">:</span> any <span class="token class-name">Collection</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>At runtime, <code>c</code> could store an <code>[Int]</code> or a <code>[String: (any InitByName).Type]</code>, or a <code>Set&lt;String&gt;</code> or any other collection. If we ask for the <code>first</code> value in <code>c</code>:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">let</span> f <span class="token operator">=</span> c<span class="token punctuation">.</span>first</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>what type should we expect to get? We know it&#39;s the <code>Value</code> type of the underlying collection, but since we don&#39;t know what the collection itself is, we don&#39;t know the <code>Value</code> type of it, either. Therefore, the type of the <code>first</code> is also type-erased by replacing each occurrence of an associated type (here, it&#39;s <code>Value</code>) with an <code>any</code> type based on the constraints placed on that associated type. There are no constraints on <code>Value</code>, so the type of <code>first</code> (<code>Value?</code>) is type-erased to <code>Any?</code>. For an associated type like <code>Index</code> that has constraints, we&#39;ll get a more interesting resulting type: <code>Index</code> will be type-erased to <code>any Equatable</code>, so if we grab the start and end index of our collection, we&#39;ll get <code>any Equatable</code> values:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> si <span class="token operator">=</span> c<span class="token punctuation">.</span>startIndex   <span class="token comment">// inferred type is &#39;any Equatable&#39;</span></span>
<span class="line"><span class="token keyword">let</span> ei <span class="token operator">=</span> c<span class="token punctuation">.</span>endIndex     <span class="token comment">// inferred type is &#39;any Equatable&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>The type erasure for associated types happens automatically, and generally means that once you&#39;ve erased some type information, that type information stays erased until you do something explicit to bring type information back. Most of the time, that&#39;s fine, but it can be surprising.</p><h3 id="equality-of-types" tabindex="-1"><a class="header-anchor" href="#equality-of-types"><span>Equality of types</span></a></h3><p>Now that we have the start and end indices, it&#39;s completely reasonable that we&#39;d want to be able to loop over the elements of our collection <code>c</code>, perhaps like this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">while</span> si <span class="token operator">!=</span> ei <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">let</span> element <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token keyword">subscript</span><span class="token punctuation">[</span>si<span class="token punctuation">]</span></span>
<span class="line">  <span class="token function">doSomething</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span></span>
<span class="line">  si <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>after<span class="token punctuation">:</span> si<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>However, this can&#39;t work. Let&#39;s focus on the <code>si != ei</code>, which is trying to use the <code>!=</code> operator from the <code>Equatable</code> protocol:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">protocol</span> <span class="token class-name">Equatable</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token operator">==</span><span class="token punctuation">(</span>lhs<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span></span>
<span class="line">  <span class="token keyword">static</span> <span class="token keyword">func</span> <span class="token operator">!=</span><span class="token punctuation">(</span>lhs<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Remember that <code>Self</code> is the actual, concrete type that conforms to the protocol <code>Equatable</code>. When we write <code>si != ei</code>, where each of <code>si</code> and <code>ei</code> are of type <code>any Equatable</code>, the actual type for <code>Self</code> is stored inside that <code>any Equatable</code> and can vary at runtime. Here in the call, there&#39;s no static guarantee that both <code>si</code> and <code>ei</code> have the same underlying type as run-time, so the compiler has to reject the call. Otherwise, we could end up trying to compare an <code>Int</code> to a <code>String</code>, but there&#39;s no operator for that.</p><h3 id="opening-any-types" tabindex="-1"><a class="header-anchor" href="#opening-any-types"><span>Opening <code>any</code> types</span></a></h3><p>To make this work, we&#39;re going to have to <em>dynamically</em> check that both sides have the same type, <em>then</em> use their operator. Let&#39;s build a function to check equality of two distinct <code>Equatable</code> types. To do so, we&#39;re going to use generics:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">isEqual</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Equatable</span><span class="token punctuation">,</span> <span class="token class-name">U</span><span class="token punctuation">:</span> <span class="token class-name">Equatable</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> lhs<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> <span class="token class-name">U</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token keyword">let</span> rhsAsT <span class="token operator">=</span> rhs <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">T</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> lhs <span class="token operator">==</span> rhsAsT</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">if</span> <span class="token keyword">let</span> lhsAsU <span class="token operator">=</span> lhs <span class="token keyword">as</span><span class="token operator">?</span> <span class="token class-name">U</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> lhsAsU <span class="token operator">==</span> rhs</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The types <code>T</code> and <code>U</code> could be different, so we first try to cast <code>rhs</code> to a <code>T</code>: if that succeeds, we can compare the values as <code>T</code> instances because <code>T</code> is <code>Equatable</code>. We also try in the other direction, to compare as <code>U</code> instances (via <code>U: Equatable</code>). If both fail, the types are incomparable, and we return <code>false</code>. Now, our loop condition can be</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">while</span> <span class="token operator">!</span><span class="token function">isEqual</span><span class="token punctuation">(</span>si<span class="token punctuation">,</span> ei<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>But how does that <em>work</em>? We passed two <code>any Equatable</code> values (which are firmly runtime-polymorphic) into a generic function (which is statically-polymorphic), and it... just... works. This is what I meant be moving between static and dynamic polymorphism in Swift.</p><p>What&#39;s happening under the hood is called &quot;opening&quot; the <code>any</code> type. Effectively, the compiler is reaching in to each <code>any Equatable</code> value to pull out the concrete type, and binding the appropriate generic parameter (<code>T</code> or <code>U</code>) to that concrete type. Swift can do this due to separate compilation of generics, so the <code>isEqual</code> function implementation can work with types that aren&#39;t known until runtime.</p><p>We could write a similar function to perform the subscript of the collection, but it would be a lot easier if we turned the whole loop into a generic function on the collection. Say, a for-each operation:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">forEach</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Collection</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> c<span class="token punctuation">:</span> <span class="token class-name">C</span><span class="token punctuation">,</span> body<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">C</span><span class="token punctuation">.</span><span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> si <span class="token operator">=</span> c<span class="token punctuation">.</span>startIndex</span>
<span class="line">  <span class="token keyword">let</span> ei <span class="token operator">=</span> c<span class="token punctuation">.</span>endIndex</span>
<span class="line">  <span class="token keyword">while</span> si <span class="token operator">!=</span> ei <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">let</span> current <span class="token operator">=</span> c<span class="token punctuation">[</span>si<span class="token punctuation">]</span></span>
<span class="line">    <span class="token function">body</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span></span>
<span class="line">    si <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>after<span class="token punctuation">:</span> si<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This operation is generic: we have a name for the collection type (<code>C</code>), and know the relationship to its <code>Value</code> and <code>Index</code> types, so we have strong type equality. We can call this function with a value of type <code>any Collection</code>:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token function">forEach</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span> element <span class="token keyword">in</span></span>
<span class="line">  <span class="token function">doSomething</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>That call opens up the type of <code>c</code>, binding it to <code>forEach</code>&#39;s generic parameter <code>C</code>. The call itself still needs to erase the associated type, so the <code>element</code> parameter of the closure will be the type-erased <code>Value</code> type, i.e., <code>Any</code>.</p><h3 id="primary-associated-types" tabindex="-1"><a class="header-anchor" href="#primary-associated-types"><span>Primary associated types</span></a></h3><p>Sometimes, it can be useful to be able to make some of the associated types concrete even when using an <code>any</code> type. For example, we might want to be able to take any collection stores <code>String</code> values. We can do so with <em>primary</em> associated types, which use generic argument syntax to specify associated types. The primary associated types are listed in angle brackets following the protocol name:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">protocol</span> <span class="token class-name">Collection</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">associatedtype</span> <span class="token class-name">Value</span></span>
<span class="line">  <span class="token keyword">associatedtype</span> <span class="token class-name">Index</span><span class="token punctuation">:</span> <span class="token class-name">Equatable</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This enables <code>any</code> types to specify the <code>Value</code> type. For example, <code>any Collection&lt;String&gt;</code> is any type that conforms to <code>Collection</code> and has <code>String</code> as its value type. A value of such a type could store a <code>[String]</code>, <code>Set&lt;String&gt;</code>, or other collection:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> strings<span class="token punctuation">:</span> any <span class="token class-name">Collection</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span></span>
<span class="line">strings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">&quot;Hello&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;World&quot;</span></span><span class="token punctuation">]</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span>first <span class="token operator">??</span> <span class="token string-literal"><span class="token string">&quot;Empty collection&quot;</span></span><span class="token punctuation">)</span> <span class="token comment">// &quot;Hello&quot;</span></span>
<span class="line">strings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string-literal"><span class="token string">&quot;Hello&quot;</span></span><span class="token punctuation">,</span> <span class="token string-literal"><span class="token string">&quot;World&quot;</span></span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span>strings<span class="token punctuation">.</span>first <span class="token operator">??</span> <span class="token string-literal"><span class="token string">&quot;Empty collection&quot;</span></span><span class="token punctuation">)</span> <span class="token comment">// &quot;Hello&quot; or &quot;World&quot;; ordering in sets is not guaranteed</span></span>
<span class="line"></span>
<span class="line">strings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token comment">// error: cannot convert value of type &#39;Int&#39; to expected element type &#39;String&#39; </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Even when there are primary associated types, one can use <code>any</code> types without mentioning them. In such cases, the associated type will be type-erased. For example, with the above protocol, <code>any Collection</code> will have its <code>Value</code> type type-erased to <code>Any</code>.</p><p>Why did we choose to make <code>Value</code> a primary associated type and not <code>Index</code>? It&#39;s all about the use cases, and here your instincts from C++ containers will serve you well: you generally care about the value type of a container because you&#39;re operating on its elements, but its iterator type is generally not interesting except as a mechanism to get at the elements. More importantly, although you generally get to choose the value type of your container, but the iterator comes with it, so only the value type makes sense as a primary associated type.</p><hr><h2 id="when-to-type-erase" tabindex="-1"><a class="header-anchor" href="#when-to-type-erase"><span>When to type-erase?</span></a></h2><p>Type erasure via <code>any</code> is not free: an instance of an <code>any</code> type has a fixed-sized buffer along with information about the (dynamically) stored type and each of the protocols that type conforms to. When the stored value is larger than that buffer, the <code>any</code> instance will be heap-allocated. Every operation on an instance of <code>any</code> goes through the equivalent of a <code>virtual</code> method dispatch, including copying and destruction. If you&#39;ve ever looked into the implementation of <code>std::any</code> or <code>std::function</code>, you&#39;ll have a good mental model for how <code>any</code> types work under the hood in Swift, and why they aren&#39;t cheap. The Swift optimizer will do some amount of specialization of <code>any</code> types, but for it to succeed it needs to see both the creation and use of the <code>any</code> type, so it&#39;s not recommended to rely heavily on this optimization.</p><p>Use <code>any</code> types when you need to store heterogeneous data that potentially accepts any number of types. If there&#39;s a small, fixed number of types that you might store (say, a choice among a few basic types), consider using an <code>enum</code> instead:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">enum</span> <span class="token class-name">StoredValue</span><span class="token punctuation">:</span> <span class="token class-name">Hashable</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">case</span> <span class="token function">integer</span><span class="token punctuation">(</span><span class="token class-name">Int</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">case</span> <span class="token function">floating</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">case</span> <span class="token function">string</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Operations on the <code>StoredValue</code> enum will be more efficient than operating on an <code>any Hashable</code> instance, because <code>StoredValue</code> is a concrete type.</p><p>More importantly, prefer generic operations to operations on <code>any</code> values. There is no reason to have a function that accepts a single <code>any</code> value, for example:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">operateOnAny</span><span class="token punctuation">(</span>strings<span class="token punctuation">:</span> any <span class="token class-name">Collection</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>because the same function can be expressed generically as follows:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">operateOnAny</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Collection</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>strings<span class="token punctuation">:</span> <span class="token class-name">C</span><span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">C</span><span class="token punctuation">.</span><span class="token class-name">Value</span> <span class="token operator">==</span> <span class="token class-name">String</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Due to opening of <code>any</code> types, which we talked about earlier, the two functions above are effectively interchangeable for callers. The generic function is better for performance, however, both because calls passing a concrete type like <code>[String]</code> avoid the formation of the <code>any Collection&lt;String&gt;</code> value and because it&#39;s easier for the compiler to specialize the generic version for <code>[String]</code> when it&#39;s profitable.</p><p>This is another place where your C++ instincts are good and you shouldn&#39;t ignore them: you wouldn&#39;t write a function to take a <code>std::any</code> parameter unless you really couldn&#39;t write it as a function template taking an arbitrary <code>T</code>, so think of <code>any</code> types the same way in Swift.</p><p>It&#39;s a <em>little</em> unfortunate that the more efficient generic function is more verbose than the less-efficient one. I&#39;ve been holding off on introducing one last bit of syntactic sugar that gets rid of that advantage, because it needs a little explanation. Spoiler alert: the <code>some</code> keyword is used to introduce unnamed generic parameters with syntax parallel to that of <code>any</code> types, so the second function can be written as:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">operateOnAny</span><span class="token punctuation">(</span>strings<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">Collection</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Each <code>some</code> type introduces an unnamed generic parameter whose constraints are listed after the <code>some</code>. Swift <code>some</code> types are also called <em>opaque</em> types, because they hide the name of the underlying type: an unnamed generic parameter can&#39;t be named (duh), so the actual collection type based into <code>operateOnAny(strings:)</code> is hidden from the function body. Opaque types are also useful in the return type of a function to hide the specific return type from the caller.</p><hr><h2 id="implementation-hiding-with-opaque-types" tabindex="-1"><a class="header-anchor" href="#implementation-hiding-with-opaque-types"><span>Implementation hiding with opaque types</span></a></h2><p><code>any</code> types effectively hide the underlying type from clients, allowing it to change dynamically at run time. These are two different things: the first is about hiding implementation details behind an abstraction barrier (e.g., we know that we have a <code>Collection</code> of <code>String</code>s, but not the specific type of the collection itself) and the other is about allowing the underlying representation to change dynamically (e.g., we can choose <code>Set&lt;String&gt;</code> or <code>[String]</code> depending on what&#39;s best for the problem at hand). Swift has a notion of <em>opaque</em> types that let you hide the implementation type behind an abstraction barrier without allowing it to change dynamically at runtime. This gives you, as the implementer, the freedom to limit your API surface area (by not exposing specific conrete types) and evolve your implementations over time, without breaking clients. For example, let&#39;s consider implementing a generic function <code>uniqued</code> on a <code>Collection</code> that produces a new collection with duplicates removed. We could have such a function return a <code>Set</code>:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">extension</span> <span class="token class-name">Collection</span> <span class="token keyword">where</span> <span class="token class-name">Value</span><span class="token punctuation">:</span> <span class="token class-name">Hashable</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">func</span> <span class="token function-definition function">uniqued</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>That implementation was easy, but it&#39;s perhaps not the best one. It might be better to unique into an array and return that, or return some different type entirely. The problem is that we have to decide right at the point where we create this function what the act type will be, and assess all of the tradeoffs. We could introduce a special type to capture the &quot;uniqued collection&quot;, like <code>UniquedCollection&lt;Self&gt;</code>. That&#39;s probably what we would do in C++, perhaps burying it in an <code>impl</code> or <code>detail</code> namespace to discourage users from depending on it. Opaque types let us describe the result type based on its capabilities (in terms of protocols) without stating its identity:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">extension</span> <span class="token class-name">Collection</span> <span class="token keyword">where</span> <span class="token class-name">Value</span><span class="token punctuation">:</span> <span class="token class-name">Hashable</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">uniqued</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">some</span> <span class="token class-name">Collection</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token comment">// okay, Set&lt;Value&gt; is a Collection&lt;Value&gt;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>A user that calls <code>uniqued()</code> can&#39;t spell the type of the result, but it can be inferred and is known to be a collection containing the same value type as the collection it was applied to:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">let</span> uniquedNumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">uniqued</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// okay, type is opaque to the user</span></span>
<span class="line"><span class="token function">print</span><span class="token punctuation">(</span>uniquedNumbers<span class="token punctuation">.</span>first<span class="token punctuation">)</span>                         <span class="token comment">// prints the (1)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>If we later decide to change the type returned by <code>unique()</code>, we can, because we never exposed the type to the user. So we can change our implementation to produce an array:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">extension</span> <span class="token class-name">Collection</span> <span class="token keyword">where</span> <span class="token class-name">Value</span><span class="token punctuation">:</span> <span class="token class-name">Hashable</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">uniqued</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">some</span> <span class="token class-name">Collection</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// okay, unique via a set but return an array</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>or a private type of some sort:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">private</span> <span class="token keyword">struct</span> <span class="token class-name">UniquedCollection</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Collection</span><span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token class-name">Collection</span> <span class="token keyword">where</span> <span class="token class-name">C</span><span class="token punctuation">.</span><span class="token class-name">Value</span><span class="token punctuation">:</span> <span class="token class-name">Hashable</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">extension</span> <span class="token class-name">Collection</span> <span class="token keyword">where</span> <span class="token class-name">Value</span><span class="token punctuation">:</span> <span class="token class-name">Hashable</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">public</span> <span class="token keyword">func</span> <span class="token function-definition function">uniqued</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">some</span> <span class="token class-name">Collection</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">UniquedCollection</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token comment">// okay, unique via a set but return an array</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Because the type is opaque to clients, these implementation changes won&#39;t affect them at all: they&#39;re under-the-hood improvements made by the author of <code>uniqued()</code>.</p><h3 id="some-vs-any" tabindex="-1"><a class="header-anchor" href="#some-vs-any"><span><code>some</code> vs. <code>any</code></span></a></h3><p>In Swift, <code>any</code> types can be read to mean &quot;any type that satisfies these requirements&quot; whereas <code>some</code> types are read to mean &quot;some specific type that satisfied these requirements&quot;. The key point here is that <code>some</code> types maintain identity whereas <code>any</code> types do not: if I take that <code>uniquedNumbers</code> type from above, I can iterate over it directly:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">let</span> uniquedNumbers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">uniqued</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">var</span> ci <span class="token operator">=</span> uniquedNumbers<span class="token punctuation">.</span>startIndex</span>
<span class="line"><span class="token keyword">let</span> ei <span class="token operator">=</span> uniquedNumbers<span class="token punctuation">.</span>endIndex</span>
<span class="line"><span class="token keyword">while</span> ci <span class="token operator">!=</span> ei <span class="token punctuation">{</span> <span class="token comment">// okay, Index type of the opaque type of uniquedNumbers</span></span>
<span class="line">  <span class="token function">print</span><span class="token punctuation">(</span>uniquedNumbers<span class="token punctuation">[</span>ci<span class="token punctuation">]</span><span class="token punctuation">)</span></span>
<span class="line">  ci <span class="token operator">=</span> uniquedNumbers<span class="token punctuation">.</span><span class="token function">index</span><span class="token punctuation">(</span>after<span class="token punctuation">:</span> ci<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This puts some restrictions on the body of functions returning <code>some</code> types. Specifically, every <code>return</code> statement must produce a value of the same type. This is called the <em>underlying type</em>, and the Swift compiler will detect a mismatch:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token number">66</span> <span class="token operator">|</span> <span class="token keyword">extension</span> <span class="token class-name">Collection</span> <span class="token keyword">where</span> <span class="token class-name">Value</span><span class="token punctuation">:</span> <span class="token class-name">Hashable</span> <span class="token punctuation">{</span></span>
<span class="line"><span class="token number">67</span> <span class="token operator">|</span>   <span class="token keyword">func</span> <span class="token function-definition function">uniqued</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">some</span> <span class="token class-name">Collection</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">   <span class="token operator">|</span>        `<span class="token operator">-</span> error<span class="token punctuation">:</span> function declares an opaque <span class="token keyword">return</span> type &#39;<span class="token keyword">some</span> <span class="token class-name">Collection</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span>&#39;<span class="token punctuation">,</span> but the <span class="token keyword">return</span> </span>
<span class="line">   <span class="token operator">|</span>           statements <span class="token keyword">in</span> its body <span class="token keyword">do</span> not have matching underlying types</span>
<span class="line"><span class="token number">68</span> <span class="token operator">|</span>     <span class="token keyword">if</span> isEmpty <span class="token punctuation">{</span></span>
<span class="line"><span class="token number">69</span> <span class="token operator">|</span>       <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token class-name">Element</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">   <span class="token operator">|</span>                      `<span class="token operator">-</span> note<span class="token punctuation">:</span> <span class="token keyword">return</span> statement has underlying type &#39;<span class="token punctuation">[</span><span class="token keyword">Self</span><span class="token punctuation">.</span><span class="token class-name">Value</span><span class="token punctuation">]</span>&#39;</span>
<span class="line"><span class="token number">70</span> <span class="token operator">|</span>     <span class="token punctuation">}</span></span>
<span class="line"><span class="token number">71</span> <span class="token operator">|</span> </span>
<span class="line"><span class="token number">72</span> <span class="token operator">|</span>     <span class="token keyword">return</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">Element</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">)</span></span>
<span class="line">   <span class="token operator">|</span>                       `<span class="token operator">-</span> note<span class="token punctuation">:</span> <span class="token keyword">return</span> statement has underlying type &#39;<span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">.</span><span class="token class-name">Value</span><span class="token operator">&gt;</span>&#39;</span>
<span class="line"><span class="token number">73</span> <span class="token operator">|</span>   <span class="token punctuation">}</span></span>
<span class="line"><span class="token number">74</span> <span class="token operator">|</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Note that the identity of the underlying type is hidden from clients of the function, but it is known to the compiler, so hiding a type via an opaque type isn&#39;t a performance pessimization the way an <code>any</code> type is.</p><h3 id="hiding-complicated-result-types" tabindex="-1"><a class="header-anchor" href="#hiding-complicated-result-types"><span>Hiding complicated result types</span></a></h3><p>Opaque result types really shine when they&#39;re used to hide unnecessary implementation details. To see what I mean, think about the types that are produced from a C++ library that uses <a href="https://en.wikipedia.org/wiki/Expression_templates" target="_blank" rel="noopener noreferrer"><i class="vp-icon fa-brands fa-wikipedia-w" sizing="height"></i>expression templates</a>: every single operator introduces another wrapper type (often two of them), producing a final result whose type encodes the entire operation. For example, one might have a <code>parallel_array</code> type that uses expression templates, and an expression like:</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token keyword">auto</span> result <span class="token operator">=</span> a <span class="token operator">*</span> x <span class="token operator">+</span> b</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>would produce a type such as <code>expr&lt;add_expr&lt;expr&lt;mul_expr&lt;expr&lt;parallel_array&lt;double&gt;&gt;, expr&lt;double&gt;&gt;&gt;, expr&lt;parallel_array&lt;double&gt;&gt;&gt;</code>. Add some namespace qualifiers in there and it gets overwhelming, fast. It gets particularly bad when you have to name the result type for some reason, e.g.,</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">A</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">X</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">B</span><span class="token operator">&gt;</span></span>
<span class="line">expr<span class="token operator">&lt;</span>add_expr<span class="token operator">&lt;</span>expr<span class="token operator">&lt;</span>mul_expr<span class="token operator">&lt;</span>A<span class="token punctuation">,</span> X<span class="token operator">&gt;&gt;</span><span class="token punctuation">,</span> Y<span class="token operator">&gt;</span> <span class="token function">mul_add</span><span class="token punctuation">(</span>A a<span class="token punctuation">,</span> X x<span class="token punctuation">,</span> B b<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> a <span class="token operator">*</span> x <span class="token operator">+</span> b<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Expression templates can be a useful tool in Swift for the same reasons they&#39;re useful in C++, and Swift would have exactly the same issue with an explosion in user-facing types from simple uses. However, opaque result types let us hide the information behind a <code>some</code> type. For example,</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">protocol</span> <span class="token class-name">ArrayExpr</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">associatedtype</span> <span class="token class-name">Value</span><span class="token punctuation">:</span> <span class="token class-name">Numeric</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">struct</span> <span class="token class-name">MulScalarOp</span><span class="token operator">&lt;</span><span class="token constant">LHS</span><span class="token punctuation">:</span> <span class="token class-name">ArrayExpr</span><span class="token operator">&gt;</span><span class="token punctuation">:</span> <span class="token class-name">ArrayExpr</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">typealias</span> <span class="token class-name">Value</span> <span class="token operator">=</span> <span class="token constant">LHS</span><span class="token punctuation">.</span><span class="token class-name">Value</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">init</span><span class="token punctuation">(</span>lhs<span class="token punctuation">:</span> <span class="token constant">LHS</span><span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> <span class="token constant">LHS</span><span class="token punctuation">.</span><span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token operator">*&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>lhs<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">ArrayExpr</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">some</span> <span class="token class-name">ArrayExpr</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> </span>
<span class="line">  <span class="token class-name">MulScalarOp</span><span class="token punctuation">(</span>lhs<span class="token punctuation">:</span> lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> value<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">struct</span> <span class="token class-name">AddArrayOp</span><span class="token operator">&lt;</span><span class="token constant">LHS</span><span class="token punctuation">:</span> <span class="token class-name">ArrayExpr</span><span class="token punctuation">,</span> <span class="token constant">RHS</span><span class="token punctuation">:</span> <span class="token class-name">ArrayExpr</span><span class="token operator">&gt;</span> <span class="token keyword">where</span> <span class="token constant">LHS</span><span class="token punctuation">.</span><span class="token class-name">Value</span> <span class="token operator">==</span> <span class="token constant">RHS</span><span class="token punctuation">.</span><span class="token class-name">Value</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">typealias</span> <span class="token class-name">Value</span> <span class="token operator">=</span> <span class="token constant">LHS</span><span class="token punctuation">.</span><span class="token class-name">Value</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">init</span><span class="token punctuation">(</span>lhs<span class="token punctuation">:</span> <span class="token constant">LHS</span><span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> <span class="token constant">RHS</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token operator">+&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>lhs<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">ArrayExpr</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">ArrayExpr</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">some</span> <span class="token class-name">ArrayExpr</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span> </span>
<span class="line">  <span class="token class-name">AddArrayOp</span><span class="token punctuation">(</span>lhs<span class="token punctuation">:</span> lhs<span class="token punctuation">,</span> rhs<span class="token punctuation">:</span> rhs<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, code like this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">let</span> result <span class="token operator">=</span> a <span class="token operator">*</span> x <span class="token operator">+</span> b</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>produces an opaque type like <code>some ArrayExpr&lt;Double&gt;</code> that avoids exposing all of the implementation details of the expression templates. Add operation like the C++ <code>mul_add</code> earlier can be expressed in terms of opaque types so one never has to name the complicated types:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">mulAdd</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> a<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">ArrayExpr</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token omit keyword">_</span> x<span class="token punctuation">:</span> <span class="token class-name">Value</span><span class="token punctuation">,</span> <span class="token omit keyword">_</span> b<span class="token punctuation">:</span> <span class="token keyword">some</span> <span class="token class-name">ArrayExpr</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">some</span> <span class="token class-name">ArrayExpr</span><span class="token operator">&lt;</span><span class="token class-name">Value</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  a <span class="token operator">*</span> x <span class="token operator">+</span> b</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We&#39;re still expressing the fundamental type constraints here: both <code>a</code> and <code>b</code> are array expressions of some type, whose underlying value type is <code>Value</code>, and <code>x</code> is a scalar of type <code>Value</code>. But we&#39;ve abstracted away the actual array expression types so they can be propagated behind-the-scenes.</p><p>However, the compiler can still see the underlying types, so it can optimize the expression templates in the same manner one would expect.</p><hr><h2 id="wrap-up" tabindex="-1"><a class="header-anchor" href="#wrap-up"><span>Wrap up</span></a></h2><p>Type erasure in Swift leverages the same notion of protocols and constraints as generics, but moves from the realm of static polymorphism (concrete types known at compile time) to runtime polymorphism (types only known at runtime). Type erasure makes it easy to create heterogeneous data structures, which contain values of types not known until runtime.</p><p>Because of Swift&#39;s model of separate compilation, one can move easily between static and dynamic polymorphism: a value that conforms to a protocol <code>P</code> can be type-erased into a value of type <code>any P</code>, moving from static to dynamic polymorphism. Conversely, a value of type <code>any P</code> can be passed to a generic function requiring a type conforming to <code>P</code>, moving from dynamic back to static polymorphism. So while most of the time you should probably be using generics for abstraction, because they maintain more type information and are therefore easier to optimize, you can use type erasure locally in those places where you need the runtime polymorphism.</p><p>We also discussed metatypes. Metatypes are first-class values in Swift, and are the answer to the question &quot;what&#39;s the type of this value?&quot;. Metatypes can be used to identify the types of values, construct new instances of the identified type (when there is a suitable <code>init</code> requirement), and dynamically query the capabilities of a given type with queries such as &quot;does this type conform to the protocol <code>Decodable</code>?&quot;.</p><p>Next up, we&#39;ll explore Swift&#39;s take on error handling, comparing against C++&#39;s model of exceptions.</p></div><!----><!----><!----></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/chanhi2000/bookshelf/edit/main/src/douggregor.net/swift-for-cpp-practitioners-5.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/bookshelf/programming/swift/articles/" aria-label="/programming/swift/articles/"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->/programming/swift/articles/</div></a><a class="route-link auto-link next" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-6.html" aria-label="Swift for C++ Practitioners, Part 6: Error Handling"><div class="hint">Next<span class="arrow end"></span></div><div class="link">Swift for C++ Practitioners, Part 6: Error Handling<i class="vp-icon fa-brands fa-swift" sizing="height"></i></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">MIT Licensed | Copyright Â© 2022-present <a href="https://github.com/chanhi2000">Chan Hee Lee</a></div><!----></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/bookshelf/assets/app-BItykJLQ.js" defer></script>
  </body>
</html>
