<!doctype html>
<html lang="ko-KR" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.24" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.94" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Swift for C++ Practitioners, Part 7: Closures","image":[""],"datePublished":"2024-04-28T00:00:00.000Z","dateModified":null,"author":[]}</script><meta property="og:url" content="https://chanhi2000.github.io/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html"><meta property="og:site_name" content="📚Bookshelf"><meta property="og:title" content="Swift for C++ Practitioners, Part 7: Closures"><meta property="og:description" content="Article(s) > Swift for C++ Practitioners, Part 7: Closures"><meta property="og:type" content="article"><meta property="og:locale" content="ko-KR"><meta property="article:tag" content="cpp"><meta property="article:tag" content="c++"><meta property="article:tag" content="ios"><meta property="article:tag" content="swift"><meta property="article:tag" content="douggregor.net"><meta property="article:tag" content="blog"><meta property="article:published_time" content="2024-04-28T00:00:00.000Z"><link rel="icon" href="/bookshelf/assets/icon/favicon.svg"><title>Swift for C++ Practitioners, Part 7: Closures | 📚Bookshelf</title><meta name="description" content="Article(s) > Swift for C++ Practitioners, Part 7: Closures">
    <link rel="preload" href="/bookshelf/assets/style-DmRYlEXZ.css" as="style"><link rel="stylesheet" href="/bookshelf/assets/style-DmRYlEXZ.css">
    
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/bookshelf/" aria-label="Take me home"><img class="vp-nav-logo" src="/bookshelf/assets/icon/favicon.svg" alt><!----><span class="vp-site-name hide-in-pad">📚Bookshelf</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/bookshelf/news.html" aria-label><!--[--><i class="vp-icon fas fa-rss" sizing="height"></i><!--]--><!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label><!--[--><i class="vp-icon fas fa-keyboard" sizing="height"></i><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/hackingwithswift.com/" aria-label="hackingwithswift.com"><!--[--><img class="vp-icon" src="https://hackingwithswift.com/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->hackingwithswift.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/fcc/" aria-label="freecodecamp.org"><!--[--><img class="vp-icon" src="https://cdn.freecodecamp.org/universal/favicons/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->freecodecamp.org<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/kodeco.com/" aria-label="kodeco.com"><!--[--><img class="vp-icon" src="https://kodeco.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->kodeco.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.kotzilla.io/" aria-label="blog.kotzilla.io"><!--[--><img class="vp-icon" src="https://blog.kotzilla.io/hubfs/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->blog.kotzilla.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/kt.academy/" aria-label="kt.academy"><!--[--><img class="vp-icon" src="https://kt.academy/logo.png" alt aria-hidden no-view sizing="both"><!--]-->kt.academy<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/droidcon.com/" aria-label="droidcon.com"><!--[--><img class="vp-icon" src="https://droidcon.com/wp-content/uploads/2021/07/favicon-300x300.png" alt aria-hidden no-view sizing="both"><!--]-->droidcon.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/outcomeschool.com/" aria-label="outcomeschool.com"><!--[--><img class="vp-icon" src="https://outcomeschool.com/static/favicons/apple-touch-icon.png" alt aria-hidden no-view sizing="both"><!--]-->outcomeschool.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/frontendmasters.com/" aria-label="frontendmasters.com"><!--[--><img class="vp-icon" src="https://frontendmasters.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->frontendmasters.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/css-tricks.com/" aria-label="css-tricks.com"><!--[--><img class="vp-icon" src="https://css-tricks.com/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->css-tricks.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/smashingmagazine.com/" aria-label="smashingmagazine.com"><!--[--><img class="vp-icon" src="https://smashingmagazine.com/images/favicon/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->smashingmagazine.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.logrocket.com/" aria-label="blog.logrocket.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/blog.logrocket.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->blog.logrocket.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/realpython.com/" aria-label="realpython.com"><!--[--><img class="vp-icon" src="https://realpython.com/static/favicon.68cbf4197b0c.png" alt aria-hidden no-view sizing="both"><!--]-->realpython.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/digitalocean.com/" aria-label="digitalocean.com"><!--[--><img class="vp-icon" src="https://digitalocean.com/_next/static/media/favicon.594d6067.ico" alt aria-hidden no-view sizing="both"><!--]-->digitalocean.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/antonioleiva.com/" aria-label="antonioleiva.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/antonioleiva.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->antonioleiva.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/johnnyreilly.com/" aria-label="johnnyreilly.com"><!--[--><img class="vp-icon" src="https://johnnyreilly.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->johnnyreilly.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/code-maze.com/" aria-label="code-maze.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/code-maze.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->code-maze.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/milanjovanovic.tech/" aria-label="milanjovanovic.tech"><!--[--><img class="vp-icon" src="https://milanjovanovic.tech/profile_favicon.png" alt aria-hidden no-view sizing="both"><!--]-->milanjovanovic.tech<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/shopify.engineering/" aria-label="shopify.engineering"><!--[--><img class="vp-icon" src="https://cdn.shopify.com/static/shopify-favicon.png" alt aria-hidden no-view sizing="both"><!--]-->shopify.engineering<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/devtoolstips.org/" aria-label="devtoolstips.org"><!--[--><img class="vp-icon" src="https://devtoolstips.org/assets/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->devtoolstips.org<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/piccalil.li/" aria-label="piccalil.li"><!--[--><img class="vp-icon" src="https://piccalil.li/favicons/apple-touch-icon.png" alt aria-hidden no-view sizing="both"><!--]-->piccalil.li<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/sitepoint.com/" aria-label="sitepoint.com"><!--[--><img class="vp-icon" src="https://sitepoint.com/favicons/512x512.png" alt aria-hidden no-view sizing="both"><!--]-->sitepoint.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/event-driven.io/" aria-label="event-driven.io"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/event-driven.io/favicon.jfif" alt aria-hidden no-view sizing="both"><!--]-->event-driven.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/packagemain.tech/" aria-label="packagemain.tech"><!--[--><img class="vp-icon" src="https://substack-post-media.s3.amazonaws.com/public/images/2ea54e25-eaa6-4630-bfc0-10b8cfdce894/apple-touch-icon-1024x1024.png" alt aria-hidden no-view sizing="both"><!--]-->packagemain.tech<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/gosolve.io/" aria-label="gosolve.io"><!--[--><img class="vp-icon" src="https://gosolve.io/wp-content/uploads/2022/03/cropped-ikona1-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->gosolve.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/towardsdatascience.com/" aria-label="towardsdatascience.com"><!--[--><img class="vp-icon" src="https://cdn-images-1.medium.com/v2/resize:fill:128:128/1*VzTUkfeGymHP4Bvav-T-lA.png" alt aria-hidden no-view sizing="both"><!--]-->towardsdatascience.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/bookshelf/douggregor.net/" aria-label="douggregor.net"><!--[--><i class="vp-icon fas fa-globe" sizing="both"></i><!--]-->douggregor.net<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/d2.naver.com/" aria-label="d2.naver.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/d2.naver.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->d2.naver.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tech.kakao.com/" aria-label="tech.kakao.com"><!--[--><img class="vp-icon" src="https://www.kakaocorp.com/page/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tech.kakao.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tech.kakaopay.com/" aria-label="tech.kakaopay.com"><!--[--><img class="vp-icon" src="https://tech.kakaopay.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tech.kakaopay.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/fe-developers.kakaoent.com/" aria-label="fe-developers.kakaoent.com"><!--[--><img class="vp-icon" src="https://fe-developers.kakaoent.com/favicon-32x32.png?v=44803cb16c1e2debd3984cf2e8cb2ded" alt aria-hidden no-view sizing="both"><!--]-->fe-developers.kakaoent.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/yozm.wishket.com/" aria-label="yozm.wishket.com"><!--[--><img class="vp-icon" src="https://yozm.wishket.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->yozm.wishket.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/popit.kr/" aria-label="popit.kr"><!--[--><img class="vp-icon" src="https://popit.kr/wp-content/uploads/2016/08/favicon_32x32.png" alt aria-hidden no-view sizing="both"><!--]-->popit.kr<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/devkuma.com/" aria-label="devkuma.com"><!--[--><img class="vp-icon" src="https://devkuma.com/favicons/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->devkuma.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.gangnamunni.com/" aria-label="blog.gangnamunni.com"><!--[--><img class="vp-icon" src="https://blog.gangnamunni.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->blog.gangnamunni.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/codingeverybody.kr/" aria-label="codingeverybody.kr"><!--[--><img class="vp-icon" src="https://codingeverybody.kr/wp-content/uploads/cropped-favicon-origin-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->codingeverybody.kr<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label><!--[--><i class="vp-icon fas fa-network-wired" sizing="height"></i><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tecmint.com/" aria-label="tecmint.com"><!--[--><img class="vp-icon" src="https://tecmint.com/wp-content/uploads/2020/07/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tecmint.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/docker.com/" aria-label="docker.com"><!--[--><img class="vp-icon" src="https://docker.com/app/uploads/2024/02/cropped-docker-logo-favicon-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->docker.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/learnk8s.io/" aria-label="learnk8s.io"><!--[--><img class="vp-icon" src="https://static.learnk8s.io/f7e5160d4744cf05c46161170b5c11c9.svg" alt aria-hidden no-view sizing="both"><!--]-->learnk8s.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/itsfoss.com/" aria-label="itsfoss.com"><!--[--><img class="vp-icon" src="https://itsfoss.com/content/images/size/w256h256/2022/12/android-chrome-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->itsfoss.com<!----></a></li></ul></button></div></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/chanhi2000/articles" target="_blank" rel="noopener noreferrer" aria-label="Github"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-appearance-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-appearance-dropdown"><!----></div></button></div><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><i class="vp-icon fas fa-globe" sizing="both"></i><span class="vp-sidebar-title">douggregor.net</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-1.html" aria-label="Swift for C++ Practitioners, Part 1: Intro &amp; Value Types"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 1: Intro &amp; Value Types<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-2.html" aria-label="Swift for C++ Practitioners, Part 2: Reference Types &amp; Optionals"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 2: Reference Types &amp; Optionals<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-3.html" aria-label="Swift for C++ Practitioners, Part 3: Extensions and Access Control"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 3: Extensions and Access Control<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-4.html" aria-label="Swift for C++ Practitioners, Part 4: Generics"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 4: Generics<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-5.html" aria-label="Swift for C++ Practitioners, Part 5: Type erasure &amp; metatypes"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 5: Type erasure &amp; metatypes<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-6.html" aria-label="Swift for C++ Practitioners, Part 6: Error Handling"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 6: Error Handling<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html" aria-label="Swift for C++ Practitioners, Part 7: Closures"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 7: Closures<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-8.html" aria-label="Swift for C++ Practitioners, Part 8: Global Variables"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 8: Global Variables<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-9.html" aria-label="Swift for C++ Practitioners, Part 9: Extensible Literals"><!--[--><i class="vp-icon fa-brands fa-swift" sizing="both"></i><!--]-->Swift for C++ Practitioners, Part 9: Extensible Literals<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><i class="vp-icon fa-brands fa-swift" sizing="height"></i>Swift for C++ Practitioners, Part 7: Closures</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">24. 4. 28.</span><meta property="datePublished" content="2024-04-28T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 13 min</span><meta property="timeRequired" content="PT13M"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color3" role>Swift</span><span class="page-category-item color6" role>C++</span><span class="page-category-item color8" role>Article(s)</span><!--]--><meta property="articleSection" content="Swift,C++,Article(s)"></span><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color8" role>blog</span><span class="page-tag-item color8" role>douggregor.net</span><span class="page-tag-item color6" role>swift</span><span class="page-tag-item color8" role>ios</span><span class="page-tag-item color8" role>c++</span><span class="page-tag-item color4" role>cpp</span><!--]--><meta property="keywords" content="blog,douggregor.net,swift,ios,c++,cpp"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><h1 id="frontmatter-title-관련" tabindex="-1"><a class="header-anchor" href="#frontmatter-title-관련"><span>Swift for C++ Practitioners, Part 7: Closures 관련</span></a></h1><a class="route-link vp-card" href="/bookshelf/programming/swift/articles/" style="background:rgba(10,10,10,0.2);"><img class="vp-card-logo" src="https://chanhi2000.github.io/images/ico-wind.svg" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">Swift > Article(s)</div><hr><div class="vp-card-desc">Article(s)</div></div></a><a class="route-link vp-card" href="/bookshelf/programming/cpp/articles/" style="background:rgba(10,10,10,0.2);"><img class="vp-card-logo" src="https://chanhi2000.github.io/images/ico-wind.svg" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">C++ > Article(s)</div><hr><div class="vp-card-desc">Article(s)</div></div></a><nav class="table-of-contents"><ul><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html#the-syntax" class="router-link-active router-link-exact-active">The syntax</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html#captures" class="router-link-active router-link-exact-active">Captures</a><ul><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html#implementation-model-for-captures" class="router-link-active router-link-exact-active">Implementation model for captures</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html#optimizations-for-captures" class="router-link-active router-link-exact-active">Optimizations for captures</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html#parameters-of-function-type-are-non-escaping-by-default" class="router-link-active router-link-exact-active">Parameters of function type are non-escaping by default</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html#escaping-function-types" class="router-link-active router-link-exact-active">Escaping function types</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html#getting-around-the-escaping-restrictions" class="router-link-active router-link-exact-active">Getting around the escaping restrictions</a></li></ul></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html#local-functions" class="router-link-active router-link-exact-active">Local functions</a></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html#trailing-closures" class="router-link-active router-link-exact-active">Trailing closures</a><ul><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html#multiple-trailing-closures" class="router-link-active router-link-exact-active">Multiple trailing closures</a></li></ul></li><li><a aria-current="page" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-7.html#wrap-up-what-s-next" class="router-link-active router-link-exact-active">Wrap-up &amp;&amp; what&#39;s next</a></li></ul></nav><hr><a class="vp-card" href="https://www.douggregor.net/posts/swift-for-cxx-practitioners-closures/" target="_blank" style="background:rgba(22,22,22,0.2);"><!----><div class="vp-card-content"><div class="vp-card-title">Swift for C++ Practitioners, Part 7: Closures | Doug's Compiler Corner</div><hr><div class="vp-card-desc">Swift for C++ Practitioners, Part 7: Closures</div></div></a><p>Throughout this series, I&#39;ve been using closures in examples without really defining them. Swift closures are a whole lot like C++ lambdas, with a similar design and syntax, and generally the same use cases. This post is going to dig a little deeper into Swift closures to give a better feel for how they work and how to make the best use of them.</p><hr><h2 id="the-syntax" tabindex="-1"><a class="header-anchor" href="#the-syntax"><span>The syntax</span></a></h2><p>A Swift closure is an expression delimited by curly braces, <code>{ ... }</code> that represents an anonymous function. For example, this</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">let</span> hello <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token string-literal"><span class="token string">&quot;Hello&quot;</span></span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>defines a local variable <code>hello</code> that stores the closure. The type of <code>hello</code> is <code>() -&gt; String</code>, i.e., a function that takes no parameters.</p><p>Swift closures can be provided with parameters in one of two ways: anonymous parameters <code>$0</code>, <code>$1</code>, <code>$2</code>, and so on let you write very short closures for quick one-off operations. For example:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">let</span> arithmeticOp<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Double</span></span>
<span class="line"><span class="token keyword">switch</span> opCode <span class="token punctuation">{</span></span>
<span class="line"><span class="token keyword">case</span> <span class="token string-literal"><span class="token string">&quot;+&quot;</span></span><span class="token punctuation">:</span> arithmeticOp <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token short-argument">$0</span> <span class="token operator">+</span> <span class="token short-argument">$1</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">case</span> <span class="token string-literal"><span class="token string">&quot;-&quot;</span></span><span class="token punctuation">:</span> arithmeticOp <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token short-argument">$0</span> <span class="token operator">-</span> <span class="token short-argument">$1</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">case</span> <span class="token string-literal"><span class="token string">&quot;*&quot;</span></span><span class="token punctuation">:</span> arithmeticOp <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token short-argument">$0</span> <span class="token operator">*</span> <span class="token short-argument">$1</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">case</span> <span class="token string-literal"><span class="token string">&quot;/&quot;</span></span><span class="token punctuation">:</span> arithmeticOp <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token short-argument">$0</span> <span class="token operator">/</span> <span class="token short-argument">$1</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">throw</span> <span class="token class-name">InterpreterError</span><span class="token punctuation">.</span><span class="token function">invalidOpcode</span><span class="token punctuation">(</span>opCode<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><em>Please</em> only use this shorthand for the smallest closures. Once you get behind a single short expression, it&#39;s much better to name your parameters. To do so, list them prior to <code>in</code> within the curly braces. The <code>in</code> separates the declaration part of the closure from its statements. For example, the first case above could instead by written like this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token punctuation">{</span> x<span class="token punctuation">,</span> y <span class="token keyword">in</span> x <span class="token operator">+</span> y <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>In fact, prior to the <code>in</code>, you can write a full-fledged parameter list with type annotations, result type, and effect specifiers, if you don&#39;t want to leave them up to inference:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token punctuation">{</span> <span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token class-name">Double</span><span class="token punctuation">,</span> y<span class="token punctuation">:</span> <span class="token class-name">Double</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-&gt;</span> <span class="token class-name">Double</span> <span class="token keyword">in</span> </span>
<span class="line">     <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token keyword">try</span> <span class="token function">addSafely</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token punctuation">}</span></span>
<span class="line">     <span class="token keyword">return</span> result</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>It&#39;s fairly uncommon to see such closures with all of the types written out like this, because the parameter types are generally inferred by context and the result type can be inferred from the closure body. Indeed, if you end up finding yourself writing a long closure that needs the full type annotations, it&#39;s likely that you should write a local function. I&#39;ll come back to local functions later. For now, I want to talk about captures.</p><hr><h2 id="captures" tabindex="-1"><a class="header-anchor" href="#captures"><span>Captures</span></a></h2><p>A <em>capture</em> is when a closure refers to a local variable (or parameter) from its enclosing scope. In such cases, the closure needs to a way to reference that variable---or it&#39;s value---when it executes. A simple example would be a closure that inserts elements into a set to remove duplicates from a collection, returning a new array with the elements uniqued:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">uniquing</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Collection</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>from collection<span class="token punctuation">:</span> <span class="token class-name">C</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token class-name">C</span><span class="token punctuation">.</span><span class="token class-name">Element</span><span class="token punctuation">]</span> <span class="token keyword">where</span> <span class="token class-name">C</span><span class="token punctuation">.</span><span class="token class-name">Element</span><span class="token punctuation">:</span> <span class="token class-name">Hashable</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> known<span class="token punctuation">:</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">.</span><span class="token class-name">Element</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">  <span class="token keyword">return</span> collection<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">{</span></span>
<span class="line">    known<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token short-argument">$0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inserted</span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The closure passed to <code>filter</code> captures the local variable <code>known</code>. Each time it is called, it tries inserting the element it was given into the known set. If successful (i.e., the element wasn&#39;t there), the <code>inserted</code> field in the result is <code>true</code>, so the element is kept in the filtered sequence. If the element wasn&#39;t there, the <code>inserted</code> field in the result is <code>false</code>, so it&#39;s dropped.</p><p>Swift&#39;s captures default to by-reference. If you want a by-value capture rather than a by-reference capture, you can provide a capture list using the familiar square bracket syntax from C++ lambdas. However, in Swift the capture list goes <em>within</em> the curly braces and before the (optional) parameter list. The <code>filter</code> call could capture <code>known</code> by-value like this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">return</span> collection<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token punctuation">[</span>known<span class="token punctuation">]</span> <span class="token keyword">in</span></span>
<span class="line">  known<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token short-argument">$0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>inserted        <span class="token comment">// error: known is immutable</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>However, note the error: by-value captures are immutable, so the above code would actually fail with an error <code>cannot assign to value: &#39;count&#39; is an immutable capture</code>.</p><p>Also similar to C++ captures, a Swift capture list can define a new captured values at the point the closures is created. For example, here we create a bunch of closures that produce string values of the index in the loop where they were created:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> closures<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token number">0</span><span class="token operator">..&lt;</span><span class="token number">100</span> <span class="token punctuation">{</span></span>
<span class="line">  closures<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token punctuation">[</span>string <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">in</span> string <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>I wouldn&#39;t expect most of the above to be surprising to a C++ practitioner, because it&#39;s mostly the same as lambdas. But the &quot;captures are by reference&quot; statement might be a little nerve-wracking, because what happens if you return a closure that captures by reference?</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token comment">// Produce a function that adds `x` to whatever integer value it is given.</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function-definition function">adding</span><span class="token punctuation">(</span>x<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span> x <span class="token operator">+</span> <span class="token short-argument">$0</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Bad news, right? Not in Swift... let&#39;s look into the implementation model a bit.</p><h3 id="implementation-model-for-captures" tabindex="-1"><a class="header-anchor" href="#implementation-model-for-captures"><span>Implementation model for captures</span></a></h3><p>The implementation of C++ lambdas is fairly straightforward: for each lambda, the compiler synthesizes a class. The code of the lambda goes into its <code>operator()</code>, and for each capture the compiler will create a non-static data member. For example, let&#39;s consider this C++ lambda expression:</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line">std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> values<span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">int</span> target<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">auto</span> fn <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;&amp;</span>values<span class="token punctuation">,</span>target<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The corresponding synthesized class will look something like this:</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token keyword">class</span> <span class="token class-name">Synthesized</span> <span class="token punctuation">{</span></span>
<span class="line">  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">&amp;&amp;</span>values<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">int</span> target<span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line"><span class="token keyword">public</span><span class="token operator">:</span></span>
<span class="line">  <span class="token function">Synthesized</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">&amp;&amp;</span>values<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">values</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">target</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span></span>
<span class="line">    values<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> target<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>By-reference captures produce a non-static member of reference type, while by-value captures are of non-reference type (so you get a copy).</p><p>Swift&#39;s translation of closures is conceptually similar, but the main difference is in the handling of by-reference captures. Semantically, a by-reference capture in Swift promotes the captured local to the heap, and uses a reference type to box it up. For example, imagine we have this <code>Box</code> type:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">class</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> value<span class="token punctuation">:</span> <span class="token class-name">T</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">init</span><span class="token punctuation">(</span>value<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">self</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>When a local variable like</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> numbers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Int</span><span class="token punctuation">]</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>is captured by-reference in a closure, it is <em>as if</em> the local variable were rewritten to</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> numbers<span class="token punctuation">:</span> <span class="token class-name">Box</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token class-name">Int</span><span class="token punctuation">]</span><span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>and every initialization of <code>numbers</code> creates a box instance, and every subsequent access to <code>numbers</code>, whether it&#39;s in the function or a closure that captures it by reference, is rewritten to <code>numbers.value</code>.</p><p>This model makes it safe to return a closure from a function, even when that closure captures a local in the function by reference:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">numberAccessor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> numbers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">...</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token punctuation">{</span> x <span class="token keyword">in</span> numbers<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Since <code>numbers</code> is promoted to a <code>Box&lt;[Int]&gt;</code>, the returned closure itself keeps the &quot;local&quot; variable alive on the heap until the closure is no longer used. It&#39;s a simple model, and a safe one.</p><p>But if you actually did this for every local variable captured everywhere, it would be a very, very slow model. Let&#39;s talk about optimizations.</p><h3 id="optimizations-for-captures" tabindex="-1"><a class="header-anchor" href="#optimizations-for-captures"><span>Optimizations for captures</span></a></h3><p>There are two main optimizations for by-reference captures in Swift. The first is to realize when the capture doesn&#39;t need to be by-reference at all: if we&#39;re capturing a <code>let</code>, its value can&#39;t change anyway, so we can capture by value to avoid the boxing overhead without changing the semantics. There are more complicated analyses one can do when capturing a <code>var</code>: if the <code>var</code> isn&#39;t modified after the point of capture (either in the closure or outside of it), then we can capture by value because the value isn&#39;t going to change.</p><p>The second optimization is when you can be sure that the closure itself won&#39;t live longer than the variables it is capturing. In these cases, it is safe to do a by-reference capture of the stack variable, without moving it to the heap. As C++ programmers, we make this kind of decision all the time based on knowledge of the functions we are calling: it&#39;s perfectly reasonable to use by-reference captures when passing a lambda into <code>std::transform</code>, because the algorithm isn&#39;t going to escape the closure.</p><p>The problem in C++, of course, is that we could be wrong: if the lambda does use by-reference captures and escapes, we have a stack use-after-free. If the lambda uses expensive by-copy captures and it never escapes, we&#39;ve wasted some processor cycles and some memory.</p><p>Shouldn&#39;t the optimizer just figure out for us? Ideally, when the closure doesn&#39;t escape, we&#39;d use by-reference captures that refer to the local variable on the stack, with no overhead. And when the closure does escape, we&#39;d promote the captured local variables to the heap to maintain memory safety. Easy, right?</p><p>The problem is that you can&#39;t always see the code you&#39;re calling to determine whether it stashes a copy of the closure somewhere. If I call some C++ function:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line">void <span class="token function">doSomething</span><span class="token punctuation">(</span>std<span class="token punctuation">:</span><span class="token punctuation">:</span>function<span class="token operator">&lt;</span><span class="token function">int</span><span class="token punctuation">(</span>int<span class="token punctuation">)</span><span class="token operator">&gt;</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>with a lambda, I have <em>no idea</em> what it is going to do with <code>f</code>. Even if it&#39;s a C++ template like this:</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">F</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">doSomething</span><span class="token punctuation">(</span>F f<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>the code might be hidden behind an explicit instantiation, or do something tricky with <code>f</code> that obscures the fact that it&#39;s storing a copy of it to execute later. So either the optimizer has to go through heroics to prove that <code>doSomething</code> doesn&#39;t stash a copy of <code>f</code> somewhere on the side, or it has to conservatively assume that the lambda could escape. The end result is that escape analysis like the one we would need to have both safe and efficient by-reference closures isn&#39;t actually very effective in C++.</p><p>To address this issue in Swift, we decided to change the language to make this optimization more reliable. The idea is simple:</p><h3 id="parameters-of-function-type-are-non-escaping-by-default" tabindex="-1"><a class="header-anchor" href="#parameters-of-function-type-are-non-escaping-by-default"><span>Parameters of function type are non-escaping by default</span></a></h3><p>In Swift, a parameter of function type is (by default) not allowed to escape the function&#39;s stack frame. Let&#39;s see an example:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">struct</span> <span class="token class-name">S</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> fn<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">mutating</span> <span class="token keyword">func</span> <span class="token function-definition function">doSomething</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    fn <span class="token operator">=</span> f  <span class="token comment">// error: assigning non-escaping parameter &#39;f&#39; to an @escaping closure</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The function <code>doSomething</code> is trying to escape the value of <code>f</code> out of its stack frame by writing into the instance property <code>fn</code>. The compiler prevents such escapes systematically, and only allows the code to use <code>f</code> in a manner that either calls it (which is fine) or passes it down the stack to other functions that won&#39;t escape it.</p><p>Because the non-escaping behavior is part of the interface contract, the optimizer can safely assume that a closure passed to <code>doSomething</code> won&#39;t outlive its own stack frame. So this kind of code:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> numbers<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token class-name">Int</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">...</span></span>
<span class="line">s<span class="token punctuation">.</span>doSomething <span class="token punctuation">{</span> </span>
<span class="line">  <span class="token keyword">if</span> <span class="token keyword">let</span> value <span class="token operator">=</span> numbers<span class="token punctuation">.</span>last <span class="token punctuation">{</span></span>
<span class="line">    numbers<span class="token punctuation">.</span><span class="token function">removeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> value</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"> </span>
<span class="line">  <span class="token keyword">return</span> <span class="token number">0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>we get by-reference captures without the overhead of promoting the local variables to the heap. By making non-escaping the default, we get better performance for the common cases that use closures for (e.g.) algorithms and callbacks while maintaining the safe model.</p><h3 id="escaping-function-types" tabindex="-1"><a class="header-anchor" href="#escaping-function-types"><span>Escaping function types</span></a></h3><p>You might have noticed that my struct <code>S</code> had an instance property of function type:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">struct</span> <span class="token class-name">S</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> fn<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Outside of function parameters, values of function type are assumed to be escaping. If I were to assign directly into <code>S.fn</code>, the closure provided would be assumed to be escaping, so it would promote mutable captures to the heap:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line">s<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token punctuation">{</span>      <span class="token comment">// promotes numbers to the heap</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token keyword">let</span> value <span class="token operator">=</span> numbers<span class="token punctuation">.</span>last <span class="token punctuation">{</span></span>
<span class="line">    numbers<span class="token punctuation">.</span><span class="token function">removeLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> value</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"> </span>
<span class="line">  <span class="token keyword">return</span> <span class="token number">0</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>A function parameter can be explicitly marked with <code>@escaping</code> to allow its value to escape the function&#39;s stack frame. This is part of the type of the function, so callers know that they need to promote captures to the heap. For our <code>doSomething</code> function, it would look like this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">struct</span> <span class="token class-name">S</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> fn<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">mutating</span> <span class="token keyword">func</span> <span class="token function-definition function">doSomething</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token attribute atrule">@escaping</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    fn <span class="token operator">=</span> f  <span class="token comment">// ok, f is marked @escaping</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="getting-around-the-escaping-restrictions" tabindex="-1"><a class="header-anchor" href="#getting-around-the-escaping-restrictions"><span>Getting around the escaping restrictions</span></a></h3><p>The restriction on non-escaping functions can feel pretty harsh some times: you can&#39;t, for example, put the non-escaping value into another local variable or inside a local struct, because the Swift compiler will flag it as a local escape. For example, even this is disallowed:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">haveFun</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token class-name">S</span><span class="token punctuation">(</span>fn<span class="token punctuation">:</span> f<span class="token punctuation">)</span>  <span class="token comment">// error: passing non-escaping parameter &#39;f&#39; to function expecting an @escaping closure</span></span>
<span class="line">  <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Swift does have a mechanism to deal with such cases, using the standard library function <a href="https://developer.apple.com/documentation/swift/withoutactuallyescaping(_:do:)" target="_blank" rel="noopener noreferrer"><i class="vp-icon fa-brands fa-apple" sizing="height"></i><code>withoutActuallyEscaping</code></a>: the basic idea is that <code>withoutActuallyEscaping</code> lets you temporarily convert a non-escaping closure into an escaping one. The escaping one is passed into a second closure that is immediately evaluated and its result returned. So <code>haveFun</code> can be implemented as follows:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">haveFun</span><span class="token punctuation">(</span>f<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">withoutActuallyEscaping</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> body<span class="token punctuation">:</span> <span class="token punctuation">{</span> escapingF <span class="token keyword">in</span> </span>
<span class="line">    <span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token class-name">S</span><span class="token punctuation">(</span>fn<span class="token punctuation">:</span> escapingF<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> s<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The first parameter to <code>withoutActuallyEscaping</code> is the non-escaping function <code>f</code>. The second parameter, <code>body</code>, is a closure that takes the escaping form of <code>f</code> and is executed immediately.</p><p>I know what you&#39;re thinking: after all that talk about safety with non-escaping parameters, how can there possibly be a standard library function that just throws all of it away? Madness!</p><p>What <code>withoutActuallyEscaping</code> is actually doing is deferring the correctness check for a non-escaping closure into a runtime check. If you try any funny business that actually escapes <code>escapingF</code> out of the <code>body</code> closure, the program will trap at runtime:</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="log"><span>log</span></div><div class="language-plaintext line-numbers-mode" data-highlighter="prismjs" data-ext="plaintext"><pre><code class="language-plaintext"><span class="line">0    escape                             0x000000010423750c haveFun(f:) + 144</span>
<span class="line">1    escape                             0x00000001042374dc main + 24</span>
<span class="line">2    dyld                               0x0000000187fa87a8 start + 2360</span>
<span class="line">closure argument was escaped in withoutActuallyEscaping block: file escape.swift, line 9, column 3 </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>I triggered this by writing <code>escapingF</code> into a global. The implementation of <code>withoutActuallyEscaping</code> is actually pretty neat: since escaping closures are reference counted (like other reference types in Swift), <code>withoutActuallyEscaping</code> records the reference count of the function <code>escapingF</code> when it&#39;s passed into the body closure. Then, it checks whether the reference count is the same on the way out of the body closure---if it is, all is well. If the reference count on the way out is <em>different</em>, it means that <code>escapingF</code> has escaped out of <code>body</code>, and we need to halt lest we cause undefined behavior.</p><p>You probably won&#39;t need <code>withoutActuallyEscaping</code> often, but when you need it, you <em>really</em> need it. It also illustrates an important principle: static safety is great, but sometimes you need to step outside of the bounds of what a compiler can statically prove is safe. When that happens, Swift takes the view that it&#39;s better to roll into dynamic checking to maintain the safety model rather than ban the code entirely or throw away safety. We saw this in our discussions of the law of exclusivity in part 1 of this series, and it comes up again as part of Swift&#39;s concurrency model.</p><hr><h2 id="local-functions" tabindex="-1"><a class="header-anchor" href="#local-functions"><span>Local functions</span></a></h2><p>C++ function definitions can only be defined in class or namespace scope, and there is no notion of a &quot;local&quot; function that&#39;s defined within another function. The introduction of lambdas into C++ gave us an approximation of the feature. For example, here&#39;s a rough C++ equivalent to the <code>uniquing</code> function in Swift from earlier:</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">R</span><span class="token operator">&gt;</span></span>
<span class="line">std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>iter_value_t<span class="token operator">&lt;</span>iterator_t<span class="token operator">&lt;</span>R<span class="token operator">&gt;</span> <span class="token function">uniquing</span><span class="token punctuation">(</span>R <span class="token operator">&amp;&amp;</span><span class="token operator">&amp;&amp;</span>range<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">using</span> value_type <span class="token operator">=</span> iter_value_t<span class="token operator">&lt;</span>iterator_t<span class="token operator">&lt;</span>R<span class="token operator">&gt;</span><span class="token punctuation">;</span></span>
<span class="line">  std<span class="token double-colon punctuation">::</span>unordered_set<span class="token operator">&lt;</span>value_type<span class="token operator">&gt;</span> known<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">// Local function to insert an item into &quot;known&quot; and report whether it was added.</span></span>
<span class="line">  <span class="token keyword">auto</span> tryInsertKnown <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> value_type <span class="token operator">&amp;&amp;</span>item<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> known<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span>second<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// Copy the items from the range that match the tryInsertKnown predicate.</span></span>
<span class="line">  std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>value_type<span class="token operator">&gt;</span> result<span class="token punctuation">;</span></span>
<span class="line">  std<span class="token double-colon punctuation">::</span>ranges<span class="token double-colon punctuation">::</span><span class="token function">copy_if_result</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> tryInsertKnown<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">back_inserter</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> result<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The lambda we create and store in <code>tryInsertKnown</code> is effectively a local function: it&#39;s a function defined within another function, and captures some state from that outer function. It&#39;s a useful tool for breaking out local reusable parts of your function while still sharing state.</p><p>But doing this in C++ has some warts and limitations. First of all, it may act like a function, but it doesn&#39;t <em>look</em> like a function until you learn to squint at the pattern the right way, and not all IDEs know to treat it like a function for (e.g.) code completion. Second, because writing the type of a lambda explicitly isn&#39;t possible, we have to use <code>auto</code>, and that prevents us from directly writing a recursive local function in this style:</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token keyword">auto</span> localFib <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> i<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">localFib</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">localFib</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// error: variable &#39;localFib&#39; declared with deduced type &#39;auto&#39; cannot appear in its own initializer</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now, we can get around this by using <a href="https://en.cppreference.com/w/cpp/utility/functional/function" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-cpp" sizing="height"></i><code>std::function</code></a>:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line">std<span class="token punctuation">:</span><span class="token punctuation">:</span>function<span class="token operator">&lt;</span><span class="token function">int</span><span class="token punctuation">(</span>int<span class="token punctuation">)</span><span class="token operator">&gt;</span> localFib<span class="token punctuation">;</span></span>
<span class="line">localFib <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>int i<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> i<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">localFib</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">localFib</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// okay!</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This works because we&#39;ve separated out the declaration of <code>localFib</code> and given it a type, so it can be captured in the lambda that&#39;s eventually assigned into it. It&#39;s uglier, but it works. And it&#39;s most likely going to cause a heap allocation in <code>std::function</code> unless your C++ library implements the <a href="https://devblogs.microsoft.com/oldnewthing/20200514-00/?p=103749" target="_blank" rel="noopener noreferrer"><i class="vp-icon fa-brands fa-microsoft" sizing="height"></i>small object optimization for <code>std::function</code></a> and your lambda fits into it.</p><p>In Swift, local functions are just like functions at module scope. Here&#39;s a more explicit Swift <code>uniquing</code> that uses the local function:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">func</span> <span class="token function-definition function">uniquing</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Collection</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> collection<span class="token punctuation">:</span> <span class="token class-name">C</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token class-name">C</span><span class="token punctuation">.</span><span class="token class-name">Element</span><span class="token punctuation">]</span> <span class="token keyword">where</span> <span class="token class-name">C</span><span class="token punctuation">.</span><span class="token class-name">Element</span><span class="token punctuation">:</span> <span class="token class-name">Hashable</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> known<span class="token punctuation">:</span> <span class="token class-name">Set</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">.</span><span class="token class-name">Element</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">func</span> <span class="token function-definition function">tryInsertKnown</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> item<span class="token punctuation">:</span> <span class="token class-name">C</span><span class="token punctuation">.</span><span class="token class-name">Element</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span> <span class="token punctuation">{</span></span>
<span class="line">    known<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">.</span>inserted</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">return</span> collection<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>tryInsertKnown<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Like closures, local functions can capture local variables (such as <code>x</code> in the example above). Like global functions, local functions have a name with argument labels of your choosing, can be generic, and can be recursive. In other words---they&#39;re just like functions, and you don&#39;t need to think about them differently.</p><p>In an earlier revision of this post, I actually skipped this section on local functions, because they &quot;just work&quot; as they obviously should. Reader Pierre Lebeaupin pointed out that I need to explain them, because if you&#39;re coming from C++, you wouldn&#39;t expect them to work and therefore miss this feature entirely. Worse, you might be inclined to try to replicate the C++ pattern in Swift. If you try, it&#39;s going to be <em>hideous</em>:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">var</span> localFibRec<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Int</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Int</span><span class="token punctuation">)</span><span class="token operator">!</span> <span class="token operator">=</span> <span class="token nil constant">nil</span></span>
<span class="line">localFibRec <span class="token operator">=</span> <span class="token punctuation">{</span> i <span class="token keyword">in</span> </span>
<span class="line">  <span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> i <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> localFibRec<span class="token operator">!</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> localFibRec<span class="token operator">!</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">let</span> localFib <span class="token operator">=</span> localFibRec</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>The optional and extra level of indirection is there because of definite initialization: a variable needs to have a value before it is captured, so <code>localFibRec</code> needs to have a value (in this case, <code>nil</code>), because it can be captured in the closure that eventually gives <code>localFibRec</code> its value. When the language is fighting you that hard, find another way.</p><p>Enough local functions, now let&#39;s move along to a feature that Swift borrowed from... Ruby!</p><hr><h2 id="trailing-closures" tabindex="-1"><a class="header-anchor" href="#trailing-closures"><span>Trailing closures</span></a></h2><p>When passing C++ lambdas into C++ standard library algorithms, we often end up with this ugly like <code>})</code> thing at the end of every call:</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line">std<span class="token double-colon punctuation">::</span><span class="token function">copy_if</span><span class="token punctuation">(</span>numbers<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> numbers<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">back_inserter</span><span class="token punctuation">(</span>even_numbers<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> x <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span></span>
<span class="line"><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>I know, it&#39;s just syntax. It shouldn&#39;t be a big deal. But these standard algorithms are supposed to feel like extensions of the language. It turns out that Ruby has a nice approach here, which allows a closure to be juxtaposed with a function name or call to be passed like a normal parameter. The <code>std::copy_if</code> above, in Swift, would be a <a href="https://developer.apple.com/documentation/swift/string/filter(_:)" target="_blank" rel="noopener noreferrer"><i class="vp-icon fa-brands fa-apple" sizing="height"></i><code>filter</code></a> operation that looks more like this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line">numbers<span class="token punctuation">.</span>filter <span class="token punctuation">{</span> <span class="token short-argument">$0</span> <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>The actual <code>filter</code> function is a collection algorithm declared like this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">extension</span> <span class="token class-name">Collection</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">func</span> <span class="token function-definition function">filter</span><span class="token punctuation">(</span><span class="token omit keyword">_</span> isIncluded<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token class-name">Element</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You can call <code>filter</code> by passing a function in parentheses, e.g., <code>numbers.filter(isPrime)</code>, or use trailing closure syntax as we did above. When designing Swift APIs involving closures, you generally want to put the closure parameter at the end to allow trailing closure syntax. For example, perhaps we want a version of <code>filter</code> that puts an upper limit on the number of elements that will be removed. We could design it like this:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token keyword">extension</span> <span class="token class-name">Collection</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">func</span> <span class="token function-definition function">filtering</span><span class="token punctuation">(</span>removingAtMost maxRemovals<span class="token punctuation">:</span> <span class="token class-name">Int</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token nil constant">nil</span><span class="token punctuation">,</span> isIncluded<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Bool</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">[</span><span class="token class-name">Element</span><span class="token punctuation">]</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>This <code>filtering</code> function can be called with or without <code>removingAtMost</code>, while still using trailing closure syntax:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line">numbers<span class="token punctuation">.</span><span class="token function">filtering</span><span class="token punctuation">(</span>removingAtMost<span class="token punctuation">:</span> <span class="token number">17</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span> <span class="token comment">// A</span></span>
<span class="line">numbers<span class="token punctuation">.</span>filtering <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>                     <span class="token comment">// B, maxRemovals defaults to nil</span></span>
<span class="line"></span>
<span class="line">numbers<span class="token punctuation">.</span><span class="token function">filtering</span><span class="token punctuation">(</span>removingAtMost<span class="token punctuation">:</span> <span class="token number">17</span><span class="token punctuation">,</span> isIncluded<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">// same as A</span></span>
<span class="line">numbers<span class="token punctuation">.</span><span class="token function">filtering</span><span class="token punctuation">(</span>isIncluded<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>                     <span class="token comment">// same as B, maxRemovals defaults to nil</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>You may have noticed that the trailing closure is unlabeled: the responsibiity is on the author of the function to ensure that the name of the function strongly implies what the trailing closure does, so that code using the function reads clearly. After all, <em>clarity at the point of use</em> is one of the central tenets of Swift&#39;s <a href="https://swift.org/documentation/api-design-guidelines/" target="_blank" rel="noopener noreferrer"><i class="vp-icon fa-brands fa-swift" sizing="height"></i>API design guidelines</a>.</p><h3 id="multiple-trailing-closures" tabindex="-1"><a class="header-anchor" href="#multiple-trailing-closures"><span>Multiple trailing closures</span></a></h3><p>When a function takes multiple closure parameters, it&#39;s possible to call it with multiple trailing closures. This can help make code clearer when there are multiple actions that could be taken. For example, imagine an API that executes an operation with a timeout, cancelling it early if time expires:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token comment">/// Run the given &#39;operation&#39;. If it takes more than &#39;seconds&#39;, call the `onTimeout` function to</span></span>
<span class="line"><span class="token comment">/// abort the operation and throw a `TimeoutError` instance.</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function-definition function">run</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>timeout seconds<span class="token punctuation">:</span> <span class="token class-name">Double</span><span class="token punctuation">,</span> operation<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">R</span><span class="token punctuation">,</span> onTimeout<span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Void</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token operator">-&gt;</span> <span class="token class-name">R</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>A call to this function could make use of multiple trailing closures:</p><div class="language-swift line-numbers-mode" data-highlighter="prismjs" data-ext="swift"><pre><code class="language-swift"><span class="line"><span class="token function">run</span><span class="token punctuation">(</span>timeout<span class="token punctuation">:</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">while</span> <span class="token operator">!</span>aborted <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// part of a long-running operation</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span> onTimeout<span class="token punctuation">:</span> <span class="token punctuation">{</span></span>
<span class="line">  aborted <span class="token operator">=</span> <span class="token boolean">true</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Beyond the first trailing closure, the remaining trailing closures must have labels matching the corresponding parameter&#39;s label. Again, this needs to be reflected in API design: the primary &quot;control flow&quot; operation should be the first closure, and remaining closures should have labels that clearly express how and when the closure will be run.</p><hr><h2 id="wrap-up-what-s-next" tabindex="-1"><a class="header-anchor" href="#wrap-up-what-s-next"><span>Wrap-up &amp;&amp; what&#39;s next</span></a></h2><p>For the most part, you can think of Swift closures like C++ lambdas. Similar use cases, similar syntax. Swift provides a safe model of captures that means you don&#39;t generally have to fret over returning a closure or how captures occur, although you will need to mark some parameters <code>@escaping</code> for those times when you want to save a closure to be called later.</p><p>Trailing closure syntax is a little nicety in Swift that makes closure-based APIs cleaner to use. Yes, it&#39;s <em>basically</em> nothing more than removing the unsightly <code>})</code> from a bunch of calls, but it&#39;s part of a larger design goal of enabling the design of powerful libraries that feel like extensions of the language. In fact, that&#39;s going to be our next topic: the features Swift provides for language extensibility and domain-specific embedded languages.</p></div><!----><!----><!----></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/chanhi2000/articles/edit/main/src/douggregor.net/swift-for-cpp-practitioners-7.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/bookshelf/programming/swift/articles/" aria-label="/programming/swift/articles/"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->/programming/swift/articles/</div></a><a class="route-link auto-link next" href="/bookshelf/douggregor.net/swift-for-cpp-practitioners-8.html" aria-label="Swift for C++ Practitioners, Part 8: Global Variables"><div class="hint">Next<span class="arrow end"></span></div><div class="link">Swift for C++ Practitioners, Part 8: Global Variables<i class="vp-icon fa-brands fa-swift" sizing="height"></i></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">MIT Licensed | Copyright © 2022-present <a href="https://github.com/chanhi2000">Chan Hee Lee</a></div><!----></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/bookshelf/assets/app-BVguHYKu.js" defer></script>
  </body>
</html>
