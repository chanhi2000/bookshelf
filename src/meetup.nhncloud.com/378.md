---
lang: ko-KR
title: ë””ìŠ¤ì–´ì…ˆë¸” í”„ë ˆì„ì›Œí¬ Capstone-engine í™œìš©í•˜ê¸°
description: Article(s) > ë””ìŠ¤ì–´ì…ˆë¸” í”„ë ˆì„ì›Œí¬ Capstone-engine í™œìš©í•˜ê¸°
icon: fa-brands fa-python
category: 
  - Python
  - C++
  - Article(s)
tag: 
  - blog
  - meetup.nhncloud.com
  - python
  - py
  - cpp
  - c++
head:
  - - meta:
    - property: og:title
      content: Article(s) > ë””ìŠ¤ì–´ì…ˆë¸” í”„ë ˆì„ì›Œí¬ Capstone-engine í™œìš©í•˜ê¸°
    - property: og:description
      content: ë””ìŠ¤ì–´ì…ˆë¸” í”„ë ˆì„ì›Œí¬ Capstone-engine í™œìš©í•˜ê¸°
    - property: og:url
      content: https://chanhi2000.github.io/bookshelf/meetup.nhncloud.com/378.html
prev: /programming/py/articles/README.md
date: 2024-03-18
isOriginal: false
cover: /assets/image/meetup.nhncloud.com/378/banner.png
---

# {{ $frontmatter.title }} ê´€ë ¨

```component VPCard
{
  "title": "Python > Article(s)",
  "desc": "Article(s)",
  "link": "/programming/py/articles/README.md",
  "logo": "https://chanhi2000.github.io/images/ico-wind.svg",
  "background": "rgba(10,10,10,0.2)"
}
```

```component VPCard
{
  "title": "C++ > Article(s)",
  "desc": "Article(s)",
  "link": "/programming/cpp/articles/README.md",
  "logo": "https://chanhi2000.github.io/images/ico-wind.svg",
  "background": "rgba(10,10,10,0.2)"
}
```

[[toc]]

---

<SiteInfo
  name="ë””ìŠ¤ì–´ì…ˆë¸” í”„ë ˆì„ì›Œí¬ Capstone-engine í™œìš©í•˜ê¸° | NHN Cloud Meetup"
  desc="ë””ìŠ¤ì–´ì…ˆë¸” í”„ë ˆì„ì›Œí¬ Capstone-engine í™œìš©í•˜ê¸°"
  url="https://meetup.nhncloud.com/posts/378"
  logo="https://meetup.nhncloud.com/resources/img/favicon.ico"
  preview="/assets/image/meetup.nhncloud.com/378/banner.png"/>

![NHN Cloud_meetup 2024.03](/assets/image/meetup.nhncloud.com/378/banner.png)

## ë“¤ì–´ê°€ë©°

ì´ ê¸€ì—ì„œëŠ” ë””ìŠ¤ì–´ì…ˆë¸” í”„ë ˆì„ì›Œí¬ì¸ Capstone-engineì„ í™œìš©í•˜ëŠ” ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë³´ê³ ì í•©ë‹ˆë‹¤.

í™ˆí˜ì´ì§€ ì†Œê°œê¸€([<FontIcon icon="fas fa-globe"/>https://www.capstone-engine.org/](https://www.capstone-engine.org/))ì— ì˜í•˜ë©´ Capstoneì€ Capstone-engineì„ ë°”ì´ë„ˆë¦¬ ë¶„ì„ê³¼ ë¦¬ë²„ì‹±ì— ìˆì–´ **the ultimate disassembly engine**ìœ¼ë¡œ ë§Œë“œëŠ” ê²Œ ëª©í‘œë¼ê³  í•©ë‹ˆë‹¤. ì—¬ê¸°ì—ì„œëŠ” Python APIë¥¼ ì´ìš©í•´ ë””ìŠ¤ì–´ì…ˆë¸” ë„êµ¬ë¥¼ ë§Œë“¤ì–´ ë³´ê³ , ì• í”Œë¦¬ì¼€ì´ì…˜ ëŸ°íƒ€ì„ ì‹œ ì´ë¥¼ ë””ìŠ¤ì–´ì…ˆë¸”í•˜ëŠ” ë° C APIë¥¼ ì´ìš©í•´ ë³´ê² ìŠµë‹ˆë‹¤.

---

## Python API ì‚¬ìš©ë²•

Capstone ì˜ Python APIë¥¼ ì´ìš©í•˜ë©´ ë‚˜ë§Œì˜ íŒŒì´ì¬ ë””ìŠ¤ì–´ì…ˆë¸” ë„êµ¬ë¥¼ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Capstone ì„¤ì¹˜(macOS)

```sh
pip install capstone # (for intel macOS)
pip install --pre --no-binary capstone capstone # (for m1, m2 macOS)
```

Windows ë“± ë‹¤ë¥¸ í”Œë«í¼ì˜ ê²½ìš° [<FontIcon icon="fas fa-globe"/>https://www.capstone-engine.org/documentation.html](https://www.capstone-engine.org/documentation.html)ì„ ì°¸ê³ í•˜ì—¬ ì„¤ì¹˜í•˜ë©´ ë˜ê² ìŠµë‹ˆë‹¤.

### ê¸°ë³¸ ì‚¬ìš©ë²•

ê¸°ë³¸ì ì¸ ì‚¬ìš©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

ë””ìŠ¤ì–´ì…ˆë¸”í•˜ê³ ì í•˜ëŠ” í—¥ìŠ¤ ì½”ë“œë¥¼ ì ì–´ ì£¼ê³ , ì•„í‚¤í…ì²˜ ë° ëª¨ë“œë¥¼ ì •í•œ ë’¤ `disasm_lite()` ë©”ì„œë“œë¡œ ë””ìŠ¤ì–´ì…ˆë¸”í•´ ì£¼ë©´ ë©ë‹ˆë‹¤.

![](https://image.toast.com/aaaadh/real/2024/techblog/capstoneengine01.png)

---

## ëŸ°íƒ€ì„ ì‚¬ìš©ë²•

ì• í”Œë¦¬ì¼€ì´ì…˜ ëŸ°íƒ€ì„ ì‹œì— ë””ìŠ¤ì–´ì…ˆë¸”ì´ í•„ìš”í•œ ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤. ì´ë•Œ Capstone C APIë¥¼ ì´ìš©í•˜ì—¬ í”„ë¡œê·¸ë˜ë°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì—¬ê¸°ì—ì„œëŠ” Android ì•± ëŸ°íƒ€ì„ ì‹œì— Capstoneì„ ì´ìš©í•´ ë””ìŠ¤ì–´ì…ˆë¸”í•´ ë³´ê³ ì í•©ë‹ˆë‹¤.

C í”„ë¡œê·¸ë˜ë° ì˜ˆì‹œ ì½”ë“œëŠ” [<FontIcon icon="fas fa-globe"/>https://www.capstone-engine.org/lang_c.html](https://www.capstone-engine.org/lang_c.html)ì— ë‚˜ì™€ ìˆëŠ”ë°ìš”. ëª¨ë°”ì¼ì—ì„œ ì–´ë–»ê²Œ ì‚¬ìš©í•˜ëŠ”ì§€ëŠ” ìƒì„¸íˆ ë‚˜ì™€ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤í–‰íˆ [<FontIcon icon="iconfont icon-github"/>`frida/frida-gum`](https://github.com/frida/frida-gum)ì—ì„œ Capstone APIë¥¼ ì œê³µí•´ ì£¼ê³  ìˆìŠµë‹ˆë‹¤.

arm64ìš© frida-gum static libraryëŠ” [<FontIcon icon="fas fa-globe"/>https://github.com/frida/frida/releases/download/16.1.11/frida-gum-devkit-16.1.11-android-arm64.tar.xz](https://github.com/frida/frida/releases/download/16.1.11/frida-gum-devkit-16.1.11-android-arm64.tar.xz)ì—ì„œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### ê¸°ë³¸ ì‚¬ìš©ë²•

Android ë„¤ì´í‹°ë¸Œ í”„ë¡œì íŠ¸ì—ì„œ ê¸°ë³¸ì ì¸ ì‚¬ìš©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. ë””ìŠ¤ì–´ì…ˆë¸”í•˜ê³ ì í•˜ëŠ” í—¥ìŠ¤ ì½”ë“œë¥¼ ì ì–´ ì£¼ê³ , ì•„í‚¤í…ì²˜ ë° ëª¨ë“œë¥¼ ì •í•œ ë’¤ `cs_disasm()` í•¨ìˆ˜ë¡œ ë””ìŠ¤ì–´ì…ˆë¸”í•´ ì£¼ë©´ ë©ë‹ˆë‹¤.

![](https://image.toast.com/aaaadh/real/2024/techblog/capstoneengine02.png)

ë‹¤ìŒì€ ì „ì²´ ì†ŒìŠ¤ ì½”ë“œì…ë‹ˆë‹¤.

```cpp
#include <jni.h>
#include <string>
#include <stdio.h>
#include <inttypes.h>
#include <android/log.h>
#include "include/frida-gum.h"

#ifndef LOG_TAG
#define LOG_TAG    "[nhncloud]"
#endif
#define LOGD(...)  __android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, __VA_ARGS__)

static const uint8_t CODE[] = {0xc8, 0x02, 0x40, 0xf9, 0x08, 0x01, 0x00, 0xb5, 0x08, 0x1c, 0xa0, 0x4e, 0xe0, 0x03, 0x15, 0xaa};

void disassemble() {
    csh capstone;
    cs_insn * insn;
    size_t count;

    cs_open (CS_ARCH_ARM64, CS_MODE_ARM, &capstone);
    cs_option (capstone, CS_OPT_DETAIL, CS_OPT_ON);
    insn = cs_malloc (capstone);
    count = cs_disasm(capstone, CODE, sizeof(CODE), 0x1000, 0, &insn);
    if (count > 0) {
        size_t j;
        for (j = 0; j < count; j++) {
            LOGD("0x%" PRIx64":\t%s\t\t%s\n", insn[j].address, insn[j].mnemonic,
                 insn[j].op_str);
        }
        cs_free(insn, count);
    } else {
        LOGD("ERROR: Failed to disassemble given code!\n");
    }

    cs_close (&capstone);
}

extern "C" JNIEXPORT jstring

JNICALL
Java_com_nhncloud_capstonetest_MainActivity_stringFromJNI(
        JNIEnv *env,
        jobject /* this */) {
    std::string hello = "Hello from C++";

    disassemble();

    return env->NewStringUTF(hello.c_str());
}
```

### ì‘ìš© ì‚¬ìš©ë²•

íŠ¹ì • ë©”ëª¨ë¦¬ íŒ¨í„´ì„ ìŠ¤ìº”í•˜ê³ , í•´ë‹¹ íŒ¨í„´ì´ ë°œê²¬ëœ ë©”ëª¨ë¦¬ ì£¼ì†Œì—ì„œ Capstone APIë¥¼ ì´ìš©í•´ ë””ìŠ¤ì–´ì…ˆë¸” í›„ ê·¸ ê²°ê³¼ê°’ì— ëŒ€í•´ ì¶”ê°€ ë™ì‘(ì˜ˆ: í›„í‚¹, ë©”ëª¨ë¦¬ íŒ¨ì¹˜ ë“±)ì„ ê³ ë ¤í•´ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ íƒ€ê¹ƒ í•¨ìˆ˜ì˜ offsetì´ ë§¤ ë¹Œë“œë§ˆë‹¤ ë‹¬ë¼ì ¸ë„ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ë””ìŠ¤ì–´ì…ˆë¸”í•œ ê²°ê³¼ê°’ì— ëŒ€í•´ ì¶”ê°€ ë™ì‘ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒì´ê³ , ë³´í†µ ë””ìŠ¤ì–´ì…ˆë¸”í•œ ê²°ê³¼ê°’ì€ ì†ŒìŠ¤ ì½”ë“œê°€ ë³€í•˜ì§€ ì•ŠëŠ” í•œ ë™ì¼í•œ í˜•íƒœë¥¼ ë³´ì´ê¸° ë•Œë¬¸ì´ì£ .

ì˜ˆë¥¼ ë“¤ì–´ 'libxxx.so'ë¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ë©”ëª¨ë¦¬ì—ì„œ `AA AA AA AA BB BB BB BB CC CC CC CC DD DD DD DD` íŒ¨í„´ì„ ìŠ¤ìº”í•©ë‹ˆë‹¤. í•´ë‹¹ íŒ¨í„´ì´ ë°œê²¬ëœ ì£¼ì†Œì—ì„œ 0xcë§Œí¼ ë–¨ì–´ì§„ ìœ„ì¹˜ë¥¼ ë””ìŠ¤ì–´ì…ˆë¸”í•˜ë©´ í•­ìƒ ì–´ë–¤ í•¨ìˆ˜ë¡œ branchí•˜ëŠ” `b #0xabcdef`ì…ë‹ˆë‹¤. `0xabcdef` í•¨ìˆ˜ëŠ” ë¶ˆí•„ìš”í•œ ê¸°ëŠ¥ì´ë¯€ë¡œ ë©”ëª¨ë¦¬ íŒ¨ì¹˜ë¥¼ í†µí•´ ì‘ë™í•˜ì§€ ì•Šë„ë¡ í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.
ë‹¤ìŒì€ ì´ì— ëŒ€í•œ ì˜ˆì‹œ ì½”ë“œì…ë‹ˆë‹¤.

```cpp
#include <jni.h>
#include <string>
#include <stdio.h>
#include <inttypes.h>
#include <android/log.h>
#include "include/frida-gum.h"

#ifndef LOG_TAG
#define LOG_TAG    "[nhncloud]"
#endif
#define LOGD(...)  __android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, __VA_ARGS__)

// disassemble using capstone api
static void
disassemble (const guint8* code, gsize size, guint64 address, std::string& mnemonic, std::string& op_str)
{
    csh capstone;
    cs_insn * insn;

#ifdef __aarch64__
    cs_open (CS_ARCH_ARM64, CS_MODE_ARM, &capstone);
#elif __arm__
    cs_open (CS_ARCH_ARM, static_cast<cs_mode>(CS_MODE_ARM | CS_MODE_THUMB), &capstone);
#endif
    cs_option (capstone, CS_OPT_DETAIL, CS_OPT_ON);

    insn = cs_malloc (capstone);

    while (cs_disasm_iter (capstone, &code, &size, &address, insn))
    {
        op_str = std::string(insn->op_str);
        mnemonic = std::string(insn->mnemonic);
    }

    cs_free (insn, 1);
    cs_close (&capstone);
}

int mem_scan_match_count = 0;
static gboolean
mem_scan_match_func (GumAddress address, gsize size, gpointer user_data)
{
    mem_scan_match_count++;
    if (mem_scan_match_count == 1)
    {
        unsigned char* data;
        gsize n_bytes_read;

        LOGD("match at %p", (void*)address);

        data = gum_memory_read(reinterpret_cast<gconstpointer>(address + 0xc), 4, &n_bytes_read);
        std::string op_str, mnemonic;
        disassemble(data, n_bytes_read, (address + 0xc), mnemonic, op_str);

        // op_str is "#0xabcdef"
        size_t pos = op_str.find("0x");
        std::string hex_str = op_str.substr(pos + 2);
        uint64_t value = std::stoull(hex_str, <span class="hljs-literal">nullptr, 16);

        // memory patch
        const guint8 patch[] = {0xc0, 0x03, 0x5f, 0xd6};
        gum_memory_write((void*)value, patch, 4);

        return TRUE;
    }
    else
    {
        return FALSE;
    }
}

void mem_scan_with_pattern(const GumModuleDetails* m, const char* mem_scan_pattern)
{
    GumMatchPattern* mem_pattern = gum_match_pattern_new_from_string(mem_scan_pattern);
    gum_try_mprotect(reinterpret_cast<gpointer>(m->range->base_address), m->range->size, GUM_PAGE_RWX);
    gum_memory_scan(m->range, mem_pattern, mem_scan_match_func, <span class="hljs-literal">NULL);
}

__attribute__((constructor))
void native_init(void)
{
    gum_init_embedded ();
    LOGD("frida-gum initialized!");

    uint64_t libxxx_base = gum_module_find_base_address("libxxx.so");
    const GumModuleDetails* m = gum_module_map_find(gum_module_map_new(), libxxx_base);

    // scan memory pattern
    const char* mem_scan_pattern = "AA AA AA AA BB BB BB BB CC CC CC CC DD DD DD DD";
    mem_scan_with_pattern(m, mem_scan_pattern);
}
```


---

## ë‚˜ê°€ë©°

ì´ ê¸€ì—ì„œëŠ” ë””ìŠ¤ì–´ì…ˆë¸” ë„êµ¬ë¥¼ ë§Œë“¤ê±°ë‚˜ ì• í”Œë¦¬ì¼€ì´ì…˜ ëŸ°íƒ€ì„ ì‹œ ë””ìŠ¤ì–´ì…ˆë¸”í•˜ëŠ” ë° Capstone-engineì„ í™œìš©í•´ ë³´ëŠ” ì˜ˆë¥¼ ë‹¤ë¤˜ìŠµë‹ˆë‹¤. ì§ì ‘ ì‚¬ìš©í•´ ë³´ë‹ˆ APIë„ ê°„ë‹¨í•˜ê³  ì§ê´€ì ì´ì–´ì„œ ë§¤ìš° ìœ ìš©í•´ ë³´ì˜€ìŠµë‹ˆë‹¤. ì•ì„œ ì†Œê°œí•´ ë“œë¦° ê³µì‹ í™ˆí˜ì´ì§€ì—ì„œë„ ë‹¤ì–‘í•œ ìë£Œë¥¼ ì œê³µí•˜ê³  ìˆê¸° ë•Œë¬¸ì— ì–´ë ¤ì›€ ì—†ì´ ì‚¬ìš©í•´ ë³´ì‹¤ ìˆ˜ ìˆì„ ê±°ë¼ ìƒê°ë©ë‹ˆë‹¤. ê¸´ ê¸€ì„ ì½ì–´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤. ğŸ™‚

### ì°¸ê³  ë¬¸í—Œ

```component VPCard
{
  "title": "The Ultimate Disassembly Framework - Capstone - The Ultimate Disassembler",
  "desc": "The Ultimate Disassembler",
  "link": "https://www.capstone-engine.org",
  "logo": "https://www.capstone-engine.org/favicon.ico",
  "background": "rgba(177,46,61,0.2)"
}
```
