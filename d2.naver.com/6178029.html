<!doctype html>
<html lang="ko-KR" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.24" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.94" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화","image":["https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/6178029/1.png","https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/6178029/2.png"],"datePublished":"2024-03-27T00:00:00.000Z","dateModified":null,"author":[]}</script><meta property="og:url" content="https://chanhi2000.github.io/bookshelf/d2.naver.com/6178029.html"><meta property="og:site_name" content="📚Bookshelf"><meta property="og:title" content="Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화"><meta property="og:description" content="Article(s) > Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화"><meta property="og:type" content="article"><meta property="og:image" content="https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/6178029/banner.png"><meta property="og:locale" content="ko-KR"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:src" content="https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/6178029/banner.png"><meta name="twitter:image:alt" content="Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화"><meta property="article:tag" content="mongodb"><meta property="article:tag" content="golang"><meta property="article:tag" content="go"><meta property="article:tag" content="d2.naver.com"><meta property="article:tag" content="blog"><meta property="article:published_time" content="2024-03-27T00:00:00.000Z"><link rel="icon" href="/bookshelf/assets/icon/favicon.svg"><title>Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화 | 📚Bookshelf</title><meta name="description" content="Article(s) > Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화">
    <link rel="preload" href="/bookshelf/assets/style-DmRYlEXZ.css" as="style"><link rel="stylesheet" href="/bookshelf/assets/style-DmRYlEXZ.css">
    
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/bookshelf/" aria-label="Take me home"><img class="vp-nav-logo" src="/bookshelf/assets/icon/favicon.svg" alt><!----><span class="vp-site-name hide-in-pad">📚Bookshelf</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/bookshelf/news.html" aria-label><!--[--><i class="vp-icon fas fa-rss" sizing="height"></i><!--]--><!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label><!--[--><i class="vp-icon fas fa-keyboard" sizing="height"></i><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/hackingwithswift.com/" aria-label="hackingwithswift.com"><!--[--><img class="vp-icon" src="https://hackingwithswift.com/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->hackingwithswift.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/fcc/" aria-label="freecodecamp.org"><!--[--><img class="vp-icon" src="https://cdn.freecodecamp.org/universal/favicons/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->freecodecamp.org<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/kodeco.com/" aria-label="kodeco.com"><!--[--><img class="vp-icon" src="https://kodeco.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->kodeco.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.kotzilla.io/" aria-label="blog.kotzilla.io"><!--[--><img class="vp-icon" src="https://blog.kotzilla.io/hubfs/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->blog.kotzilla.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/kt.academy/" aria-label="kt.academy"><!--[--><img class="vp-icon" src="https://kt.academy/logo.png" alt aria-hidden no-view sizing="both"><!--]-->kt.academy<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/droidcon.com/" aria-label="droidcon.com"><!--[--><img class="vp-icon" src="https://droidcon.com/wp-content/uploads/2021/07/favicon-300x300.png" alt aria-hidden no-view sizing="both"><!--]-->droidcon.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/outcomeschool.com/" aria-label="outcomeschool.com"><!--[--><img class="vp-icon" src="https://outcomeschool.com/static/favicons/apple-touch-icon.png" alt aria-hidden no-view sizing="both"><!--]-->outcomeschool.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/frontendmasters.com/" aria-label="frontendmasters.com"><!--[--><img class="vp-icon" src="https://frontendmasters.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->frontendmasters.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/css-tricks.com/" aria-label="css-tricks.com"><!--[--><img class="vp-icon" src="https://css-tricks.com/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->css-tricks.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/smashingmagazine.com/" aria-label="smashingmagazine.com"><!--[--><img class="vp-icon" src="https://smashingmagazine.com/images/favicon/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->smashingmagazine.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.logrocket.com/" aria-label="blog.logrocket.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/blog.logrocket.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->blog.logrocket.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/realpython.com/" aria-label="realpython.com"><!--[--><img class="vp-icon" src="https://realpython.com/static/favicon.68cbf4197b0c.png" alt aria-hidden no-view sizing="both"><!--]-->realpython.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/digitalocean.com/" aria-label="digitalocean.com"><!--[--><img class="vp-icon" src="https://digitalocean.com/_next/static/media/favicon.594d6067.ico" alt aria-hidden no-view sizing="both"><!--]-->digitalocean.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/antonioleiva.com/" aria-label="antonioleiva.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/antonioleiva.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->antonioleiva.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/johnnyreilly.com/" aria-label="johnnyreilly.com"><!--[--><img class="vp-icon" src="https://johnnyreilly.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->johnnyreilly.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/code-maze.com/" aria-label="code-maze.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/code-maze.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->code-maze.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/milanjovanovic.tech/" aria-label="milanjovanovic.tech"><!--[--><img class="vp-icon" src="https://milanjovanovic.tech/profile_favicon.png" alt aria-hidden no-view sizing="both"><!--]-->milanjovanovic.tech<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/shopify.engineering/" aria-label="shopify.engineering"><!--[--><img class="vp-icon" src="https://cdn.shopify.com/static/shopify-favicon.png" alt aria-hidden no-view sizing="both"><!--]-->shopify.engineering<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/devtoolstips.org/" aria-label="devtoolstips.org"><!--[--><img class="vp-icon" src="https://devtoolstips.org/assets/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->devtoolstips.org<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/piccalil.li/" aria-label="piccalil.li"><!--[--><img class="vp-icon" src="https://piccalil.li/favicons/apple-touch-icon.png" alt aria-hidden no-view sizing="both"><!--]-->piccalil.li<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/sitepoint.com/" aria-label="sitepoint.com"><!--[--><img class="vp-icon" src="https://sitepoint.com/favicons/512x512.png" alt aria-hidden no-view sizing="both"><!--]-->sitepoint.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/event-driven.io/" aria-label="event-driven.io"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/event-driven.io/favicon.jfif" alt aria-hidden no-view sizing="both"><!--]-->event-driven.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/packagemain.tech/" aria-label="packagemain.tech"><!--[--><img class="vp-icon" src="https://substack-post-media.s3.amazonaws.com/public/images/2ea54e25-eaa6-4630-bfc0-10b8cfdce894/apple-touch-icon-1024x1024.png" alt aria-hidden no-view sizing="both"><!--]-->packagemain.tech<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/gosolve.io/" aria-label="gosolve.io"><!--[--><img class="vp-icon" src="https://gosolve.io/wp-content/uploads/2022/03/cropped-ikona1-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->gosolve.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/towardsdatascience.com/" aria-label="towardsdatascience.com"><!--[--><img class="vp-icon" src="https://cdn-images-1.medium.com/v2/resize:fill:128:128/1*VzTUkfeGymHP4Bvav-T-lA.png" alt aria-hidden no-view sizing="both"><!--]-->towardsdatascience.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/douggregor.net/" aria-label="douggregor.net"><!--[--><i class="vp-icon fas fa-globe" sizing="both"></i><!--]-->douggregor.net<!----></a></li><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/bookshelf/d2.naver.com/" aria-label="d2.naver.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/d2.naver.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->d2.naver.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tech.kakao.com/" aria-label="tech.kakao.com"><!--[--><img class="vp-icon" src="https://www.kakaocorp.com/page/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tech.kakao.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tech.kakaopay.com/" aria-label="tech.kakaopay.com"><!--[--><img class="vp-icon" src="https://tech.kakaopay.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tech.kakaopay.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/fe-developers.kakaoent.com/" aria-label="fe-developers.kakaoent.com"><!--[--><img class="vp-icon" src="https://fe-developers.kakaoent.com/favicon-32x32.png?v=44803cb16c1e2debd3984cf2e8cb2ded" alt aria-hidden no-view sizing="both"><!--]-->fe-developers.kakaoent.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/yozm.wishket.com/" aria-label="yozm.wishket.com"><!--[--><img class="vp-icon" src="https://yozm.wishket.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->yozm.wishket.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/popit.kr/" aria-label="popit.kr"><!--[--><img class="vp-icon" src="https://popit.kr/wp-content/uploads/2016/08/favicon_32x32.png" alt aria-hidden no-view sizing="both"><!--]-->popit.kr<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/devkuma.com/" aria-label="devkuma.com"><!--[--><img class="vp-icon" src="https://devkuma.com/favicons/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->devkuma.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.gangnamunni.com/" aria-label="blog.gangnamunni.com"><!--[--><img class="vp-icon" src="https://blog.gangnamunni.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->blog.gangnamunni.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/codingeverybody.kr/" aria-label="codingeverybody.kr"><!--[--><img class="vp-icon" src="https://codingeverybody.kr/wp-content/uploads/cropped-favicon-origin-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->codingeverybody.kr<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label><!--[--><i class="vp-icon fas fa-network-wired" sizing="height"></i><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tecmint.com/" aria-label="tecmint.com"><!--[--><img class="vp-icon" src="https://tecmint.com/wp-content/uploads/2020/07/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tecmint.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/docker.com/" aria-label="docker.com"><!--[--><img class="vp-icon" src="https://docker.com/app/uploads/2024/02/cropped-docker-logo-favicon-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->docker.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/learnk8s.io/" aria-label="learnk8s.io"><!--[--><img class="vp-icon" src="https://static.learnk8s.io/f7e5160d4744cf05c46161170b5c11c9.svg" alt aria-hidden no-view sizing="both"><!--]-->learnk8s.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/itsfoss.com/" aria-label="itsfoss.com"><!--[--><img class="vp-icon" src="https://itsfoss.com/content/images/size/w256h256/2022/12/android-chrome-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->itsfoss.com<!----></a></li></ul></button></div></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/chanhi2000/articles" target="_blank" rel="noopener noreferrer" aria-label="Github"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-appearance-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-appearance-dropdown"><!----></div></button></div><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><img class="vp-icon" src="/bookshelf/assets/image/d2.naver.com/favicon.ico" alt aria-hidden no-view sizing="both"><span class="vp-sidebar-title">d2.naver.com</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/6532276.html" aria-label="User-Agent Client Hints의 도입, UA 프리징을 대비하라"><!--[--><i class="vp-icon fa-brands fa-node" sizing="both"></i><!--]-->User-Agent Client Hints의 도입, UA 프리징을 대비하라<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1329.html" aria-label="Java Garbage Collection"><!--[--><i class="vp-icon fa-brands fa-java" sizing="both"></i><!--]-->Java Garbage Collection<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1336.html" aria-label="WebSocket과 Socket.io"><!--[--><i class="vp-icon fa-brands fa-java" sizing="both"></i><!--]-->WebSocket과 Socket.io<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1341.html" aria-label="Spring-Test-MVC 프로젝트 소개"><!--[--><i class="vp-icon iconfont icon-spring" sizing="both"></i><!--]-->Spring-Test-MVC 프로젝트 소개<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/994.html" aria-label="AMIGO - 행위 기반 악성코드 탐지"><!--[--><i class="vp-icon fas fa-shield-halved" sizing="both"></i><!--]-->AMIGO - 행위 기반 악성코드 탐지<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1011.html" aria-label="Git vs. Mercurial"><!--[--><i class="vp-icon iconfont icon-git" sizing="both"></i><!--]-->Git vs. Mercurial<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1016.html" aria-label="Hadoop과 MongoDB를 이용한 로그분석시스템"><!--[--><i class="vp-icon iconfont icon-hadoop" sizing="both"></i><!--]-->Hadoop과 MongoDB를 이용한 로그분석시스템<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1039.html" aria-label="NoSQL 가용성과 운영 안정성"><!--[--><i class="vp-icon iconfont icon-apachecassandra" sizing="both"></i><!--]-->NoSQL 가용성과 운영 안정성<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1042.html" aria-label="분산 고속 저장소 nStore"><!--[--><i class="vp-icon fas fa-database" sizing="both"></i><!--]-->분산 고속 저장소 nStore<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1052.html" aria-label="RTCS 실시간 웹 서비스를 위한 도전"><!--[--><i class="vp-icon fa-brands fa-js" sizing="both"></i><!--]-->RTCS 실시간 웹 서비스를 위한 도전<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1062.html" aria-label="uMon의 이해"><!--[--><i class="vp-icon fas fa-pen-ruler" sizing="both"></i><!--]-->uMon의 이해<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/8842776.html" aria-label="HTTPS 전환 후 서버 메모리는 안녕한가요?"><!--[--><i class="vp-icon iconfont icon-shell" sizing="both"></i><!--]-->HTTPS 전환 후 서버 메모리는 안녕한가요?<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/0590136.html" aria-label="사용자의 액션에 반응하는 UI 라이브러리, eg.Axes"><!--[--><i class="vp-icon iconfont icon-typescript" sizing="both"></i><!--]-->사용자의 액션에 반응하는 UI 라이브러리, eg.Axes<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/0853669.html" aria-label="Kafka NetworkClient Internals"><!--[--><i class="vp-icon iconfont icon-apachekafka" sizing="both"></i><!--]-->Kafka NetworkClient Internals<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/6445508.html" aria-label="HDFS 쓰기 파이프라인을 활용한 HBase의 WAL 쓰기 최적화"><!--[--><i class="vp-icon fa-brands fa-java" sizing="both"></i><!--]-->HDFS 쓰기 파이프라인을 활용한 HBase의 WAL 쓰기 최적화<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/8404108.html" aria-label="프로파일링 적용기 - 당신의 Go 애플리케이션은 좀 더 나아질 수 있다"><!--[--><i class="vp-icon fa-brands fa-golang" sizing="both"></i><!--]-->프로파일링 적용기 - 당신의 Go 애플리케이션은 좀 더 나아질 수 있다<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1203723.html" aria-label="Virtual Thread의 기본 개념 이해하기"><!--[--><i class="vp-icon iconfont icon-spring" sizing="both"></i><!--]-->Virtual Thread의 기본 개념 이해하기<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/9581727.html" aria-label="일 3,000만 건의 네이버페이 주문 메시지를 처리하는 Kafka 시스템의 무중단 전환 사례"><!--[--><i class="vp-icon iconfont icon-apachekafka" sizing="both"></i><!--]-->일 3,000만 건의 네이버페이 주문 메시지를 처리하는 Kafka 시스템의 무중단 전환 사례<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/8588537.html" aria-label="Golang, 그대들은 어떻게 할 것인가 - 1. 들어가며"><!--[--><i class="vp-icon fa-brands fa-golang" sizing="both"></i><!--]-->Golang, 그대들은 어떻게 할 것인가 - 1. 들어가며<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/bookshelf/d2.naver.com/6178029.html" aria-label="Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화"><!--[--><i class="vp-icon fa-brands fa-golang" sizing="both"></i><!--]-->Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/2690202.html" aria-label="Golang, 그대들은 어떻게 할 것인가 - 3. error 래핑"><!--[--><i class="vp-icon fa-brands fa-golang" sizing="both"></i><!--]-->Golang, 그대들은 어떻게 할 것인가 - 3. error 래핑<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/6507662.html" aria-label="Golang, 그대들은 어떻게 할 것인가 - 4. error 핸들링"><!--[--><i class="vp-icon fa-brands fa-golang" sizing="both"></i><!--]-->Golang, 그대들은 어떻게 할 것인가 - 4. error 핸들링<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/8113611.html" aria-label="네이버 통합 검색의 웹 성능 - 모니터링과 성능 개선"><!--[--><i class="vp-icon fas fa-gauge" sizing="both"></i><!--]-->네이버 통합 검색의 웹 성능 - 모니터링과 성능 개선<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/2461452.html" aria-label="UX 원칙에 따른 NELO 4.0 개발기"><!--[--><i class="vp-icon fas fa-pen-ruler" sizing="both"></i><!--]-->UX 원칙에 따른 NELO 4.0 개발기<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/5564264.html" aria-label="쿠버네티스 네이티브 사이드카 컨테이너 (Sidecar Containers)"><!--[--><i class="vp-icon iconfont icon-k8s" sizing="both"></i><!--]-->쿠버네티스 네이티브 사이드카 컨테이너 (Sidecar Containers)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/7472830.html" aria-label="infer, never만 보면 두려워지는 당신을 위한 고급 TypeScript"><!--[--><i class="vp-icon iconfont icon-typescript" sizing="both"></i><!--]-->infer, never만 보면 두려워지는 당신을 위한 고급 TypeScript<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/0680815.html" aria-label="실시간 광고 사용자 ID 매핑"><!--[--><i class="vp-icon iconfont icon-apachespark" sizing="both"></i><!--]-->실시간 광고 사용자 ID 매핑<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/0623656.html" aria-label="DESIGN SYSTEM FOR Android: From Figma to Jetpack Compose"><!--[--><i class="vp-icon fa-brands fa-figma" sizing="both"></i><!--]-->DESIGN SYSTEM FOR Android: From Figma to Jetpack Compose<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/7030870.html" aria-label="디자인시스템을 개발에서 적용 하는법"><!--[--><i class="vp-icon fa-brands fa-figma" sizing="both"></i><!--]-->디자인시스템을 개발에서 적용 하는법<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/8011540.html" aria-label="Writing Path: MBTI J처럼 체계적으로 글쓰는 AI"><!--[--><i class="vp-icon fas fa-language" sizing="both"></i><!--]-->Writing Path: MBTI J처럼 체계적으로 글쓰는 AI<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/2905424.html" aria-label="Kubernetes에서 DNS 다루는 방법 - 도메인을 찾아서"><!--[--><i class="vp-icon iconfont icon-k8s" sizing="both"></i><!--]-->Kubernetes에서 DNS 다루는 방법 - 도메인을 찾아서<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/7282210.html" aria-label="보낼 로그가 1000개가 되는동안 겪었던 고민들"><!--[--><i class="vp-icon fa-brands fa-android" sizing="both"></i><!--]-->보낼 로그가 1000개가 되는동안 겪었던 고민들<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/7321313.html" aria-label="시간은 금이다: LLM을 이용한 AI 코드 리뷰 도입기"><!--[--><i class="vp-icon fas fa-language" sizing="both"></i><!--]-->시간은 금이다: LLM을 이용한 AI 코드 리뷰 도입기<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/9283310.html" aria-label="infer, never만 보면 두려워지는 당신을 위한 타입 추론 - 기초 타입 이론"><!--[--><i class="vp-icon iconfont icon-typescript" sizing="both"></i><!--]-->infer, never만 보면 두려워지는 당신을 위한 타입 추론 - 기초 타입 이론<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/3713986.html" aria-label="infer, never만 보면 두려워지는 당신을 위한 타입 추론 - 고급 타입 추론"><!--[--><i class="vp-icon iconfont icon-typescript" sizing="both"></i><!--]-->infer, never만 보면 두려워지는 당신을 위한 타입 추론 - 고급 타입 추론<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/5088940.html" aria-label="infer, never만 보면 두려워지는 당신을 위한 타입 추론 - 응용 문제"><!--[--><i class="vp-icon iconfont icon-typescript" sizing="both"></i><!--]-->infer, never만 보면 두려워지는 당신을 위한 타입 추론 - 응용 문제<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/0281668.html" aria-label="네이버 검색 SRE - 상위 레벨 모니터링 시스템"><!--[--><i class="vp-icon fas fa-pen-ruler" sizing="both"></i><!--]-->네이버 검색 SRE - 상위 레벨 모니터링 시스템<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1623894.html" aria-label="네이버 검색 SRE - 지진과 비상 대응 시스템"><!--[--><i class="vp-icon fas fa-pen-ruler" sizing="both"></i><!--]-->네이버 검색 SRE - 지진과 비상 대응 시스템<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/7989422.html" aria-label="실시간 광고 사용자 ID 매핑"><!--[--><i class="vp-icon fa-brands fa-python" sizing="both"></i><!--]-->실시간 광고 사용자 ID 매핑<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/8149881.html" aria-label="GitHub Actions를 이용한 코드 리뷰 문화 개선기"><!--[--><i class="vp-icon iconfont icon-github" sizing="both"></i><!--]-->GitHub Actions를 이용한 코드 리뷰 문화 개선기<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><div class="page-cover"><img src="/bookshelf/assets/image/d2.naver.com/6178029/banner.png" alt no-view></div><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><i class="vp-icon fa-brands fa-golang" sizing="height"></i>Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화</h1><div class="page-info"><!----><!----><span class="page-date-info" aria-label="Writing Date📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">24. 3. 27.</span><meta property="datePublished" content="2024-03-27T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 7 min</span><meta property="timeRequired" content="PT7M"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color2" role>Go</span><span class="page-category-item color3" role>MongoDB</span><span class="page-category-item color8" role>Article(s)</span><!--]--><meta property="articleSection" content="Go,MongoDB,Article(s)"></span><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color8" role>blog</span><span class="page-tag-item color8" role>d2.naver.com</span><span class="page-tag-item color5" role>go</span><span class="page-tag-item color5" role>golang</span><span class="page-tag-item color3" role>mongodb</span><!--]--><meta property="keywords" content="blog,d2.naver.com,go,golang,mongodb"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><h1 id="frontmatter-title-관련" tabindex="-1"><a class="header-anchor" href="#frontmatter-title-관련"><span>Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화 관련</span></a></h1><a class="route-link vp-card" href="/bookshelf/programming/go/articles/" style="background:rgba(10,10,10,0.2);"><img class="vp-card-logo" src="https://chanhi2000.github.io/images/ico-wind.svg" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">Go > Article(s)</div><hr><div class="vp-card-desc">Article(s)</div></div></a><nav class="table-of-contents"><ul><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#기존-문제점" class="router-link-active router-link-exact-active">기존 문제점</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#개선-방향" class="router-link-active router-link-exact-active">개선 방향</a><ul><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#db-쿼리-실행-정보와-error를-래핑하여-반환" class="router-link-active router-link-exact-active">DB 쿼리 실행 정보와 error를 래핑하여 반환</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#error-값이-nil이면-반환되는-값-document-데이터-은-nil이-아니며-쿼리-성공을-보장" class="router-link-active router-link-exact-active">error 값이 nil이면, 반환되는 값(document 데이터)은 nil이 아니며 쿼리 성공을 보장</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#singleresult-cursor-등을-디코딩하는-중복-코드를-공통화" class="router-link-active router-link-exact-active">singleResult, Cursor 등을 디코딩하는 중복 코드를 공통화</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#상위-레이어에서는-db-레이어-내부에서-정의한-error를-처리하고-로그-레벨을-판단해-로깅" class="router-link-active router-link-exact-active">상위 레이어에서는 DB 레이어 내부에서 정의한 error를 처리하고 로그 레벨을 판단해 로깅</a></li></ul></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#공통화" class="router-link-active router-link-exact-active">공통화</a><ul><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#collection-객체-singleton" class="router-link-active router-link-exact-active">collection 객체 singleton</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#slow-쿼리-로깅" class="router-link-active router-link-exact-active">slow 쿼리 로깅</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#시간-초과-처리" class="router-link-active router-link-exact-active">시간 초과 처리</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#디코딩-및-error-타입-생성" class="router-link-active router-link-exact-active">디코딩 및 error 타입 생성</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#error-분류에-대한-고민" class="router-link-active router-link-exact-active">error 분류에 대한 고민</a></li></ul></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#마치며" class="router-link-active router-link-exact-active">마치며</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/6178029.html#참고" class="router-link-active router-link-exact-active">참고</a></li></ul></nav><hr><div class="vp-site-info" data-name="Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화 | NAVER D2"><a class="vp-site-info-navigator no-external-link-icon" title="Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화 | NAVER D2" href="https://d2.naver.com/helloworld/6178029" target="_blank"></a><div class="vp-site-info-preview" style="background:url(/bookshelf/assets/image/d2.naver.com/6178029/banner.png) center/cover no-repeat;"></div><div class="vp-site-info-detail"><img class="vp-site-info-logo" src="/assets/image/d2.naver.com/favicon.ico" alt loading="lazy" no-view><div class="vp-site-info-name">Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화 | NAVER D2</div><div class="vp-site-info-desc">Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화</div></div><!----></div><div></div><p>클로바노트 V1의 주요 서버들은 Golang(v1.14)으로 개발되었고 MongoDB를 메인 DB로 사용하고 있습니다. <a href="https://github.com/mongodb/mongo-go-driver" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i>MongoDB Go Driver (<code>mongodb/mongo-go-driver</code>)</a>라는 라이브러리를 사용하고 있는데, 이는 DB 쿼리(raw query)를 간편하게 작성할 수 있게 하고 struct에 매핑을 도와주는 매퍼 형식의 DB 라이브러리라고 생각하시면 될 것 같습니다.</p><p><a class="route-link" href="/bookshelf/d2.naver.com/8588537.html">앞 글</a>에서 이야기한 error에 대한 고민 중 DB 레이어에서 고민이 필요한 부분은 다음과 같았습니다.</p><ul><li>로그는 어디서 남겨야 하는가? 남긴다면 어떤 레벨로 남겨야 하는가?</li></ul><p>어떤 document에 대한 find를 실행했는데 해당 document가 없는 경우, 이것이 발생하면 안 되는 상황인지 정상적인 상황인지는 상위 레이어에서 결정됩니다. 그렇다면 DB 레이어에서는 로그를 Info, Warn 중 어떤 레벨로 남겨야 할까요? DB 레이어에서는 로그 레벨을 결정할 수가 없습니다. 그러면 DB 레이어에서는 Info 레벨로 로그를 남기고 상위 함수에서 error 여부를 판단하여 Error 레벨로 로그를 남겨야 할까요? 하지만 그러면 로그가 중복되고 효율적이지 못한 것 같았습니다.</p><p>이 밖에도 DB에서 다양한 error(찾을 수 없음, 중복된 키, 시간 초과, 디코딩 오류 등)가 발생할 수 있는데 상위 레이어에서는 이를 어떻게 판별할지에 대한 고민도 필요했습니다.</p><hr><h2 id="기존-문제점" tabindex="-1"><a class="header-anchor" href="#기존-문제점"><span>기존 문제점</span></a></h2><p>V1 서버에서 DB 레이어 구조만 보면 다음과 같습니다.</p><figure><img src="/bookshelf/assets/image/d2.naver.com/6178029/1.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>클로바노트 V1을 만들 때는 서비스를 만들어내는 속도가 중요한 상황이어서 일관성 없이 각 서버에서 각자의 방식으로 MongoDB Go Driver를 사용하고 있었는데, 이러한 구조를 없애고 모든 서버가 같은 구조로 일관성 있게 동작하게 개선하고 싶었습니다.</p><p>document를 가져오는 코드의 구조는 다음과 같았습니다.</p><ol><li>DB collection 객체 생성</li><li>시간 초과(timeout) 설정</li><li>쿼리 작성(filter, update 등)</li><li>slow 쿼리 로깅</li><li>document 디코딩</li></ol><p>3번을 제외한 코드는 대부분 각 서버에서 작성해 코드가 중복되어 있었고, 그에 따라 코드의 양이 많아지고 동작이 다르거나 누락된 경우도 많아 공통화에 대한 고민도 했습니다.</p><details class="hint-container details"><summary>코드 예</summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">type</span> MyCollectionManager <span class="token keyword">struct</span> <span class="token punctuation">{</span>  </span>
<span class="line">    authSource <span class="token builtin">string</span></span>
<span class="line">    collection <span class="token builtin">string</span></span>
<span class="line">    client  <span class="token operator">*</span>mongoDB<span class="token punctuation">.</span>Client</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 1. collection 객체 생성</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">MyCollection</span><span class="token punctuation">(</span>client <span class="token operator">*</span>mongo<span class="token punctuation">.</span>Client<span class="token punctuation">)</span> <span class="token operator">*</span>MyCollectionManager <span class="token punctuation">{</span>  </span>
<span class="line">    manager <span class="token operator">:=</span> <span class="token operator">&amp;</span>MyCollectionManager<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    dbConfig <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">GetDatabaseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    manager<span class="token punctuation">.</span>authSource <span class="token operator">=</span> dbConfig<span class="token punctuation">.</span>DatabaseName</span>
<span class="line">    manager<span class="token punctuation">.</span>collection <span class="token operator">=</span> <span class="token string">&quot;myCollection&quot;</span></span>
<span class="line">    manager<span class="token punctuation">.</span>client <span class="token operator">=</span> client</span>
<span class="line">    <span class="token keyword">return</span> manager</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 실제 쿼리 조건 세팅 및 디코딩</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>manager <span class="token operator">*</span>MyCollectionManager<span class="token punctuation">)</span> <span class="token function">GetDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>MyDocument<span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    document <span class="token operator">:=</span> <span class="token operator">&amp;</span>MyDocument<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 3. 쿼리 조건 세팅</span></span>
<span class="line">    filter <span class="token operator">:=</span> bson<span class="token punctuation">.</span>M<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    singleResult <span class="token operator">:=</span> manager<span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">FindOne</span><span class="token punctuation">(</span>manager<span class="token punctuation">.</span>authSource<span class="token punctuation">,</span> manager<span class="token punctuation">.</span>collection<span class="token punctuation">,</span> <span class="token operator">&amp;</span>filter<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 4. slow 쿼리 로깅</span></span>
<span class="line">    <span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span> <span class="token operator">&gt;</span> slowQueryLimit <span class="token punctuation">{</span></span>
<span class="line">            log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> singleResult <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        msg <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;FindOne document is failed&quot;</span><span class="token punctuation">)</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> document<span class="token punctuation">,</span> ERROR_INTERNAL_SERVER<span class="token punctuation">,</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token comment">// 5. 디코딩</span></span>
<span class="line">    <span class="token keyword">var</span> document MyDocument</span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> singleResult<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">==</span> mongo<span class="token punctuation">.</span>ErrNoDocuments <span class="token punctuation">{</span></span>
<span class="line">                <span class="token keyword">return</span> document<span class="token punctuation">,</span> ERROR_NOT_FOUND<span class="token punctuation">,</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token operator">&amp;</span>document<span class="token punctuation">,</span> ERROR_INTERNAL_SERVER<span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>document<span class="token punctuation">,</span> notecommon<span class="token punctuation">.</span>SUCCESS<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// 2. 시간 초과 설정 및 쿼리 수행</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>client <span class="token operator">*</span>mongo<span class="token punctuation">.</span>Client<span class="token punctuation">)</span> <span class="token function">FindOne</span><span class="token punctuation">(</span>databaseName <span class="token builtin">string</span><span class="token punctuation">,</span> collectionName <span class="token builtin">string</span><span class="token punctuation">,</span> filter <span class="token operator">*</span>bson<span class="token punctuation">.</span>M<span class="token punctuation">)</span> <span class="token operator">*</span>mongo<span class="token punctuation">.</span>SingleResult <span class="token punctuation">{</span>  </span>
<span class="line">    collection <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span>databaseName<span class="token punctuation">,</span> collectionName<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> collection <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        ctx<span class="token punctuation">,</span> ctxCancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeoutLimit<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">defer</span> <span class="token function">ctxCancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        res <span class="token operator">:=</span> collection<span class="token punctuation">.</span><span class="token function">FindOne</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> filter<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">return</span> res</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><hr><h2 id="개선-방향" tabindex="-1"><a class="header-anchor" href="#개선-방향"><span>개선 방향</span></a></h2><p>저는 개선 방향을 다음과 같이 정했습니다.</p><ol><li><strong>DB 레이어에서는 로그를 남기지 않고 DB 쿼리 실행 정보와 error를 래핑하여 반환한다.</strong></li><li><strong><code>error</code> 값이 <code>nil</code>(=Null)이면, 반환되는 값(document)은 <code>nil</code>이 아니며 쿼리 성공을 보장한다.</strong></li><li><strong>singleResult, Cursor 등을 디코딩하는 중복 코드를 공통화한다.</strong></li><li><strong>상위 레이어에서는 MongoDB Go Driver의 error를 처리하는 것이 아니라 DB 레이어 내부에서 정의한 error를 처리하고 로그 레벨을 판단해 로그를 남긴다.</strong></li></ol><p>방향을 이렇게 정한 이유와 그 결과를 하나씩 설명하겠습니다.</p><h3 id="db-쿼리-실행-정보와-error를-래핑하여-반환" tabindex="-1"><a class="header-anchor" href="#db-쿼리-실행-정보와-error를-래핑하여-반환"><span>DB 쿼리 실행 정보와 error를 래핑하여 반환</span></a></h3><p>글의 초반에서 언급한 대로, DB 레이어에서는 error의 심각성을 판단할 수 없습니다. 실제로 어떤 레벨의 error인지는 <strong>비즈니스 로직을 포함한 상위 레이어까지 올라가야만 알 수 있기 때문에, DB 레이어는 로그를 남가지 않도록</strong> 설계 방향을 잡았습니다.</p><p>DB 레이어에서 로그를 기록하지 않기로 결정했으므로, DB 레이어는 상위 레이어에 error 정보를 정확하게 전달해야 했습니다. 그러면 error에 어떤 정보를 포함해야 할지 생각해보았습니다.</p><p>우선, DB에서 발생할 수 있는 error를 파악했습니다.</p><ul><li>시간 초과(timeout)</li><li>찾을 수 없음(not found)</li><li>중복된 키(duplicated key)</li><li>네트워크 오류(network)</li><li>연결 끊김(disconnect)</li></ul><p>MongoDB Go Driver에서 정의한 error는 위의 5개 외에도 더 있지만 크게 위와 같이 분류했고, 결과를 디코딩하는 중 발생한 오류도 고려하여 디코딩 error까지 총 6개의 error를 추렸습니다.</p><p>그 다음에는 어떤 정보를 error에 포함할지 정했습니다. DB 오류가 발생한 경우 디버깅에 어떤 정보가 필요할지 고민했습니다.</p><ul><li>필터링 조건</li><li>update/insert 내용</li><li>대상 collection</li><li>Mongo 내부 오류 메시지</li></ul><p>위와 같은 정보가 필요하다고 생각했고, 해당 내용을 담을 수 있는 <code>struct</code>를 다음과 같이 정의했습니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">package</span> errorUtils</span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> basicQueryInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span>  </span>
<span class="line">    collection <span class="token builtin">string</span></span>
<span class="line">    filter     <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    update     <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    doc        <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> notFoundError <span class="token keyword">struct</span> <span class="token punctuation">{</span>  </span>
<span class="line">    basicQueryInfo</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> duplicatedKeyError <span class="token keyword">struct</span> <span class="token punctuation">{</span>  </span>
<span class="line">    basicQueryInfo</span>
<span class="line">    <span class="token builtin">error</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><details class="hint-container details"><summary>부가 함수</summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token function">NotFoundError</span><span class="token punctuation">(</span>col <span class="token builtin">string</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> doc <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>  </span>
<span class="line">    err <span class="token operator">:=</span> <span class="token operator">&amp;</span>notFoundError<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    err<span class="token punctuation">.</span><span class="token function">setBasicError</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> doc<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> err</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>err <span class="token operator">*</span>basicQueryInfo<span class="token punctuation">)</span> <span class="token function">setBasicError</span><span class="token punctuation">(</span>col <span class="token builtin">string</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> doc <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    err<span class="token punctuation">.</span>filter <span class="token operator">=</span> filter</span>
<span class="line">    err<span class="token punctuation">.</span>collection <span class="token operator">=</span> col</span>
<span class="line">    err<span class="token punctuation">.</span>update <span class="token operator">=</span> update</span>
<span class="line">    err<span class="token punctuation">.</span>doc <span class="token operator">=</span> doc</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>그리고 로그를 남길 때 앞에서 정의한 struct의 정보가 보이도록 문자열을 작성했습니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>notFoundError<span class="token punctuation">)</span> <span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%s not found. &quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>collection<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">getBasicInfoErrorMsg</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>basicQueryInfo<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">getBasicInfoErrorMsg</span><span class="token punctuation">(</span>e basicQueryInfo<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>  </span>
<span class="line">    msg <span class="token operator">:=</span> <span class="token string">&quot;| {query info: &quot;</span></span>
<span class="line">    <span class="token keyword">if</span> e<span class="token punctuation">.</span>filter <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        msg <span class="token operator">+=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot; filter: %+v&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>filter<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> e<span class="token punctuation">.</span>update <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        msg <span class="token operator">+=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;, update: %+v&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>update<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> e<span class="token punctuation">.</span>doc <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        msg <span class="token operator">+=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;, doc: %+v&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span>doc<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    msg <span class="token operator">+=</span> <span class="token string">&quot;}&quot;</span></span>
<span class="line">    <span class="token keyword">return</span> msg</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>이 코드의 error의 로그는 다음과 같이 <code>error 종류, Mongo 오류 내용, 쿼리 내용</code>의 구조로 남겨집니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token comment">// accounts collection에서 특정 document를 찾지 못함</span></span>
<span class="line"><span class="token string">&quot;accounts not found. | {query info: filter: map[account_id: 123]}&quot;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="error-값이-nil이면-반환되는-값-document-데이터-은-nil이-아니며-쿼리-성공을-보장" tabindex="-1"><a class="header-anchor" href="#error-값이-nil이면-반환되는-값-document-데이터-은-nil이-아니며-쿼리-성공을-보장"><span><code>error</code> 값이 <code>nil</code>이면, 반환되는 값(document 데이터)은 <code>nil</code>이 아니며 쿼리 성공을 보장</span></a></h3><p>Golang을 사용하면서 외부 API를 호출할 때 <a href="https://pkg.go.dev/net/http" target="_blank" rel="noopener noreferrer"><i class="vp-icon fas fa-boxes-stacked" sizing="height"></i>net/http</a> 패키지를 자주 사용했는데, <code>error</code> 값이 <code>nil</code>이면 반환 값이 항상 <code>non-nil</code>이라는 점이 괜찮다고 생각했습니다. 개발자는 <code>error</code> 값이 <code>nil</code>이면 반환 값을 검증 없이 사용할 수 있었습니다.</p><details class="hint-container details"><summary>net/http/client.go <i class="vp-icon fa-brands fa-golang" sizing="height"></i></summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token comment">// net/http/client.go</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// If the returned error is nil, the Response will contain a non-nil</span></span>
<span class="line"><span class="token comment">// Body which the user is expected to close.</span></span>
<span class="line"><span class="token comment">// ...</span></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Client<span class="token punctuation">)</span> <span class="token function">Do</span><span class="token punctuation">(</span>req <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Response<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">return</span> c<span class="token punctuation">.</span><span class="token function">do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>그래서 저도 이러한 개념을 도입하기로 했습니다. 반환된 <code>error</code> 값이 <code>nil</code>이면, 반환된 document 또는 결과는 <code>nil</code>이 아니며 동시에 쿼리 성공을 보장하도록 했습니다.</p><p>이러한 결정을 한 주요한 이유는 document를 찾을 수 없는 상황 때문이었습니다. find의 결과로 document를 찾을 수 없는 경우, 쿼리가 실패하지는 않았기 때문에 다음과 같이 결과물을 <code>nil</code>로, <code>error</code>도 <code>nil</code>로 반환할 수 있습니다.</p><details class="hint-container details"><summary>코드 예</summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token function">FindSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>MyDocument<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">if</span> not found <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>하지만 저는 다음과 같은 이유로 이 방식을 선호하지 않았습니다.</p><ul><li>만약 <code>nil</code>이 반환된다면 상위 함수에서 document가 <code>nil</code>인지 확인해야 한다.</li><li>MongoDB Go Driver에서는 document를 찾을 수 없는 상황을 error(<code>ErrNoDocuments</code>)로 정의한다.</li></ul><details class="hint-container details"><summary>mongo/single_result.go <i class="vp-icon fa-brands fa-golang" sizing="height"></i></summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token comment">// single_result.go</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// ErrNoDocuments is returned by SingleResult methods when the operation that created the SingleResult did not return</span></span>
<span class="line"><span class="token comment">// any documents.</span></span>
<span class="line"><span class="token keyword">var</span> ErrNoDocuments <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;mongo: no documents in result&quot;</span><span class="token punctuation">)</span>  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>물론 document를 찾을 수 없는 상황을 error로 반환하는 경우도 확인해야 합니다.</p><p>하지만 document를 찾을 수 없는 상황을 error로 취급한다면, 굳이 error 내용을 확인할 필요 없이 상위 레이어로 올리거나 error 로그를 남기기만 하면 된다는 장점이 있습니다.</p><p>그래서 저는 <code>not found</code>는 error로 보기로 했고, <code>error</code> 값이 <code>nil</code>인 경우에는 결과 값은 <code>nil</code>이 아니며 쿼리 성공을 보장하는 방식을 도입했습니다.</p><h3 id="singleresult-cursor-등을-디코딩하는-중복-코드를-공통화" tabindex="-1"><a class="header-anchor" href="#singleresult-cursor-등을-디코딩하는-중복-코드를-공통화"><span><code>singleResult</code>, <code>Cursor</code> 등을 디코딩하는 중복 코드를 공통화</span></a></h3><p>MongoDB Go Driver를 사용하면서 불편한 점은 매번 디코딩 코드를 작성해야 한다는 것이었습니다.</p><details class="hint-container details"><summary>코드 예</summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token comment">// find all 1</span></span>
<span class="line">cursor<span class="token punctuation">,</span> err <span class="token operator">:=</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> bson<span class="token punctuation">.</span>M<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  </span>
<span class="line"><span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token keyword">defer</span> cursor<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>  </span>
<span class="line"><span class="token keyword">var</span> results <span class="token punctuation">[</span><span class="token punctuation">]</span>MyDocument  </span>
<span class="line"><span class="token keyword">for</span> cursor<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">var</span> doc MyDocument</span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    results <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> doc<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// find all 2</span></span>
<span class="line"><span class="token keyword">var</span> results <span class="token punctuation">[</span><span class="token punctuation">]</span>MyDocument  </span>
<span class="line"><span class="token keyword">if</span> err <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">All</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// find one</span></span>
<span class="line">singleResult <span class="token operator">:=</span> collection<span class="token punctuation">.</span><span class="token function">FindOne</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> bson<span class="token punctuation">.</span>M<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>  </span>
<span class="line"><span class="token keyword">var</span> doc MyDocument  </span>
<span class="line"><span class="token keyword">if</span> err <span class="token operator">:=</span> singleResult<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line">fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span>  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>위와 같은 중복 코드를 제거하고 공통 함수에서 디코딩할 수 있는 방법을 고민했습니다.</p><p>먼저, <code>singleResult</code> 디코딩은 디코딩 함수를 한 번 래핑하는 것으로 간단히 해결할 수 있었습니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">package</span> mongo</span>
<span class="line"></span>
<span class="line"><span class="token keyword">var</span> SingleResultErr  <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;single result is nil&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">EvaluateAndDecodeSingleResult</span><span class="token punctuation">(</span>result <span class="token operator">*</span>mongo<span class="token punctuation">.</span>SingleResult<span class="token punctuation">,</span> v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">if</span> result <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> SingleResultErr</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> result<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>하지만 문제는 Cursor 디코딩이었습니다. 어떤 타입을 디코딩해야 하는지는 런타임에 결정되어, 동적으로 추론하는 방법은 reflect 밖에 없었고 그것도 완벽하지 않았습니다.</p><details class="hint-container details"><summary>reflect를 사용하여 디코딩하는 예</summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>col <span class="token operator">*</span>Collection<span class="token punctuation">)</span> <span class="token function">FindAll</span><span class="token punctuation">(</span>requiredExample <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> filter <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> opts <span class="token operator">...</span><span class="token operator">*</span>options<span class="token punctuation">.</span>FindOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">    cursor<span class="token punctuation">,</span> err <span class="token operator">:=</span> col<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">DecodeCursor</span><span class="token punctuation">(</span>cursor<span class="token punctuation">,</span> <span class="token function">GetInterfaceType</span><span class="token punctuation">(</span>requiredExample<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">DecodeCursor</span><span class="token punctuation">(</span>cursor <span class="token operator">*</span>mongo<span class="token punctuation">.</span>Cursor<span class="token punctuation">,</span> t reflect<span class="token punctuation">.</span>Type<span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token comment">// 타입에 맞춰 slice 생성</span></span>
<span class="line">    slice <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">MakeSlice</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">SliceOf</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">for</span> cursor<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// struct 초기화</span></span>
<span class="line">        doc <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token comment">// 디코딩</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cursor<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token comment">// 디코딩 결과 slice append</span></span>
<span class="line">        slice <span class="token operator">=</span> reflect<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span>slice<span class="token punctuation">,</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">// slice return</span></span>
<span class="line">    <span class="token keyword">return</span> slice<span class="token punctuation">.</span><span class="token function">Interface</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">GetInterfaceType</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> reflect<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">var</span> t reflect<span class="token punctuation">.</span>Type</span>
<span class="line">    <span class="token keyword">if</span> xt<span class="token punctuation">,</span> ok <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span></span>
<span class="line">        t <span class="token operator">=</span> xt</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        t <span class="token operator">=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> t</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>이 코드는 다음과 같은 단계를 거칩니다.</p><ol><li><code>FindAll()</code> 함수에 slice로 반환받을 예시 struct 객체를 넣으면 해당 객체가 담긴 <code>interface{}</code>를 반환</li><li>상위 함수에서는 이를 한 번 더 type assertion</li></ol><p>reflect를 사용하다 보니 코드를 바로 이용하기가 쉽지 않았고, <code>interface{}</code>로 반환되므로 다시 타입을 변환해야 하는 불편함이 있었습니다.</p><details class="hint-container details"><summary>reflect 방식 사용 예</summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">  <span class="token comment">// FindAll(Account 타입, 쿼리 조건)</span></span>
<span class="line">    all<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">FindAll</span><span class="token punctuation">(</span>types<span class="token punctuation">.</span>Account<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> bson<span class="token punctuation">.</span>M<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span></span>
<span class="line">    result <span class="token operator">:=</span> all<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>types<span class="token punctuation">.</span>Account<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p><code>DecodeCursor()</code> 함수 내부에서 slice를 만들지 않고 기존의 커서 디코딩 방식처럼 외부에서 slice를 받아서 append하는 방식을 시도해보았으나 쉽지 않았고 구글링으로도 해결책을 찾지 못했습니다.</p><p>그래서 기존 MongoDB Go Driver에서는 <code>cursor.All()</code>은 어떻게 구현되어 있는지 확인해보았습니다.</p><blockquote><i class="vp-icon fas fa-folder-open" sizing="height"></i><code>mongo/</code><i class="vp-icon fa-brands fa-golang" sizing="height"></i><code>cursor.go</code></blockquote><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Cursor<span class="token punctuation">)</span> <span class="token function">All</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> results <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>  </span>
<span class="line">    resultsVal <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">ValueOf</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> resultsVal<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> reflect<span class="token punctuation">.</span>Ptr <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;results argument must be a pointer to a slice, but was a %s&quot;</span><span class="token punctuation">,</span> resultsVal<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    sliceVal <span class="token operator">:=</span> resultsVal<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> sliceVal<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> reflect<span class="token punctuation">.</span>Interface <span class="token punctuation">{</span></span>
<span class="line">        sliceVal <span class="token operator">=</span> sliceVal<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> sliceVal<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> reflect<span class="token punctuation">.</span>Slice <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;results argument must be a pointer to a slice, but was a pointer to %s&quot;</span><span class="token punctuation">,</span> sliceVal<span class="token punctuation">.</span><span class="token function">Kind</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    elementType <span class="token operator">:=</span> sliceVal<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">var</span> index <span class="token builtin">int</span></span>
<span class="line">    <span class="token keyword">var</span> err <span class="token builtin">error</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">defer</span> c<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    batch <span class="token operator">:=</span> c<span class="token punctuation">.</span>batch <span class="token comment">// exhaust the current batch before iterating the batch cursor</span></span>
<span class="line">    <span class="token keyword">for</span> <span class="token punctuation">{</span></span>
<span class="line">        sliceVal<span class="token punctuation">,</span> index<span class="token punctuation">,</span> err <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">addFromBatch</span><span class="token punctuation">(</span>sliceVal<span class="token punctuation">,</span> elementType<span class="token punctuation">,</span> batch<span class="token punctuation">,</span> index<span class="token punctuation">)</span></span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        <span class="token keyword">if</span> <span class="token operator">!</span>c<span class="token punctuation">.</span>bc<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">break</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">        batch <span class="token operator">=</span> c<span class="token punctuation">.</span>bc<span class="token punctuation">.</span><span class="token function">Batch</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">=</span> <span class="token function">replaceErrors</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>bc<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    resultsVal<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>sliceVal<span class="token punctuation">.</span><span class="token function">Slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>:::</p><p>제가 구현한 방식과 비슷하게 reflect를 사용하고 있지만, 다른 점은 마지막 줄이었습니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line">resultsVal<span class="token punctuation">.</span><span class="token function">Elem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>sliceVal<span class="token punctuation">.</span><span class="token function">Slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">)</span>  </span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>내부에서 생성한 slice의 데이터를 외부에서 받은 slice에 담는 작업인데, 이렇게 작성하면 <code>All()</code> 내부에 2개의 slice가 존재하게 됩니다. 이에 대해 공식 문서에서는 <code>cursor.All()</code>의 메모리 이슈 가능성을 설명하고 있습니다.</p><blockquote><p>Memory</p><p>If the number and size of documents returned by your query exceeds available application memory, your program will crash. If you except a large result set, you should consume your cursor iteratively.</p><p>출처: <a href="https://www.mongodb.com/docs/drivers/go/upcoming/fundamentals/crud/read-operations/cursor/#retrieve-all-documents" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-mongodb" sizing="height"></i>Retrieve All Documents</a></p></blockquote><p>그래서 결국 <code>cursor.All()</code>을 사용하는 방식과 제가 직접 만든 reflect 함수를 사용하는 방식, 이렇게 두 가지를 만들어, 만약 조회할 데이터가 크지 않다면 전자의 함수를, 크다면 불편함은 있지만 후자의 함수를 사용하는 것으로 마무리하려고 했었습니다.</p><p>하지만 이러한 고민을 해결해줄 <strong>Go 1.18 버전이 2022년 3월 15일에 공개</strong>되었고 <strong>Generic이 도입</strong>되었습니다. Generic을 이용한 해결을 시도해보았는데, 디코딩할 때 함수에 Generic 타입을 넘겨주면 아주 간단하게 처리할 수 있었습니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token comment">// cursor</span></span>
<span class="line"><span class="token keyword">func</span> DecodeCursor<span class="token punctuation">[</span>T any<span class="token punctuation">]</span><span class="token punctuation">(</span>cursor <span class="token operator">*</span>mongo<span class="token punctuation">.</span>Cursor<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">defer</span> cursor<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    slice <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>T<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// nil이 아님을 보장하기 위해 slice intialize</span></span>
<span class="line">    <span class="token keyword">for</span> cursor<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">var</span> doc T</span>
<span class="line">        <span class="token keyword">if</span> err <span class="token operator">:=</span> cursor<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        slice <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>slice<span class="token punctuation">,</span> doc<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> slice<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// single result</span></span>
<span class="line"><span class="token keyword">func</span> EvaluateAndDecodeSingleResult<span class="token punctuation">[</span>T any<span class="token punctuation">]</span><span class="token punctuation">(</span>result <span class="token operator">*</span>mongo<span class="token punctuation">.</span>SingleResult<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">if</span> result <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorType<span class="token punctuation">.</span>SingleResultErr</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">var</span> v T</span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">:=</span> result<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>v<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>이 방법으로, 이제는 reflect를 사용한 경우 caller에서 type assertion을 할 필요가 없었으며, <code>cursor.All()</code>의 메모리 이슈도 해결할 수 있었습니다.</p><h3 id="상위-레이어에서는-db-레이어-내부에서-정의한-error를-처리하고-로그-레벨을-판단해-로깅" tabindex="-1"><a class="header-anchor" href="#상위-레이어에서는-db-레이어-내부에서-정의한-error를-처리하고-로그-레벨을-판단해-로깅"><span>상위 레이어에서는 DB 레이어 내부에서 정의한 error를 처리하고 로그 레벨을 판단해 로깅</span></a></h3><p>마지막으로, 상위 레이어에서 MongoDB Go Driver의 error를 처리하는 것이 아니라 앞서 DB 레이어가 쿼리 실행 정보와 함께 래핑한 error를 처리하게 하는 일이 남았습니다.</p><p>이를 위해서는 상위 레이어에서 error를 구별할 방법이 필요했고, 다음의 총 3가지 방법이 있었습니다.</p><ul><li><strong><code>errors.As()</code></strong></li><li><strong>reflect</strong></li><li><strong>type swtich</strong></li></ul><h4 id="_1-errors-as" tabindex="-1"><a class="header-anchor" href="#_1-errors-as"><span>1. <code>errors.As()</code></span></a></h4><p><code>github.com/pkg/errors</code>를 사용하여 특정 구조체에 error가 바인딩될 수 있는지 확인하는 방법입니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token function">IsErrorOf</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">,</span> target <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">As</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>하지만 이 방식은 매번 error를 확인할 때마다 target error의 변수를 선언해서 넘겨야 하는 불편함이 있습니다.</p><details class="hint-container details"><summary>코드 예</summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token function">service</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">var</span> notFoundErr notFoundError</span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">IsErrorOf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token operator">&amp;</span>notFoundErr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// handle error</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">var</span> dupKeyErr duplicatedKeyError</span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">IsErrorOf</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dupKeyErr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// handle error</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><h4 id="_2-reflect" tabindex="-1"><a class="header-anchor" href="#_2-reflect"><span>2. <code>reflect</code></span></a></h4><p>Golang의 <code>reflect</code>를 사용하여 error가 해당 <code>struct</code>의 타입과 동일한지 판별하는 것입니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token function">GetInterfaceType</span><span class="token punctuation">(</span>v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> reflect<span class="token punctuation">.</span>Type <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">var</span> t reflect<span class="token punctuation">.</span>Type</span>
<span class="line">    <span class="token keyword">if</span> xt<span class="token punctuation">,</span> ok <span class="token operator">:=</span> v<span class="token punctuation">.</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span>Type<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span></span>
<span class="line">        t <span class="token operator">=</span> xt</span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        t <span class="token operator">=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> t</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token function">IsErrorTypeOf</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">,</span> v <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>  </span>
<span class="line">    t <span class="token operator">:=</span> <span class="token function">GetInterfaceType</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span></span>
<span class="line">    errorType <span class="token operator">:=</span> reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> t <span class="token operator">==</span> errorType <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">// IsErrorTypeOf(err, duplicatedKeyError{})</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>하지만 이 방식을 사용하기 위해서는 error struct를 public으로 공개해야 한다는 조건이 있습니다. 또한, 확인하려는 struct의 객체를 생성해야 하므로 이로 인한 불편함도 존재합니다.</p><h4 id="_3-type-switch" tabindex="-1"><a class="header-anchor" href="#_3-type-switch"><span>3. <code>type switch</code></span></a></h4><p>이 방식은 Golang에서 타입을 판별할 때 가장 자주 사용되는 방식입니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token function">IsDBInternalErr</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">for</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">switch</span> err<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">case</span> <span class="token operator">*</span>internalError<span class="token punctuation">,</span></span>
<span class="line">            <span class="token operator">*</span>timeoutError<span class="token punctuation">,</span></span>
<span class="line">            <span class="token operator">*</span>dbClientError<span class="token punctuation">:</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">true</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        err <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">Unwrap</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token boolean">false</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>(Golang에서 error는 여러 겹으로 래핑될 수 있기 때문에 양파 껍질을 까듯이 확인하도록 만들었습니다. 래핑에 관한 내용은 다음 글에서 자세히 설명하겠습니다.)</p><p>위 방식은 모든 error struct마다 타입 switch 함수를 만들어야 하는 불편함은 있지만 가장 직관적이고, DB에서 발생하는 error의 종류가 늘어날 가능성이 거의 없기 때문에 이 방법도 괜찮아 보였습니다. 또한, <code>IsDBInternalErr()</code>와 같이 여러 error를 1개로 처리되도록 할 수 있었습니다.</p><p>상위 함수에서는 다음과 같이 사용될 수 있습니다.</p><details class="hint-container details"><summary>사용 예</summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token function">service</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">IsNotFoundErr</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// handle error</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token function">IsDBInternalErr</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// handle error</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>위의 상황을 전체적으로 고려할 때, 팀 내에서는 세 번째 방식이 가장 좋을 것으로 결론을 내렸으며, 타입 switch 방식으로 상위 함수에서 처리하도록 설정했습니다.</p><hr><h2 id="공통화" tabindex="-1"><a class="header-anchor" href="#공통화"><span>공통화</span></a></h2><p>error를 정의하고 처리하고 쿼리 결과를 디코딩하는 것까지 완성하고, V1에서 중복되어 있던 다음과 같은 코드를 공통화하는 작업을 진행했습니다.</p><ul><li>collection 객체 singleton</li><li>slow 쿼리 로깅</li><li>시간 초과</li><li>디코딩</li><li>error 타입 생성</li></ul><h3 id="collection-객체-singleton" tabindex="-1"><a class="header-anchor" href="#collection-객체-singleton"><span>collection 객체 singleton</span></a></h3><p>기존 V1에서는 MongoDB <code>client</code> 객체에서 매번 <code>Collection</code> 객체를 생성하고 있었습니다.</p><details class="hint-container details"><summary>코드 예</summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>client <span class="token operator">*</span>mongo<span class="token punctuation">.</span>Client<span class="token punctuation">)</span> <span class="token function">getCollection</span><span class="token punctuation">(</span>database <span class="token builtin">string</span><span class="token punctuation">,</span> collection <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>mongo<span class="token punctuation">.</span>Collection <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">return</span> client<span class="token punctuation">.</span><span class="token function">Database</span><span class="token punctuation">(</span>database<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Collection</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>manager <span class="token operator">*</span>mongo<span class="token punctuation">.</span>Client<span class="token punctuation">)</span> <span class="token function">FindOne</span><span class="token punctuation">(</span>databaseName <span class="token builtin">string</span><span class="token punctuation">,</span> collectionName <span class="token builtin">string</span><span class="token punctuation">,</span> filter <span class="token operator">*</span>bson<span class="token punctuation">.</span>M<span class="token punctuation">)</span> <span class="token operator">*</span>mongo<span class="token punctuation">.</span>SingleResult <span class="token punctuation">{</span>  </span>
<span class="line">    collection <span class="token operator">:=</span> manager<span class="token punctuation">.</span><span class="token function">getCollection</span><span class="token punctuation">(</span>databaseName<span class="token punctuation">,</span> collectionName<span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>쿼리마다 객체를 생성하는 비용이 있기 때문에, 이를 줄이기 위해 객체를 공유해서 사용해도 되는지 MongoDB Go Driver 공식 문서를 찾아보았습니다. 확인 결과, <code>Collection</code> 객체는 <a href="https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#Collection" target="_blank" rel="noopener noreferrer"><i class="vp-icon fas fa-boxes-stacked" sizing="height"></i>goroutine safe</a>하여 singleton으로 사용해도 무방하다는 내용을 찾을 수 있었습니다.</p><details class="hint-container details"><summary>mongo/collection.go <i class="vp-icon fa-brands fa-golang" sizing="height"></i></summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token comment">// Collection is a handle to a MongoDB collection. It is safe for concurrent use by multiple goroutines.</span></span>
<span class="line"><span class="token keyword">type</span> Collection <span class="token keyword">struct</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>그래서 V2에서는 <code>Collection</code> 객체는 singleton으로 사용하기로 하고, <code>Collection</code> 객체에 디코딩할 때 사용할 <code>struct</code> 타입을 Generic 타입으로 받아, 앞에서 언급한 디코딩 함수에 넘기도록 했습니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">package</span> mongo</span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> Collection<span class="token punctuation">[</span>T any<span class="token punctuation">]</span> <span class="token keyword">struct</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token operator">*</span>mongo<span class="token punctuation">.</span>Collection</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> MakeCollection<span class="token punctuation">[</span>T any<span class="token punctuation">]</span><span class="token punctuation">(</span>mongoManager <span class="token operator">*</span>MongoDBClient<span class="token punctuation">,</span> databaseName<span class="token punctuation">,</span> collectionName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Collection<span class="token punctuation">[</span>T<span class="token punctuation">]</span> <span class="token punctuation">{</span>  </span>
<span class="line">    collection <span class="token operator">:=</span> mongoManager<span class="token punctuation">.</span><span class="token function">GetCollection</span><span class="token punctuation">(</span>databaseName<span class="token punctuation">,</span> collectionName<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Collection<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">{</span>Collection<span class="token punctuation">:</span> collection<span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="slow-쿼리-로깅" tabindex="-1"><a class="header-anchor" href="#slow-쿼리-로깅"><span>slow 쿼리 로깅</span></a></h3><p>이전에 생성한 <code>Collection</code> 객체의 메서드로 각 쿼리 함수를 래핑하여, 여기에 slow 쿼리 로깅을 할 수 있도록 했습니다(이해를 돕기 위해 따로 함수 추출은 하지 않음).</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">const</span> slowQueryLimit <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second <span class="token comment">// slow 쿼리 기준 값</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>col <span class="token operator">*</span>Collection<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">findAll</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> filter <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> opts <span class="token operator">...</span><span class="token operator">*</span>options<span class="token punctuation">.</span>FindOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>mongo<span class="token punctuation">.</span>Cursor<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    startTime <span class="token operator">:=</span> time<span class="token punctuation">.</span><span class="token function">Now</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    cursor<span class="token punctuation">,</span> err <span class="token operator">:=</span> col<span class="token punctuation">.</span>Collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">// slow 쿼리 로깅</span></span>
<span class="line">    <span class="token keyword">if</span> time<span class="token punctuation">.</span><span class="token function">Since</span><span class="token punctuation">(</span>startTime<span class="token punctuation">)</span> <span class="token operator">&gt;</span> slowQueryLimit <span class="token punctuation">{</span></span>
<span class="line">        log<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">&quot;%s, filter: %+v&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;findAll&quot;</span><span class="token punctuation">,</span> filter<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> singleResult</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="시간-초과-처리" tabindex="-1"><a class="header-anchor" href="#시간-초과-처리"><span>시간 초과 처리</span></a></h3><p>또한, DB 응답이 없으면 시간 초과 error를 내면서 함수를 종료하도록 해야 했습니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">const</span> timeoutLimit <span class="token operator">=</span> <span class="token number">15</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second <span class="token comment">// 시간 초과 기준 값</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>col <span class="token operator">*</span>Collection<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">FindAll</span><span class="token punctuation">(</span>filter <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> opts <span class="token operator">...</span><span class="token operator">*</span>options<span class="token punctuation">.</span>FindOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    ctx<span class="token punctuation">,</span> ctxCancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeoutLimit<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> <span class="token function">ctxCancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    cursor<span class="token punctuation">,</span> err <span class="token operator">:=</span> col<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Golang의 내장 라이브러리인 <code>context</code>를 활용하여 , 기준 시간 동안 <code>findAll</code>의 결과가 없으면 <code>err</code> 변수에 <code>context Deadline exceed</code>라는 error가 나오도록 했습니다(<a href="https://www.mongodb.com/docs/drivers/go/current/fundamentals/connections/connection-guide/" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-mongodb" sizing="height"></i>MongoDB Golang 클라이언트 설정</a>으로 글로벌하게 설정할 수도 있습니다). 시간 초과 설정에 대한 더 자세한 내용은 <a href="https://www.mongodb.com/docs/drivers/go/current/fundamentals/context/" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-mongodb" sizing="height"></i>MongoDB Go Driver 문서</a>를 참고하시기 바랍니다.</p><h3 id="디코딩-및-error-타입-생성" tabindex="-1"><a class="header-anchor" href="#디코딩-및-error-타입-생성"><span>디코딩 및 error 타입 생성</span></a></h3><p>모든 error에 대한 정의는 끝났으니, 이제는 error 타입을 매핑해야 했습니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token function">ParseAndReturnDBError</span><span class="token punctuation">(</span>err <span class="token builtin">error</span><span class="token punctuation">,</span> collection <span class="token builtin">string</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> doc <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> mongo<span class="token punctuation">.</span>ErrNoDocuments<span class="token punctuation">)</span> <span class="token operator">||</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> NotMatchedAnyErr<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">NotFoundError</span><span class="token punctuation">(</span>collection<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> doc<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> mongo<span class="token punctuation">.</span><span class="token function">IsDuplicateKeyError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">DuplicatedKeyError</span><span class="token punctuation">(</span>collection<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> doc<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">if</span> mongo<span class="token punctuation">.</span><span class="token function">IsTimeout</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">||</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> context<span class="token punctuation">.</span>DeadlineExceeded<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token function">TimeoutError</span><span class="token punctuation">(</span>collection<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> doc<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    <span class="token keyword">return</span> <span class="token function">InternalError</span><span class="token punctuation">(</span>collection<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> doc<span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>err</code> 변수를 받아서 각각 정의한 error 객체를 매핑하여 반환하도록 함수를 만들고, 다음과 같이 실제 쿼리 결과 함수에 적용했습니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>col <span class="token operator">*</span>Collection<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">FindAll</span><span class="token punctuation">(</span>filter <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> opts <span class="token operator">...</span><span class="token operator">*</span>options<span class="token punctuation">.</span>FindOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    ctx<span class="token punctuation">,</span> ctxCancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timeoutLimit<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">defer</span> <span class="token function">ctxCancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    cursor<span class="token punctuation">,</span> err1 <span class="token operator">:=</span> col<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token function">ParseAndReturnDBError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> col<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    resultSlice<span class="token punctuation">,</span> err2 <span class="token operator">:=</span> DecodeCursor<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span>cursor<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token function">DecodeError</span><span class="token punctuation">(</span>col<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> resultSlice<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>쿼리 결과에서 나온 <code>err1</code> 변수에는 쿼리에서 발생한 error가 담기며, 이를 넘겨서 분류에 따른 error가 반환되게 했습니다.</p><p>쿼리에서 발생한 error가 없다면 커서를 받아서 디코딩하고, 디코딩에서 나온 <code>err2</code>는 <code>DecodeError</code>로 매핑했습니다. 커서에서 <code>DecodeError</code>는 struct의 타입이 정상적이라면 거의 나오지 않습니다.</p><p>하지만 <code>singleResult</code>에서는 디코딩할 때 총 <strong>3가지 error를 따로 분류</strong>해야 했습니다.</p><ul><li>no document found</li><li>deadline exceed</li><li>duplicated key error(replace, update 등에서 발생)</li></ul><p>위 error는 따로 처리하여 <code>DecodeError</code>로 분류되지 않도록 했습니다.</p><details class="hint-container details"><summary>적용 코드</summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>col <span class="token operator">*</span>Collection<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">FindOneAndModify</span><span class="token punctuation">(</span>filter <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> update <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> opts <span class="token operator">...</span><span class="token operator">*</span>options<span class="token punctuation">.</span>FindOneAndUpdateOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>T<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">    singleResult <span class="token operator">:=</span> col<span class="token punctuation">.</span><span class="token function">findOneAndModify</span><span class="token punctuation">(</span>commonHead<span class="token punctuation">,</span> ctx<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">    doc<span class="token punctuation">,</span> err <span class="token operator">:=</span> EvaluateAndDecodeSingleResult<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">(</span>singleResult<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">if</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>mongo<span class="token punctuation">.</span>ErrNoDocuments<span class="token punctuation">)</span> <span class="token operator">||</span> errors<span class="token punctuation">.</span><span class="token function">Is</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> context<span class="token punctuation">.</span>DeadlineExceeded<span class="token punctuation">)</span> <span class="token operator">||</span> mongo<span class="token punctuation">.</span><span class="token function">IsDuplicateKeyError</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorType<span class="token punctuation">.</span><span class="token function">ParseAndReturnDBError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> col<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">        <span class="token punctuation">}</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorType<span class="token punctuation">.</span><span class="token function">DecodeError</span><span class="token punctuation">(</span>col<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> doc<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>대부분의 DB CRUD에서의 시간 초과, slow 쿼리 로깅, error 분류까지 모두 마쳤지만, 한 가지 남은 고민이 있었습니다.</p><h3 id="error-분류에-대한-고민" tabindex="-1"><a class="header-anchor" href="#error-분류에-대한-고민"><span>error 분류에 대한 고민</span></a></h3><p>update, delete의 결과 <code>MatchedCount</code>/<code>ModifiedCount</code> 값이 <strong>0이면 error로 봐야하는지</strong> 고민해볼 필요가 있었습니다.</p><p>멱등성 관점에서는 다음과 같이 볼 수 있습니다.</p><ul><li>delete의 경우, 지우려는 대상이 없다는 것은(<code>MatchedCount == 0</code>) <strong>해당 값이 DB에 없는 정상적인 상황</strong>이다.</li><li>update의 경우, 수정된 대상이 없다는 것은(<code>MatchedCount ≠ 0 &amp; ModifiedCount == 0</code>) <strong>해당 값이 이미 update 요청한 값</strong>이다.</li></ul><p>하지만 비즈니스 로직마다 관점이 다르므로, 멱등성 관점만 고려하여 error로 보지 않기는 어려울 것 같았습니다.</p><p>그래서 팀 내 리뷰 시간에 이와 같은 고민을 나눴고, 다음과 같은 이유로 <strong><code>not matched</code>는 <code>not found</code>로 남겨두고, <code>not modified</code>는 error는 보지 않기로 결론</strong> 내렸습니다.</p><ul><li><code>not matched</code>의 경우, 대부분의 <strong>사용자(개발자)는 update/delete 쿼리를 사용할 때 해당 값이 있는 것을 기대하고 사용</strong>하기 때문에, <strong><code>not found</code>에 대한 error 처리가 필요</strong>할 수도 있다(삭제된 개수가 0인 경우도 <code>not found</code>로 간주).</li><li><code>not modified</code>의 경우, <strong>이미 해당 값으로 db에 저장되어 있다</strong>는 것이기 때문에, <strong>사용자의 기대 혹은 의도와 일치</strong>하므로 error 처리가 필요하지 않다.</li></ul><details class="hint-container details"><summary>반영된 코드</summary><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">var</span> NotMatchedAnyErr <span class="token operator">=</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">&quot;no documents have been matched&quot;</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>col <span class="token operator">*</span>Collection<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">UpdateOne</span><span class="token punctuation">(</span>filter <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> update <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> opts <span class="token operator">...</span><span class="token operator">*</span>options<span class="token punctuation">.</span>UpdateOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>mongo<span class="token punctuation">.</span>UpdateResult<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">    updateResult<span class="token punctuation">,</span> err <span class="token operator">:=</span> col<span class="token punctuation">.</span><span class="token function">updateOne</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorType<span class="token punctuation">.</span><span class="token function">ParseAndReturnDBError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> col<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> updateResult<span class="token punctuation">.</span>MatchedCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;</span> updateResult<span class="token punctuation">.</span>UpsertedCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> updateResult<span class="token punctuation">,</span> errorType<span class="token punctuation">.</span><span class="token function">ParseAndReturnDBError</span><span class="token punctuation">(</span>errorType<span class="token punctuation">.</span>NotMatchedAnyErr<span class="token punctuation">,</span> col<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> update<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> updateResult<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>col <span class="token operator">*</span>Collection<span class="token punctuation">[</span>T<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token function">DeleteOne</span><span class="token punctuation">(</span>filter <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> opts <span class="token operator">...</span><span class="token operator">*</span>options<span class="token punctuation">.</span>DeleteOptions<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>mongo<span class="token punctuation">.</span>DeleteResult<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">    deleteResult<span class="token punctuation">,</span> err <span class="token operator">:=</span> col<span class="token punctuation">.</span><span class="token function">deleteOne</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> filter<span class="token punctuation">,</span> opts<span class="token operator">...</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> errorType<span class="token punctuation">.</span><span class="token function">ParseAndReturnDBError</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> col<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">if</span> deleteResult<span class="token punctuation">.</span>DeletedCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> deleteResult<span class="token punctuation">,</span> errorType<span class="token punctuation">.</span><span class="token function">ParseAndReturnDBError</span><span class="token punctuation">(</span>errorType<span class="token punctuation">.</span>NotMatchedAnyErr<span class="token punctuation">,</span> col<span class="token punctuation">.</span><span class="token function">Name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filter<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> deleteResult<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></details><p>여기서 조심해야 하는 부분은, update에서 <strong>upsert가 수행된 경우에는 MatchedCount가 0</strong>이 된다는 것입니다. 이때 <code>UpsertedCount</code>는 양수인데 이 값까지 확인하지 않으면 not found error로 분류될 수 있으므로 주의가 필요합니다.</p><hr><h2 id="마치며" tabindex="-1"><a class="header-anchor" href="#마치며"><span>마치며</span></a></h2><p>로그는 어디서 남겨야 하는가, 어느 레벨로 남겨야 하는가 하는 고민에서 시작된, 가장 하위 레이어인 DB 레이어를 개편한 과정이었습니다.</p><p>결국 위에 대한 고민에 대한 답은, 여기서는 판단이 불가하기 때문에 &#39;<strong>DB 레이어에서는 로그를 남기지 않는다</strong>&#39;입니다. 대신 다음과 같은 장치를 마련하여, 로그를 남기지 않더라도 충분한 기능을 제공하도록 했습니다.</p><ul><li>DB 레이어에서는 로그를 남기지 않고 DB 쿼리 실행 정보와 error를 래핑하여 반환한다.</li><li><code>error</code> 값이 <code>nil</code>이면, 반환되는 값(document)은 <code>nil</code>이 아니며 쿼리 성공을 보장한다.</li><li>DB 레이어 내부에서 정의한 error를 처리하고 로그 레벨을 판단해 로그를 남길 수 있도록 error 타입을 정의하고 판별 함수를 제공한다.</li></ul><p>그리고 <strong>각 서버마다 구현했던 다음과 같은 부분을 공통 저장소로 옮겨 일관되게 로직을 수행하고 error를 분류</strong>하게 했습니다.</p><ul><li>collection 객체 singleton 유지</li><li>slow 쿼리 로깅</li><li>시간 초과 처리</li><li>singleResult, Cursor 등 디코딩</li></ul><figure><img src="/bookshelf/assets/image/d2.naver.com/6178029/2.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>그 결과 V2 코드는 다음과 같이 줄어들었습니다.</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go"><pre><code class="language-go"><span class="line"><span class="token keyword">type</span> MyCollectionManager <span class="token keyword">struct</span> <span class="token punctuation">{</span>  </span>
<span class="line">    collection <span class="token operator">*</span>commonMongoDB<span class="token punctuation">.</span>Collection<span class="token punctuation">[</span>MyDocument<span class="token punctuation">]</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">MyCollection</span><span class="token punctuation">(</span>client <span class="token operator">*</span>mongo<span class="token punctuation">.</span>Client<span class="token punctuation">)</span> <span class="token operator">*</span>MyCollectionManager <span class="token punctuation">{</span>  </span>
<span class="line">    manager <span class="token operator">:=</span> <span class="token operator">&amp;</span>MyCollectionManager<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line">    dbConfig <span class="token operator">:=</span> config<span class="token punctuation">.</span><span class="token function">GetDatabaseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    manager<span class="token punctuation">.</span>collection <span class="token operator">=</span> commonMongoDB<span class="token punctuation">.</span>MakeCollection<span class="token punctuation">[</span>MyDocument<span class="token punctuation">]</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> dbConfig<span class="token punctuation">.</span>DatabaseName<span class="token punctuation">,</span> <span class="token string">&quot;myCollection&quot;</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">return</span> manager</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>manager <span class="token operator">*</span>MyCollectionManager<span class="token punctuation">)</span> <span class="token function">GetDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>MyDocument<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">    filter <span class="token operator">:=</span> bson<span class="token punctuation">.</span>M<span class="token punctuation">{</span><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">    doc<span class="token punctuation">,</span> err <span class="token operator">:=</span> manager<span class="token punctuation">.</span>collection<span class="token punctuation">.</span><span class="token function">FindOne</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>filter<span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err</span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">    <span class="token keyword">return</span> doc<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>다음 글에서는 여기서 발생한 error를 상위에 어떻게 전달할 수 있을지에 대한 고민을 이야기해보려 합니다.</p><hr><h2 id="참고" tabindex="-1"><a class="header-anchor" href="#참고"><span>참고</span></a></h2><p>slow 쿼리 로깅과 같은 부분은 monitor 혹은 logger를 이용하면 좀 더 정확하고 실제 MongoDB raw query를 받아 볼 수도 있으니, 관심이 있다면 참고하시기 바랍니다.</p><a class="vp-card" href="https://pkg.go.dev/go.mongodb.org/mongo-driver/event" target="_blank" style="background:rgba(r,g,b,0.2);"><img class="vp-card-logo" src="/bookshelf/logo" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">title</div><hr><div class="vp-card-desc">desc</div></div></a><a class="vp-card" href="https://www.mongodb.com/docs/drivers/go/current/fundamentals/logging/" target="_blank" style="background:rgba(r,g,b,0.2);"><img class="vp-card-logo" src="/bookshelf/logo" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">title</div><hr><div class="vp-card-desc">desc</div></div></a></div><!----><!----><!----></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/chanhi2000/articles/edit/main/src/d2.naver.com/6178029.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/bookshelf/programming/go/articles/" aria-label="/programming/go/articles/"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->/programming/go/articles/</div></a><a class="route-link auto-link next" href="/bookshelf/d2.naver.com/2690202.html" aria-label="Golang, 그대들은 어떻게 할 것인가 - 3. error 래핑"><div class="hint">Next<span class="arrow end"></span></div><div class="link">Golang, 그대들은 어떻게 할 것인가 - 3. error 래핑<i class="vp-icon fa-brands fa-golang" sizing="height"></i></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">MIT Licensed | Copyright © 2022-present <a href="https://github.com/chanhi2000">Chan Hee Lee</a></div><!----></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/bookshelf/assets/app-BVguHYKu.js" defer></script>
  </body>
</html>
