<!doctype html>
<html lang="ko-KR" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.24" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.94" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Virtual Thread의 기본 개념 이해하기","image":["https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/1203723/1.png","https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/1203723/2.png","https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/1203723/3.png","https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/1203723/4.png","https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/1203723/5.png","https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/1203723/6.png","https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/1203723/7.png","https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/1203723/8.png","https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/1203723/9.png"],"dateModified":null,"author":[]}</script><meta property="og:url" content="https://chanhi2000.github.io/bookshelf/d2.naver.com/1203723.html"><meta property="og:site_name" content="📚Bookshelf"><meta property="og:title" content="Virtual Thread의 기본 개념 이해하기"><meta property="og:description" content="Article(s) > Virtual Thread의 기본 개념 이해하기"><meta property="og:type" content="article"><meta property="og:image" content="https://chanhi2000.github.io/bookshelf/assets/image/d2.naver.com/1203723/1.png"><meta property="og:locale" content="ko-KR"><meta property="article:tag" content="virtual-tread"><meta property="article:tag" content="jni"><meta property="article:tag" content="c++"><meta property="article:tag" content="cpp"><meta property="article:tag" content="spring"><meta property="article:tag" content="java"><meta property="article:tag" content="d2.naver.com"><meta property="article:tag" content="blog"><link rel="icon" href="/bookshelf/assets/icon/favicon.svg"><title>Virtual Thread의 기본 개념 이해하기 | 📚Bookshelf</title><meta name="description" content="Article(s) > Virtual Thread의 기본 개념 이해하기">
    <link rel="preload" href="/bookshelf/assets/style-DmRYlEXZ.css" as="style"><link rel="stylesheet" href="/bookshelf/assets/style-DmRYlEXZ.css">
    
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/bookshelf/" aria-label="Take me home"><img class="vp-nav-logo" src="/bookshelf/assets/icon/favicon.svg" alt><!----><span class="vp-site-name hide-in-pad">📚Bookshelf</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/bookshelf/news.html" aria-label><!--[--><i class="vp-icon fas fa-rss" sizing="height"></i><!--]--><!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label><!--[--><i class="vp-icon fas fa-keyboard" sizing="height"></i><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/hackingwithswift.com/" aria-label="hackingwithswift.com"><!--[--><img class="vp-icon" src="https://hackingwithswift.com/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->hackingwithswift.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/fcc/" aria-label="freecodecamp.org"><!--[--><img class="vp-icon" src="https://cdn.freecodecamp.org/universal/favicons/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->freecodecamp.org<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/kodeco.com/" aria-label="kodeco.com"><!--[--><img class="vp-icon" src="https://kodeco.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->kodeco.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.kotzilla.io/" aria-label="blog.kotzilla.io"><!--[--><img class="vp-icon" src="https://blog.kotzilla.io/hubfs/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->blog.kotzilla.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/kt.academy/" aria-label="kt.academy"><!--[--><img class="vp-icon" src="https://kt.academy/logo.png" alt aria-hidden no-view sizing="both"><!--]-->kt.academy<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/droidcon.com/" aria-label="droidcon.com"><!--[--><img class="vp-icon" src="https://droidcon.com/wp-content/uploads/2021/07/favicon-300x300.png" alt aria-hidden no-view sizing="both"><!--]-->droidcon.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/outcomeschool.com/" aria-label="outcomeschool.com"><!--[--><img class="vp-icon" src="https://outcomeschool.com/static/favicons/apple-touch-icon.png" alt aria-hidden no-view sizing="both"><!--]-->outcomeschool.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/frontendmasters.com/" aria-label="frontendmasters.com"><!--[--><img class="vp-icon" src="https://frontendmasters.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->frontendmasters.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/css-tricks.com/" aria-label="css-tricks.com"><!--[--><img class="vp-icon" src="https://css-tricks.com/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->css-tricks.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/smashingmagazine.com/" aria-label="smashingmagazine.com"><!--[--><img class="vp-icon" src="https://smashingmagazine.com/images/favicon/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->smashingmagazine.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.logrocket.com/" aria-label="blog.logrocket.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/blog.logrocket.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->blog.logrocket.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/realpython.com/" aria-label="realpython.com"><!--[--><img class="vp-icon" src="https://realpython.com/static/favicon.68cbf4197b0c.png" alt aria-hidden no-view sizing="both"><!--]-->realpython.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/digitalocean.com/" aria-label="digitalocean.com"><!--[--><img class="vp-icon" src="https://digitalocean.com/_next/static/media/favicon.594d6067.ico" alt aria-hidden no-view sizing="both"><!--]-->digitalocean.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/antonioleiva.com/" aria-label="antonioleiva.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/antonioleiva.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->antonioleiva.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/johnnyreilly.com/" aria-label="johnnyreilly.com"><!--[--><img class="vp-icon" src="https://johnnyreilly.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->johnnyreilly.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/code-maze.com/" aria-label="code-maze.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/code-maze.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->code-maze.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/milanjovanovic.tech/" aria-label="milanjovanovic.tech"><!--[--><img class="vp-icon" src="https://milanjovanovic.tech/profile_favicon.png" alt aria-hidden no-view sizing="both"><!--]-->milanjovanovic.tech<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/shopify.engineering/" aria-label="shopify.engineering"><!--[--><img class="vp-icon" src="https://cdn.shopify.com/static/shopify-favicon.png" alt aria-hidden no-view sizing="both"><!--]-->shopify.engineering<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/devtoolstips.org/" aria-label="devtoolstips.org"><!--[--><img class="vp-icon" src="https://devtoolstips.org/assets/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->devtoolstips.org<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/piccalil.li/" aria-label="piccalil.li"><!--[--><img class="vp-icon" src="https://piccalil.li/favicons/apple-touch-icon.png" alt aria-hidden no-view sizing="both"><!--]-->piccalil.li<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/sitepoint.com/" aria-label="sitepoint.com"><!--[--><img class="vp-icon" src="https://sitepoint.com/favicons/512x512.png" alt aria-hidden no-view sizing="both"><!--]-->sitepoint.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/event-driven.io/" aria-label="event-driven.io"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/event-driven.io/favicon.jfif" alt aria-hidden no-view sizing="both"><!--]-->event-driven.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/packagemain.tech/" aria-label="packagemain.tech"><!--[--><img class="vp-icon" src="https://substack-post-media.s3.amazonaws.com/public/images/2ea54e25-eaa6-4630-bfc0-10b8cfdce894/apple-touch-icon-1024x1024.png" alt aria-hidden no-view sizing="both"><!--]-->packagemain.tech<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/gosolve.io/" aria-label="gosolve.io"><!--[--><img class="vp-icon" src="https://gosolve.io/wp-content/uploads/2022/03/cropped-ikona1-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->gosolve.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/towardsdatascience.com/" aria-label="towardsdatascience.com"><!--[--><img class="vp-icon" src="https://cdn-images-1.medium.com/v2/resize:fill:128:128/1*VzTUkfeGymHP4Bvav-T-lA.png" alt aria-hidden no-view sizing="both"><!--]-->towardsdatascience.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/douggregor.net/" aria-label="douggregor.net"><!--[--><i class="vp-icon fas fa-globe" sizing="both"></i><!--]-->douggregor.net<!----></a></li><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/bookshelf/d2.naver.com/" aria-label="d2.naver.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/d2.naver.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->d2.naver.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tech.kakao.com/" aria-label="tech.kakao.com"><!--[--><img class="vp-icon" src="https://www.kakaocorp.com/page/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tech.kakao.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tech.kakaopay.com/" aria-label="tech.kakaopay.com"><!--[--><img class="vp-icon" src="https://tech.kakaopay.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tech.kakaopay.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/fe-developers.kakaoent.com/" aria-label="fe-developers.kakaoent.com"><!--[--><img class="vp-icon" src="https://fe-developers.kakaoent.com/favicon-32x32.png?v=44803cb16c1e2debd3984cf2e8cb2ded" alt aria-hidden no-view sizing="both"><!--]-->fe-developers.kakaoent.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/yozm.wishket.com/" aria-label="yozm.wishket.com"><!--[--><img class="vp-icon" src="https://yozm.wishket.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->yozm.wishket.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/popit.kr/" aria-label="popit.kr"><!--[--><img class="vp-icon" src="https://popit.kr/wp-content/uploads/2016/08/favicon_32x32.png" alt aria-hidden no-view sizing="both"><!--]-->popit.kr<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/devkuma.com/" aria-label="devkuma.com"><!--[--><img class="vp-icon" src="https://devkuma.com/favicons/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->devkuma.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.gangnamunni.com/" aria-label="blog.gangnamunni.com"><!--[--><img class="vp-icon" src="https://blog.gangnamunni.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->blog.gangnamunni.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/codingeverybody.kr/" aria-label="codingeverybody.kr"><!--[--><img class="vp-icon" src="https://codingeverybody.kr/wp-content/uploads/cropped-favicon-origin-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->codingeverybody.kr<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label><!--[--><i class="vp-icon fas fa-network-wired" sizing="height"></i><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tecmint.com/" aria-label="tecmint.com"><!--[--><img class="vp-icon" src="https://tecmint.com/wp-content/uploads/2020/07/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tecmint.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/docker.com/" aria-label="docker.com"><!--[--><img class="vp-icon" src="https://docker.com/app/uploads/2024/02/cropped-docker-logo-favicon-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->docker.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/learnk8s.io/" aria-label="learnk8s.io"><!--[--><img class="vp-icon" src="https://static.learnk8s.io/f7e5160d4744cf05c46161170b5c11c9.svg" alt aria-hidden no-view sizing="both"><!--]-->learnk8s.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/itsfoss.com/" aria-label="itsfoss.com"><!--[--><img class="vp-icon" src="https://itsfoss.com/content/images/size/w256h256/2022/12/android-chrome-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->itsfoss.com<!----></a></li></ul></button></div></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/chanhi2000/articles" target="_blank" rel="noopener noreferrer" aria-label="Github"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-appearance-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-appearance-dropdown"><!----></div></button></div><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><img class="vp-icon" src="/bookshelf/assets/image/d2.naver.com/favicon.ico" alt aria-hidden no-view sizing="both"><span class="vp-sidebar-title">d2.naver.com</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/6532276.html" aria-label="User-Agent Client Hints의 도입, UA 프리징을 대비하라"><!--[--><i class="vp-icon fa-brands fa-node" sizing="both"></i><!--]-->User-Agent Client Hints의 도입, UA 프리징을 대비하라<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1329.html" aria-label="Java Garbage Collection"><!--[--><i class="vp-icon fa-brands fa-java" sizing="both"></i><!--]-->Java Garbage Collection<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1336.html" aria-label="WebSocket과 Socket.io"><!--[--><i class="vp-icon fa-brands fa-java" sizing="both"></i><!--]-->WebSocket과 Socket.io<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1341.html" aria-label="Spring-Test-MVC 프로젝트 소개"><!--[--><i class="vp-icon iconfont icon-spring" sizing="both"></i><!--]-->Spring-Test-MVC 프로젝트 소개<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/994.html" aria-label="AMIGO - 행위 기반 악성코드 탐지"><!--[--><i class="vp-icon fas fa-shield-halved" sizing="both"></i><!--]-->AMIGO - 행위 기반 악성코드 탐지<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1011.html" aria-label="Git vs. Mercurial"><!--[--><i class="vp-icon iconfont icon-git" sizing="both"></i><!--]-->Git vs. Mercurial<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1016.html" aria-label="Hadoop과 MongoDB를 이용한 로그분석시스템"><!--[--><i class="vp-icon iconfont icon-hadoop" sizing="both"></i><!--]-->Hadoop과 MongoDB를 이용한 로그분석시스템<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1039.html" aria-label="NoSQL 가용성과 운영 안정성"><!--[--><i class="vp-icon iconfont icon-apachecassandra" sizing="both"></i><!--]-->NoSQL 가용성과 운영 안정성<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1042.html" aria-label="분산 고속 저장소 nStore"><!--[--><i class="vp-icon fas fa-database" sizing="both"></i><!--]-->분산 고속 저장소 nStore<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1052.html" aria-label="RTCS 실시간 웹 서비스를 위한 도전"><!--[--><i class="vp-icon fa-brands fa-js" sizing="both"></i><!--]-->RTCS 실시간 웹 서비스를 위한 도전<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1062.html" aria-label="uMon의 이해"><!--[--><i class="vp-icon fas fa-pen-ruler" sizing="both"></i><!--]-->uMon의 이해<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/8842776.html" aria-label="HTTPS 전환 후 서버 메모리는 안녕한가요?"><!--[--><i class="vp-icon iconfont icon-shell" sizing="both"></i><!--]-->HTTPS 전환 후 서버 메모리는 안녕한가요?<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/0590136.html" aria-label="사용자의 액션에 반응하는 UI 라이브러리, eg.Axes"><!--[--><i class="vp-icon iconfont icon-typescript" sizing="both"></i><!--]-->사용자의 액션에 반응하는 UI 라이브러리, eg.Axes<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/0853669.html" aria-label="Kafka NetworkClient Internals"><!--[--><i class="vp-icon iconfont icon-apachekafka" sizing="both"></i><!--]-->Kafka NetworkClient Internals<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/6445508.html" aria-label="HDFS 쓰기 파이프라인을 활용한 HBase의 WAL 쓰기 최적화"><!--[--><i class="vp-icon fa-brands fa-java" sizing="both"></i><!--]-->HDFS 쓰기 파이프라인을 활용한 HBase의 WAL 쓰기 최적화<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/8404108.html" aria-label="프로파일링 적용기 - 당신의 Go 애플리케이션은 좀 더 나아질 수 있다"><!--[--><i class="vp-icon fa-brands fa-golang" sizing="both"></i><!--]-->프로파일링 적용기 - 당신의 Go 애플리케이션은 좀 더 나아질 수 있다<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/bookshelf/d2.naver.com/1203723.html" aria-label="Virtual Thread의 기본 개념 이해하기"><!--[--><i class="vp-icon iconfont icon-spring" sizing="both"></i><!--]-->Virtual Thread의 기본 개념 이해하기<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/9581727.html" aria-label="일 3,000만 건의 네이버페이 주문 메시지를 처리하는 Kafka 시스템의 무중단 전환 사례"><!--[--><i class="vp-icon iconfont icon-apachekafka" sizing="both"></i><!--]-->일 3,000만 건의 네이버페이 주문 메시지를 처리하는 Kafka 시스템의 무중단 전환 사례<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/8588537.html" aria-label="Golang, 그대들은 어떻게 할 것인가 - 1. 들어가며"><!--[--><i class="vp-icon fa-brands fa-golang" sizing="both"></i><!--]-->Golang, 그대들은 어떻게 할 것인가 - 1. 들어가며<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/6178029.html" aria-label="Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화"><!--[--><i class="vp-icon fa-brands fa-golang" sizing="both"></i><!--]-->Golang, 그대들은 어떻게 할 것인가 - 2. MongoDB Go Driver 추상화<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/2690202.html" aria-label="Golang, 그대들은 어떻게 할 것인가 - 3. error 래핑"><!--[--><i class="vp-icon fa-brands fa-golang" sizing="both"></i><!--]-->Golang, 그대들은 어떻게 할 것인가 - 3. error 래핑<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/6507662.html" aria-label="Golang, 그대들은 어떻게 할 것인가 - 4. error 핸들링"><!--[--><i class="vp-icon fa-brands fa-golang" sizing="both"></i><!--]-->Golang, 그대들은 어떻게 할 것인가 - 4. error 핸들링<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/8113611.html" aria-label="네이버 통합 검색의 웹 성능 - 모니터링과 성능 개선"><!--[--><i class="vp-icon fas fa-gauge" sizing="both"></i><!--]-->네이버 통합 검색의 웹 성능 - 모니터링과 성능 개선<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/2461452.html" aria-label="UX 원칙에 따른 NELO 4.0 개발기"><!--[--><i class="vp-icon fas fa-pen-ruler" sizing="both"></i><!--]-->UX 원칙에 따른 NELO 4.0 개발기<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/5564264.html" aria-label="쿠버네티스 네이티브 사이드카 컨테이너 (Sidecar Containers)"><!--[--><i class="vp-icon iconfont icon-k8s" sizing="both"></i><!--]-->쿠버네티스 네이티브 사이드카 컨테이너 (Sidecar Containers)<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/7472830.html" aria-label="infer, never만 보면 두려워지는 당신을 위한 고급 TypeScript"><!--[--><i class="vp-icon iconfont icon-typescript" sizing="both"></i><!--]-->infer, never만 보면 두려워지는 당신을 위한 고급 TypeScript<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/0680815.html" aria-label="실시간 광고 사용자 ID 매핑"><!--[--><i class="vp-icon iconfont icon-apachespark" sizing="both"></i><!--]-->실시간 광고 사용자 ID 매핑<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/0623656.html" aria-label="DESIGN SYSTEM FOR Android: From Figma to Jetpack Compose"><!--[--><i class="vp-icon fa-brands fa-figma" sizing="both"></i><!--]-->DESIGN SYSTEM FOR Android: From Figma to Jetpack Compose<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/7030870.html" aria-label="디자인시스템을 개발에서 적용 하는법"><!--[--><i class="vp-icon fa-brands fa-figma" sizing="both"></i><!--]-->디자인시스템을 개발에서 적용 하는법<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/8011540.html" aria-label="Writing Path: MBTI J처럼 체계적으로 글쓰는 AI"><!--[--><i class="vp-icon fas fa-language" sizing="both"></i><!--]-->Writing Path: MBTI J처럼 체계적으로 글쓰는 AI<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/2905424.html" aria-label="Kubernetes에서 DNS 다루는 방법 - 도메인을 찾아서"><!--[--><i class="vp-icon iconfont icon-k8s" sizing="both"></i><!--]-->Kubernetes에서 DNS 다루는 방법 - 도메인을 찾아서<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/7282210.html" aria-label="보낼 로그가 1000개가 되는동안 겪었던 고민들"><!--[--><i class="vp-icon fa-brands fa-android" sizing="both"></i><!--]-->보낼 로그가 1000개가 되는동안 겪었던 고민들<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/7321313.html" aria-label="시간은 금이다: LLM을 이용한 AI 코드 리뷰 도입기"><!--[--><i class="vp-icon fas fa-language" sizing="both"></i><!--]-->시간은 금이다: LLM을 이용한 AI 코드 리뷰 도입기<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/9283310.html" aria-label="infer, never만 보면 두려워지는 당신을 위한 타입 추론 - 기초 타입 이론"><!--[--><i class="vp-icon iconfont icon-typescript" sizing="both"></i><!--]-->infer, never만 보면 두려워지는 당신을 위한 타입 추론 - 기초 타입 이론<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/3713986.html" aria-label="infer, never만 보면 두려워지는 당신을 위한 타입 추론 - 고급 타입 추론"><!--[--><i class="vp-icon iconfont icon-typescript" sizing="both"></i><!--]-->infer, never만 보면 두려워지는 당신을 위한 타입 추론 - 고급 타입 추론<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/5088940.html" aria-label="infer, never만 보면 두려워지는 당신을 위한 타입 추론 - 응용 문제"><!--[--><i class="vp-icon iconfont icon-typescript" sizing="both"></i><!--]-->infer, never만 보면 두려워지는 당신을 위한 타입 추론 - 응용 문제<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/0281668.html" aria-label="네이버 검색 SRE - 상위 레벨 모니터링 시스템"><!--[--><i class="vp-icon fas fa-pen-ruler" sizing="both"></i><!--]-->네이버 검색 SRE - 상위 레벨 모니터링 시스템<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/1623894.html" aria-label="네이버 검색 SRE - 지진과 비상 대응 시스템"><!--[--><i class="vp-icon fas fa-pen-ruler" sizing="both"></i><!--]-->네이버 검색 SRE - 지진과 비상 대응 시스템<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/7989422.html" aria-label="실시간 광고 사용자 ID 매핑"><!--[--><i class="vp-icon fa-brands fa-python" sizing="both"></i><!--]-->실시간 광고 사용자 ID 매핑<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/d2.naver.com/8149881.html" aria-label="GitHub Actions를 이용한 코드 리뷰 문화 개선기"><!--[--><i class="vp-icon iconfont icon-github" sizing="both"></i><!--]-->GitHub Actions를 이용한 코드 리뷰 문화 개선기<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><i class="vp-icon iconfont icon-spring" sizing="height"></i>Virtual Thread의 기본 개념 이해하기</h1><div class="page-info"><!----><!----><!----><!----><span class="page-reading-time-info" aria-label="Reading Time⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 7 min</span><meta property="timeRequired" content="PT7M"></span><span class="page-category-info" aria-label="Category🌈" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color8" role>Java</span><span class="page-category-item color1" role>Spring</span><span class="page-category-item color6" role>C++</span><span class="page-category-item color4" role>Java Native Interface</span><span class="page-category-item color8" role>Article(s)</span><!--]--><meta property="articleSection" content="Java,Spring,C++,Java Native Interface,Article(s)"></span><span class="page-tag-info" aria-label="Tag🏷" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color8" role>blog</span><span class="page-tag-item color8" role>d2.naver.com</span><span class="page-tag-item color8" role>java</span><span class="page-tag-item color8" role>spring</span><span class="page-tag-item color4" role>cpp</span><span class="page-tag-item color8" role>c++</span><span class="page-tag-item color6" role>jni</span><span class="page-tag-item color4" role>virtual-tread</span><!--]--><meta property="keywords" content="blog,d2.naver.com,java,spring,cpp,c++,jni,virtual-tread"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><h1 id="frontmatter-title-관련" tabindex="-1"><a class="header-anchor" href="#frontmatter-title-관련"><span>Virtual Thread의 기본 개념 이해하기 관련</span></a></h1><a class="route-link vp-card" href="/bookshelf/programming/java-spring/articles/" style="background:rgba(10,10,10,0.2);"><img class="vp-card-logo" src="https://chanhi2000.github.io/images/ico-wind.svg" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">Spring > Article(s)</div><hr><div class="vp-card-desc">Article(s)</div></div></a><nav class="table-of-contents"><ul><li><a aria-current="page" href="/bookshelf/d2.naver.com/1203723.html#jni" class="router-link-active router-link-exact-active">JNI</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/1203723.html#java-스레드" class="router-link-active router-link-exact-active">Java 스레드</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/1203723.html#virtualthread-virtual-thread" class="router-link-active router-link-exact-active">virtualthread&quot;&gt;Virtual Thread</a><ul><li><a aria-current="page" href="/bookshelf/d2.naver.com/1203723.html#virtual-thread-concepts" class="router-link-active router-link-exact-active">Virtual Thread concepts</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/1203723.html#virtual-thread-states" class="router-link-active router-link-exact-active">Virtual Thread states</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/1203723.html#virtual-thread-pinning" class="router-link-active router-link-exact-active">Virtual Thread pinning</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/1203723.html#virtual-thread-blocking" class="router-link-active router-link-exact-active">Virtual Thread blocking</a></li></ul></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/1203723.html#마치며" class="router-link-active router-link-exact-active">마치며</a></li><li><a aria-current="page" href="/bookshelf/d2.naver.com/1203723.html#참고-자료" class="router-link-active router-link-exact-active">참고 자료</a></li></ul></nav><hr><div class="vp-site-info" data-name="Virtual Thread의 기본 개념 이해하기 | NAVER D2"><a class="vp-site-info-navigator no-external-link-icon" title="Virtual Thread의 기본 개념 이해하기 | NAVER D2" href="https://d2.naver.com/helloworld/1203723" target="_blank"></a><div class="vp-site-info-preview" style="background:url(/bookshelf/assets/image/d2.naver.com/1203723/banner.png) center/cover no-repeat;"></div><div class="vp-site-info-detail"><img class="vp-site-info-logo" src="/assets/image/d2.naver.com/favicon.ico" alt loading="lazy" no-view><div class="vp-site-info-name">Virtual Thread의 기본 개념 이해하기 | NAVER D2</div><div class="vp-site-info-desc">Virtual Thread의 기본 개념 이해하기</div></div><!----></div><div></div><p>JDK에 정식 도입된 Virtual Thread는 기존의 KLT(kernel-level thread)와 ULT(user-level thread)를 1:1 매핑하여 사용하는 JVM의 스레드 모델을 개선한, 여러 개의 가상 스레드를 하나의 네이티브 스레드에 할당하여 사용하는 모델입니다. 이 글에서는 Virtual Thread가 기존 스레드 모델과 어떤 점이 다른지 알아보겠습니다.</p><h2 id="jni" tabindex="-1"><a class="header-anchor" href="#jni"><span>JNI</span></a></h2><p>Java Native Interface(이하 JNI)는 C, C++처럼 인터프리터 없이 OS가 바로 읽을 수 있는 형태의 네이티브 코드를 JVM이 호출할 수 있게 하는 인터페이스다. 쉽게 말해, JVM에서 다른 언어를 사용할 수 있게 한다. 이 JNI 덕분에 Java가 머신 플랫폼에 상관없이 동작할 수 있다. 이 호출은 Java에서 메서드 앞에 <code>native</code> 키워드를 붙여 해당 메서드가 JNI를 사용함을 나타낸다.</p><p>직접 사용하면서 이해해 보자(macOS 기준).</p><p>hoyoungjni라는 라이브러를 동적으로 읽어오게 하고, hyNativeMethod의 메서드는 JNI를 사용하도록 선언한다.</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>example</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HoyoungJNI</span> <span class="token punctuation">{</span>  </span>
<span class="line">  <span class="token keyword">public</span> <span class="token class-name">HoyoungJNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">hyNativeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var0<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">HoyoungJNI</span> var1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HoyoungJNI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    var1<span class="token punctuation">.</span><span class="token function">hyNativeMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">static</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">&quot;hoyoungjni&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>hyNativeMethod를 구현해 보자. 헤더 파일을 만든다.</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">javac HoyoungJNI.java</span>
<span class="line">javah <span class="token parameter variable">-classpath</span> <span class="token variable">${경로}</span> org.example.HoyoungJNI</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jni.h&gt;</span></span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_Included_org_example_HoyoungJNI</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_Included_org_example_HoyoungJNI</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span></span>
<span class="line"><span class="token keyword">extern</span> <span class="token string">&quot;C&quot;</span> <span class="token punctuation">{</span>  </span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"></span>
<span class="line">JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_org_example_HoyoungJNI_hyNativeMethod</span>  </span>
<span class="line">  <span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span><span class="token punctuation">,</span> jobject<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>이를 구현한다.</p><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;jni.h&gt;</span></span></span>
<span class="line"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;org_example_HoyoungJNI.h&quot;</span></span></span>
<span class="line"></span>
<span class="line">JNIEXPORT <span class="token keyword">void</span> JNICALL <span class="token function">Java_org_example_HoyoungJNI_hyNativeMethod</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">       <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">&quot;JNI는 이렇게 동작해요&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>컴파일한다.</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line">gcc -I<span class="token variable">$JAVA_HOME</span>/include -I<span class="token variable">$JAVA_HOME</span>/include/darwin -I<span class="token string">&quot;<span class="token variable">${만든javah헤더파일경로}</span>&quot;</span> <span class="token parameter variable">-shared</span> <span class="token parameter variable">-m64</span>  <span class="token variable">${경로}</span>/HoyoungJNI.c <span class="token parameter variable">-o</span> libhoyoungjni.dylib  </span>
<span class="line"><span class="token comment">#</span></span>
<span class="line"><span class="token comment"># The filename of a dynamic library normally contains the library’s name with the lib prefix and the .dylib extension</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>.<a href="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/DynamicLibraries/100-Articles/DynamicLibraryDesignGuidelines.html" target="_blank" rel="noopener noreferrer"><i class="vp-icon fa-brands fa-apple" sizing="height"></i>Dynamic Library Design Guidelines</a>의 다음 규약에 따라 앞의 <code>lib</code>와 뒤의 <code>.dylib</code>를 제외한 <code>hoyoungjni</code>가 라이브러리 이름으로 인식된다.</p><p>공유 라이브러리 파일을 만들었으니, 환경변수를 주입하여 실행해 보자.</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code class="language-bash"><span class="line"><span class="token comment"># JNI는 이렇게 동작해요</span></span>
<span class="line"><span class="token function">java</span> <span class="token parameter variable">-Djava.library.path</span><span class="token operator">=</span><span class="token variable">${dylib파일경로}</span>  <span class="token parameter variable">-classpath</span> <span class="token variable">${classpath}</span> org.example.HoyoungJNI</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>즉, 이렇게 JVM은 JNI를 사용하여 별도 인터프리터 없이 C로 작성된 코드를 실행한다.</p><h2 id="java-스레드" tabindex="-1"><a class="header-anchor" href="#java-스레드"><span>Java 스레드</span></a></h2><p>Java는 <code>java.util.concurrent.ExecutorService</code>를 두어 JVM 내부에서 스레드를 관리/실행한다. 여러 <code>ExecutorService</code> 중 <code>ThreadPoolExecutor</code>로 실제 스레드가 실행되는 부분만 간단히 살펴보자.</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token class-name">ThreadPoolExecutor</span> threadPoolExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Runnable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">threadPoolExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>submit</code>을 하면 무슨 일이 일어나는 걸까?</p><p>다음은 <code>ThreadPoolExecutor</code>의 <code>execute</code> 함수의 일부이다.</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * java.util.concurrent.ThreadPoolExecutor.java</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> command<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">  <span class="token keyword">int</span> c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">// 현재 RUNNUNG 상태인 스레드 수를 가져오고</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">workerCountOf</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&lt;</span> corePoolSize<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">addWorker</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token comment">// 풀 수보다 작으면 워커에 추가한다.</span></span>
<span class="line">      <span class="token keyword">return</span><span class="token punctuation">;</span></span>
<span class="line">    c <span class="token operator">=</span> ctl<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">addWorker</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> firstTask<span class="token punctuation">,</span> <span class="token keyword">boolean</span> core<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// ThreadPoolExecutor가 실행해도 된다고 판단하면</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>workerAdded<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    container<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 실행한다.</span></span>
<span class="line">    workerStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>워커에 추가된 스레드는 결국 <code>Thread.start</code>를 실행한다.</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * java.lang.Thread.java</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">start0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 실제 실행은 결국 JNI를 통한다.</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token comment">// zero status corresponds to state &quot;NEW&quot;.</span></span>
<span class="line">        <span class="token keyword">if</span> <span class="token punctuation">(</span>holder<span class="token punctuation">.</span>threadStatus <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span></span>
<span class="line">          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalThreadStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">        <span class="token function">start0</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>즉, <code>ExecutorService</code>의 스케줄링 정책에 따라 JNI로 스레드를 실행하는 방식이다.</p><p>JDK 21을 기준으로 살펴보자.</p><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/java.base/share/native/libjava/Thread.c#L39" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code> - <i class="vp-icon fas fa-folder-open" sizing="height"></i><code>/src/java.base/share/native/libjava/</code><i class="vp-icon iconfont icon-c" sizing="height"></i><code>Thread.c</code></a>)</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token keyword">static</span> JNINativeMethod methods<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>  </span>
<span class="line">  <span class="token punctuation">{</span><span class="token string">&quot;start0&quot;</span><span class="token punctuation">,</span>           <span class="token string">&quot;()V&quot;</span><span class="token punctuation">,</span>        <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_StartThread<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token punctuation">{</span><span class="token string">&quot;setPriority0&quot;</span><span class="token punctuation">,</span>     <span class="token string">&quot;(I)V&quot;</span><span class="token punctuation">,</span>       <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>JVM_SetThreadPriority<span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>start0</code>는 <code>JVM_StartThread</code> 메서드이고 <code>JavaThread</code>를 생성한다.</p><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/hotspot/share/prims/jvm.cpp#L2928" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code> - <i class="vp-icon fas fa-folder-open" sizing="height"></i><code>/src/hotspot/share/prims/</code><i class="vp-icon iconfont icon-cpp" sizing="height"></i><code>jvm.cpp</code></a>)</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token function">JVM_ENTRY</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">,</span> <span class="token function">JVM_StartThread</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject jthread<span class="token punctuation">)</span><span class="token punctuation">)</span>  </span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">  native_thread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">JavaThread</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread_entry<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">JVM_END</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>JavaThread</code>는 <code>Thread</code>의 하위 클래스이다.</p><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/hotspot/share/runtime/javaThread.hpp#L78" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code> - <i class="vp-icon fas fa-folder-open" sizing="height"></i><code>src/hotspot/share/runtime/</code><i class="vp-icon iconfont icon-cpp" sizing="height"></i><code>javaThread.hpp</code></a>)</p></blockquote><div class="language-cpp line-numbers-mode" data-highlighter="prismjs" data-ext="cpp"><pre><code class="language-cpp"><span class="line"><span class="token keyword">class</span> <span class="token class-name">JavaThread</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Thread</span></span> <span class="token punctuation">{</span>  </span>
<span class="line">  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">VMStructs</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">JVMCIVMStructs</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">WhiteBox</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>결국, Java 단의 <code>ExecutorService</code>를 통해 스케줄링되는 여러 <code>java.lang.Thread</code> 객체는 JVM에 존재하는 start0 함수를 JNI를 통해 호출하고, 각 머신 OS에 맞게 설치된 JVM은 커널 스레드를 만들어 실행한다. 이러한 네이티브 메서드 호출은 JVM 내에서 스택과 분리되어 있는 네이티브 메서드 스택을 사용한다.</p><figure><img src="/bookshelf/assets/image/d2.naver.com/1203723/1.png" alt="출처: https://usemynotes.com/what-is-jvm-jit/" tabindex="0" loading="lazy"><figcaption>출처: https://usemynotes.com/what-is-jvm-jit/</figcaption></figure><p>즉, 스케줄링은 Java에서, 실제 실행은 JNI를 통해 커널에서 실행된다. Java의 스레드 모델을 도식화하면 다음과 같다.</p><figure><img src="/bookshelf/assets/image/d2.naver.com/1203723/2.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>Heap에 존재하는 많은 ULT 중 하나가 JVM의 스케줄링에 따라 KLT에 매핑되어 실행하는 형태가 기존의 Java 스레드 모델이다.</p><h2 id="virtualthread-virtual-thread" tabindex="-1"><a class="header-anchor" href="#virtualthread-virtual-thread"><span>virtualthread&quot;&gt;Virtual Thread</span></a></h2><p>기존의 Java 스레드를 알아보았으니 이제 JDK 21에 새로 도입된 Virtual Thread를 알아보자.</p><h3 id="virtual-thread-concepts" tabindex="-1"><a class="header-anchor" href="#virtual-thread-concepts"><span>Virtual Thread concepts</span></a></h3><figure><img src="/bookshelf/assets/image/d2.naver.com/1203723/3.png" alt="출처: https://jenkov.com/tutorials/java-concurrency/java-virtual-threads.html" tabindex="0" loading="lazy"><figcaption>출처: https://jenkov.com/tutorials/java-concurrency/java-virtual-threads.html</figcaption></figure><p>Virtual Thread는 기존 KLT(1) : ULT(1)의 구조가 아닌 KLT(1) : ULT(1) : Virtual Thread(N)의 구조로 사용된다. KLT와 Virtual Thread 사이의 ULT는 플랫폼 스레드라고 한다.</p><p>위 그림과 같이 Heap에 수많은 Virtual Thread를 할당해놓고, 플랫폼 스레드에 대상 Virtual Thread를 마운트/언마운트하여 컨텍스트 스위칭을 수행한다. 따라서 컨텍스트 스위칭 비용이 작아질 수 밖에 없다.</p><figure><img src="/bookshelf/assets/image/d2.naver.com/1203723/4.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>스레드의 크기와 컨텍스트 스위칭 비용이 많이 감소한 모델이기 때문에 Spring MVC/Tomcat 등의 모델이 Netty/WebFlux에 비해 가진 단점이 많이 희석되었다.</p><h3 id="virtual-thread-states" tabindex="-1"><a class="header-anchor" href="#virtual-thread-states"><span>Virtual Thread states</span></a></h3><p>Virtual Thread에는 9개의 상태가 있다.</p><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/java.base/share/classes/java/lang/VirtualThread.java#L91" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code> - <i class="vp-icon fas fa-folder-open" sizing="height"></i><code>/src/java.base/share/classes/java/lang/</code><i class="vp-icon fa-brands fa-java" sizing="height"></i><code>VirtualThread.java</code></a>)</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token doc-comment comment">/**</span>
<span class="line"> * Virtual thread state and transitions:</span>
<span class="line"> *</span>
<span class="line"> *      NEW -&gt; STARTED         // Thread.start</span>
<span class="line"> *  STARTED -&gt; TERMINATED      // failed to start</span>
<span class="line"> *  STARTED -&gt; RUNNING         // first run</span>
<span class="line"> *</span>
<span class="line"> *  RUNNING -&gt; PARKING         // Thread attempts to park</span>
<span class="line"> *  PARKING -&gt; PARKED          // cont.yield successful, thread is parked</span>
<span class="line"> *  PARKING -&gt; PINNED          // cont.yield failed, thread is pinned</span>
<span class="line"> *</span>
<span class="line"> *   PARKED -&gt; RUNNABLE        // unpark or interrupted</span>
<span class="line"> *   PINNED -&gt; RUNNABLE        // unpark or interrupted</span>
<span class="line"> *</span>
<span class="line"> * RUNNABLE -&gt; RUNNING         // continue execution</span>
<span class="line"> *</span>
<span class="line"> *  RUNNING -&gt; YIELDING        // Thread.yield</span>
<span class="line"> * YIELDING -&gt; RUNNABLE        // yield successful</span>
<span class="line"> * YIELDING -&gt; RUNNING         // yield failed</span>
<span class="line"> *</span>
<span class="line"> *  RUNNING -&gt; TERMINATED      // done</span>
<span class="line"> */</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">NEW</span>      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STARTED</span>  <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RUNNABLE</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>     <span class="token comment">// runnable-unmounted</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">RUNNING</span>  <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>     <span class="token comment">// runnable-mounted</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PARKING</span>  <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PARKED</span>   <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>     <span class="token comment">// unmounted</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">PINNED</span>   <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>     <span class="token comment">// mounted</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">YIELDING</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>     <span class="token comment">// Thread.yield</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">TERMINATED</span> <span class="token operator">=</span> <span class="token number">99</span><span class="token punctuation">;</span>  <span class="token comment">// final state</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>다음과 같이 Virtual Thread의 상태에 따라 플랫폼 스레드에 마운트/언마운트해 실행을 관리한다.</p><figure><img src="/bookshelf/assets/image/d2.naver.com/1203723/5.png" alt="" tabindex="0" loading="lazy"><figcaption></figcaption></figure><p>플랫폼 스레드에 언마운트/마운트할 때에는 park/unpark 메서드를 사용한다.</p><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/java.base/share/classes/java/lang/BaseVirtualThread.java#L30" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code> - <i class="vp-icon fas fa-folder-open" sizing="height"></i><code>/src/java.base/share/classes/java/lang/</code><i class="vp-icon fa-brands fa-java" sizing="height"></i><code>BaseVirtualThread.java</code></a>)</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token keyword">sealed</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">BaseVirtualThread</span> <span class="token keyword">extends</span> <span class="token class-name">Thread</span>  </span>
<span class="line">        <span class="token keyword">permits</span> <span class="token class-name">VirtualThread</span><span class="token punctuation">,</span> <span class="token class-name">ThreadBuilders<span class="token punctuation">.</span>BoundVirtualThread</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/**</span>
<span class="line">   * Initializes a virtual Thread.</span>
<span class="line">   *</span>
<span class="line">   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hljs-doctag<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>@param name thread name, can be null</span>
<span class="line">   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hljs-doctag<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>@param characteristics thread characteristics</span>
<span class="line">   * <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>hljs-doctag<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>@param bound true when bound to an OS thread</span>
<span class="line">   */</span></span>
<span class="line">  <span class="token class-name">BaseVirtualThread</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">int</span> characteristics<span class="token punctuation">,</span> <span class="token keyword">boolean</span> bound<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">super</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> characteristics<span class="token punctuation">,</span> bound<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/**</span>
<span class="line">   * Parks the current virtual thread until the parking permit is available or</span>
<span class="line">   * the thread is interrupted.</span>
<span class="line">   *</span>
<span class="line">   * The behavior of this method when the current thread is not this thread</span>
<span class="line">   * is not defined.</span>
<span class="line">   */</span></span>
<span class="line">  <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/**</span>
<span class="line">   * Parks current virtual thread up to the given waiting time until the parking</span>
<span class="line">   * permit is available or the thread is interrupted.</span>
<span class="line">   *</span>
<span class="line">   * The behavior of this method when the current thread is not this thread</span>
<span class="line">   * is not defined.</span>
<span class="line">   */</span></span>
<span class="line">  <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">parkNanos</span><span class="token punctuation">(</span><span class="token keyword">long</span> nanos<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token doc-comment comment">/**</span>
<span class="line">   * Makes available the parking permit to the given this virtual thread.</span>
<span class="line">   */</span></span>
<span class="line">  <span class="token keyword">abstract</span> <span class="token keyword">void</span> <span class="token function">unpark</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>위 상태 그림처럼 Virtual Thread의 <code>state</code>를 변경시켜가며 상태를 관리한다.</p><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/java.base/share/classes/java/lang/VirtualThread.java#L581" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code> - <i class="vp-icon fas fa-folder-open" sizing="height"></i><code>/src/java.base/share/classes/java/lang/</code><i class="vp-icon fa-brands fa-java" sizing="height"></i><code>VirtualThread.java</code></a>)</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">park</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">  <span class="token comment">// park on the carrier thread when pinned</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>yielded<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">parkOnCarrierThread</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">parkOnCarrierThread</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> timed<span class="token punctuation">,</span> <span class="token keyword">long</span> nanos<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">assert</span> <span class="token function">state</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">RUNNING</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token constant">PINNED</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// RUNNING -&gt; PINNED 로 전환</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>플랫폼 스레드에 마운트하여 실행하는 <code>unpark</code> 메서드를 보자.</p><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/java.base/share/classes/java/lang/VirtualThread.java#L733" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code> - <i class="vp-icon fas fa-folder-open" sizing="height"></i><code>/src/java.base/share/classes/java/lang/</code><i class="vp-icon fa-brands fa-java" sizing="height"></i><code>VirtualThread.java</code></a>)</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token keyword">void</span> <span class="token function">unpark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token constant">PARKED</span> <span class="token operator">&amp;</span> <span class="token function">compareAndSetState</span><span class="token punctuation">(</span><span class="token constant">PARKED</span><span class="token punctuation">,</span> <span class="token constant">RUNNABLE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span>currentThread <span class="token keyword">instanceof</span> <span class="token class-name">VirtualThread</span> vthread<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      vthread<span class="token punctuation">.</span><span class="token function">switchToCarrierThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token function">submitRunContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">          <span class="token function">switchToVirtualThread</span><span class="token punctuation">(</span>vthread<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">submitRunContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">submitRunContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    scheduler<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>runContinuation<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RejectedExecutionException</span> ree<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">submitFailed</span><span class="token punctuation">(</span>ree<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">throw</span> ree<span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>보다시피 <code>scheduler</code>로 실제 실행을 넘기며, <code>scheduler</code>는 <code>ForkJoinPool</code>이다.</p><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/java.base/share/classes/java/lang/VirtualThread.java#L1113" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code> - <i class="vp-icon fas fa-folder-open" sizing="height"></i><code>/src/java.base/share/classes/java/lang/</code><i class="vp-icon fa-brands fa-java" sizing="height"></i><code>VirtualThread.java</code></a>)</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ForkJoinPool</span> <span class="token function">createDefaultScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token class-name">ForkJoinWorkerThreadFactory</span> factory <span class="token operator">=</span> pool <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">&gt;</span></span> pa <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">CarrierThread</span><span class="token punctuation">(</span>pool<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span>pa<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Virtual Thread는 플랫폼 스레드를 참조하고 있으며 이는 <code>carrierThread</code>라고 한다.</p><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/java.base/share/classes/java/lang/VirtualThread.java#L131" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code></a>)</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token comment">// carrier thread when mounted, accessed by VM</span></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Thread</span> carrierThread<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>즉, JVM이 직접 접근하는 스레드는 플랫폼 스레드이며, 플랫폼 스레드에 마운트하여 실행하는 과정은 <code>carrierThread</code>에 실행 대상 Virtual Thread를 할당하는 방식이다.</p><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/java.base/share/classes/java/lang/VirtualThread.java#L351" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code></a>)</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">  carrier<span class="token punctuation">.</span><span class="token function">setCurrentThread</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// -&gt; 플랫폼 스레드에 실행할 Virtual Thread 할당</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token class-name">Thread</span> carrier <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>carrierThread<span class="token punctuation">;</span></span>
<span class="line">  carrier<span class="token punctuation">.</span><span class="token function">setCurrentThread</span><span class="token punctuation">(</span>carrier<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>interruptLock<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">setCarrierThread</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// -&gt; Virtual Thread에서 Virtual Thread 제거</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  carrier<span class="token punctuation">.</span><span class="token function">clearInterrupt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Virtual Thread는 플랫폼 스레드를 참조하고 있으며 실제 실행 시에는 플랫폼 스레드에 마운트되어 <code>ForkJoinPool</code>의 큐에 들어가 스케줄링된다.</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">poolSubmit</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> signalIfEmpty<span class="token punctuation">,</span>  </span>
<span class="line">                                       <span class="token class-name">ForkJoinTask</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> task<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token class-name">WorkQueue</span> q<span class="token punctuation">;</span> <span class="token class-name">Thread</span> t<span class="token punctuation">;</span> <span class="token class-name">ForkJoinWorkerThread</span> wt<span class="token punctuation">;</span></span>
<span class="line">  <span class="token class-name">U</span><span class="token punctuation">.</span><span class="token function">storeStoreFence</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// ensure safely publishable</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>task <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">NullPointerException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>t <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span></span>
<span class="line">      <span class="token punctuation">(</span>wt <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ForkJoinWorkerThread</span><span class="token punctuation">)</span>t<span class="token punctuation">)</span><span class="token punctuation">.</span>pool <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">)</span></span>
<span class="line">      q <span class="token operator">=</span> wt<span class="token punctuation">.</span>workQueue<span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">      task<span class="token punctuation">.</span><span class="token function">markPoolSubmission</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">      q <span class="token operator">=</span> <span class="token function">submissionQueue</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  q<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>task<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> signalIfEmpty<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> task<span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="virtual-thread-pinning" tabindex="-1"><a class="header-anchor" href="#virtual-thread-pinning"><span>Virtual Thread pinning</span></a></h3><p>Virtual Thread의 장점은, JVM이 자체적으로 Virtual Thread를 스케줄링하고 컨텍스트 스위칭 비용이 줄어들어 효율적으로 운영할 수 있다는 것이다. 하지만 Virtual Thread가 플랫폼 스레드에 고정되어 장점을 활용할 수 없는 경우가 있다. Virtual Thread 내에서 synchronized block을 사용하거나, JNI를 통해 네이티브 메서드를 사용하는 경우다.</p><figure><img src="/bookshelf/assets/image/d2.naver.com/1203723/6.png" alt="출처: https://docs.oracle.com/en/java/javase/21/core/virtual-threads.html#GUID-704A716D-0662-4BC7-8C7F-66EE74B1EDAD" tabindex="0" loading="lazy"><figcaption>출처: https://docs.oracle.com/en/java/javase/21/core/virtual-threads.html#GUID-704A716D-0662-4BC7-8C7F-66EE74B1EDAD</figcaption></figure><p>Virtual Thread는 <a href="https://spring.io/blog/2023/09/09/all-together-now-spring-boot-3-2-graalvm-native-images-java-21-and-virtual" target="_blank" rel="noopener noreferrer">Spring Boot 3.2.x에서 공식적으로 지원</a>하지만 <a href="https://spring.io/blog/2022/10/11/embracing-virtual-threads" target="_blank" rel="noopener noreferrer">2.x에서도 별도로 설정해서 사용</a>할 수 있다</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Bean</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">TomcatProtocolHandlerCustomizer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">protocolHandlerVirtualThreadExecutorCustomizer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">return</span> protocolHandler <span class="token operator">-&gt;</span> <span class="token punctuation">{</span></span>
<span class="line">      protocolHandler<span class="token punctuation">.</span><span class="token function">setExecutor</span><span class="token punctuation">(</span><span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newVirtualThreadPerTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>다만, 공식 블로그에 따르면 Spring 로직 내에 많은 <code>synchronized</code>가 있어 효율이 좋지 않다.</p><figure><img src="/bookshelf/assets/image/d2.naver.com/1203723/7.png" alt="출처: https://spring.io/blog/2022/10/11/embracing-virtual-threads#mitigating-limitations" tabindex="0" loading="lazy"><figcaption>출처: https://spring.io/blog/2022/10/11/embracing-virtual-threads#mitigating-limitations</figcaption></figure><p>실제로 Spring Boot 2.7.17에서 Virtual Thread를 사용하도록 설정하고 <code>-Djdk.tracePinnedThreads=short</code> 옵션과 함께 구동한 후 <code>synchronized</code>를 사용하는 컨트롤러를 호출하면 다음과 같은 로그를 많이 볼 수 있다.</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;테스트&quot;</span><span class="token punctuation">,</span> description <span class="token operator">=</span> <span class="token string">&quot;테스트&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">{</span></span>
<span class="line">    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000l</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;HELLO&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line">Thread<span class="token punctuation">[</span><span class="token comment">#185,ForkJoinPool-1-worker-1,5,CarrierThreads]  </span></span>
<span class="line">    com.example.test.TestController.test(TestController.java<span class="token punctuation">:</span>22) &lt;== monitors<span class="token punctuation">:</span><span class="token number">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>또한 Spring 구동 시 다음과 같은 로그도 볼 수 있다.</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line">Thread<span class="token punctuation">[</span><span class="token comment">#184,ForkJoinPool-1-worker-2,5,CarrierThreads]  </span></span>
<span class="line">    com.mysql.cj.protocol.ReadAheadInputStream.read(ReadAheadInputStream.java<span class="token punctuation">:</span>180) &lt;== monitors<span class="token punctuation">:</span><span class="token number">1</span></span>
<span class="line">    com.mysql.cj.jdbc.ConnectionImpl.commit(ConnectionImpl.java<span class="token punctuation">:</span>791) &lt;== monitors<span class="token punctuation">:</span><span class="token number">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>MySQL 패키지에 사용된 <code>synchronized</code>가 pinning을 유발하고 있는 것이다.</p><p>따라서 Spring은 <code>synchronized</code>를 <code>ReentrantLock</code>으로 마이그레이션하는 방향으로 가고 있다.</p><figure><img src="/bookshelf/assets/image/d2.naver.com/1203723/8.png" alt="출처: https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.2.0-M2-Release-Notes#support-for-virtual-threads" tabindex="0" loading="lazy"><figcaption>출처: https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.2.0-M2-Release-Notes#support-for-virtual-threads</figcaption></figure><p>그 밖에도 많은 진영에서 Virtual Thread를 지원하기 위해 <code>synchronized</code>에서 <code>ReentrantLock</code>으로 마이그레이션이 진행되고 있다.</p><ul><li><a href="https://github.com/mysql/mysql-connector-j/pull/95" target="_blank" rel="noopener noreferrer"><code>MySQL</code> (<i class="vp-icon iconfont icon-github" sizing="height"></i><code>mysql/mysql-connector-j</code>)</a></li><li><a href="https://github.com/f4b6a3/uuid-creator/commit/3e684b1dec472b51a641bbd1762b33c9ea62bc77" target="_blank" rel="noopener noreferrer"><code>UUId</code> (<i class="vp-icon iconfont icon-github" sizing="height"></i><code>f4b6a3/uuid-creator</code>)</a></li></ul><p><code>synchronized</code>가 많이 남아있는 Spring Boot 2.x에서는 Virtual Thread를 잘 사용하기 위해서는 여러 의존 모듈의 마이그레이션이 선행되어야 할 것 같다. 앞으로 미래 Java 버전에서는 <code>synchronized</code>는 점점 사라질 것으로 예상한다.</p><h3 id="virtual-thread-blocking" tabindex="-1"><a class="header-anchor" href="#virtual-thread-blocking"><span>Virtual Thread blocking</span></a></h3><p>기존 Java 스레드는 sleep 실행 시 blocking 상태가 되며 다른 스레드와 컨텍스트 스위칭을 한다. Virtual Thread의 sleep을 살펴보자.</p><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/java.base/share/classes/java/lang/Thread.java#L498" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code></a>)</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">long</span> millis<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">if</span> <span class="token punctuation">(</span>millis <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;timeout value is negative&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">long</span> nanos <span class="token operator">=</span> <span class="token constant">MILLISECONDS</span><span class="token punctuation">.</span><span class="token function">toNanos</span><span class="token punctuation">(</span>millis<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token class-name">ThreadSleepEvent</span> event <span class="token operator">=</span> <span class="token function">beforeSleep</span><span class="token punctuation">(</span>nanos<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">VirtualThread</span> vthread<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">        vthread<span class="token punctuation">.</span><span class="token function">sleepNanos</span><span class="token punctuation">(</span>nanos<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></span>
<span class="line">        <span class="token function">sleep0</span><span class="token punctuation">(</span>nanos<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">afterSleep</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>기존 스레드의 경우 sleep0 JNI 호출로 KLT와 함께 block 상태로 변경되고 Virtual Thread의 경우 다른 동작을 하는 것을 볼 수 있다.</p><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/java.base/share/classes/java/lang/VirtualThread.java#L791" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code></a>)</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token keyword">void</span> <span class="token function">sleepNanos</span><span class="token punctuation">(</span><span class="token keyword">long</span> nanos<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">  <span class="token function">parkNanos</span><span class="token punctuation">(</span>remainingNanos<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>(<a href="https://github.com/openjdk/jdk21/blob/master/src/java.base/share/classes/java/lang/VirtualThread.java#L628" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>openjdk/jdk21</code></a>)</p></blockquote><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@Override</span></span>
<span class="line"><span class="token keyword">void</span> <span class="token function">parkNanos</span><span class="token punctuation">(</span><span class="token keyword">long</span> nanos<span class="token punctuation">)</span> <span class="token punctuation">{</span>  </span>
<span class="line">  <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">  <span class="token keyword">boolean</span> yielded <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token class-name">Future</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> unparker <span class="token operator">=</span> <span class="token function">scheduleUnpark</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">::</span><span class="token function">unpark</span><span class="token punctuation">,</span> nanos<span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">setState</span><span class="token punctuation">(</span><span class="token constant">PARKING</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    yielded <span class="token operator">=</span> <span class="token function">yieldContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// may throw</span></span>
<span class="line">    <span class="token comment">/* ... 생략 ... */</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token comment">/* ... 생략 ... */</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">yieldContinuation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token comment">// unmount</span></span>
<span class="line">  <span class="token function">notifyJvmtiUnmount</span><span class="token punctuation">(</span><span class="token comment">/*hide*/</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token function">unmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">try</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token keyword">return</span> <span class="token class-name">Continuation</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token constant">VTHREAD_SCOPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// re-mount</span></span>
<span class="line">    <span class="token function">mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">    <span class="token function">notifyJvmtiMount</span><span class="token punctuation">(</span><span class="token comment">/*hide*/</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>스레드를 언마운트/park하고 다시 마운트/unpark하는 것은 Future로 돌리는 것을 알 수 있다. 즉, 명시적인 KLT의 sleep/block을 수행하지 않는다.</p><p>Spring MVC Tomcat 하에서 테스트를 해보자. Virtual Thread를 사용하지 않는 Tomcat의 threads를 1로 설정하여 커널 스레드를 하나만 사용하게 하고, Virtual Thread에서도 커널 스레드를 하나만 사용하게 하여 처리량을 비교해 보겠다. 또한 호출은 100개의 요청을 동시에 보내 보겠다.</p><p>다음 컨트롤러를 호출한다.</p><div class="language-java line-numbers-mode" data-highlighter="prismjs" data-ext="java"><pre><code class="language-java"><span class="line"><span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;테스트&quot;</span><span class="token punctuation">,</span> description <span class="token operator">=</span> <span class="token string">&quot;테스트&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000l</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;{}&quot;</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token string">&quot;OK&quot;</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Tomcat은 다음 설정으로 스레드를 제한한다.</p><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line"><span class="token key atrule">server</span><span class="token punctuation">:</span>  </span>
<span class="line">  <span class="token key atrule">tomcat</span><span class="token punctuation">:</span></span>
<span class="line">    <span class="token key atrule">threads</span><span class="token punctuation">:</span></span>
<span class="line">      <span class="token key atrule">max</span><span class="token punctuation">:</span> <span class="token number">1</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Virtual Thread는 가이드에 따라 다음 환경변수를 통해 스레드를 제한한다.</p><figure><img src="/bookshelf/assets/image/d2.naver.com/1203723/9.png" alt="출처: https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Thread.html" tabindex="0" loading="lazy"><figcaption>출처: https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/Thread.html</figcaption></figure><p>Virtual Thread를 사용하지 않은 환경에서는 100개의 호출이 동시에 발생했으나, Tomcat 스레드가 1이므로 호출 처리에 최대 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1000</mn><mi>m</mi><mi>s</mi><mo>×</mo><mn>100</mn></mrow><annotation encoding="application/x-tex">1000ms\times{100}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1000</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord"><span class="mord">100</span></span></span></span></span> 의 처리 시간이 걸리고 1TPS의 처리량을 넘지 못한다. 즉, 동시성이 거의 없는 것을 볼 수 있다.</p><table><thead><tr><th style="text-align:left;">Name</th><th style="text-align:left;"># reqs</th><th style="text-align:left;"># fails</th><th style="text-align:left;">Avg</th><th style="text-align:left;">Min</th><th style="text-align:left;">Max</th><th style="text-align:left;">Median</th><th style="text-align:left;">req/s</th><th style="text-align:left;">failures/s</th></tr></thead><tbody><tr><td style="text-align:left;">GET /test</td><td style="text-align:left;">23</td><td style="text-align:left;">0(0.00%)</td><td style="text-align:left;">11986</td><td style="text-align:left;">1021</td><td style="text-align:left;">22943</td><td style="text-align:left;">12000</td><td style="text-align:left;">0.99</td><td style="text-align:left;">0.00</td></tr></tbody></table><p>Virtual Thread를 사용한 환경에서는 높은 TPS 처리량을 보인다. 100개의 호출이 동시에 발생했으나, non-blocking 방식으로 처리되어 최대 처리 시간 또한 1000l 정도다. 또한 로그에서 커널 스레드는 하나만 사용하는 것을 알 수 있다.</p><table><thead><tr><th style="text-align:left;">Name</th><th style="text-align:left;"># reqs</th><th style="text-align:left;"># fails</th><th style="text-align:left;">Avg</th><th style="text-align:left;">Min</th><th style="text-align:left;">Max</th><th style="text-align:left;">Median</th><th style="text-align:left;">req/s</th><th style="text-align:left;">failures/s</th></tr></thead><tbody><tr><td style="text-align:left;">GET /test</td><td style="text-align:left;">928</td><td style="text-align:left;">0(0.00%)</td><td style="text-align:left;">1005</td><td style="text-align:left;">1001</td><td style="text-align:left;">1031</td><td style="text-align:left;">1001</td><td style="text-align:left;">89.19</td><td style="text-align:left;">0.00</td></tr></tbody></table><div class="language-yaml line-numbers-mode" data-highlighter="prismjs" data-ext="yml"><pre><code class="language-yaml"><span class="line">2024<span class="token punctuation">-</span>02<span class="token punctuation">-</span>05 13<span class="token punctuation">:</span>17<span class="token punctuation">:</span>26.329  INFO 70581 <span class="token punctuation">---</span> <span class="token punctuation">[</span>               <span class="token punctuation">]</span> VirtualThread<span class="token punctuation">[</span><span class="token comment">#312]/runnable@ForkJoinPool-1-worker-1  </span></span>
<span class="line">2024<span class="token punctuation">-</span>02<span class="token punctuation">-</span>05 13<span class="token punctuation">:</span>17<span class="token punctuation">:</span>26.336  INFO 70581 <span class="token punctuation">---</span> <span class="token punctuation">[</span>               <span class="token punctuation">]</span> VirtualThread<span class="token punctuation">[</span><span class="token comment">#313]/runnable@ForkJoinPool-1-worker-1  </span></span>
<span class="line">2024<span class="token punctuation">-</span>02<span class="token punctuation">-</span>05 13<span class="token punctuation">:</span>17<span class="token punctuation">:</span>26.339  INFO 70581 <span class="token punctuation">---</span> <span class="token punctuation">[</span>               <span class="token punctuation">]</span> VirtualThread<span class="token punctuation">[</span><span class="token comment">#314]/runnable@ForkJoinPool-1-worker-1  </span></span>
<span class="line">2024<span class="token punctuation">-</span>02<span class="token punctuation">-</span>05 13<span class="token punctuation">:</span>17<span class="token punctuation">:</span>26.349  INFO 70581 <span class="token punctuation">---</span> <span class="token punctuation">[</span>               <span class="token punctuation">]</span> VirtualThread<span class="token punctuation">[</span><span class="token comment">#315]/runnable@ForkJoinPool-1-worker-1  </span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>따라서 Tomcat, Spring MVC 하에서도 Netty/WebFlux와 처리 방식과 효율이 같으며, 네트워크 I/O처럼 CPU를 사용하지 않는 스레드 blocking 환경에서 사용하면 좋은 효율을 보여줄 수 있다고 판단할 수 있다.</p><hr><h2 id="마치며" tabindex="-1"><a class="header-anchor" href="#마치며"><span>마치며</span></a></h2><p>CPU intensive 환경이 아닌, 네트워크 I/O가 다수 발생하는 웹서버 환경에서는 하나의 호출에 하나의 스레드를 점유하는 기존 Spring MVC/Tomcat 모델은 큰 부담으로 작용했고, non-blocking single thread 모델인 Netty/WebFlux 모델이 그 단점을 해결하며 부상했다. 하지만 학습이 어렵고, 숙련도가 부족해 block을 한 번이라도 잘못 사용하는 순간 전체 서비스가 망가지기 때문에 쉽게 도입하긴 쉽지 않다고 생각한다. 레거시 서비스의 경우 webflux로 마이그레이션하기도 어려울 것이다.</p><p>Virtual Thread의 등장은 non-blocking single thread 모델을 사용하지 않아도 된다고 말하고 있다. 실제로 CPU intensive 환경이 아니라면 non-blocking single thread 모델만큼이나 효율을 잘 내고 있다.</p><p>추후 많은 Java 진영에서 synchronized를 제거하는 등, Virtual Thread를 사용하기 위한 준비가 된다면 Java 진영의 non-blocking single thread 모델의 자리에 Virtual Thread가 들어갈지도 모르겠다.</p><hr><h2 id="참고-자료" tabindex="-1"><a class="header-anchor" href="#참고-자료"><span>참고 자료</span></a></h2><a class="vp-card" href="https://github.com/openjdk/jdk21" target="_blank" style="background:rgba(10,10,10,0.2);"><img class="vp-card-logo" src="https://avatars.githubusercontent.com/u/41768318?s=200&amp;v=4" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">openjdk/jdk21</div><hr><div class="vp-card-desc">https://openjdk.org/projects/jdk/21 released 2023-09-19</div></div></a><a class="vp-card" href="https://docs.oracle.com/en/java/javase/21" target="_blank" style="background:rgba(0,104,140,0.2);"><img class="vp-card-logo" src="https://docs.oracle.com/sp_common/site-template/ohc-common/img/favicon.ico" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">JDK 21 Documentation - Home</div><hr><div class="vp-card-desc">The documentation for JDK 21 includes developer guides, API documentation, and release notes.</div></div></a><a class="vp-card" href="https://spring.io/blog" target="_blank" style="background:rgba(109,179,63,0.2);"><img class="vp-card-logo" src="https://spring.io/favicon.svg?v=96334d577af708644f6f0495dd1c7bc8" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">Spring | Blog</div><hr><div class="vp-card-desc">Level up your Java code and explore what Spring can do for you.</div></div></a><a class="vp-card" href="https://usemynotes.com/what-is-jvm-jit/" target="_blank" style="background:rgba(45,201,151,0.2);"><img class="vp-card-logo" src="https://usemynotes.com/wp-content/uploads/2020/10/cropped-fevicon-2-192x192.png" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">What is JVM (Java Virtual Machine)? - UseMyNotes</div><hr><div class="vp-card-desc">In this tutorial, we will unfold two of the most important questions of the Java programming environment i.e What is JVM (Java Virtual Machine)? and What is</div></div></a><a class="vp-card" href="https://jenkov.com/tutorials/java-concurrency/java-virtual-threads.html" target="_blank" style="background:rgba(10,10,10,0.2);"><img class="vp-card-logo" src="https://jenkov.com/favicon.ico" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">Java Virtual Threads</div><hr><div class="vp-card-desc">From Java 19 virtual threads were added to Java. This tutorial explains how to create Java virtual threads, and how they differ from system threads in Java</div></div></a></div><!----><!----><!----></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/chanhi2000/articles/edit/main/src/d2.naver.com/1203723.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/bookshelf/programming/java-spring/articles/" aria-label="/programming/java-spring/articles/"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->/programming/java-spring/articles/</div></a><a class="route-link auto-link next" href="/bookshelf/d2.naver.com/9581727.html" aria-label="일 3,000만 건의 네이버페이 주문 메시지를 처리하는 Kafka 시스템의 무중단 전환 사례"><div class="hint">Next<span class="arrow end"></span></div><div class="link">일 3,000만 건의 네이버페이 주문 메시지를 처리하는 Kafka 시스템의 무중단 전환 사례<i class="vp-icon iconfont icon-apachekafka" sizing="height"></i></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">MIT Licensed | Copyright © 2022-present <a href="https://github.com/chanhi2000">Chan Hee Lee</a></div><!----></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/bookshelf/assets/app-BVguHYKu.js" defer></script>
  </body>
</html>
