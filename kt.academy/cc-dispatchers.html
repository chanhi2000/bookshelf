<!doctype html>
<html lang="en-US" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.26" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.99" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"Kotlin Coroutines dispatchers","image":["https://marcinmoskala.com/coroutines_book/promotion/207_dispatchers.jpg"],"datePublished":"2024-07-01T00:00:00.000Z","dateModified":null,"author":[{"@type":"Person","name":"Marcin MoskaÅ‚a","url":"https://kt.academy/user/marcinmoskala"}]}</script><meta property="og:url" content="https://chanhi2000.github.io/bookshelf/kt.academy/cc-dispatchers.html"><meta property="og:site_name" content="ðŸ“šBookshelf"><meta property="og:title" content="Kotlin Coroutines dispatchers"><meta property="og:description" content="Article(s) > Kotlin Coroutines dispatchers"><meta property="og:type" content="article"><meta property="og:image" content="https://marcinmoskala.com/coroutines_book/promotion/207_dispatchers.jpg"><meta property="og:locale" content="en-US"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:src" content="https://marcinmoskala.com/coroutines_book/promotion/207_dispatchers.jpg"><meta name="twitter:image:alt" content="Kotlin Coroutines dispatchers"><meta property="article:author" content="Marcin MoskaÅ‚a"><meta property="article:tag" content="kotlin"><meta property="article:tag" content="java"><meta property="article:tag" content="kt.academy"><meta property="article:tag" content="blog"><meta property="article:published_time" content="2024-07-01T00:00:00.000Z"><link rel="icon" href="/bookshelf/assets/icon/favicon.svg"><title>Kotlin Coroutines dispatchers | ðŸ“šBookshelf</title><meta name="description" content="Article(s) > Kotlin Coroutines dispatchers">
    <link rel="preload" href="/bookshelf/assets/style-Bhb-QcDa.css" as="style"><link rel="stylesheet" href="/bookshelf/assets/style-Bhb-QcDa.css">
    
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">Skip to main content</a><!--]--><div class="theme-container external-link-icon has-toc" vp-container><!--[--><header id="navbar" class="vp-navbar" vp-navbar><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><a class="route-link vp-brand" href="/bookshelf/" aria-label="Take me home"><img class="vp-nav-logo" src="/bookshelf/assets/icon/favicon.svg" alt><!----><span class="vp-site-name hide-in-pad">ðŸ“šBookshelf</span></a><!--]--></div><div class="vp-navbar-center"><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/bookshelf/news.html" aria-label><!--[--><i class="vp-icon fas fa-rss" sizing="height"></i><!--]--><!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label><!--[--><i class="vp-icon fas fa-keyboard" sizing="height"></i><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/hackingwithswift.com/" aria-label="hackingwithswift.com"><!--[--><img class="vp-icon" src="https://hackingwithswift.com/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->hackingwithswift.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/fcc/" aria-label="freecodecamp.org"><!--[--><img class="vp-icon" src="https://cdn.freecodecamp.org/universal/favicons/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->freecodecamp.org<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/kodeco.com/" aria-label="kodeco.com"><!--[--><img class="vp-icon" src="https://kodeco.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->kodeco.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.kotzilla.io/" aria-label="blog.kotzilla.io"><!--[--><img class="vp-icon" src="https://blog.kotzilla.io/hubfs/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->blog.kotzilla.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/bookshelf/kt.academy/" aria-label="kt.academy"><!--[--><img class="vp-icon" src="https://kt.academy/logo.png" alt aria-hidden no-view sizing="both"><!--]-->kt.academy<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/droidcon.com/" aria-label="droidcon.com"><!--[--><img class="vp-icon" src="https://droidcon.com/wp-content/uploads/2021/07/favicon-300x300.png" alt aria-hidden no-view sizing="both"><!--]-->droidcon.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/outcomeschool.com/" aria-label="outcomeschool.com"><!--[--><img class="vp-icon" src="https://outcomeschool.com/static/favicons/apple-touch-icon.png" alt aria-hidden no-view sizing="both"><!--]-->outcomeschool.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/frontendmasters.com/" aria-label="frontendmasters.com"><!--[--><img class="vp-icon" src="https://frontendmasters.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->frontendmasters.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/css-tricks.com/" aria-label="css-tricks.com"><!--[--><img class="vp-icon" src="https://css-tricks.com/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->css-tricks.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/smashingmagazine.com/" aria-label="smashingmagazine.com"><!--[--><img class="vp-icon" src="https://smashingmagazine.com/images/favicon/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->smashingmagazine.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/smashingmagazine.com/" aria-label="oddbird.net"><!--[--><img class="vp-icon" src="https://oddbird.net/safari-pinned-tab.svg" alt aria-hidden no-view sizing="both"><!--]-->oddbird.net<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/zeroheight.com/" aria-label="zeroheight.com"><!--[--><img class="vp-icon" src="https://zeroheight.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->zeroheight.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/typescript.tv/" aria-label="typescript.tv"><!--[--><img class="vp-icon" src="https://typescript.tv/_astro/android-chrome-192x192.BhQ8hcWh.png" alt aria-hidden no-view sizing="both"><!--]-->typescript.tv<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.logrocket.com/" aria-label="blog.logrocket.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/blog.logrocket.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->blog.logrocket.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/realpython.com/" aria-label="realpython.com"><!--[--><img class="vp-icon" src="https://realpython.com/static/favicon.68cbf4197b0c.png" alt aria-hidden no-view sizing="both"><!--]-->realpython.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/digitalocean.com/" aria-label="digitalocean.com"><!--[--><img class="vp-icon" src="https://digitalocean.com/_next/static/media/favicon.594d6067.ico" alt aria-hidden no-view sizing="both"><!--]-->digitalocean.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/antonioleiva.com/" aria-label="antonioleiva.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/antonioleiva.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->antonioleiva.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/johnnyreilly.com/" aria-label="johnnyreilly.com"><!--[--><img class="vp-icon" src="https://johnnyreilly.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->johnnyreilly.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/code-maze.com/" aria-label="code-maze.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/code-maze.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->code-maze.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/milanjovanovic.tech/" aria-label="milanjovanovic.tech"><!--[--><img class="vp-icon" src="https://milanjovanovic.tech/profile_favicon.png" alt aria-hidden no-view sizing="both"><!--]-->milanjovanovic.tech<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/shopify.engineering/" aria-label="shopify.engineering"><!--[--><img class="vp-icon" src="https://cdn.shopify.com/static/shopify-favicon.png" alt aria-hidden no-view sizing="both"><!--]-->shopify.engineering<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/devtoolstips.org/" aria-label="devtoolstips.org"><!--[--><img class="vp-icon" src="https://devtoolstips.org/assets/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->devtoolstips.org<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/piccalil.li/" aria-label="piccalil.li"><!--[--><img class="vp-icon" src="https://piccalil.li/favicons/apple-touch-icon.png" alt aria-hidden no-view sizing="both"><!--]-->piccalil.li<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/sitepoint.com/" aria-label="sitepoint.com"><!--[--><img class="vp-icon" src="https://sitepoint.com/favicons/512x512.png" alt aria-hidden no-view sizing="both"><!--]-->sitepoint.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/event-driven.io/" aria-label="event-driven.io"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/event-driven.io/favicon.jfif" alt aria-hidden no-view sizing="both"><!--]-->event-driven.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/packagemain.tech/" aria-label="packagemain.tech"><!--[--><img class="vp-icon" src="https://substack-post-media.s3.amazonaws.com/public/images/2ea54e25-eaa6-4630-bfc0-10b8cfdce894/apple-touch-icon-1024x1024.png" alt aria-hidden no-view sizing="both"><!--]-->packagemain.tech<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/gosolve.io/" aria-label="gosolve.io"><!--[--><img class="vp-icon" src="https://gosolve.io/wp-content/uploads/2022/03/cropped-ikona1-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->gosolve.io<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/bram.us/" aria-label="bram.us"><!--[--><img class="vp-icon" src="https://bram.us/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->bram.us<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/una.im/" aria-label="una.im"><!--[--><img class="vp-icon" src="https://una.im/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->una.im<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/joshwcomeau.com/" aria-label="joshwcomeau.com"><!--[--><img class="vp-icon" src="https://joshwcomeau.com/favicon.png" alt aria-hidden no-view sizing="both"><!--]-->joshwcomeau.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/css-tip.com/" aria-label="css-tip.com"><!--[--><img class="vp-icon" src="https://css-tip.com/img/fav.png" alt aria-hidden no-view sizing="both"><!--]-->css-tip.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/nerdy.dev/" aria-label="nerdy.dev"><!--[--><img class="vp-icon" src="https://nerdy.dev/favicon.svg" alt aria-hidden no-view sizing="both"><!--]-->nerdy.dev<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/towardsdatascience.com/" aria-label="towardsdatascience.com"><!--[--><img class="vp-icon" src="https://cdn-images-1.medium.com/v2/resize:fill:128:128/1*VzTUkfeGymHP4Bvav-T-lA.png" alt aria-hidden no-view sizing="both"><!--]-->towardsdatascience.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/douggregor.net/" aria-label="douggregor.net"><!--[--><i class="vp-icon fas fa-globe" sizing="both"></i><!--]-->douggregor.net<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/d2.naver.com/" aria-label="d2.naver.com"><!--[--><img class="vp-icon" src="/bookshelf/assets/image/d2.naver.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->d2.naver.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tech.kakao.com/" aria-label="tech.kakao.com"><!--[--><img class="vp-icon" src="https://www.kakaocorp.com/page/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tech.kakao.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tech.kakaopay.com/" aria-label="tech.kakaopay.com"><!--[--><img class="vp-icon" src="https://tech.kakaopay.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tech.kakaopay.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/fe-developers.kakaoent.com/" aria-label="fe-developers.kakaoent.com"><!--[--><img class="vp-icon" src="https://fe-developers.kakaoent.com/favicon-32x32.png?v=44803cb16c1e2debd3984cf2e8cb2ded" alt aria-hidden no-view sizing="both"><!--]-->fe-developers.kakaoent.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/yozm.wishket.com/" aria-label="yozm.wishket.com"><!--[--><img class="vp-icon" src="https://yozm.wishket.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->yozm.wishket.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/popit.kr/" aria-label="popit.kr"><!--[--><img class="vp-icon" src="https://popit.kr/wp-content/uploads/2016/08/favicon_32x32.png" alt aria-hidden no-view sizing="both"><!--]-->popit.kr<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/devkuma.com/" aria-label="devkuma.com"><!--[--><img class="vp-icon" src="https://devkuma.com/favicons/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->devkuma.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/blog.gangnamunni.com/" aria-label="blog.gangnamunni.com"><!--[--><img class="vp-icon" src="https://blog.gangnamunni.com/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->blog.gangnamunni.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/codingeverybody.kr/" aria-label="codingeverybody.kr"><!--[--><img class="vp-icon" src="https://codingeverybody.kr/wp-content/uploads/cropped-favicon-origin-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->codingeverybody.kr<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label><!--[--><i class="vp-icon fas fa-network-wired" sizing="height"></i><!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/tecmint.com/" aria-label="tecmint.com"><!--[--><img class="vp-icon" src="https://tecmint.com/wp-content/uploads/2020/07/favicon.ico" alt aria-hidden no-view sizing="both"><!--]-->tecmint.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/docker.com/" aria-label="docker.com"><!--[--><img class="vp-icon" src="https://docker.com/app/uploads/2024/02/cropped-docker-logo-favicon-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->docker.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/learnkube.com/" aria-label="learnkube.com"><!--[--><img class="vp-icon" src="https://static.learnkube.com/f7e5160d4744cf05c46161170b5c11c9.svg" alt aria-hidden no-view sizing="both"><!--]-->learnkube.com<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/bookshelf/itsfoss.com/" aria-label="itsfoss.com"><!--[--><img class="vp-icon" src="https://itsfoss.com/content/images/size/w256h256/2022/12/android-chrome-192x192.png" alt aria-hidden no-view sizing="both"><!--]-->itsfoss.com<!----></a></li></ul></button></div></div></nav><!--]--></div><div class="vp-navbar-end"><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/chanhi2000/bookshelf" target="_blank" rel="noopener noreferrer" aria-label="Github"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><!----></div><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><img class="vp-icon" src="https://kt.academy/logo.png" alt aria-hidden no-view sizing="both"><span class="vp-sidebar-title">kt.academy</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">2025</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><span class="vp-sidebar-title">2024</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/benchmark-reflection.html" aria-label="Is reflection slowing down your code?"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Is reflection slowing down your code?<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/blockhound.html" aria-label="Using BlockHound to track blocking calls in non-blocking dispatchers"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Using BlockHound to track blocking calls in non-blocking dispatchers<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/viewmodel-stateflow-sharedflow-channel.html" aria-label="Representing ViewModel events with StateFlow vs. SharedFlow vs. Channel"><!--[--><i class="vp-icon fa-brands fa-android" sizing="both"></i><!--]-->Representing ViewModel events with StateFlow vs. SharedFlow vs. Channel<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/dispatcher-for-backend.html" aria-label="The best dispatcher for a backend framework"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->The best dispatcher for a backend framework<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/cc-why.html" aria-label="Why using Kotlin Coroutines?"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Why using Kotlin Coroutines?<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/ek-respect-contracts.html" aria-label="Item 31: Respect abstraction contracts"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Item 31: Respect abstraction contracts<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/ek-contracts-documentation.html" aria-label="Item 30: Define contracts with documentation"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Item 30: Define contracts with documentation<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/bookshelf/kt.academy/cc-dispatchers.html" aria-label="Kotlin Coroutines dispatchers"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Kotlin Coroutines dispatchers<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/sharedflow-vs-stateflow.html" aria-label="SharedFlow vs StateFlow"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->SharedFlow vs StateFlow<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/ek-api-stability.html" aria-label="Item 27: Specify API stability"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Item 27: Specify API stability<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/power-assert.html" aria-label="Power Assert now in Kotlin!"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Power Assert now in Kotlin!<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/union-types-into.html" aria-label="The problem of union types for type systems"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->The problem of union types for type systems<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/var-readonly-vs-val-mutable.html" aria-label="Mutable objects or properties?"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Mutable objects or properties?<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/network-client-threads.html" aria-label="How many threads your network client uses?"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->How many threads your network client uses?<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/ek-element-visibility.html" aria-label="Item 29: Minimize elementsâ€™ visibility"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Item 29: Minimize elementsâ€™ visibility<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/ek-wrapping-api.html" aria-label="Item 28: Consider wrapping external APIs"><!--[--><i class="vp-icon fa-brands fa-android" sizing="both"></i><!--]-->Item 28: Consider wrapping external APIs<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/pattern-for-composing-flows.html" aria-label="A Pattern for Composing Flow Operations"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->A Pattern for Composing Flow Operations<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/nonblocking-spring-mvc.html" aria-label="Why Non-Blocking?"><!--[--><i class="vp-icon iconfont icon-spring" sizing="both"></i><!--]-->Why Non-Blocking?<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/kfde-generics.html" aria-label="Generics in Kotlin"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Generics in Kotlin<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/cc-cancellation.html" aria-label="Cancellation in Kotlin Coroutines"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Cancellation in Kotlin Coroutines<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/bookshelf/kt.academy/ak-static-analysis.html" aria-label="Static Code Analysers"><!--[--><i class="vp-icon iconfont icon-kotlin" sizing="both"></i><!--]-->Static Code Analysers<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><!----><span class="vp-sidebar-title">2023</span><span class="vp-arrow end"></span></button><!----></section></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><div class="page-cover"><img src="https://marcinmoskala.com/coroutines_book/promotion/207_dispatchers.jpg" alt no-view></div><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><i class="vp-icon iconfont icon-kotlin" sizing="height"></i>Kotlin Coroutines dispatchers</h1><div class="page-info"><span class="page-author-info" aria-label="AuthorðŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://kt.academy/user/marcinmoskala" target="_blank" rel="noopener noreferrer">Marcin MoskaÅ‚a</a></span><span property="author" content="Marcin MoskaÅ‚a"></span></span><!----><span class="page-date-info" aria-label="Writing DateðŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">7/1/24</span><meta property="datePublished" content="2024-07-01T00:00:00.000Z"></span><!----><span class="page-reading-time-info" aria-label="Reading TimeâŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>About 16 min</span><meta property="timeRequired" content="PT16M"></span><span class="page-category-info" aria-label="CategoryðŸŒˆ" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="category icon" name="category"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></svg><!--[--><span class="page-category-item color8" role>Java</span><span class="page-category-item color2" role>Kotlin</span><span class="page-category-item color8" role>Article(s)</span><!--]--><meta property="articleSection" content="Java,Kotlin,Article(s)"></span><span class="page-tag-info" aria-label="TagðŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color8" role>blog</span><span class="page-tag-item color7" role>kt.academy</span><span class="page-tag-item color8" role>java</span><span class="page-tag-item color0" role>kotlin</span><!--]--><meta property="keywords" content="blog,kt.academy,java,kotlin"></span></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><h1 id="frontmatter-title-á„€á…ªá†«á„…á…§á†«" tabindex="-1"><a class="header-anchor" href="#frontmatter-title-á„€á…ªá†«á„…á…§á†«"><span>Kotlin Coroutines dispatchers ê´€ë ¨</span></a></h1><a class="route-link vp-card" href="/bookshelf/programming/java/articles/" style="background:rgba(10,10,10,0.2);"><img class="vp-card-logo" src="https://chanhi2000.github.io/images/ico-wind.svg" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">Java > Article(s)</div><hr><div class="vp-card-desc">Article(s)</div></div></a><nav class="table-of-contents"><ul><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#default-dispatcher" class="router-link-active router-link-exact-active">Default dispatcher</a></li><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#limiting-the-default-dispatcher" class="router-link-active router-link-exact-active">Limiting the default dispatcher</a></li><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#main-dispatcher" class="router-link-active router-link-exact-active">Main dispatcher</a></li><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#io-dispatcher" class="router-link-active router-link-exact-active">IO dispatcher</a></li><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#dispatcher-with-a-custom-limit" class="router-link-active router-link-exact-active">Dispatcher with a custom limit</a></li><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#dispatcher-with-a-fixed-pool-of-threads" class="router-link-active router-link-exact-active">Dispatcher with a fixed pool of threads</a></li><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#dispatcher-limited-to-a-single-thread" class="router-link-active router-link-exact-active">Dispatcher limited to a single thread</a></li><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#using-virtual-threads-from-project-loom" class="router-link-active router-link-exact-active">Using virtual threads from Project Loom</a></li><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#unconfined-dispatcher" class="router-link-active router-link-exact-active">Unconfined dispatcher</a></li><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#immediate-main-dispatching" class="router-link-active router-link-exact-active">Immediate main dispatching</a></li><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#continuation-interceptor" class="router-link-active router-link-exact-active">Continuation interceptor</a></li><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#performance-of-dispatchers-when-executing-different-tasks" class="router-link-active router-link-exact-active">Performance of dispatchers when executing different tasks</a></li><li><a aria-current="page" href="/bookshelf/kt.academy/cc-dispatchers.html#summary" class="router-link-active router-link-exact-active">Summary</a></li></ul></nav><hr><div class="vp-site-info" data-name="Kotlin Coroutines dispatchers"><a class="vp-site-info-navigator no-external-link-icon" title="Kotlin Coroutines dispatchers" href="https://kt.academy/article/cc-dispatchers" target="_blank"></a><div class="vp-site-info-preview" style="background:url(https://marcinmoskala.com/coroutines_book/promotion/207_dispatchers.jpg) center/cover no-repeat;"></div><div class="vp-site-info-detail"><img class="vp-site-info-logo" src="https://kt.academy/logo.png" alt loading="lazy" no-view><div class="vp-site-info-name">Kotlin Coroutines dispatchers</div><div class="vp-site-info-desc">Where we should use each dispatcher from the Kotlin Coroutines library.</div></div><!----></div><div class="hint-container note"><p class="hint-container-title">Note</p><p>This is a chapter from the book <a href="/book/effectivekotlin" target="_blank" rel="noopener noreferrer">Effective Kotlin</a>. You can find it on <a href="https://leanpub.com/effectivekotlin" target="_blank" rel="noopener noreferrer"><i class="vp-icon fas fa-globe" sizing="height"></i>LeanPub</a> or <a href="https://amazon.com/Effective-Kotlin-Best-Practices-Developers-ebook/dp/B0CHBR5XPF/" target="_blank" rel="noopener noreferrer"><i class="vp-icon fa-brands fa-amazon" sizing="height"></i>Amazon</a>.</p></div><p>The Kotlin Coroutines library offers an important functionality that lets us decide which thread (or pool of threads) a coroutine should be running on (starting and resuming). This is done using dispatchers.</p><p>In the English dictionary, a dispatcher is defined as &quot;a person who is responsible for sending people or vehicles to where they are needed, especially emergency vehicles&quot;. In Kotlin coroutines, <code>CoroutineContext</code> determines which thread a certain coroutine will run on.</p><div class="hint-container note"><p class="hint-container-title">Note</p><p>Dispatchers in Kotlin Coroutines are a similar concept to RxJava Schedulers.</p></div><hr><h2 id="default-dispatcher" tabindex="-1"><a class="header-anchor" href="#default-dispatcher"><span>Default dispatcher</span></a></h2><p>If you don&#39;t set any dispatcher, the one chosen by default by asynchronous coroutine builders is <code>Dispatchers.Default</code>, which is designed to run CPU-intensive operations. It has a pool of threads whose size is equal to the number of cores in the machine your code is running on (but not less than two). At least theoretically, this is the optimal number of threads, assuming you are using them efficiently, i.e., performing CPU-intensive calculations and not blocking threads. To see this dispatcher in action, run the following code:</p><div class="kotlin-playground-wrapper"><div class="header">Default dispatcher</div><div class="kotlin-playground-container"><div class="kotlin-playground" theme="default"><pre>suspend fun main(): Unit = coroutineScope {
  repeat(1000) {
    launch { // or launch(Dispatchers.Default) {
      // To make it busy
      List(1_000_000) { Random.nextLong() }.maxOrNull()
      val threadName = Thread.currentThread().name
      println(&quot;Running on thread: $threadName&quot;)
    }
  }
}
</pre><!----></div></div></div><p>Example result on my machine (I have 12 cores, so there are 12 threads in the pool):</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">Running on thread: DefaultDispatcher-worker-1</span>
<span class="line">Running on thread: DefaultDispatcher-worker-5</span>
<span class="line">Running on thread: DefaultDispatcher-worker-7</span>
<span class="line">Running on thread: DefaultDispatcher-worker-6</span>
<span class="line">Running on thread: DefaultDispatcher-worker-11</span>
<span class="line">Running on thread: DefaultDispatcher-worker-2</span>
<span class="line">Running on thread: DefaultDispatcher-worker-10</span>
<span class="line">Running on thread: DefaultDispatcher-worker-4</span>
<span class="line">...</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container warning"><p class="hint-container-title">Warning</p><p><code>runBlocking</code> sets its own dispatcher if no other one is set; so, inside its scope the <code>Dispatcher.Default</code> is not the one that is chosen automatically. If we used <code>runBlocking</code> instead of <code>coroutineScope</code> in the above example, all coroutines would be running on &quot;main&quot;.</p></div><hr><h2 id="limiting-the-default-dispatcher" tabindex="-1"><a class="header-anchor" href="#limiting-the-default-dispatcher"><span>Limiting the default dispatcher</span></a></h2><p>Let&#39;s say that you have an expensive process and you suspect that it might use all <code>Dispatchers.Default</code> threads and starve other coroutines using the same dispatcher. In such cases, we can use <code>limitedParallelism</code> on <code>Dispatchers.Default</code> to make a dispatcher that runs on the same threads but is limited to using not more than a certain number of them at the same time.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">private</span> <span class="token keyword">val</span> dispatcher <span class="token operator">=</span> Dispatchers<span class="token punctuation">.</span>Default</span>
<span class="line">                            <span class="token punctuation">.</span><span class="token function">limitedParallelism</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>If you&#39;ve seen <code>limitedParallelism</code> before, I should warn you that this function has completely different behavior for <code>Dispatchers.Default</code> than for <code>Dispatchers.IO</code>. We will discuss it later.</p><div class="hint-container info"><p class="hint-container-title">Info</p><p><code>limitedParallelism</code> was introduced in kotlinx-coroutines version <code>1.6</code>, so it is quite a new feature and you won&#39;t find it being used in older projects.</p></div><hr><h2 id="main-dispatcher" tabindex="-1"><a class="header-anchor" href="#main-dispatcher"><span>Main dispatcher</span></a></h2><p>Android and many other application frameworks have the concept of a main or UI thread, which is generally the most important thread as it is the only one that can be used to interact with the UI on Android. Therefore, it needs to be used very often but also with great care. When the Main thread is blocked, the whole application is frozen. To run a coroutine on the Main thread, we use <code>Dispatchers.Main</code>.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">showUserName</span><span class="token punctuation">(</span>name<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token operator">=</span> </span>
<span class="line">  <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Main<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    userNameTextView<span class="token punctuation">.</span>text <span class="token operator">=</span> name</span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Notice that frontend libraries are typically not used in unit tests, so <code>Dispatchers.Main</code> is not defined there. To be able to use it, you need to set a dispatcher using <code>Dispatchers.setMain(dispatcher)</code> from <code>kotlinx-coroutines-test</code>.</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="SomeTest.kt"><span>SomeTest.kt</span></div><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">class</span> SomeTest <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">val</span> dispatcher <span class="token operator">=</span> Executors</span>
<span class="line">                              <span class="token punctuation">.</span><span class="token function">newSingleThreadExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                              <span class="token punctuation">.</span><span class="token function">asCoroutineDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  </span>
<span class="line">  <span class="token annotation builtin">@Before</span></span>
<span class="line">  <span class="token keyword">fun</span> <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    Dispatchers<span class="token punctuation">.</span><span class="token function">setMain</span><span class="token punctuation">(</span>dispatcher<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token annotation builtin">@After</span></span>
<span class="line">  <span class="token keyword">fun</span> <span class="token function">tearDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// reset the Main dispatcher to</span></span>
<span class="line">    <span class="token comment">// the original Main dispatcher</span></span>
<span class="line">    Dispatchers<span class="token punctuation">.</span><span class="token function">resetMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    dispatcher<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token annotation builtin">@Test</span></span>
<span class="line">  <span class="token keyword">fun</span> <span class="token function">testSomeUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Main<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token comment">// ...</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>On Android, we typically use the Main dispatcher as the default one. If you use libraries that are suspending instead of blocking and you don&#39;t do any complex calculations, in practice you can only use <code>Dispatchers.Main</code>. If you do some CPU-intensive operations, you should run them on <code>Dispatchers.Default</code>. These two are enough for many applications, but what if you need to block the thread because, for example, you need to perform long I/O operations (e.g., read big files) or use a library with blocking functions? You cannot block the Main thread because your application would freeze. If you block your default dispatcher, you risk blocking all the threads in the thread pool, in which case you won&#39;t be able to do any calculations. This is why we need a different dispatcher for such a situation, and this dispatcher is <code>Dispatchers.IO</code>.</p><hr><h2 id="io-dispatcher" tabindex="-1"><a class="header-anchor" href="#io-dispatcher"><span>IO dispatcher</span></a></h2><p><code>Dispatchers.IO</code> is designed to be used when we block threads with I/O operations, such as when we read/write files or call blocking functions. The code below takes around 1 second because <code>Dispatchers.IO</code> allows more than 50 active threads at the same time.</p><div class="kotlin-playground-wrapper"><div class="header">IO dispatcher (1)</div><div class="kotlin-playground-container"><div class="kotlin-playground" theme="default"><pre>import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.coroutineScope
import kotlinx.coroutines.launch
import kotlin.system.measureTimeMillis

suspend fun main() {
  val time = measureTimeMillis {
    coroutineScope {
      repeat(50) {
        launch(Dispatchers.IO) {
          Thread.sleep(1000)
        }
      }
    }
  }
  println(time) // ~1000
}
</pre><!----></div></div></div><div class="hint-container info"><p class="hint-container-title">Info</p><p><code>Dispatchers.IO</code> is only needed if you have an API that blocks threads. If you use suspending functions, you can use any dispatcher. You do not need to use <code>Dispatchers.IO</code> if you want to use a network or database library that provides suspending functions. In many projects, this means you might not need to use <code>Dispatchers.IO</code> at all.</p></div><p>How does IO dispatcher work? Imagine an unlimited pool of threads that is initially empty but more threads are created as we need them and kept active until they are not used for some time. Such a pool exists, but it wouldn&#39;t be safe to use it directly because too many active threads cause performance to degrade in a slow but unlimited manner, eventually causing out-of-memory errors. This is why all basic dispatchers have a limited number of threads they can use at the same time. <code>Dispatchers.Default</code> is limited by the number of cores in your processor. The limit of <code>Dispatchers.IO</code> is 64 (or the number of cores if there are more).</p><div class="kotlin-playground-wrapper"><div class="header">IO dispatcher (2)</div><div class="kotlin-playground-container"><div class="kotlin-playground" theme="default"><pre>suspend fun main(): Unit = coroutineScope {
  repeat(1000) {
    launch(Dispatchers.IO) {
      Thread.sleep(200)
    
      val threadName = Thread.currentThread().name
      println(&quot;Running on thread: $threadName&quot;)
    }
  }
}
//
// Running on thread: DefaultDispatcher-worker-1
//...
// Running on thread: DefaultDispatcher-worker-53
// Running on thread: DefaultDispatcher-worker-14
</pre><!----></div></div></div><p>As we have mentioned, both <code>Dispatchers.Default</code> and <code>Dispatchers.IO</code> share the same pool of threads. This is an important optimization. Threads are reused, and redispatching is often not needed. For instance, let&#39;s say you are running on <code>Dispatchers.Default</code> and then execution reaches <code>withContext(Dispatchers.IO) { ... }</code>. Most often, you will stay on the same thread<sup class="footnote-ref"><a href="#footnote1">[1]</a><a class="footnote-anchor" id="footnote-ref1"></a></sup>, but what changes is that this thread counts towards not the <code>Dispatchers.Default</code> limit but the <code>Dispatchers.IO</code> limit. Their limits are independent, so they will never starve each other.</p><div class="kotlin-playground-wrapper"><div class="header">IO dispatcher (3)</div><div class="kotlin-playground-container"><div class="kotlin-playground" theme="default"><pre>import kotlinx.coroutines.*

suspend fun main(): Unit = coroutineScope {
  launch(Dispatchers.Default) {
    println(Thread.currentThread().name)
    withContext(Dispatchers.IO) {
      println(Thread.currentThread().name)
    }
  }
}
//
// DefaultDispatcher-worker-2
// DefaultDispatcher-worker-2
</pre><!----></div></div></div><p>To see this more clearly, imagine that you use both <code>Dispatchers.Default</code> and <code>Dispatchers.IO</code> to the maximum. As a result, your number of active threads will be the sum of their limits. If you allow 64 threads in <code>Dispatchers.IO</code> and you have 8 cores, you will have 72 active threads in the shared pool. This means we have efficient thread reuse and both dispatchers have strong independence.</p><p>The most typical case in which we use <code>Dispatchers.IO</code> is when we need to call blocking functions from libraries. The best practice is to wrap them with <code>withContext(Dispatchers.IO)</code> to make them suspending functions, which can be used without any special care: they can be treated like all other properly implemented suspending functions.</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="DiscUserRepository.kt"><span>DiscUserRepository.kt</span></div><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">class</span> <span class="token function">DiscUserRepository</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">val</span> discReader<span class="token operator">:</span> DiscReader</span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">:</span> UserRepository <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> UserData <span class="token operator">=</span></span>
<span class="line">    <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">UserData</span><span class="token punctuation">(</span>discReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;userName&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>To better understand why <code>Dispatchers.IO</code> must have a limit, imagine that you have a periodic task that needs to start a large number of coroutines, each of which needs to block a thread. Your task might be sending a newsletter using a blocking API, like SendGrid. If <code>Dispatchers.IO</code> had no limit, this process would start as many threads as there are emails to send: if you have 100,000 emails to send, it will try to start 100,000 threads, which would require 100 GB of RAM, so it would crash your application. This is why we need to set a limit for <code>Dispatchers.IO</code>.</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="NewsletterService.kt"><span>NewsletterService.kt</span></div><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">class</span> NewsletterService <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">val</span> sendGrid <span class="token operator">=</span> <span class="token function">SendGrid</span><span class="token punctuation">(</span>API_KEY<span class="token punctuation">)</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">sendNewsletter</span><span class="token punctuation">(</span></span>
<span class="line">    newsletter<span class="token operator">:</span> Newsletter<span class="token punctuation">,</span></span>
<span class="line">    emails<span class="token operator">:</span> List<span class="token operator">&lt;</span>Email<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    emails<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> email <span class="token operator">-&gt;</span></span>
<span class="line">      launch <span class="token punctuation">{</span></span>
<span class="line">        sendGrid<span class="token punctuation">.</span><span class="token function">api</span><span class="token punctuation">(</span><span class="token function">createNewsletter</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> newsletter<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>This limit protects our resources but also makes processes take longer. If sending each email takes on average 100 ms and we have 100,000 emails to send, with <code>Dispatchers.IO</code> limited to 64 threads it will take nearly 3 minutes to send all emails. The problem with <code>Dispatchers.IO</code> is that it has one limit for the whole application, so one service might block another. Imagine that in the same application you have another service that needs to send registration confirmation emails. If both services used <code>Dispatchers.IO</code>, then users trying to register would wait in a queue for threads until all newsletter emails have been sent. This should never happen, so we need to create dispatchers with custom independent limits.</p><hr><h2 id="dispatcher-with-a-custom-limit" tabindex="-1"><a class="header-anchor" href="#dispatcher-with-a-custom-limit"><span>Dispatcher with a custom limit</span></a></h2><p><code>Dispatchers.IO</code> has a special behavior defined for the <code>limitedParallelism</code> function that creates a new dispatcher with an independent thread limit. For example, imagine you start 100 coroutines, each of which blocks a thread for a second. If you run these coroutines on <code>Dispatchers.IO</code>, it will take 2 seconds. If you run them on <code>Dispatchers.IO</code> with <code>limitedParallelism</code> set to 100 threads, it will take 1 second. The execution time of both dispatchers can be measured at the same time because the limits of these two dispatchers are independent anyway.</p><div class="kotlin-playground-wrapper"><div class="header">Dispatcher with a custom limit</div><div class="kotlin-playground-container"><div class="kotlin-playground" theme="default"><pre>import kotlinx.coroutines.*
import kotlin.system.measureTimeMillis

suspend fun main(): Unit = coroutineScope {
  launch {
    printCoroutinesTime(Dispatchers.IO)
    // Dispatchers.IO took: 2074
  }
  launch {
    val dispatcher = Dispatchers.IO
                        .limitedParallelism(100)
    printCoroutinesTime(dispatcher)
    // LimitedDispatcher@XXX took: 1082
  }
}

suspend fun printCoroutinesTime(
  dispatcher: CoroutineDispatcher
) {
  val test = measureTimeMillis {
    coroutineScope {
      repeat(100) {
        launch(dispatcher) {
          Thread.sleep(1000)
        }
      }
    }
  }
  println(&quot;$dispatcher took: $test&quot;)
}
</pre><!----></div></div></div><p>Conceptually, there is an unlimited pool of threads that is used by <code>Dispatchers.Default</code> and <code>Dispatchers.IO</code>, but they both have limited access to these threads. When we use <code>limitedParallelism</code> on <code>Dispatchers.IO</code>, we create a new dispatcher with an independent pool of threads (completely independent of <code>Dispatchers.IO</code> limit). If we use <code>limitedParallelism</code> on <code>Dispatchers.Default</code> or any other dispatcher, we create a dispatcher with an additional limit that is still limited, just like the original dispatcher.</p><div class="language-text line-numbers-mode" data-highlighter="prismjs" data-ext="text"><pre><code class="language-text"><span class="line">// Dispatcher with an unlimited pool of threads</span>
<span class="line">private val pool = ...</span>
<span class="line">Dispatchers.IO = pool limited to 64</span>
<span class="line">Dispatchers.IO.limitedParallelism(x) = pool limited to x</span>
<span class="line">Dispatchers.Default = pool limited to coresNum</span>
<span class="line">Dispatchers.Default.limitedParallelism(x) = </span>
<span class="line">    Dispatchers.Default limited to x</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">Info</p><p><code>Dispatchers.Default</code> is limited to the number of cores. <code>Dispatchers.IO</code> is limited to 64 (or the number of cores). Using <code>limitedParallelism</code> on <code>Dispatchers.Default</code> makes a dispatcher with an additional limit to <code>Dispatchers.Default</code>, whereas using it on <code>Dispatcher.IO</code> makes a dispatcher with a limit independent of <code>Dispatcher.IO</code>. However, all these dispatchers share the same infinite pool of threads.</p></div><p>Many developers find it a bit confusing that <code>limitedParallelism</code> has different behavior for <code>Dispatchers.IO</code>, which has nothing to do with the <code>Dispatchers.IO</code> limit. I think we can make this much more intuitive by just adding a simple function to name the creation of a dispatcher that has an independent thread limit:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">fun</span> <span class="token function">limitedDispatcher</span><span class="token punctuation">(</span>threadLimit<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">=</span> Dispatchers<span class="token punctuation">.</span>IO</span>
<span class="line">                                            <span class="token punctuation">.</span><span class="token function">limitedParallelism</span><span class="token punctuation">(</span>threadLimit<span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>The best practice for classes that might intensively block threads is to define their own dispatchers that have their own independent limits. How big should this limit be? You need to decide for yourself, but remember that many threads are inefficient use of our resources. On the other hand, waiting for an available thread is not good for performance. What is most essential is that this limit is independent of <code>Dispatcher.IO</code> and other dispatchers&#39; limits, therefore one service will not block another.</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="DiscUserRepository.kt"><span>DiscUserRepository.kt</span></div><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">class</span> <span class="token function">DiscUserRepository</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">val</span> discReader<span class="token operator">:</span> DiscReader</span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">:</span> UserRepository <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">val</span> dispatcher <span class="token operator">=</span> Dispatchers<span class="token punctuation">.</span>IO</span>
<span class="line">                              <span class="token punctuation">.</span><span class="token function">limitParallelism</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> UserData <span class="token operator">=</span></span>
<span class="line">    <span class="token function">withContext</span><span class="token punctuation">(</span>dispatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">UserData</span><span class="token punctuation">(</span>discReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;userName&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>Let&#39;s get back to the example with the newsletter and the registration confirmation emails. Each of these services should have its own dispatcher with a limit. This way, they will not block each other. The question is what the size of their limits should be. This is a hard question that has no simple answer. It depends on what we care about more: performance or resource usage. If we care about performance, we should set the limit to the number of threads that will be used most of the time. If we care about resource usage, we should set the limit to the number of threads that will be used at the peak time. In this case, I don&#39;t care that the newsletters take a bit longer to send; it would be perfectly fine even if it took an hour, so I could use a small limit, like 5. On the other hand, I care about the registration confirmation emails being sent as soon as possible, and I don&#39;t think this service will ever be used too intensively, so I could set a much higher limit, like 50. Even in most extreme cases, I do not want to block too many threads, because it would expose us to attacks (a big number of requests could block enough threads to cause out-of-memory errors).</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="NewsletterService.kt"><span>NewsletterService.kt</span></div><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">class</span> NewsletterService <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">val</span> dispatcher <span class="token operator">=</span> Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">.</span><span class="token function">limitedParallelism</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">val</span> sendGrid <span class="token operator">=</span> <span class="token function">SendGrid</span><span class="token punctuation">(</span>API_KEY<span class="token punctuation">)</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">sendNewsletter</span><span class="token punctuation">(</span></span>
<span class="line">    newsletter<span class="token operator">:</span> Newsletter<span class="token punctuation">,</span></span>
<span class="line">    emails<span class="token operator">:</span> List<span class="token operator">&lt;</span>Email<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>dispatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    emails<span class="token punctuation">.</span><span class="token function">forEach</span> <span class="token punctuation">{</span> email <span class="token operator">-&gt;</span></span>
<span class="line">      launch <span class="token punctuation">{</span></span>
<span class="line">        sendGrid<span class="token punctuation">.</span><span class="token function">api</span><span class="token punctuation">(</span><span class="token function">createNewsletter</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> newsletter<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">      <span class="token punctuation">}</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> AuthorizationService <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">val</span> dispatcher <span class="token operator">=</span> Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">.</span><span class="token function">limitedParallelism</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">sendAuthEmail</span><span class="token punctuation">(</span></span>
<span class="line">    user<span class="token operator">:</span> User</span>
<span class="line">  <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">withContext</span><span class="token punctuation">(</span>dispatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    sendGrid<span class="token punctuation">.</span><span class="token function">api</span><span class="token punctuation">(</span><span class="token function">createConfirmationEmail</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">// ...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><hr><h2 id="dispatcher-with-a-fixed-pool-of-threads" tabindex="-1"><a class="header-anchor" href="#dispatcher-with-a-fixed-pool-of-threads"><span>Dispatcher with a fixed pool of threads</span></a></h2><p>Some developers like to have more control over the pools of threads they use, and Java offers a powerful API for that. For example, we can create a fixed or cached pool of threads with the <code>Executors</code> class. These pools implement the <code>ExecutorService</code> or <code>Executor</code> interfaces, which we can transform into a dispatcher using the <code>asCoroutineDispatcher</code> function.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">private</span> <span class="token keyword">val</span> NUMBER_OF_THREADS <span class="token operator">=</span> <span class="token number">20</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">val</span> dispatcher <span class="token operator">=</span> Executors</span>
<span class="line">                  <span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>NUMBER_OF_THREADS<span class="token punctuation">)</span></span>
<span class="line">                  <span class="token punctuation">.</span><span class="token function">asCoroutineDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="hint-container info"><p class="hint-container-title">Info</p><p><code>limitedParallelism</code> was introduced in <code>kotlinx-coroutines</code> version 1.6; in previous versions, we often created dispatchers with independent pools of threads using the <code>Executors</code> class.</p></div><p>The biggest problem with this approach is that a dispatcher created with <code>ExecutorService.asCoroutineDispatcher()</code> needs to be closed with the <code>close</code> function. Developers often forget about this, which leads to leaking threads. Another problem is that when you create a fixed pool of threads, you are not using them efficiently because you will keep unused threads alive without sharing them with other services.</p><hr><h2 id="dispatcher-limited-to-a-single-thread" tabindex="-1"><a class="header-anchor" href="#dispatcher-limited-to-a-single-thread"><span>Dispatcher limited to a single thread</span></a></h2><p>For all dispatchers using multiple threads, we need to consider the shared state problem. In the example below, notice that 10,000 coroutines are increasing <code>i</code> by 1. So, its value should be 10,000, but it is a smaller number. This is a result of a shared state (<code>i</code> property) modification on multiple threads at the same time.</p><div class="kotlin-playground-wrapper"><div class="header">Dispatcher limited to a single thread (1)</div><div class="kotlin-playground-container"><div class="kotlin-playground" theme="default"><pre>var i = 0

suspend fun main(): Unit = coroutineScope {
  repeat(10_000) {
    launch(Dispatchers.IO) { // or Default
      i++
    }
  }
  delay(1000)
  println(i) // ~9930
}
</pre><!----></div></div></div><p>There are many ways to solve this problem (most will be described in the <em>The problem with shared states</em> chapter), but one option is to use a dispatcher with just a single thread. If we use just a single thread at a time, we do not need any other synchronization. The classic way to do this used to be to create such a dispatcher using <code>Executors</code>. The problem with this is that this dispatcher keeps an extra thread active that needs to be closed when it is not used anymore. A modern solution is to use <code>Dispatchers.Default</code> or <code>Dispatchers.IO</code> (if we block threads) with parallelism limited to 1.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">val</span> dispatcher <span class="token operator">=</span> Dispatchers<span class="token punctuation">.</span>IO</span>
<span class="line">                  <span class="token punctuation">.</span><span class="token function">limitedParallelism</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token comment">//</span></span>
<span class="line"><span class="token comment">// previously:</span></span>
<span class="line"><span class="token comment">// val dispatcher = Executors.newSingleThreadExecutor()</span></span>
<span class="line"><span class="token comment">//     .asCoroutineDispatcher()</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="kotlin-playground-wrapper"><div class="header">Dispatcher limited to a single thread (2)</div><div class="kotlin-playground-container"><div class="kotlin-playground" theme="default"><pre>var i = 0

suspend fun main(): Unit = coroutineScope {
  val dispatcher = Dispatchers.Default
                      .limitedParallelism(1)
  repeat(10000) {
    launch(dispatcher) {
      i++
    }
  }
  delay(1000)
  println(i) // 10000
}
</pre><!----></div></div></div><p>Because we can use only one thread, the biggest disadvantage of using a dispatcher limited to a single thread is that our calls will be handled sequentially if we block it.</p><div class="kotlin-playground-wrapper"><div class="header">Dispatcher limited to a single thread (3)</div><div class="kotlin-playground-container"><div class="kotlin-playground" theme="default"><pre>import kotlinx.coroutines.*
import kotlin.system.measureTimeMillis

suspend fun main(): Unit = coroutineScope {
  val dispatcher = Dispatchers.Default
                    .limitedParallelism(1)
  
  val launch = launch(dispatcher) {
    repeat(5) {
      launch {
        Thread.sleep(1000)
      }
    }
  }
  val time = measureTimeMillis { launch.join() }
  println(&quot;Took $time&quot;) // Took 5006
}
</pre><!----></div></div></div><hr><h2 id="using-virtual-threads-from-project-loom" tabindex="-1"><a class="header-anchor" href="#using-virtual-threads-from-project-loom"><span>Using virtual threads from Project Loom</span></a></h2><p>The JVM platform introduced a new technology known as Project Loom<sup class="footnote-ref"><a href="#footnote2">[2]</a><a class="footnote-anchor" id="footnote-ref2"></a></sup>. Its biggest innovation is the introduction of <em>virtual threads</em>, which are much lighter than regular threads. It costs much less to have blocked virtual threads than to have a regular thread blocked.</p><p>Project Loom does not have much to offer us developers who know Kotlin Coroutines because they have many more amazing features, like effortless cancellation or virtual time for testing<sup class="footnote-ref"><a href="#footnote3">[3]</a><a class="footnote-anchor" id="footnote-ref3"></a></sup>. However, Project Loom can be truly useful when we use its virtual threads instead of <code>Dispatcher.IO</code>, where we cannot avoid blocking threads<sup class="footnote-ref"><a href="#footnote4">[4]</a><a class="footnote-anchor" id="footnote-ref4"></a></sup>.</p><p>To use Project Loom, we need to use JVM in the version over 19, and we currently need to enable preview features using the <code>--enable-preview</code> flag. Then, we should be able to create an executor using <code>newVirtualThreadPerTaskExecutor</code> from <code>Executors</code> and transform it into a coroutine dispatcher.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">val</span> LoomDispatcher <span class="token operator">=</span> Executors</span>
<span class="line">                      <span class="token punctuation">.</span><span class="token function">newVirtualThreadPerTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">                      <span class="token punctuation">.</span><span class="token function">asCoroutineDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Such a dispatcher can also be implemented as an object declaration:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">object</span> LoomDispatcher <span class="token operator">:</span> <span class="token function">ExecutorCoroutineDispatcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">override</span> <span class="token keyword">val</span> executor<span class="token operator">:</span> Executor <span class="token operator">=</span> Executor <span class="token punctuation">{</span> command <span class="token operator">-&gt;</span></span>
<span class="line">    Thread<span class="token punctuation">.</span><span class="token function">startVirtualThread</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">dispatch</span><span class="token punctuation">(</span></span>
<span class="line">    context<span class="token operator">:</span> CoroutineContext<span class="token punctuation">,</span></span>
<span class="line">    block<span class="token operator">:</span> Runnable</span>
<span class="line">  <span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    <span class="token function">error</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;Cannot be invoked on Dispatchers.LOOM&quot;</span></span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>To use this dispatcher similarly to other dispatchers, we can define an extension property on the <code>Dispatchers</code> object. This should also help this dispatcher&#39;s discoverability.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">val</span> Dispatchers<span class="token punctuation">.</span>Loom<span class="token operator">:</span> CoroutineDispatcher</span>
<span class="line">  <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> LoomDispatcher</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we only need to test if our new dispatcher really is an improvement. We expect it to take less memory and processor time than other dispatchers when we are blocking threads. We could set up the environment for precise measurements, or we could construct an example so extreme that anyone can observe the difference. For this book, I decided to use the latter approach. I started 100,000 coroutines, each blocked for 1 second. Making them do something else, like printing something or incrementing some value, should not change the result much. The execution of all these coroutines on <code>Dispatchers.Loom</code> took a bit more than two seconds.</p><div class="kotlin-playground-wrapper"><div class="header">Dispatcher limited to a single thread (4)</div><div class="kotlin-playground-container"><div class="kotlin-playground" theme="default"><pre>suspend fun main(): Unit = measureTimeMillis {
  coroutineScope {
    repeat(100_000) {
      launch(Dispatchers.Loom) {
        Thread.sleep(1000)
      }
    }
  }
}.let(::println) // 2 273
</pre><!----></div></div></div><p>Let&#39;s compare this new dispatcher to an alternative. Using pure <code>Dispatchers.IO</code> would not be fair as it is limited to 64 threads, and such function execution would take over 26 minutes. We should increment the thread limit to the number of coroutines. When I did that, such code execution took over 23 seconds, so ten times more. Of course, it consumed much more memory and processor time than the <code>Dispatchers.Loom</code> version. Whenever possible, we should use <code>Dispatchers.Loom</code> instead of <code>Dispatchers.IO</code>.</p><div class="kotlin-playground-wrapper"><div class="header">Dispatcher limited to a single thread (5)</div><div class="kotlin-playground-container"><div class="kotlin-playground" theme="default"><pre>import kotlinx.coroutines.*
import kotlin.system.measureTimeMillis

suspend fun main(): Unit = measureTimeMillis {
  val dispatcher = Dispatchers.IO
                      .limitedParallelism(100_000)
  coroutineScope {
    repeat(100_000) {
      launch(dispatcher) {
        Thread.sleep(1000)
      }
    }
  }
}.let(::println) // 23 803
</pre><!----></div></div></div><p>At the moment, Project Loom is still young and hard to use, but I must say it is an exciting substitution for <code>Dispatchers.IO</code>. However, you will likely not need it explicitly in the future as the Kotlin Coroutines team has expressed their willingness to use virtual threads by default once Project Loom is stable. I hope this happens soon.</p><hr><h2 id="unconfined-dispatcher" tabindex="-1"><a class="header-anchor" href="#unconfined-dispatcher"><span>Unconfined dispatcher</span></a></h2><p>The last dispatcher we need to discuss is <code>Dispatchers.Unconfined</code>, which is different from all the other dispatchers as it does not change any threads. When it is started, it runs on the thread on which it was started. If it is resumed, it runs on the thread that resumed it.</p><div class="kotlin-playground-wrapper"><div class="header">Unconfined dispatcher</div><div class="kotlin-playground-container"><div class="kotlin-playground" theme="default"><pre>fun main() {
  var continuation: Continuation&lt;Unit&gt;? = null
  
  thread(name = &quot;Thread1&quot;) {
  runBlocking(Dispatchers.Unconfined) {
  println(Thread.currentThread().name) // Thread1
  
  suspendCancellableCoroutine {
  continuation = it
  }
  
  println(Thread.currentThread().name) // Thread2
  delay(1000)
  println(Thread.currentThread().name) 
  // kotlinx.coroutines.DefaultExecutor (used by delay)
  }
  }

  thread(name = &quot;Thread2&quot;) {
  Thread.sleep(1000)
  continuation?.resume(Unit)
  }
}
</pre><!----></div></div></div><p>In older projects, you can find <code>Dispatchers.Unconfined</code> used in unit tests. Imagine that you need to test a function that calls <code>launch</code>, for which synchronizing the time might not be easy. One solution is to use <code>Dispatchers.Unconfined</code> instead of all other dispatchers. If it is used in all scopes, everything runs on the same thread, and we can more easily control the order of operations. This trick is not needed anymore, as we have much better tools for testing coroutines. We will discuss this later in the book.</p><p>From the performance point of view, this dispatcher is cheapest as it never requires thread switching, therefore we might choose it if we do not care at all which thread our code runs on. However, it is not considered good to use it so recklessly in practice. What if, by accident, we miss a blocking call and we are running on the <code>Main</code> thread? This could lead to blocking the entire application. This is why we avoid using <code>Dispatchers.Unconfined</code> in production code, except for some special cases.</p><hr><h2 id="immediate-main-dispatching" tabindex="-1"><a class="header-anchor" href="#immediate-main-dispatching"><span>Immediate main dispatching</span></a></h2><p>There is a cost associated with dispatching a coroutine. When <code>withContext</code> is called, the coroutine needs to be suspended, possibly wait in a queue, and then be resumed. This is a small but unnecessary cost if we are already on this thread. Look at the function below:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">showUser</span><span class="token punctuation">(</span>user<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Main<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    userNameElement<span class="token punctuation">.</span>text <span class="token operator">=</span> user<span class="token punctuation">.</span>name</span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>If this function had already been called on the main dispatcher, we would have an unnecessary cost of redispatching. What is more, if there were a long queue for the Main thread because of <code>withContext</code>, the user data might be shown after some delay (this coroutine would need to wait for other coroutines to do their job first). To prevent this, there is <code>Dispatchers.Main.immediate</code>, which dispatches only if it is needed. So, if the function below is called on the Main thread, it won&#39;t be re-dispatched: it will be called immediately.</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">showUser</span><span class="token punctuation">(</span>user<span class="token operator">:</span> User<span class="token punctuation">)</span> <span class="token operator">=</span></span>
<span class="line">  <span class="token function">withContext</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>Main<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    userNameElement<span class="token punctuation">.</span>text <span class="token operator">=</span> user<span class="token punctuation">.</span>name</span>
<span class="line">    <span class="token comment">// ...</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>We prefer <code>Dispatchers.Main.immediate</code> as the <code>withContext</code> argument whenever this function might have already been called from the main dispatcher. Currently, the other dispatchers do not support immediate dispatching.</p><hr><h2 id="continuation-interceptor" tabindex="-1"><a class="header-anchor" href="#continuation-interceptor"><span>Continuation interceptor</span></a></h2><p>Dispatching works based on the mechanism of continuation interception, which is built into the Kotlin language. There is a coroutine context named <code>ContinuationInterceptor</code>, whose <code>interceptContinuation</code> method is used to modify a continuation when a coroutine is suspended<sup class="footnote-ref"><a href="#footnote5">[5]</a><a class="footnote-anchor" id="footnote-ref5"></a></sup>. It also has a <code>releaseInterceptedContinuation</code> method that is called when a continuation is ended.</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="ContinuationInterceptor.kt"><span>ContinuationInterceptor.kt</span></div><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">public</span> <span class="token keyword">interface</span> ContinuationInterceptor <span class="token operator">:</span></span>
<span class="line">  CoroutineContext<span class="token punctuation">.</span><span class="token function">Element</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">companion</span> <span class="token keyword">object</span> Key <span class="token operator">:</span></span>
<span class="line">    CoroutineContext<span class="token punctuation">.</span>Key<span class="token operator">&lt;</span>ContinuationInterceptor<span class="token operator">&gt;</span></span>
<span class="line"></span>
<span class="line">  <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token function">interceptContinuation</span><span class="token punctuation">(</span></span>
<span class="line">    continuation<span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span><span class="token operator">:</span> Continuation<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span></span>
<span class="line">  </span>
<span class="line">  <span class="token keyword">fun</span> <span class="token function">releaseInterceptedContinuation</span><span class="token punctuation">(</span></span>
<span class="line">    continuation<span class="token operator">:</span> Continuation<span class="token operator">&lt;</span><span class="token operator">*</span><span class="token operator">&gt;</span></span>
<span class="line">  <span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  </span>
<span class="line">  <span class="token comment">//...</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><p>The capability to wrap a continuation gives a lot of control. Dispatchers use <code>interceptContinuation</code> to wrap a continuation with <code>DispatchedContinuation</code>, which runs on a specific pool of threads. This is how dispatchers work.</p><p>The problem is that the same context is also used by many testing libraries, such as <code>runTest</code> from <code>kotlinx-coroutines-test</code>. Each element in a context has to have a unique key, which is why we sometimes inject dispatchers into unit tests to replace them with test dispatchers. We will get back to this topic in the chapter dedicated to coroutine testing.</p><div class="code-block-with-title"><div class="code-block-title-bar" data-title="DiscUserRepository.kt"><span>DiscUserRepository.kt</span></div><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">class</span> <span class="token function">DiscUserRepository</span><span class="token punctuation">(</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">val</span> discReader<span class="token operator">:</span> DiscReader<span class="token punctuation">,</span></span>
<span class="line">  <span class="token keyword">private</span> <span class="token keyword">val</span> dispatcher<span class="token operator">:</span> CoroutineContext <span class="token operator">=</span> Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">,</span></span>
<span class="line"><span class="token punctuation">)</span> <span class="token operator">:</span> UserRepository <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">override</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> UserData <span class="token operator">=</span></span>
<span class="line">    <span class="token function">withContext</span><span class="token punctuation">(</span>dispatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">      <span class="token function">UserData</span><span class="token punctuation">(</span>discReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">&quot;userName&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">class</span> UserReaderTests <span class="token punctuation">{</span></span>
<span class="line">  <span class="token annotation builtin">@Test</span></span>
<span class="line">  <span class="token keyword">fun</span> <span class="token function">`some test`</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runTest <span class="token punctuation">{</span></span>
<span class="line">    <span class="token comment">// given</span></span>
<span class="line">    <span class="token keyword">val</span> discReader <span class="token operator">=</span> <span class="token function">FakeDiscReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token keyword">val</span> repo <span class="token operator">=</span> <span class="token function">DiscUserRepository</span><span class="token punctuation">(</span></span>
<span class="line">      discReader<span class="token punctuation">,</span></span>
<span class="line">      <span class="token comment">// one of coroutines testing practices</span></span>
<span class="line">      <span class="token keyword">this</span><span class="token punctuation">.</span>coroutineContext\<span class="token punctuation">[</span>ContinuationInterceptor\<span class="token punctuation">]</span><span class="token operator">!!</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">    <span class="token comment">//...</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><hr><h2 id="performance-of-dispatchers-when-executing-different-tasks" tabindex="-1"><a class="header-anchor" href="#performance-of-dispatchers-when-executing-different-tasks"><span>Performance of dispatchers when executing different tasks</span></a></h2><p>To show how different dispatchers perform in different tasks, I made some benchmarks. In all these cases, the task is to run 100 independent coroutines with the same task. The columns represent different tasks: suspending for a second, blocking for a second, CPU-intensive operation, and memory-intensive operation (where the majority of the time is spent accessing, allocating, and freeing memory). Different rows represent the different dispatchers used for running these coroutines. The table below shows the average execution time in milliseconds.</p><table><thead><tr><th style="text-align:right;"></th><th style="text-align:center;">Suspending</th><th style="text-align:center;">Blocking</th><th style="text-align:center;">CPU</th><th style="text-align:center;">Memory</th></tr></thead><tbody><tr><td style="text-align:right;">Single thread</td><td style="text-align:center;">1,002</td><td style="text-align:center;">100,003</td><td style="text-align:center;">39,103</td><td style="text-align:center;">94,358</td></tr><tr><td style="text-align:right;">Default (8 threads)</td><td style="text-align:center;">1,002</td><td style="text-align:center;">13,003</td><td style="text-align:center;">8,473</td><td style="text-align:center;">21,461</td></tr><tr><td style="text-align:right;">IO (64 threads)</td><td style="text-align:center;">1,002</td><td style="text-align:center;">2,003</td><td style="text-align:center;">9,893</td><td style="text-align:center;">20,776</td></tr><tr><td style="text-align:right;">100 threads</td><td style="text-align:center;">1,002</td><td style="text-align:center;">1,003</td><td style="text-align:center;">10,379</td><td style="text-align:center;">21,004</td></tr></tbody></table><p>There are a few important observations you can make:</p><ul><li>When we are just suspending, it doesn&#39;t really matter how many threads we are using.</li><li>When we are blocking, the more threads we are using, the faster all these coroutines will be finished.</li><li>With CPU-intensive operations, <code>Dispatchers.Default</code> is the best option<sup class="footnote-ref"><a href="#footnote6">[6]</a><a class="footnote-anchor" id="footnote-ref6"></a></sup>.</li><li>If we are dealing with a memory-intensive problem, more threads might provide some (but not significant) improvement.</li></ul><p>Here is how the tested functions look<sup class="footnote-ref"><a href="#footnote7">[7]</a><a class="footnote-anchor" id="footnote-ref7"></a></sup>:</p><div class="language-kotlin line-numbers-mode" data-highlighter="prismjs" data-ext="kt"><pre><code class="language-kotlin"><span class="line"><span class="token keyword">fun</span> <span class="token function">cpu</span><span class="token punctuation">(</span>order<span class="token operator">:</span> Order<span class="token punctuation">)</span><span class="token operator">:</span> Coffee <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">var</span> i <span class="token operator">=</span> Int<span class="token punctuation">.</span>MAX_VALUE</span>
<span class="line">  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">    i <span class="token operator">-=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token number">1</span> <span class="token keyword">else</span> <span class="token number">2</span></span>
<span class="line">  <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">Coffee</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>customer <span class="token operator">=</span> order<span class="token punctuation">.</span>customer <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fun</span> <span class="token function">memory</span><span class="token punctuation">(</span>order<span class="token operator">:</span> Order<span class="token punctuation">)</span><span class="token operator">:</span> Coffee <span class="token punctuation">{</span></span>
<span class="line">  <span class="token keyword">val</span> list <span class="token operator">=</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token number">1_000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> it <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">val</span> list2 <span class="token operator">=</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token number">1_000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> list <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">val</span> list3 <span class="token operator">=</span> <span class="token function">List</span><span class="token punctuation">(</span><span class="token number">1_000</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> list2 <span class="token punctuation">}</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">Coffee</span><span class="token punctuation">(</span></span>
<span class="line">    order<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span></span>
<span class="line">      customer <span class="token operator">=</span> order<span class="token punctuation">.</span>customer <span class="token operator">+</span> list3<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">    <span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">fun</span> <span class="token function">blocking</span><span class="token punctuation">(</span>order<span class="token operator">:</span> Order<span class="token punctuation">)</span><span class="token operator">:</span> Coffee <span class="token punctuation">{</span></span>
<span class="line">  Thread<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">Coffee</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">suspending</span><span class="token punctuation">(</span>order<span class="token operator">:</span> Order<span class="token punctuation">)</span><span class="token operator">:</span> Coffee <span class="token punctuation">{</span></span>
<span class="line">  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token keyword">return</span> <span class="token function">Coffee</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h2 id="summary" tabindex="-1"><a class="header-anchor" href="#summary"><span>Summary</span></a></h2><p>Dispatchers determine which thread or thread pool a coroutine will run (starting and resuming) on. The most important options are:</p><ul><li><code>Dispatchers.Default</code>, which we use for CPU-intensive operations;</li><li><code>Dispatchers.Main</code>, which we use to access the Main thread on Android, Swing, or JavaFX;</li><li><code>Dispatchers.Main.immediate</code>, which runs on the same thread as <code>Dispatchers.Main</code> but is not redispatched if it is not necessary;</li><li><code>Dispatchers.IO</code>, which we use when we need to do some blocking operations;</li><li><code>Dispatchers.IO</code> with limited parallelism or a custom dispatcher with a pool of threads, which we use when we might have many blocking calls;</li><li><code>Dispatchers.Default</code> or <code>Dispatchers.IO</code> with parallelism limited to 1, or a custom dispatcher with a single thread, which is used when we need to secure shared state modifications;</li><li><code>Dispatchers.Unconfined</code>, which does not change threads and is used in some special cases;</li></ul><!-- TODO: add ARTICLE CARD --><a class="vp-card" href="https://chanhi2000.github.io/bookshelf/kt.academy/cc-dispatchers.html" target="_blank" style="background:rgba(243,139,49,0.2);"><img class="vp-card-logo" src="https://kt.academy/logo.png" loading="lazy" no-view><div class="vp-card-content"><div class="vp-card-title">Kotlin Coroutines dispatchers</div><hr><div class="vp-card-desc">Where we should use each dispatcher from the Kotlin Coroutines library.</div></div></a><hr class="footnotes-sep"><section class="footnotes"><ol class="footnotes-list"><li id="footnote1" class="footnote-item"><p>This mechanism is not deterministic. <a href="#footnote-ref1" class="footnote-backref">â†©ï¸Ž</a></p></li><li id="footnote2" class="footnote-item"><p>I am writing this optimistically, hoping that Project Loom is already stable when you read this. At the time of writing, in early 2023, it is not. <a href="#footnote-ref2" class="footnote-backref">â†©ï¸Ž</a></p></li><li id="footnote3" class="footnote-item"><p>We will discuss this in the <em>Testing Kotlin Coroutines</em> chapter. <a href="#footnote-ref3" class="footnote-backref">â†©ï¸Ž</a></p></li><li id="footnote4" class="footnote-item"><p>The solution was inspired by the article <a class="route-link" href="/bookshelf/kt.academy/dispatcher-loom.html"><em>Running Kotlin coroutines on Project Loom&#39;s virtual threads</em> by <em>Jan Vladimir Mostert</em></a>. <a href="#footnote-ref4" class="footnote-backref">â†©ï¸Ž</a></p></li><li id="footnote5" class="footnote-item"><p>Wrapping needs to happen only once per continuation thanks to the caching mechanism. <a href="#footnote-ref5" class="footnote-backref">â†©ï¸Ž</a></p></li><li id="footnote6" class="footnote-item"><p>The main reason is that the more threads we use, the more time the processor needs to spend switching between them, thus it has less time to do meaningful operations. Also <code>Dispatchers.IO</code> should not be used for CPU-intensive operations because it is used to block operations, and some other process might block all its threads. <a href="#footnote-ref6" class="footnote-backref">â†©ï¸Ž</a></p></li><li id="footnote7" class="footnote-item"><p>The whole code can be found at <a href="https://github.com/MarcinMoskala/coroutines-benchmarks/blob/master/src/jmh/java/me/champeau/jmh/DispatchersBenchmark.kt" target="_blank" rel="noopener noreferrer"><i class="vp-icon iconfont icon-github" sizing="height"></i><code>MarcinMoskala/coroutines-benchmarks</code></a> <a href="#footnote-ref7" class="footnote-backref">â†©ï¸Ž</a></p></li></ol></section></div><!----><!----><!----></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/chanhi2000/bookshelf/edit/main/src/kt.academy/cc-dispatchers.md" aria-label="Edit this page on GitHub" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->Edit this page on GitHub<!----></a></div><div class="vp-meta-item git-info"><!----><!----></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/bookshelf/programming/java/articles/" aria-label="/programming/java/articles/"><div class="hint"><span class="arrow start"></span>Prev</div><div class="link"><!---->/programming/java/articles/</div></a><a class="route-link auto-link next" href="/bookshelf/kt.academy/sharedflow-vs-stateflow.html" aria-label="SharedFlow vs StateFlow"><div class="hint">Next<span class="arrow end"></span></div><div class="link">SharedFlow vs StateFlow<i class="vp-icon iconfont icon-kotlin" sizing="height"></i></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">MIT Licensed | Copyright Â© 2022-present <a href="https://github.com/chanhi2000">Chan Hee Lee</a></div><div class="vp-copyright">Copyright Â© 2026 Marcin MoskaÅ‚a </div></footer></div><!--]--><!--[--><!----><!--[--><!--]--><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/bookshelf/assets/app-BItykJLQ.js" defer></script>
  </body>
</html>
